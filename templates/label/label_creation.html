{% extends 'base.html' %}
{% load static %}

{% block title %}표시사항 작성{% endblock %}

{% block content %}
<!-- jQuery & Select2 -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
// ------------------ 초기화 & 그룹 체크박스 로직 ------------------
function initCheckBoxGroups() {
  // 장기보존식품 그룹: 1개만 선택
  $('.grp-long-shelf').on('click', function(e) {
    let alreadyChecked = $(this).data('alreadyChecked') || false;
    if (alreadyChecked) {
       $(this).prop('checked', false).data('alreadyChecked', false);
    } else {
       // 다른 항목 해제
       $('.grp-long-shelf').not(this).prop('checked', false).data('alreadyChecked', false);
       $(this).prop('checked', true).data('alreadyChecked', true);
    }
    e.stopPropagation();
  });

  // 제조방법 그룹: 1개만 선택 (조건 제외)
  $('.grp-sterilization').on('click', function(e) {
    if (this.id === "chk_sterilization_other") return; // 조건은 별도
    let alreadyChecked = $(this).data('alreadyChecked') || false;
    if (alreadyChecked) {
       $(this).prop('checked', false).data('alreadyChecked', false);
    } else {
       $('.grp-sterilization').not('#chk_sterilization_other').not(this)
           .prop('checked', false).data('alreadyChecked', false);
       $(this).prop('checked', true).data('alreadyChecked', true);
    }
    // 조건 체크박스 활성화: 살균 or 멸균 체크 시
    if ($("#chk_sanitized").is(":checked") || $("#chk_aseptic").is(":checked")) {
        $("#chk_sterilization_other").prop("disabled", false);
    } else {
        $("#chk_sterilization_other").prop("disabled", true).prop("checked", false).data("alreadyChecked", false);
    }
    e.stopPropagation();
  });
}

// ------------------ 식품유형 요약 업데이트 ------------------
function updateSummary() {
  const foodSmall = $('#food_type_small option:selected').text();
  const summaries = [];

  // 1. 소분류 표시
  if (foodSmall && foodSmall !== "소분류") {
    summaries.push(foodSmall);
  }

  // 2. 장기보존식품 체크
  const longShelfElem = $('.grp-long-shelf:checked');
  if (longShelfElem.length) {
    const id = longShelfElem.attr('id');
    if (id === 'chk_frozen_heated') {
      // 냉동(가열)
      summaries.push("냉동식품(가열하여 섭취하는 냉동식품)");
    } else if (id === 'chk_frozen_nonheated') {
      // 냉동(비가열)
      summaries.push("냉동식품(가열하지 않고 섭취하는 냉동식품)");
    } else {
      // 그 외(통.병조림, 레토르트 등)
      const labelText = longShelfElem.closest('.form-check').find('label').text();
      summaries.push(labelText);
    }
  }

  // 3. 제조방법 체크 (조건 제외)
  const manufacturing = $('.grp-sterilization:checked')
    .not('#chk_sterilization_other')
    .closest('.form-check')
    .find('label')
    .text();
  if (manufacturing) {
    summaries.push(manufacturing);
  }

  // 4. 조건 상세 입력
  const manufacturingOther = $("input[name='sterilization_other_detail']").val() || "";
  if (manufacturingOther) {
    summaries.push(manufacturingOther);
  }

  // 최종 요약 표시
  $('#selected-info').text("식품유형 : " + summaries.join(" | "));
}

// ------------------ 영양성분 계산 로직 ------------------
function roundXdigit(value, step, unit, min=0, lmin=0) {
  if (value < min) return "0";
  if (value < lmin) return lmin + unit + " 이하";

  let remainder = value % step;
  let result = remainder <= step/2 ? value - remainder : value - remainder + step;
  result = step >= 1 ? parseInt(result) : parseFloat(result.toFixed(1));
  return result + unit;
}

function divideroundXdigit(mid, value, step1, step2, unit, min=0, lmin=0) {
  return (value <= mid)
    ? roundXdigit(value, step1, unit, min, lmin)
    : roundXdigit(value, step2, unit, min, lmin);
}

function percentcalculate(value, limit) {
  return Math.round((value / limit) * 100);
}

function runNutritionCalculator() {
  let val = id => parseFloat(document.getElementById(id).value || "0");

  let calorie     = val("calorie");
  let natrium     = val("natrium");
  let sugar       = val("sugar");
  let carbo       = val("carbohydrate");
  let afat        = val("afat");
  let transfat    = val("transfat");
  let satufat     = val("satufat");
  let cholesterol = val("cholesterol");
  let protein     = val("protein");

  document.getElementById("result_calorie").innerText =
    roundXdigit(calorie, 5, "kcal");
  document.getElementById("result_natrium").innerText =
    divideroundXdigit(120, natrium, 5, 10, "mg", 5) + ` (${percentcalculate(natrium,2000)}%)`;
  document.getElementById("result_carbohydrate").innerText =
    roundXdigit(carbo, 1, "g", 0.5, 1) + ` (${percentcalculate(carbo,324)}%)`;
  document.getElementById("result_sugar").innerText =
    roundXdigit(sugar, 1, "g", 0.5) + ` (${percentcalculate(sugar,100)}%)`;
  document.getElementById("result_afat").innerText =
    divideroundXdigit(5, afat, 0.1, 1, "g", 0.5) + ` (${percentcalculate(afat,54)}%)`;
  document.getElementById("result_transfat").innerText =
    divideroundXdigit(5, transfat, 0.1, 1, "g", 0.2, 0.5);
  document.getElementById("result_satufat").innerText =
    divideroundXdigit(5, satufat, 0.1, 1, "g", 0.2, 0.5) + ` (${percentcalculate(satufat,15)}%)`;
  document.getElementById("result_cholesterol").innerText =
    roundXdigit(cholesterol, 5, "mg", 2, 5) + ` (${percentcalculate(cholesterol,300)}%)`;
  document.getElementById("result_protein").innerText =
    roundXdigit(protein, 1, "g", 0.5, 1) + ` (${percentcalculate(protein,55)}%)`;
}

// ------------------ 팝업 로직 ------------------
function openIngredientPopup() {
  const rawmtrl_nm = document.querySelector('textarea[name="rawmtrl_nm"]')?.value || "";
  const label_id = '{{ label.my_label_id }}';
  const url = `/label/ingredient-popup/?rawmtrl_nm=${encodeURIComponent(rawmtrl_nm)}&label_id=${label_id}`;
  window.open(url, 'IngredientPopup', 'width=1400,height=850,scrollbars=yes');
}

function openPreviewPopup() {
  const labelId = "{{ label.my_label_id }}";
  if (!labelId) {
    alert("라벨이 저장되지 않았습니다.");
    return;
  }
  // 선택된 체크박스만 쿼리스트링에 반영
  const checkedFields = document.querySelectorAll("input[type='checkbox']:checked");
  let queryString = new URLSearchParams();
  checkedFields.forEach((chk) => {
    queryString.append(chk.name, "true");
  });
  const previewUrl = `/label/preview/?label_id=${labelId}&${queryString.toString()}`;
  window.open(previewUrl, 'previewPopup', 'width=1400,height=850,scrollbars=yes');
}

// ------------------ Document Ready ------------------
$(document).ready(function() {
  // Select2 초기화
  // 체크박스 그룹 초기화
  initCheckBoxGroups();
  // 요약 업데이트
  updateSummary();
  $('.select2-food-type, input[type="checkbox"], input[name="sterilization_other_detail"]')
    .on('change input', updateSummary);
});
</script>

<!-- 상단 헤더 -->
<div class="container mt-4" style="padding-bottom: 10px;">
  <div class="d-flex align-items-center justify-content-between" style="gap: 20px;">
    <h2 class="mb-0">표시사항 작성</h2>
    <div class="d-flex align-items-center" style="gap: 20px;">
      <span class="recent-update">최근 수정일: {{ label.update_datetime|date:"Y-m-d H:i" }}</span>
      <button type="submit" form="labelForm" class="btn btn-primary">저장</button>
      <button type="button" class="btn btn-default preview-btn" onclick="openPreviewPopup()">미리보기</button>
    </div>
  </div>
</div>

<!-- 식품유형/장기보존/제조방법 선택 영역 -->
<div class="container mb-2">
  <div class="d-flex align-items-center" style="gap:20px; width:100%;">
    <!-- 식품유형 -->
    <div class="selectable-item" style="flex:1; max-width:33%;">
      <label class="form-label" style="font-size:0.8rem; font-weight:bold;">식품유형</label>
      <div class="d-flex" style="gap:5px; width:100%;">
        <select id="food_type_large" name="food_type_large" class="form-control select2-food-type" style="width:40%;">
           <option value="">대분류</option>
           {% for lt in large_food_types %}
           <option value="{{ lt }}" {% if form.food_type_large.value == lt %}selected{% endif %}>{{ lt }}</option>
           {% endfor %}
        </select>
        <select id="food_type_small" name="prdlst_dcnm" class="form-control select2-food-type" style="width:60%;">
           <option value="">소분류</option>
           {% for t in food_types %}
           <option value="{{ t }}" {% if form.prdlst_dcnm.value == t %}selected{% endif %}>{{ t }}</option>
           {% endfor %}
        </select>
      </div>
    </div>
    
    <!-- 장기보존식품 -->
    <div style="flex:1; max-width:33%; display: flex; flex-direction: column; align-items: flex-start;">
      <div style="display: flex; align-items: center; margin-left: 0;">
         <input type="checkbox" id="dummy_long_shelf" style="visibility:hidden; width:18px; margin-right:5px;">
         <label class="form-label" style="font-size:0.8rem; font-weight:bold; margin:0;">장기보존식품</label>
      </div>
      <div class="d-flex align-items-center" style="gap:10px; width:100%;">
        <div class="form-check" style="margin:0;">
          <input type="checkbox" id="chk_frozen_heated" name="chk_long_shelf" class="form-check-input grp-long-shelf">
          <label for="chk_frozen_heated" class="form-check-label" style="font-size:0.8rem;">냉동(가열)</label>
        </div>
        <div class="form-check" style="margin:0;">
          <input type="checkbox" id="chk_frozen_nonheated" name="chk_long_shelf" class="form-check-input grp-long-shelf">
          <label for="chk_frozen_nonheated" class="form-check-label" style="font-size:0.8rem;">냉동(비가열)</label>
        </div>
        <div class="form-check" style="margin:0;">
          <input type="checkbox" id="chk_canned" name="chk_long_shelf" class="form-check-input grp-long-shelf">
          <label for="chk_canned" class="form-check-label" style="font-size:0.8rem;">통.병조림</label>
        </div>
        <div class="form-check" style="margin:0;">
          <input type="checkbox" id="chk_retort" name="chk_long_shelf" class="form-check-input grp-long-shelf">
          <label for="chk_retort" class="form-check-label" style="font-size:0.8rem;">레토르트</label>
        </div>
      </div>
    </div>
    
    <!-- 제조방법 -->
    <div style="flex:1; max-width:33%; display: flex; flex-direction: column; align-items: flex-start;">
      <div style="display: flex; align-items: center; margin-left: 0;">
         <input type="checkbox" id="dummy_manufacturing" style="visibility:hidden; width:18px; margin-right:5px;">
         <label class="form-label" style="font-size:0.8rem; font-weight:bold; margin:0;">제조방법</label>
      </div>
      <div class="d-flex align-items-center" style="gap:10px; flex-wrap: nowrap; width:100%;">
        <div class="form-check" style="margin:0;">
          <input type="checkbox" id="chk_sanitized" name="grp_sterilization" class="form-check-input grp-sterilization">
          <label for="chk_sanitized" class="form-check-label" style="font-size:0.8rem;">살균</label>
        </div>
        <div class="form-check" style="margin:0;">
          <input type="checkbox" id="chk_aseptic" name="grp_sterilization" class="form-check-input grp-sterilization">
          <label for="chk_aseptic" class="form-check-label" style="font-size:0.8rem;">멸균</label>
        </div>
        <div class="form-check" style="margin:0;">
          <input type="checkbox" id="chk_yutang" name="grp_sterilization" class="form-check-input grp-sterilization">
          <label for="chk_yutang" class="form-check-label" style="font-size:0.8rem;">유탕/유처리</label>
        </div>
        <div class="form-check" style="margin:0;">
          <input type="checkbox" id="chk_sterilization_other" name="grp_sterilization_other" class="form-check-input">
          <label for="chk_sterilization_other" class="form-check-label" style="font-size:0.8rem;">조건</label>
        </div>
        <input type="text" name="sterilization_other_detail" class="form-control" placeholder="조건 상세" style="width:120px;" value="{{ form.sterilization_other_detail.value }}">
      </div>
    </div>
  </div>
</div>

<hr class="mb-2">

<!-- 식품유형 요약 -->
<div class="container mb-2">
  <div id="selected-info" style="font-weight:bold; font-size:0.9rem;"></div>
</div>

<!-- 좌: 표시사항(70%), 우: 관련 규정(30%) -->
<div class="container">
  <form method="post" id="labelForm">
    {% csrf_token %}
    <div class="d-flex" style="gap:5px; align-items: stretch;">
      <!-- 좌측 70% 영역: 표시사항 입력 -->
      <div style="flex: 7; padding-right:5px;">

        <!-- (예시) 라벨명 -->
        <div class="d-flex align-items-center mb-1" style="gap:5px;">
          <div style="width:14%; min-width:125px;">
            <input type="checkbox" id="chk_label_nm" name="chk_label_nm" class="form-check-input" {% if form.chk_label_nm.value == "Y" %}checked{% endif %}>
            <label for="chk_label_nm" class="m-0">라벨명</label>
          </div>
          <div style="width:86%;">
            <input type="text" name="label_nm" class="form-control" value="{{ form.label_nm.value }}">
          </div>
        </div>

        <!-- 제품명, 성분명 및 함량 -->
        <div class="d-flex" style="gap:5px;">
          <!-- 제품명 -->
          <div class="d-flex align-items-center" style="flex:1; gap:5px;">
            <div style="width:14%; min-width:125px;">
              <input type="checkbox" id="chk_prdlst_nm" name="chk_prdlst_nm" class="form-check-input" {% if form.chk_prdlst_nm.value == "Y" %}checked{% endif %}>
              <label for="chk_prdlst_nm" class="m-0">제품명</label>
            </div>
            <div style="width:86%;">
              <input type="text" name="prdlst_nm" class="form-control" value="{{ form.prdlst_nm.value }}">
            </div>
          </div>
          <!-- 성분명 및 함량 -->
          <div class="d-flex align-items-center" style="flex:1; gap:5px;">
            <div style="width:14%; min-width:125px;">
              <input type="checkbox" id="chk_ingredients_info" name="chk_ingredients_info" class="form-check-input" {% if form.chk_ingredients_info.value == "Y" %}checked{% endif %}>
              <label for="chk_ingredients_info" class="m-0">성분명 및 함량</label>
            </div>
            <div style="width:86%;">
              <input type="text" name="ingredients_info" class="form-control" value="{{ form.ingredients_info.value }}">
            </div>
          </div>
        </div>

        <!-- 내용량, 내용량(열량) -->
        <div class="d-flex" style="gap:5px;">
          <div class="d-flex align-items-center" style="flex:1; gap:5px;">
            <div style="width:14%; min-width:125px;">
              <input type="checkbox" id="chk_content_qty" name="chk_content_qty" class="form-check-input" {% if form.chk_content_qty.value == "Y" %}checked{% endif %}>
              <label for="chk_content_qty" class="m-0">내용량</label>
            </div>
            <div style="width:86%;">
              <input type="text" name="content_qty" class="form-control" value="{{ form.content_qty.value }}">
            </div>
          </div>
          <div class="d-flex align-items-center" style="flex:1; gap:5px;">
            <div style="width:14%; min-width:125px;">
              <input type="checkbox" id="chk_content_energy" name="chk_content_energy" class="form-check-input" {% if form.chk_content_energy.value == "Y" %}checked{% endif %}>
              <label for="chk_content_energy" class="m-0">내용량(열량)</label>
            </div>
            <div style="width:86%;">
              <input type="text" name="content_energy" class="form-control" value="{{ form.content_energy.value }}">
            </div>
          </div>
        </div>

        <!-- 품목보고번호, 원산지 -->
        <div class="d-flex" style="gap:5px;">
          <div class="d-flex align-items-center" style="flex:1; gap:5px;">
            <div style="width:14%; min-width:125px;">
              <input type="checkbox" id="chk_prdlst_report_no" name="chk_prdlst_report_no" class="form-check-input" {% if form.chk_prdlst_report_no.value == "Y" %}checked{% endif %}>
              <label for="chk_prdlst_report_no" class="m-0">품목보고번호</label>
            </div>
            <div style="width:86%;">
              <input type="text" name="prdlst_report_no" class="form-control" value="{{ form.prdlst_report_no.value }}">
            </div>
          </div>
          <div class="d-flex align-items-center" style="flex:1; gap:5px;">
            <div style="width:14%; min-width:125px;">
              <input type="checkbox" id="chk_country_of_origin" name="chk_country_of_origin" class="form-check-input" {% if form.chk_country_of_origin.value == "Y" %}checked{% endif %}>
              <label for="chk_country_of_origin" class="m-0">원산지</label>
            </div>
            <div style="width:86%;">
              <select name="country_of_origin" class="form-control select2-country">
                <option value="">선택하세요</option>
                {% for c in country_list %}
                <option value="{{ c.country_code2 }}" {% if form.country_of_origin.value == c.country_code2 %}selected{% endif %}>{{ c.country_name_ko }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
        </div>

        <!-- 보관방법, 용기.포장재질 -->
        <div class="d-flex" style="gap:5px;">
          <div class="d-flex align-items-center" style="flex:1; gap:5px;">
            <div style="width:14%; min-width:125px;">
              <input type="checkbox" id="chk_storage_method" name="chk_storage_method" class="form-check-input" {% if form.chk_storage_method.value == "Y" %}checked{% endif %}>
              <label for="chk_storage_method" class="m-0">보관방법</label>
            </div>
            <div style="width:86%;">
              <input type="text" name="storage_method" class="form-control" value="{{ form.storage_method.value }}">
            </div>
          </div>
          <div class="d-flex align-items-center" style="flex:1; gap:5px;">
            <div style="width:14%; min-width:125px;">
              <input type="checkbox" id="chk_packaging_material" name="chk_packaging_material" class="form-check-input" {% if form.chk_packaging_material.value == "Y" %}checked{% endif %}>
              <label for="chk_packaging_material" class="m-0">용기.포장재질</label>
            </div>
            <div style="width:86%;">
              <input type="text" name="packaging_material" class="form-control" value="{{ form.packaging_material.value }}">
            </div>
          </div>
        </div>

        <!-- 제조원 및 소재지 -->
        <div class="d-flex align-items-center mb-1" style="gap:5px;">
          <div style="width:14%; min-width:80px;">
            <input type="checkbox" id="chk_manufacturer_info" name="chk_manufacturer_info" class="form-check-input" {% if form.chk_manufacturer_info.value == "Y" %}checked{% endif %}>
            <label for="chk_manufacturer_info" class="m-0">제조원 및 소재지</label>
          </div>
          <div style="width:86%;">
            <input type="text" name="manufacturer_info" class="form-control" value="{{ form.manufacturer_info.value }}">
          </div>
        </div>
        
        <!-- 유통전문판매원/소분원/수입원 -->
        <div class="d-flex align-items-center mb-1" style="gap:5px;">
          <div style="width:14%; min-width:80px;">
            <input type="checkbox" id="chk_distribution" name="chk_distribution" class="form-check-input" {% if form.chk_distribution.value == "Y" %}checked{% endif %}>
            <label for="chk_distribution" class="m-0">제조원 외</label>
          </div>
          <div style="width:86%;">
            <div class="d-flex" style="gap:5px;">
              <select name="distribution_option" class="form-control" style="width:25%;">
                <option value="유통전문판매원 및 소재지" {% if form.distribution_option.value == "유통전문판매원 및 소재지" or not form.distribution_option.value %}selected{% endif %}>유통전문판매원 및 소재지</option>
                <option value="소분원 및 소재지" {% if form.distribution_option.value == "소분원 및 소재지" %}selected{% endif %}>소분원 및 소재지</option>
                <option value="수입원 및 소재지" {% if form.distribution_option.value == "수입원 및 소재지" %}selected{% endif %}>수입원 및 소재지</option>
              </select>
              <input type="text" name="distribution_info" class="form-control" style="width:80%;" value="{{ form.distribution_info.value }}">
            </div>
          </div>
        </div>
        
        <!-- 소비기한/품질유지기한/제조연월일/생산연도 -->
        <div class="d-flex align-items-center mb-1" style="gap:5px;">
          <div style="width:14%; min-width:80px;">
            <input type="checkbox" id="chk_date_info" name="chk_date_info" class="form-check-input" {% if form.chk_date_info.value == "Y" %}checked{% endif %}>
            <label for="chk_date_info" class="m-0">소비기한</label>
          </div>
          <div style="width:86%;">
            <div class="d-flex" style="gap:5px;">
              <select name="date_option" class="form-control" style="width:25%;">
                <option value="소비기한" {% if form.date_option.value == "소비기한" or not form.date_option.value %}selected{% endif %}>소비기한</option>
                <option value="품질유지기한" {% if form.date_option.value == "품질유지기한" %}selected{% endif %}>품질유지기한</option>
                <option value="제조연월일" {% if form.date_option.value == "제조연월일" %}selected{% endif %}>제조연월일</option>
                <option value="생산연도" {% if form.date_option.value == "생산연도" %}selected{% endif %}>생산연도</option>
              </select>
              <input type="text" name="date_info_text" class="form-control" style="width:80%;" value="{{ form.date_info_text.value }}">
            </div>
          </div>
        </div>
        
        <!-- 원재료명 -->
        <div class="d-flex align-items-center mb-1" style="gap:5px;">
          <div style="width:14%; min-width:80px;">
            <input type="checkbox" id="chk_rawmtrl_nm" name="chk_rawmtrl_nm" class="form-check-input" {% if form.chk_rawmtrl_nm.value == "Y" %}checked{% endif %}>
            <label for="chk_rawmtrl_nm" class="m-0">원재료명</label>
          </div>
          <div style="width:86%; display: flex; gap:5px; align-items: center;">
            <textarea name="rawmtrl_nm" class="form-control" style="flex:1;" placeholder="원재료명을 입력하세요" {% if disable_rawmtrl %}disabled{% endif %}>{{ form.rawmtrl_nm.value|default:'' }}</textarea>
            <button type="button" class="btn btn-secondary btn-sm" onclick="openIngredientPopup()">상세보기</button>
          </div>
        </div>
        
        <!-- 주의사항 -->
        <div class="d-flex align-items-center mb-1" style="gap:5px;">
          <div style="width:14%; min-width:80px;">
            <input type="checkbox" id="chk_cautions" name="chk_cautions" class="form-check-input" {% if form.chk_cautions.value == "Y" %}checked{% endif %}>
            <label for="chk_cautions" class="m-0">주의사항</label>
          </div>
          <div style="width:86%;">
            <textarea name="cautions" rows="2" class="auto-expand form-control" placeholder="주의사항을 입력하세요">{{ form.cautions.value }}</textarea>
          </div>
        </div>
        
        <!-- 기타 표시사항 -->
        <div class="d-flex align-items-center mb-1" style="gap:5px;">
          <div style="width:14%; min-width:80px;">
            <input type="checkbox" id="chk_additional_info" name="chk_additional_info" class="form-check-input" {% if form.chk_additional_info.value == "Y" %}checked{% endif %}>
            <label for="chk_additional_info" class="m-0">기타 표시사항</label>
          </div>
          <div style="width:86%;">
            <textarea name="additional_info" rows="2" class="auto-expand form-control" placeholder="기타 표시사항을 입력하세요">{{ form.additional_info.value }}</textarea>
          </div>
        </div>

        <!-- 영양성분 -->
        <div class="d-flex align-items-center mb-1" style="gap:5px;">
          <div style="width:14%; min-width:125px;">
            <input type="checkbox" id="chk_nutri_input" name="chk_nutri_input" class="form-check-input" {% if form.chk_nutri_input.value == "Y" %}checked{% endif %}>
            <label for="chk_nutri_input" class="m-0">영양성분</label>
          </div>
          <!-- 표 + 계산하기 버튼 (한 줄) -->
          <div style="width:86%; display: flex; gap:5px; align-items: flex-start;">
            <table class="table table-bordered table-sm mb-2" style="font-size:0.75rem; table-layout: fixed; flex:1;">
              <tbody>
                <tr>
                  <th style="width:6%;">항목</th>
                  <td style="width:10%;">칼로리</td>
                  <td style="width:10%;">나트륨</td>
                  <td style="width:10%;">탄수화물</td>
                  <td style="width:10%;">당류</td>
                  <td style="width:10%;">지방</td>
                  <td style="width:10%;">트랜스지방</td>
                  <td style="width:10%;">포화지방</td>
                  <td style="width:10%;">콜레스테롤</td>
                  <td style="width:10%;">단백질</td>
                </tr>
                <tr>
                  <th>입력</th>
                  <td><input type="number" id="calorie" class="form-control form-control-sm" step="any"></td>
                  <td><input type="number" id="natrium" class="form-control form-control-sm" step="any"></td>
                  <td><input type="number" id="carbohydrate" class="form-control form-control-sm" step="any"></td>
                  <td><input type="number" id="sugar" class="form-control form-control-sm" step="any"></td>
                  <td><input type="number" id="afat" class="form-control form-control-sm" step="any"></td>
                  <td><input type="number" id="transfat" class="form-control form-control-sm" step="any"></td>
                  <td><input type="number" id="satufat" class="form-control form-control-sm" step="any"></td>
                  <td><input type="number" id="cholesterol" class="form-control form-control-sm" step="any"></td>
                  <td><input type="number" id="protein" class="form-control form-control-sm" step="any"></td>
                </tr>
                <tr>
                  <th>표시</th>
                  <td id="result_calorie"></td>
                  <td id="result_natrium"></td>
                  <td id="result_carbohydrate"></td>
                  <td id="result_sugar"></td>
                  <td id="result_afat"></td>
                  <td id="result_transfat"></td>
                  <td id="result_satufat"></td>
                  <td id="result_cholesterol"></td>
                  <td id="result_protein"></td>
                </tr>
              </tbody>
            </table>
            <!-- 계산하기 버튼 -->
            <button type="button" class="btn btn-secondary btn-sm" onclick="runNutritionCalculator()">계산하기</button>
          </div>
        </div>
      </div>

      <!-- 우측 30% 영역: 관련 규정 -->
      <div style="flex: 3; padding-left:5px; display: flex; flex-direction: column;">
         <label class="m-0">관련 규정(표시기준 등)</label>
         <textarea name="related_regulations" class="form-control" style="flex:1;" placeholder="각 항목에 대한 관련 규정을 입력하세요"></textarea>
      </div>
    </div>
  </form>
</div>

<!-- 스타일 -->
<style>
label, .form-control {
  font-size: 0.8rem !important;
  color: #495057 !important;
}
/* Select2 기본 스타일 */
.select2-container--default .select2-selection--single {
  height: auto !important;
  font-size: 0.8rem !important;
  color: #495057 !important;
  border: 1px solid #ced4da !important;
  border-radius: 0.25rem !important;
  padding: 0.3rem 0.6rem !important;
}
.select2-selection__rendered {
  line-height: 1.5 !important;
}
/* 숫자 입력 필드 스피너 제거 */
input[type=number]::-webkit-inner-spin-button,
input[type=number]::-webkit-outer-spin-button {
  -webkit-appearance: none;
  margin: 0;
}
input[type=number] {
  -moz-appearance: textfield;
}
/* 표 셀 패딩 최소화 */
.table-bordered td, .table-bordered th {
  padding: 0.2rem;
}
.disabled-textarea {
  background-color: #e9ecef;
  cursor: not-allowed;
}
.detail-btn {
  font-size: 0.75rem;
  padding: 4px 6px;
}
</style>
{% endblock %}
