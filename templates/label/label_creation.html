{% extends 'base.html' %}
{% load static %}

{% block title %}í‘œì‹œì‚¬í•­ ì‘ì„±{% endblock %}

{% block content %}
<!-- jQuery & Select2 -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
function initCheckBoxGroups() {
  // ì¥ê¸°ë³´ì¡´ì‹í’ˆ ê·¸ë£¹: 1ê°œë§Œ ì„ íƒ
  $('.grp-long-shelf').on('change', function(e) {
    if (this.checked) {
      $('.grp-long-shelf').not(this).prop('checked', false).data('alreadyChecked', false);
      $(this).data('alreadyChecked', true);
    } else {
      $(this).data('alreadyChecked', false);
    }
    updateSummary(); // ìš”ì•½ ê°±ì‹ 
  });

  // ì œì¡°ë°©ë²• ê·¸ë£¹: 1ê°œë§Œ ì„ íƒ (ì¡°ê±´ ì œì™¸)
  $('.grp-sterilization').on('change', function(e) {
    if (this.id === "chk_sterilization_other") return;

    if (this.checked) {
      $('.grp-sterilization').not('#chk_sterilization_other').not(this)
        .prop('checked', false).data('alreadyChecked', false);
      $(this).data('alreadyChecked', true);
    } else {
      $(this).data('alreadyChecked', false);
    }

    // ì¡°ê±´ ì²´í¬ë°•ìŠ¤ í™œì„±í™” ì—¬ë¶€
    if ($("#chk_sanitized").is(":checked") || $("#chk_aseptic").is(":checked")) {
      $("#chk_sterilization_other").prop("disabled", false);
    } else {
      $("#chk_sterilization_other").prop("disabled", true).prop("checked", false);
    }
    updateSummary(); // ìš”ì•½ ê°±ì‹ 
  });
}

function initSingleSelectGroup(selector, exceptionId = null) {
    $(selector).on('click', function (e) {
        if (this.id === exceptionId) return;
        const alreadyChecked = $(this).data('alreadyChecked') || false;
        if (alreadyChecked) {
            $(this).prop('checked', false).data('alreadyChecked', false);
        } else {
            $(selector).not(this).prop('checked', false).data('alreadyChecked', false);
            $(this).prop('checked', true).data('alreadyChecked', true);
        }
        e.stopPropagation();
    });
}

function getCheckedLabel(selector) {
  const checked = $(selector).filter(':checked');
  if (checked.length) {
      const id = checked.attr('id');
      const label = $(`label[for="${id}"]`).text();
      return label || null;
  }
  return null;
}

// ------------------ ì‹í’ˆìœ í˜• ìš”ì•½ ì—…ë°ì´íŠ¸ ------------------
function updateSummary() {
  const summaries = [];

  // ì†Œë¶„ë¥˜
  const foodSmall = $('#food_type_small option:selected').text();
  if (foodSmall && foodSmall !== "ì†Œë¶„ë¥˜") summaries.push(foodSmall);

  // ì¥ê¸°ë³´ì¡´ì‹í’ˆ ë³€í™˜ ì²˜ë¦¬
  const longShelfId = $('.grp-long-shelf:checked').attr('id');
  let isFrozenHeated = false;
  if (longShelfId === "chk_frozen_heated") {
      summaries.push("ê°€ì—´í•˜ì—¬ ì„­ì·¨í•˜ëŠ” ëƒ‰ë™ì‹í’ˆ");
      isFrozenHeated = true;
  } else if (longShelfId === "chk_frozen_nonheated") {
      summaries.push("ê°€ì—´í•˜ì§€ ì•Šê³  ì„­ì·¨í•˜ëŠ” ëƒ‰ë™ì‹í’ˆ");
  } else if (longShelfId === "chk_retort") {
      summaries.push("ë ˆí† ë¥´íŠ¸ì‹í’ˆ");
  } else {
      const longShelfLabel = getCheckedLabel('.grp-long-shelf');
      if (longShelfLabel) summaries.push(longShelfLabel);
  }

  // ì œì¡°ë°©ë²• ì²´í¬ í•­ëª© í™•ì¸ ë° ë³€í™˜
  const methodLabels = {
      "chk_sanitized": "ì‚´ê· ì œí’ˆ",
      "chk_aseptic": "ë©¸ê· ì œí’ˆ",
      "chk_yutang": "ìœ íƒ•.ìœ ì²˜ë¦¬ì œí’ˆ"
  };

  let methodChecked = false;

  $(".grp-sterilization:checked").each(function () {
      const methodId = $(this).attr("id");
      if (methodLabels[methodId]) {
          summaries.push(methodLabels[methodId]);
          methodChecked = true;
      }
  });

  // ì¡°ê±´ ìƒì„¸
  const manufacturingOther = $("input[name='sterilization_other_detail']").val();
  if (manufacturingOther) summaries.push(manufacturingOther);

  // âœ… ë³€ê²½ëœ ì¡°ê±´: ê°€ì—´í•˜ì—¬ ì„­ì·¨í•˜ëŠ” ëƒ‰ë™ì‹í’ˆ + ì œì¡°ë°©ë²• ëª¨ë‘ ë¯¸ì²´í¬ => ë¹„ì‚´ê· ì œí’ˆ
  if (isFrozenHeated && !methodChecked) {
      summaries.push("ë¹„ì‚´ê· ì œí’ˆ");
  }

  $('#selected-info').text("ì‹í’ˆìœ í˜• : " + summaries.join(" | "));
}

// ------------------ ì˜ì–‘ì„±ë¶„ ê³„ì‚° ë¡œì§ ------------------
function roundXdigit(value, step, unit, min=0, lmin=0) {
  if (value < min) return "0";
  if (value < lmin) return lmin + unit + " ì´í•˜";

  let remainder = value % step;
  let result = remainder <= step/2 ? value - remainder : value - remainder + step;
  result = step >= 1 ? parseInt(result) : parseFloat(result.toFixed(1));
  return result + unit;
}

function divideroundXdigit(mid, value, step1, step2, unit, min=0, lmin=0) {
  return (value <= mid)
    ? roundXdigit(value, step1, unit, min, lmin)
    : roundXdigit(value, step2, unit, min, lmin);
}

function percentcalculate(value, limit) {
  return Math.round((value / limit) * 100);
}

function runNutritionCalculator() {
    const fields = [
        { id: "calorie", unit: "kcal", step: 5 },
        { id: "natrium", unit: "mg", step: 5, limit: 2000 },
        { id: "sugar", unit: "g", step: 0.5, limit: 100 },
        { id: "carbohydrate", unit: "g", step: 0.5, limit: 324 },
        { id: "afat", unit: "g", step: 0.1, limit: 54 },
        { id: "transfat", unit: "g", step: 0.1 },
        { id: "satufat", unit: "g", step: 0.1, limit: 15 },
        { id: "cholesterol", unit: "mg", step: 5, limit: 300 },
        { id: "protein", unit: "g", step: 0.5, limit: 55 },
    ];

    fields.forEach(field => {
        const value = parseFloat(document.getElementById(field.id).value || "0");
        const result = field.limit
            ? `${roundXdigit(value, field.step, field.unit)} (${percentcalculate(value, field.limit)}%)`
            : roundXdigit(value, field.step, field.unit);
        document.getElementById(`result_${field.id}`).innerText = result;
    });
}

// ------------------ íŒì—… ë¡œì§ ------------------
function handleIngredientPopup() {
  // íŒì—… ì—´ê¸°
  openIngredientPopup();

  // ì›ì¬ë£Œëª…(ì°¸ê³ ) ì„¹ì…˜ í‘œì‹œ
  const rawmtrlSection = document.getElementById('rawmtrl_nm_section');
  if (rawmtrlSection.classList.contains('collapse')) {
    rawmtrlSection.classList.add('show'); // í¼ì¹˜ê¸°
  }
}

function openIngredientPopup() {
  const rawmtrlNmDisplay = document.querySelector('textarea[name="rawmtrl_nm_display"]').value || "";
  const labelId = '{{ label.my_label_id }}';
  const url = `/label/ingredient-popup/?rawmtrl_nm_display=${encodeURIComponent(rawmtrlNmDisplay)}&label_id=${labelId}`;
  window.open(url, 'IngredientPopup', 'width=1400,height=850,scrollbars=yes');
}

function openPreviewPopup() {
  const labelId = "{{ label.my_label_id }}";
  if (!labelId) {
    alert("ë¼ë²¨ì´ ì €ì¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
    return;
  }
  // ì„ íƒëœ ì²´í¬ë°•ìŠ¤ë§Œ ì¿¼ë¦¬ìŠ¤íŠ¸ë§ì— ë°˜ì˜
  const checkedFields = document.querySelectorAll("input[type='checkbox']:checked");
  let queryString = new URLSearchParams();
  checkedFields.forEach((chk) => {
    queryString.append(chk.name, "true");
  });
  const previewUrl = `/label/preview/?label_id=${labelId}&${queryString.toString()}`;
  window.open(previewUrl, 'previewPopup', 'width=1400,height=850,scrollbars=yes');
}

// ------------------ Document Ready ------------------
$(document).ready(function() {
  // Select2 ì´ˆê¸°í™”
  // ì²´í¬ë°•ìŠ¤ ê·¸ë£¹ ì´ˆê¸°í™”
  initCheckBoxGroups();
  // ìš”ì•½ ì—…ë°ì´íŠ¸
  updateSummary();
  $('.select2-food-type, input[type="checkbox"], input[name="sterilization_other_detail"]')
    .on('change input', updateSummary);
});

</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const toggleBtn = document.getElementById("toggleFoodTypeBtn");
    const section = document.getElementById("food-type-section");
  
    toggleBtn.addEventListener("click", function () {
      const isHidden = section.style.display === "none";
      section.style.display = isHidden ? "block" : "none";
      toggleBtn.innerText = isHidden ? "â–²" : "â–¼";
      toggleBtn.setAttribute("title", isHidden ? "ì ‘ê¸°" : "í¼ì¹˜ê¸°");
    });

    // âœ… ìˆ˜ì •: ì²´í¬ë°•ìŠ¤ ì´ˆê¸°í™” ë° ìš”ì•½ ì—…ë°ì´íŠ¸ í•œ ê³³ì—ì„œ ì²˜ë¦¬
    updateSummary();

    // âœ… ì´ë²¤íŠ¸ ë°”ì¸ë”© í†µí•©
    $('.select2-food-type').on('change', updateSummary);
    $('.grp-long-shelf, .grp-sterilization, #chk_sterilization_other').on('change', updateSummary);
    $('input[name="sterilization_other_detail"]').on('input', updateSummary);
  });

  document.addEventListener("DOMContentLoaded", function () {
    const regulationPanel = document.getElementById("regulationPanel");
    const toggleRegulationBtn = document.getElementById("toggleRegulationBtn");
  
    toggleRegulationBtn.addEventListener("click", function () {
      regulationPanel.classList.toggle("collapsed");
      toggleRegulationBtn.innerText = "ã€“";
    });
  });
  
</script>

<!-- ìƒë‹¨ í—¤ë” -->
<div class="container mt-4" style="padding-bottom: 10px;">
  <div class="d-flex align-items-center justify-content-between" style="gap: 20px;">
    <h2 class="mb-0">í‘œì‹œì‚¬í•­ ì‘ì„±</h2>
    <div class="d-flex align-items-center" style="gap: 20px;">
      <span class="recent-update">ìµœê·¼ ìˆ˜ì •ì¼: {{ label.update_datetime|date:"Y-m-d H:i" }}</span>
      <button type="submit" form="labelForm" class="btn btn-primary">ì €ì¥</button>
      <button type="button" class="btn btn-default preview-btn" onclick="openPreviewPopup()">ë¯¸ë¦¬ë³´ê¸°</button>
    </div>
  </div>
</div>

<!-- ì‹í’ˆìœ í˜•/ì¥ê¸°ë³´ì¡´/ì œì¡°ë°©ë²• ì„ íƒ ì˜ì—­ -->
<div id="food-type-section" class="container mb-2">
  <div class="d-flex align-items-center" style="gap:20px; width:100%;">
    <!-- ì‹í’ˆìœ í˜• -->
    <div class="selectable-item" style="flex:1; max-width:30%;">
      <label class="form-label" style="font-size:0.8rem; font-weight:bold;">ì‹í’ˆìœ í˜•</label>
      <div class="d-flex" style="gap:5px; width:100%;">
        <select id="food_type_large" name="food_type_large" class="form-control select2-food-type" style="width:50%;">
           <option value="">ëŒ€ë¶„ë¥˜</option>
           {% for lt in large_food_types %}
           <option value="{{ lt }}" {% if form.food_type_large.value == lt %}selected{% endif %}>{{ lt }}</option>
           {% endfor %}
        </select>
        <select id="food_type_small" name="prdlst_dcnm" class="form-control select2-food-type" style="width:50%;">
           <option value="">ì†Œë¶„ë¥˜</option>
           {% for t in food_types %}
           <option value="{{ t }}" {% if form.prdlst_dcnm.value == t %}selected{% endif %}>{{ t }}</option>
           {% endfor %}
        </select>
      </div>
    </div>
    
    <!-- ì¥ê¸°ë³´ì¡´ì‹í’ˆ -->
    <div style="flex:1; max-width:30%; display: flex; flex-direction: column; align-items: flex-start;">
      <div style="display: flex; align-items: center; margin-left: 10;">
         <input type="checkbox" id="dummy_long_shelf" style="visibility:hidden; width:18px; margin-right:5px;">
         <label class="form-label" style="font-size:0.8rem; font-weight:bold; margin:0;">ì¥ê¸°ë³´ì¡´ì‹í’ˆ</label>
      </div>
      <div class="d-flex" style="gap:10px; flex-wrap: nowrap; width:100%;">
        <div class="form-check" style="margin:0;">
          <input type="checkbox" id="chk_frozen_heated" name="chk_long_shelf" class="form-check-input grp-long-shelf">
          <label for="chk_frozen_heated" class="form-check-label" style="font-size:0.8rem;">ëƒ‰ë™(ê°€ì—´)</label>
        </div>
        <div class="form-check" style="margin:0;">
          <input type="checkbox" id="chk_frozen_nonheated" name="chk_long_shelf" class="form-check-input grp-long-shelf">
          <label for="chk_frozen_nonheated" class="form-check-label" style="font-size:0.8rem;">ëƒ‰ë™(ë¹„ê°€ì—´)</label>
        </div>
        <div class="form-check" style="margin:0;">
          <input type="checkbox" id="chk_canned" name="chk_long_shelf" class="form-check-input grp-long-shelf">
          <label for="chk_canned" class="form-check-label" style="font-size:0.8rem;">í†µ.ë³‘ì¡°ë¦¼</label>
        </div>
        <div class="form-check" style="margin:0;">
          <input type="checkbox" id="chk_retort" name="chk_long_shelf" class="form-check-input grp-long-shelf">
          <label for="chk_retort" class="form-check-label" style="font-size:0.8rem;">ë ˆí† ë¥´íŠ¸</label>
        </div>
      </div>
    </div>

    <!-- ì œì¡°ë°©ë²• -->
    <div style="flex:1; max-width:33%; display: flex; flex-direction: column; align-items: flex-start;">
      <div style="display: flex; align-items: center; margin-left: 0;">
         <input type="checkbox" id="dummy_manufacturing" style="visibility:hidden; width:18px; margin-right:5px;">
         <label class="form-label" style="font-size:0.8rem; font-weight:bold; margin:0;">ì œì¡°ë°©ë²•</label>
      </div>
      <div class="d-flex" style="gap:10px; flex-wrap: nowrap; width:100%;">
        <div class="form-check" style="margin:0;">
          <input type="checkbox" id="chk_sanitized" name="grp_sterilization" class="form-check-input grp-sterilization">
          <label for="chk_sanitized" class="form-check-label" style="font-size:0.8rem;">ì‚´ê· </label>
        </div>
        <div class="form-check" style="margin:0;">
          <input type="checkbox" id="chk_aseptic" name="grp_sterilization" class="form-check-input grp-sterilization">
          <label for="chk_aseptic" class="form-check-label" style="font-size:0.8rem;">ë©¸ê· </label>
        </div>
        <div class="form-check" style="margin:0;">
          <input type="checkbox" id="chk_yutang" name="grp_sterilization" class="form-check-input grp-sterilization">
          <label for="chk_yutang" class="form-check-label" style="font-size:0.8rem;">ìœ íƒ•/ìœ ì²˜ë¦¬</label>
        </div>
        <div class="form-check" style="margin:0;">
          <input type="checkbox" id="chk_sterilization_other" name="grp_sterilization_other" class="form-check-input">
          <label for="chk_sterilization_other" class="form-check-label" style="font-size:0.8rem;">ì¡°ê±´</label>
        </div>
        <input type="text" name="sterilization_other_detail" class="form-control" placeholder="ì¡°ê±´ ìƒì„¸" style="width:120px;" value="{{ form.sterilization_other_detail.value }}">
      </div>
    </div>
  </div>
</div>

<hr class="mb-2">

<!-- ì‹í’ˆìœ í˜• ìš”ì•½ -->
<div class="container mb-2 d-flex justify-content-between align-items-center">
  <div class="d-flex align-items-center" style="gap: 5px;">
    <button id="toggleFoodTypeBtn" class="btn btn-sm btn-outline-secondary" type="button" title="ì ‘ê¸°">â–²</button>
    <div id="selected-info" style="font-weight:bold; font-size:0.9rem;">ì‹í’ˆìœ í˜• :</div>
  </div>
  <!-- ì ‘ê¸° ë²„íŠ¼: ì¢Œì¸¡ íŒ¨ë„ì˜ ìƒë‹¨ì— ìœ„ì¹˜ -->
  <button id="toggleRegulationBtn" class="btn btn-sm btn-outline-secondary" type="button"
  title="ì ‘ê¸°/í¼ì¹˜ê¸°" style="font-size: 1rem; padding: 1px 6px;">
  ã€“
  </button>
</div>

<!-- ë³¸ë¬¸ ì¢Œìš° íŒ¨ë„ ì˜ì—­ -->
<div class="container">
  <div class="layout-container" style="display: flex; gap: 20px; align-items: flex-start;">
    <!-- ì¢Œì¸¡: ì…ë ¥ íŒ¨ë„ -->
    <div class="left-panel flex-grow-1 position-relative" style="flex-basis: 70%;">
      <form method="post" id="labelForm">
        {% csrf_token %}

      <!-- ë¼ë²¨ëª… + ì‹í’ˆìœ í˜• í•œ ì¤„ êµ¬ì„± -->
      <div class="d-flex align-items-center mb-2" style="gap:5px;">
        <!-- ë¼ë²¨ëª… -->
        <div class="d-flex align-items-center" style="flex:1; gap:5px;">
          <div style="width:10%; min-width:110px;">
            <input type="checkbox" id="chk_label_nm" name="chk_label_nm" class="form-check-input" {% if form.chk_label_nm.value == "Y" %}checked{% endif %}>
            <label for="chk_label_nm" class="m-0">ë¼ë²¨ëª…</label>

          </div>
          <div style="width:5%;"></div> <!-- ë²„íŠ¼ ì˜ì—­ (ë¹„ì–´ ìˆìŒ) -->
          <div style="width:85%;">
            <input type="text" name="label_nm" class="form-control" value="{{ form.label_nm.value }}">
          </div>
        </div>
        <!-- ì‹í’ˆìœ í˜• -->
        <div class="d-flex align-items-center" style="flex:1; gap:5px;">
          <div style="width:10%; min-width:110px;">
            <input type="checkbox" id="chk_prdlst_dcnm" name="chk_prdlst_dcnm" class="form-check-input" {% if form.chk_prdlst_dcnm.value == "Y" %}checked{% endif %}>
          <label for="chk_prdlst_dcnm" class="m-0">ì‹í’ˆìœ í˜•</label>
          </div>
          <div style="width:5%;"></div> <!-- ë²„íŠ¼ ì˜ì—­ (ë¹„ì–´ ìˆìŒ) -->
          <div style="width:85%;">
            <input type="text" name="prdlst_dcnm" class="form-control" value="{{ form.prdlst_dcnm.value }}">
          </div>
        </div>
      </div>

      <!-- ì œí’ˆëª…, ì„±ë¶„ëª… ë° í•¨ëŸ‰ -->
      <div class="d-flex align-items-center mb-2" style="gap:5px;">
        <!-- ì œí’ˆëª… -->
        <div class="d-flex align-items-center" style="flex:1; gap:5px;">
          <div style="width:10%; min-width:110px;">
            <input type="checkbox" id="chk_prdlst_nm" name="chk_prdlst_nm" class="form-check-input" {% if form.chk_prdlst_nm.value == "Y" %}checked{% endif %}>
          <label for="chk_prdlst_nm" class="m-0">ì œí’ˆëª…</label>
          </div>
          <div style="width:5%;"></div> <!-- ë²„íŠ¼ ì˜ì—­ (ë¹„ì–´ ìˆìŒ) -->
          <div style="width:85%;">
            <input type="text" name="prdlst_nm" class="form-control" value="{{ form.prdlst_nm.value }}">
          </div>
        </div>
        <!-- ì„±ë¶„ëª… ë° í•¨ëŸ‰ -->
        <div class="d-flex align-items-center" style="flex:1; gap:5px;">
          <div style="width:10%; min-width:110px;">
            <input type="checkbox" id="chk_ingredients_info" name="chk_ingredients_info" class="form-check-input" {% if form.chk_ingredients_info.value == "Y" %}checked{% endif %}>
          <label for="chk_ingredients_info" class="m-0">ì„±ë¶„ëª… ë° í•¨ëŸ‰</label>
          </div>
          <div style="width:5%;"></div> <!-- ë²„íŠ¼ ì˜ì—­ (ë¹„ì–´ ìˆìŒ) -->
          <div style="width:85%;">
            <input type="text" name="ingredients_info" class="form-control" value="{{ form.ingredients_info.value }}">
          </div>
        </div>
      </div>

      <!-- ë‚´ìš©ëŸ‰, ë‚´ìš©ëŸ‰(ì—´ëŸ‰) -->
      <div class="d-flex align-items-center mb-2" style="gap:5px;">
        <!-- ë‚´ìš©ëŸ‰ -->
        <div class="d-flex align-items-center" style="flex:1; gap:5px;">
          <div style="width:10%; min-width:110px;">
            <input type="checkbox" id="chk_content_weight" name="chk_content_weight" class="form-check-input" {% if form.chk_content_weight.value == "Y" %}checked{% endif %}>
            <label for="chk_content_weight" class="m-0">ë‚´ìš©ëŸ‰</label>
          </div>
          <div style="width:5%;"></div> <!-- ë²„íŠ¼ ì˜ì—­ (ë¹„ì–´ ìˆìŒ) -->
          <div style="width:85%;">
            <input type="text" name="content_weight" class="form-control" value="{{ form.content_weight.value }}">
          </div>
        </div>
        <!-- ë‚´ìš©ëŸ‰(ì—´ëŸ‰) -->
        <div class="d-flex align-items-center" style="flex:1; gap:5px;">
          <div style="width:10%; min-width:110px;">
            <input type="checkbox" id="chk_weight_calorie" name="chk_weight_calorie" class="form-check-input" {% if form.chk_weight_calorie.value == "Y" %}checked{% endif %}>
            <label for="chk_weight_calorie" class="m-0">ë‚´ìš©ëŸ‰(ì—´ëŸ‰)</label>
          </div>
          <div style="width:5%;"></div> <!-- ë²„íŠ¼ ì˜ì—­ (ë¹„ì–´ ìˆìŒ) -->
          <div style="width:85%;">
            <input type="text" name="weight_calorie" class="form-control" value="{{ form.weight_calorie.value }}">
          </div>
        </div>
      </div>

      <!-- í’ˆëª©ë³´ê³ ë²ˆí˜¸, ì›ì‚°ì§€ -->
      <div class="d-flex align-items-center mb-2" style="gap:5px;">
        <!-- í’ˆëª©ë³´ê³ ë²ˆí˜¸ -->
        <div class="d-flex align-items-center" style="flex:1; gap:5px;">
          <div style="width:10%; min-width:110px;">
            <input type="checkbox" id="chk_prdlst_report_no" name="chk_prdlst_report_no" class="form-check-input" {% if form.chk_prdlst_report_no.value == "Y" %}checked{% endif %}>
            <label for="chk_prdlst_report_no" class="m-0">í’ˆëª©ë³´ê³ ë²ˆí˜¸</label>
          </div>
          <div style="width:5%;"></div> <!-- ë²„íŠ¼ ì˜ì—­ (ë¹„ì–´ ìˆìŒ) -->
          <div style="width:85%;">
            <input type="text" name="prdlst_report_no" class="form-control" value="{{ form.prdlst_report_no.value }}">
          </div>
        </div>
        <!-- ì›ì‚°ì§€ -->
        <div class="d-flex align-items-center" style="flex:1; gap:5px;">
          <div style="width:10%; min-width:110px;">
            <input type="checkbox" id="chk_country_of_origin" name="chk_country_of_origin" class="form-check-input" {% if form.chk_country_of_origin.value == "Y" %}checked{% endif %}>
            <label for="chk_country_of_origin" class="m-0">ì›ì‚°ì§€</label>
          </div>
          <div style="width:5%;"></div> <!-- ë²„íŠ¼ ì˜ì—­ (ë¹„ì–´ ìˆìŒ) -->
          <div style="width:85%;">
            <select name="country_of_origin" class="form-control select2-country">
              <option value="">ì„ íƒí•˜ì„¸ìš”</option>
              {% for c in country_list %}
              <option value="{{ c.country_code2 }}" {% if form.country_of_origin.value == c.country_code2 %}selected{% endif %}>{{ c.country_name_ko }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
      </div>

      <!-- ë³´ê´€ë°©ë²•, ìš©ê¸°.í¬ì¥ì¬ì§ˆ -->
      <div class="d-flex align-items-center mb-2" style="gap:5px;">
        <!-- ë³´ê´€ë°©ë²• -->
        <div class="d-flex align-items-center" style="flex:1; gap:5px;">
          <div style="width:10%; min-width:110px;">
            <input type="checkbox" id="chk_storage_method" name="chk_storage_method" class="form-check-input" {% if form.chk_storage_method.value == "Y" %}checked{% endif %}>
            <label for="chk_storage_method" class="m-0">ë³´ê´€ë°©ë²•</label>
          </div>
          <div style="width:5%;"></div> <!-- ë²„íŠ¼ ì˜ì—­ (ë¹„ì–´ ìˆìŒ) -->
          <div style="width:85%;">
            <input type="text" name="storage_method" class="form-control" value="{{ form.storage_method.value }}">
          </div>
        </div>
        <!-- ìš©ê¸°.í¬ì¥ì¬ì§ˆ -->
        <div class="d-flex align-items-center" style="flex:1; gap:5px;">
          <div style="width:10%; min-width:110px;">
            <input type="checkbox" id="chk_frmlc_mtrqlt" name="chk_frmlc_mtrqlt" class="form-check-input" {% if form.chk_frmlc_mtrqlt.value == "Y" %}checked{% endif %}>
            <label for="chk_frmlc_mtrqlt" class="m-0">ìš©ê¸°.í¬ì¥ì¬ì§ˆ</label>
          </div>
          <div style="width:5%;"></div> <!-- ë²„íŠ¼ ì˜ì—­ (ë¹„ì–´ ìˆìŒ) -->
          <div style="width:85%;">
            <input type="text" name="frmlc_mtrqlt" class="form-control" value="{{ form.frmlc_mtrqlt.value }}">
          </div>
        </div>
      </div>

      <!-- ì œì¡°ì› ì†Œì¬ì§€ ì…ë ¥ + í¼ì¹˜ê¸° ë²„íŠ¼ -->
      <div class="d-flex align-items-center mb-2" style="gap:5px;">
        <div style="width:9.6%; min-width:110px;">
          <div class="form-check">
            <input type="checkbox" id="chk_bssh_nm" name="chk_bssh_nm" class="form-check-input" {% if form.chk_bssh_nm.value == "Y" %}checked{% endif %}>
            <label for="chk_bssh_nm" class="m-0">ì œì¡°ì› ì†Œì¬ì§€</label>
          </div>
        </div>
        <!-- í¼ì¹˜ê¸°/ì ‘ê¸° ë²„íŠ¼ -->
        <div style="min-width:1px;">
        <button type="button" class="btn btn-outline-secondary" id="toggleManufacturerBtn" data-bs-toggle="collapse" data-bs-target="#other-manufacturers" aria-expanded="false" aria-controls="other-manufacturers" style="font-size: 0.9rem; padding: 1px 1px;" title="í¼ì¹˜ê¸°">â–¼</button>
        </div>
        <div style="width:90.4%;">
          <input type="text" name="bssh_nm" class="form-control" style="flex:1;" value="{{ form.bssh_nm.value }}">
        </div>
      </div>

      <!-- ì ‘í˜ ì˜ì—­ (í•­ëª©ë“¤ í•œ ì¤„ ì •ë ¬) -->
      <div class="collapse mb-2" id="other-manufacturers">
        <!-- ìœ í†µì „ë¬¸íŒë§¤ì› -->
        <div class="d-flex align-items-center mb-2" style="gap:5px;">
          <div style="width:11.1%; min-width:130px;">
            <input type="checkbox" id="chk_distributor_address" name="chk_distributor_address"
                  class="form-check-input" {% if form.chk_distributor_address.value == "Y" %}checked{% endif %}>
            <label for="chk_distributor_address" class="m-0">ìœ í†µì „ë¬¸íŒë§¤ì›</label>
          </div>
          <div style="width:88.9%;">
            <input type="text" name="distributor_address" class="form-control"
                  value="{{ form.distributor_address.value }}">
          </div>
        </div>

        <!-- ì†Œë¶„ì› -->
        <div class="d-flex align-items-center mb-2" style="gap:5px;">
          <div style="width:11.1%; min-width:130px;">
            <input type="checkbox" id="chk_repacker_address" name="chk_repacker_address"
                  class="form-check-input" {% if form.chk_repacker_address.value == "Y" %}checked{% endif %}>
            <label for="chk_repacker_address" class="m-0">ì†Œë¶„ì›</label>
          </div>
          <div style="width:88.9%;">
            <input type="text" name="repacker_address" class="form-control"
                  value="{{ form.repacker_address.value }}">
          </div>
        </div>

        <!-- ìˆ˜ì…ì› -->
        <div class="d-flex align-items-center mb-2" style="gap:5px;">
          <div style="width:11.1%; min-width:130px;">
            <input type="checkbox" id="chk_importer_address" name="chk_importer_address"
                  class="form-check-input" {% if form.chk_importer_address.value == "Y" %}checked{% endif %}>
            <label for="chk_importer_address" class="m-0">ìˆ˜ì…ì›</label>
          </div>
          <div style="width:88.9%;">
            <input type="text" name="importer_address" class="form-control"
                  value="{{ form.importer_address.value }}">
          </div>
        </div>
      </div>
      
      <!-- ì†Œë¹„ê¸°í•œ/í’ˆì§ˆìœ ì§€ê¸°í•œ/ì œì¡°ì—°ì›”ì¼/ìƒì‚°ì—°ë„ -->
      <div class="d-flex align-items-center mb-2" style="gap:5px;">
        <div style="width:12.25%; min-width:130px;">
          <input type="checkbox" id="chk_date_info" name="chk_date_info" class="form-check-input" {% if form.chk_date_info.value == "Y" %}checked{% endif %}>
          <label for="chk_date_info" class="m-0">ì†Œë¹„ê¸°í•œ</label>
        </div>
        <div style="width:97.75%;">
          <div class="d-flex" style="gap:5px;">
            <select name="date_option" class="form-control" style="width:20%;">
              <option value="ì†Œë¹„ê¸°í•œ" {% if form.date_option.value == "ì†Œë¹„ê¸°í•œ" or not form.date_option.value %}selected{% endif %}>ì†Œë¹„ê¸°í•œ</option>
              <option value="í’ˆì§ˆìœ ì§€ê¸°í•œ" {% if form.date_option.value == "í’ˆì§ˆìœ ì§€ê¸°í•œ" %}selected{% endif %}>í’ˆì§ˆìœ ì§€ê¸°í•œ</option>
              <option value="ì œì¡°ì—°ì›”ì¼" {% if form.date_option.value == "ì œì¡°ì—°ì›”ì¼" %}selected{% endif %}>ì œì¡°ì—°ì›”ì¼</option>
              <option value="ìƒì‚°ì—°ë„" {% if form.date_option.value == "ìƒì‚°ì—°ë„" %}selected{% endif %}>ìƒì‚°ì—°ë„</option>
            </select>
            <input type="text" name="date_info_text" class="form-control" style="width:80%;" value="{{ form.date_info_text.value }}">
          </div>
        </div>
      </div>
      
      <!-- ì›ì¬ë£Œëª…(í‘œì‹œ) -->
      <div class="d-flex align-items-center mb-2" style="gap:5px;">
        <div style="width:9.6%; min-width:110px;">
          <input type="checkbox" id="chk_rawmtrl_nm_display" name="chk_rawmtrl_nm_display" class="form-check-input" {% if form.chk_rawmtrl_nm_display.value == "Y" %}checked{% endif %}>
          <label for="chk_rawmtrl_nm_display" class="m-0">ì›ì¬ë£Œëª…(í‘œì‹œ)</label>
        </div>
        <div style="min-width:1px;">
          <button type="button" class="btn btn-outline-secondary" style="font-size: 0.9rem; padding: 1px 1px;" onclick="handleIngredientPopup()" title="ìƒì„¸ì…ë ¥">âœš</button>
        </div>
        <div style="width:90.4%;">
          <textarea name="rawmtrl_nm_display" class="form-control" rows="2" placeholder="ì›ì¬ë£Œëª…(í‘œì‹œ)ì„ ì…ë ¥í•˜ì„¸ìš”">{{ form.rawmtrl_nm_display.value }}</textarea>
        </div>
      </div>

      <!-- ì›ì¬ë£Œëª… (ì°¸ê³ ) -->
      <div class="collapse mb-2" id="rawmtrl_nm_section">
        <div class="d-flex align-items-center" style="gap:5px;">
          <div style="width:11%; min-width:130px;">
            <div class="form-check">
              <input type="checkbox" id="chk_rawmtrl_nm" name="chk_rawmtrl_nm" class="form-check-input" {% if form.chk_rawmtrl_nm.value == "Y" %}checked{% endif %}>
              <label for="chk_rawmtrl_nm" class="m-0">ì›ì¬ë£Œëª…(ì°¸ê³ )</label>
            </div>
          </div>
          <div style="width:89%;">
            <textarea name="rawmtrl_nm" class="form-control disabled-textarea" style="flex:1;" placeholder="ì›ì¬ë£Œëª…ì„ ì…ë ¥í•˜ì„¸ìš”" readonly>{{ form.rawmtrl_nm.value|default:'' }}</textarea>
          </div>
        </div>  
      </div>

      <!-- ì£¼ì˜ì‚¬í•­ -->
      <div class="d-flex align-items-center mb-2" style="gap:5px;">
        <div style="width:9%; min-width:105px;">
          <div class="form-check">
          <input type="checkbox" id="chk_cautions" name="chk_cautions" class="form-check-input" {% if form.chk_cautions.value == "Y" %}checked{% endif %}>
          <label for="chk_cautions" class="m-0">ì£¼ì˜ì‚¬í•­</label>
          </div>
        </div>
        <div style="min-width:1px;">
          <button type="button" class="btn btn-outline-secondary" style="font-size: 0.9rem; padding: 1px 1px;" onclick="openIngredientPopup()" title="ìì£¼ ì‚¬ìš©í•˜ëŠ” ë¬¸êµ¬">ğŸ“</button>
        </div>
        <div style="width:91%;">
          <textarea name="cautions" rows="2" class="auto-expand form-control" placeholder="ì£¼ì˜ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”">{{ form.cautions.value }}</textarea>
        </div>
      </div>
      <!-- ê¸°íƒ€ í‘œì‹œì‚¬í•­ -->
      <div class="d-flex align-items-center mb-2" style="gap:5px;">
        <div style="width:9%; min-width:105px;">
          <div class="form-check">
          <input type="checkbox" id="chk_additional_info" name="chk_additional_info" class="form-check-input" {% if form.chk_additional_info.value == "Y" %}checked{% endif %}>
          <label for="chk_additional_info" class="m-0">ê¸°íƒ€í‘œì‹œì‚¬í•­</label>
          </div>
        </div>
        <div style="min-width:1px;">
          <button type="button" class="btn btn-outline-secondary" style="font-size: 0.9rem; padding: 1px 1px;" onclick="openIngredientPopup()" title="ìì£¼ ì‚¬ìš©í•˜ëŠ” ë¬¸êµ¬">ğŸ“</button>
        </div>
        <div style="width:91%;">
          <textarea name="additional_info" rows="2" class="auto-expand form-control" placeholder="ê¸°íƒ€ í‘œì‹œì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”">{{ form.additional_info.value }}</textarea>
        </div>
      </div>      
      
      <!-- ì˜ì–‘ì„±ë¶„ -->
      <div class="d-flex align-items-center mb-2" style="gap:5px;">
        <div style="width:9%; min-width:105px;">
          <div class="form-check">
          <input type="checkbox" id="chk_calories" name="chk_calories" class="form-check-input">
          <label for="chk_calories" class="form-check-label m-0">ì˜ì–‘ì„±ë¶„</label>
          </div>
        </div>
        <div style="min-width:1px;">
          <button type="button" class="btn btn-outline-secondary" style="font-size: 0.9rem; padding: 1px 1px;" onclick="runNutritionCalculator()" title="ê³„ì‚°í•˜ê¸°">ğŸ§®</button>
        </div>

        <!-- ìš°ì¸¡: ì…ë ¥ í‘œ -->
        <div style="width:91%;">
          <table class="table table-bordered table-sm mb-2" style="font-size:0.75rem; table-layout: fixed;">
            <tbody>
              <tr>
                <th style="width:6%;">í•­ëª©</th>
                <td style="width:10%;">ì¹¼ë¡œë¦¬</td>
                <td style="width:10%;">ë‚˜íŠ¸ë¥¨</td>
                <td style="width:10%;">íƒ„ìˆ˜í™”ë¬¼</td>
                <td style="width:10%;">ë‹¹ë¥˜</td>
                <td style="width:10%;">ì§€ë°©</td>
                <td style="width:10%;">íŠ¸ëœìŠ¤ì§€ë°©</td>
                <td style="width:10%;">í¬í™”ì§€ë°©</td>
                <td style="width:10%;">ì½œë ˆìŠ¤í…Œë¡¤</td>
                <td style="width:10%;">ë‹¨ë°±ì§ˆ</td>
              </tr>
              <tr>
                <th>ì…ë ¥</th>
                <td><input type="number" id="calories" name="calories" class="form-control form-control-sm" step="any"></td>
                <td><input type="number" id="natriums" name="natriums" class="form-control form-control-sm" step="any"></td>
                <td><input type="number" id="carbohydrates" name="carbohydrates" class="form-control form-control-sm" step="any"></td>
                <td><input type="number" id="sugars" name="sugars" class="form-control form-control-sm" step="any"></td>
                <td><input type="number" id="fats" name="fats" class="form-control form-control-sm" step="any"></td>
                <td><input type="number" id="trans_fats" name="trans_fats" class="form-control form-control-sm" step="any"></td>
                <td><input type="number" id="saturated_fats" name="saturated_fats" class="form-control form-control-sm" step="any"></td>
                <td><input type="number" id="cholesterols" name="cholesterols" class="form-control form-control-sm" step="any"></td>
                <td><input type="number" id="proteins" name="proteins" class="form-control form-control-sm" step="any"></td>
              </tr>
              <tr>
                <th>í‘œì‹œ</th>
                <td id="result_calories"></td>
                <td id="result_natriums"></td>
                <td id="result_carbohydrates"></td>
                <td id="result_sugars"></td>
                <td id="result_fats"></td>
                <td id="result_trans_fats"></td>
                <td id="result_saturated_fats"></td>
                <td id="result_cholesterols"></td>
                <td id="result_proteins"></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      </form>
    </div>

    <!-- ìš°ì¸¡ ê·œì • íŒ¨ë„ -->
    <div id="regulationPanel" class="right-panel collapsible-panel show">
      <textarea name="related_regulations" class="form-control"
                style="height: 100%; min-height: 500px;"
                placeholder="ì‹í’ˆ ìœ í˜•ë³„ ê´€ë ¨ ê·œì •ì„ í™•ì¸í•˜ì„¸ìš”.">{{ form.related_regulations.value }}</textarea>
    </div>
  </div>
</div>

<!-- ìŠ¤íƒ€ì¼ -->
<style>
label, .form-control {
  font-size: 0.8rem !important;
  color: #495057 !important;
}
/* Select2 ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
.select2-container--default .select2-selection--single {
  height: auto !important;
  font-size: 0.8rem !important;
  color: #495057 !important;
  border: 1px solid #ced4da !important;
  border-radius: 0.25rem !important;
  padding: 0.3rem 0.6rem !important;
}
.select2-selection__rendered {
  line-height: 1.5 !important;
}
/* ìˆ«ì ì…ë ¥ í•„ë“œ ìŠ¤í”¼ë„ˆ ì œê±° */
input[type=number]::-webkit-inner-spin-button,
input[type=number]::-webkit-outer-spin-button {
  -webkit-appearance: none;
  margin: 0;
}
input[type=number] {
  -moz-appearance: textfield;
}
/* í‘œ ì…€ íŒ¨ë”© ìµœì†Œí™” */
.table-bordered td, .table-bordered th {
  padding: 0.2rem;
}
.disabled-textarea {
  background-color: #e9ecef;
  cursor: not-allowed;
}
.detail-btn {
  font-size: 0.75rem;
  padding: 4px 6px;
}

/* ìƒë‹¨ ê³ ì • ì˜ì—­ */
.sticky-top-bar {
  position: sticky;
  top: 0;
  background-color: white;
  z-index: 1020;
  padding-top: 10px;
  border-bottom: 1px solid #dee2e6;
}

/* ìš°ì¸¡ ìŠ¬ë¼ì´ë”© íŒ¨ë„ */
.collapsible-panel {
  width: 100%;
  max-width: 30%;
  transition: max-width 0.3s ease;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}
.collapsible-panel.collapsed {
  max-width: 0;
  padding: 0;
}

/* í† ê¸€ ë²„íŠ¼ ìœ„ì¹˜ ì¡°ì • */
.toggle-right-panel-btn {
  position: absolute;
  top: -5px;
  right: -15px;
  z-index: 1050;
  font-size: 1rem;
  padding: 1px 6px;
  border-radius: 4px;
  background-color: #f8f9fa;
  border: 1px solid #ced4da;
}

/* í† ê¸€ ë²„íŠ¼ ê³ ì • */
#toggleRegulationBtn {
  margin-left: auto;
  margin-right: 0;
  font-weight: bold;
}

</style>
{% endblock %}
