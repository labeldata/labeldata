{% extends "base_v2.html" %}
{% load static %}

{% block title %}식품첨가물 데이터베이스 - V2{% endblock %}

{% block topbar %}
<div class="d-flex align-items-center" style="flex:1; min-width:0;">
    <i class="bi bi-database me-2" style="color:#1a73e8;font-size:18px;flex-shrink:0;"></i>
    <span style="font-size:17px;font-weight:500;color:#202124;">식품첨가물 DB</span>
    <span class="ms-3 d-none d-md-inline" style="font-size:12px;color:#5f6368;">식품첨가물의 영문명, 이명, CAS No., INS No., E No.를 제공합니다. 수정이 필요한 경우 데이터 수정 요청을 통해 반영할 수 있습니다.</span>
</div>
{% include "includes/_topbar_account.html" %}
{% endblock %}

{% block extra_css %}
<!-- Google Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

<style>
    /* Material Design 3 기반 타이포그래피 */
    body {
        font-family: 'Roboto', 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
        color: #1f1f1f;
    }

    /* Google Drive 스타일 메인 컨테이너 */
    .additive-explorer-container {
        height: calc(100vh - 140px);
        display: flex;
        flex-direction: column;
        background: #f8f9fa;
    }

    /* 필터 툴바 - M3 스타일 */
    .filter-toolbar {
        flex-shrink: 0;
        border-bottom: 1px solid #e0e2e0;
        background: #ffffff;
        min-height: 64px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 24px;
        gap: 16px;
    }

    /* 제품 테이블 - M3 스타일 */
    .additive-table {
        table-layout: fixed;
        background: #ffffff;
    }

    .additive-table thead {
        position: sticky;
        top: 0;
        background: #ffffff;
        z-index: 10;
    }

    .additive-table thead th {
        border-bottom: 2px solid #e8eaed;
        border-left: none !important;
        border-right: none !important;
        font-weight: 500;
        font-size: 13px;
        letter-spacing: 0.3px;
        color: #444746;
        padding: 12px 8px;
        text-align: center !important;
        white-space: nowrap;
        background: #ffffff;
    }

    .additive-table thead th:first-child {
        text-align: center !important;
        width: 4%;
    }

    .additive-table tbody tr {
        cursor: pointer;
        transition: background-color 0.15s cubic-bezier(0.4, 0, 0.2, 1);
        border-bottom: none;
        height: 48px;
    }

    .additive-table tbody tr:hover {
        background-color: #f1f3f4;
    }

    .additive-table tbody td {
        padding: 8px;
        font-size: 13px;
        color: #1f1f1f;
        border-top: none;
        border-left: none;
        border-right: none;
        border-bottom-color: #f0f0f0;
        text-align: center;
        vertical-align: middle;
    }

    .additive-table tbody td:first-child {
        text-align: center;
    }

    .additive-table tbody td:nth-child(3),
    .additive-table tbody td:nth-child(4),
    .additive-table tbody td:nth-child(5) {
        text-align: left;
    }

    /* 스크롤바 커스텀 - M3 스타일 */
    .custom-scrollbar::-webkit-scrollbar {
        width: 10px;
        height: 10px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #dadce0;
        border-radius: 10px;
        border: 2px solid transparent;
        background-clip: padding-box;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #bdc1c6;
        background-clip: padding-box;
    }

    /* 검색창 - M3 스타일 */
    .input-group .form-control,
    .input-group .input-group-text {
        border: 1px solid #dadce0;
        background: #ffffff;
        color: #1f1f1f;
        font-size: 14px;
        transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .input-group .form-control:focus {
        border-color: #1a73e8;
        box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.1);
    }

    .input-group .input-group-text {
        background-color: #f8f9fa;
    }

    /* 버튼 - M3 FAB 스타일 */
    .btn-primary {
        background: #1a73e8;
        border: none;
        border-radius: 4px;
        font-weight: 500;
        font-size: 13px;
        padding: 8px 16px;
        box-shadow: 0 1px 3px 0 rgba(60,64,67,0.3);
        transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .btn-primary:hover {
        background: #1557b0;
        box-shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 2px 6px 2px rgba(60,64,67,0.15);
        transform: translateY(-1px);
    }

    .btn-outline-primary {
        border: 1px solid #dadce0;
        color: #1a73e8;
        background: #ffffff;
    }

    .btn-outline-primary:hover {
        background: #f8f9fa;
        border-color: #c0c4c7;
    }

    /* 텍스트 색상 - M3 팔레트 */
    .text-dark {
        color: #1f1f1f !important;
    }

    .text-muted {
        color: #5f6368 !important;
    }

    /* 엘립시스 셀 */
    .ellipsis-cell {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        vertical-align: middle;
    }

    /* 페이지네이션 스타일 */
    .pagination {
        --bs-pagination-padding-x: 0.75rem;
        --bs-pagination-padding-y: 0.375rem;
        --bs-pagination-font-size: 0.875rem;
        --bs-pagination-color: #5f6368;
        --bs-pagination-bg: #ffffff;
        --bs-pagination-border-width: 1px;
        --bs-pagination-border-color: #dadce0;
        --bs-pagination-border-radius: 8px;
        --bs-pagination-hover-color: #1f1f1f;
        --bs-pagination-hover-bg: #f8f9fa;
        --bs-pagination-hover-border-color: #dadce0;
        --bs-pagination-focus-color: #1967d2;
        --bs-pagination-focus-bg: #e8f0fe;
        --bs-pagination-focus-box-shadow: 0 0 0 0.25rem rgba(25, 103, 210, 0.15);
        --bs-pagination-active-color: #ffffff;
        --bs-pagination-active-bg: #1967d2;
        --bs-pagination-active-border-color: #1967d2;
    }

    /* 헤더 제목 */
    .page-header {
        padding: 24px 24px 0;
        background: #f8f9fa;
    }

    .page-header h2 {
        font-size: 28px;
        font-weight: 400;
        color: #1f1f1f;
        margin: 0;
    }

    .page-header .text-muted {
        margin-top: 8px;
        font-size: 14px;
    }

    /* 헤더에서의 버튼 그룹 */
    .header-buttons {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    /* 모달 스타일 */
    .modal-header {
        border-bottom: 1px solid #e0e2e0;
        background: #ffffff;
        padding: 20px 24px;
    }

    .modal-title {
        font-size: 16px;
        font-weight: 500;
        color: #1f1f1f;
    }

    .modal-body {
        padding: 20px 24px;
        background: #ffffff;
    }

    .modal-footer {
        border-top: 1px solid #e0e2e0;
        background: #ffffff;
        padding: 16px 24px;
        gap: 8px;
    }

    .modal-content {
        border-radius: 8px;
        border: none;
        box-shadow: 0 1px 3px 0 rgba(60,64,67,0.3), 0 4px 8px 3px rgba(60,64,67,0.15);
    }

    /* 부드러운 전환 효과 */
    * {
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }

    @media (max-width: 768px) {
        .filter-toolbar {
            flex-direction: column;
            align-items: flex-start;
        }

        .header-buttons {
            width: 100%;
        }

        .header-buttons .btn {
            flex: 1;
            flex-basis: calc(50% - 4px);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="additive-explorer-container">
    <!-- 필터 및 검색 바 -->
    <div class="filter-toolbar">
        <form method="get" action="" class="d-flex align-items-center" style="gap: 12px; flex: 1;" id="searchForm">
            <!-- 통합 검색 -->
            <div class="input-group" style="max-width: 100%;">
                <span class="input-group-text bg-white border-end-0" style="font-size: 12px;"><i class="bi bi-search text-muted"></i></span>
                <input type="text" id="search-input" name="q" class="form-control border-start-0 ps-0" 
                       placeholder="식품첨가물명, 영문명, 이명 중 검색어를 1개 이상 입력하세요" 
                       value="{{ search_query|default:'' }}" style="font-size: 13px;">
            </div>
            
            <button type="submit" class="btn btn-primary" style="border-radius: 20px; padding: 6px 18px; font-size: 13px; white-space: nowrap;">
                <i class="bi bi-search me-1"></i>검색
            </button>
            {% if search_query %}
            <a href="?" class="btn btn-outline-primary" style="border-radius: 20px; padding: 6px 18px; font-size: 13px; white-space: nowrap;">
                초기화
            </a>
            {% endif %}
        </form>

        {% if user.is_authenticated %}
        <div class="header-buttons">
            <button type="button" class="v2-action-btn-outline" onclick="copySelectedToIngredients()">
                <i class="bi bi-download"></i>내 원료 복사
            </button>
            <button type="button" class="v2-action-btn-outline" onclick="requestDataCorrection()">
                <i class="bi bi-pencil"></i>수정 요청
            </button>
        </div>
        {% endif %}
    </div>

    <!-- 식품첨가물 데이터 그리드 -->
    <div class="flex-grow-1 overflow-auto custom-scrollbar">
        {% if page_obj %}
        <table class="table table-hover align-middle mb-0 additive-table">
            <thead>
                <tr>
                    {% if user.is_authenticated %}
                    <th class="text-center">
                        <input type="checkbox" id="check-all" onclick="toggleAllCheckboxes(this)">
                    </th>
                    {% endif %}
                    <th style="width: 18%;">식품첨가물명</th>
                    <th style="width: 22%;">영문명</th>
                    <th style="width: 20%;">이명</th>
                    <th style="width: 10%;">INS No.</th>
                    <th style="width: 8%;">E No.</th>
                    <th style="width: 12%;">CAS No.</th>
                </tr>
            </thead>
            <tbody>
                {% for additive in page_obj %}
                <tr>
                    {% if user.is_authenticated %}
                    <td class="text-center">
                        <input type="checkbox" class="additive-checkbox" value="{{ additive.name_kr }}"
                               data-name-kr="{{ additive.name_kr }}"
                               data-name-en="{{ additive.name_en|default:'' }}"
                               data-alias-name="{{ additive.alias_name|default:'' }}"
                               data-ins-no="{{ additive.ins_no|default:'' }}"
                               data-e-no="{{ additive.e_no|default:'' }}"
                               data-cas-no="{{ additive.cas_no|default:'' }}"
                               data-main-purpose="{{ additive.main_purpose|default:'' }}">
                    </td>
                    {% endif %}
                    <td class="ellipsis-cell" title="{{ additive.name_kr }}">
                        <strong>{{ additive.name_kr }}</strong>
                    </td>
                    <td class="ellipsis-cell" title="{{ additive.name_en|default:'' }}">
                        {{ additive.name_en|default:"-" }}
                    </td>
                    <td class="ellipsis-cell alias-name-cell">
                        {% if additive.alias_name %}
                            <span data-original="{{ additive.alias_name }}">{{ additive.alias_name|default:"-" }}</span>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td class="ellipsis-cell" title="{{ additive.ins_no|default:'' }}">
                        {{ additive.ins_no|default:"-" }}
                    </td>
                    <td class="ellipsis-cell" title="{{ additive.e_no|default:'' }}">
                        {{ additive.e_no|default:"-" }}
                    </td>
                    <td class="ellipsis-cell cas-no-cell">
                        {% if additive.cas_no %}
                            <span data-original="{{ additive.cas_no }}">{{ additive.cas_no|default:"-" }}</span>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="{% if user.is_authenticated %}7{% else %}6{% endif %}" class="text-center text-muted py-5">검색 결과가 없습니다.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="d-flex flex-column align-items-center justify-content-center" style="height: 300px;">
            <i class="bi bi-inbox" style="font-size: 48px; color: #dadce0; margin-bottom: 16px;"></i>
            <p class="text-muted">데이터가 없습니다.</p>
        </div>
        {% endif %}
    </div>

    <!-- 페이지네이션 및 정보 -->
    <div class="d-flex justify-content-between align-items-center px-4 py-3 bg-white border-top">
        <div class="d-flex align-items-center gap-3">
            <div class="text-muted small">
                {% if page_obj %}
                    전체 <span class="fw-semibold text-dark">{{ page_obj.paginator.count }}</span>개 항목
                    ({{ page_obj.start_index }}-{{ page_obj.end_index }})
                {% endif %}
            </div>
        </div>
        {% if page_obj.has_other_pages %}
        <nav>
            <ul class="pagination mb-0">
                {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1">«</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}">‹</a>
                    </li>
                {% endif %}
                
                {% for num in page_obj.paginator.page_range %}
                    {% if page_obj.number == num %}
                        <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                    {% elif num > page_obj.number|add:'-5' and num < page_obj.number|add:'5' %}
                        <li class="page-item"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
                    {% endif %}
                {% endfor %}
                
                {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}">›</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">»</a>
                    </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>
</div>

<!-- 수정 요청 모달 -->
<div class="modal fade" id="correctionModal" tabindex="-1" role="dialog" aria-labelledby="correctionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="correctionModalLabel">
                    <i class="bi bi-pencil-square" style="color: #1a73e8; margin-right: 8px;"></i>
                    식품첨가물 데이터 수정 요청
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info" style="border-left: 4px solid #1a73e8; background: #e8f0fe; border: none;">
                    <i class="bi bi-info-circle" style="color: #1a73e8; margin-right: 8px;"></i>
                    <strong>선택한 식품첨가물의 정보를 수정해주세요.</strong> 근거 자료와 함께 제출하면 관리자가 검토 후 반영합니다.
                </div>
                
                <div id="correctionItemsList" style="max-height: 350px; overflow-y: auto; margin-bottom: 16px;"></div>
                
                <div class="mb-0">
                    <label for="correctionReason" class="form-label">
                        <strong>수정 사유 및 근거 자료</strong>
                        <span class="text-danger">*</span>
                    </label>
                    <textarea class="form-control" id="correctionReason" rows="3" 
                              placeholder="수정이 필요한 이유와 근거 자료(출처, URL 등)을 상세히 입력해주세요."
                              style="border: 1px solid #dadce0; border-radius: 4px;"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="submitCorrectionRequest()">
                    <i class="bi bi-send me-1"></i>수정 요청 제출
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="{% static 'js/label/food_additive_search.js' %}?v={{ STATIC_BUILD_DATE }}"></script>

{% endblock %}
