{% extends 'base.html' %}
{% load static %}

{% block title %}í‘œì‹œì‚¬í•­ ì‘ì„±{% endblock %}

{% block content %}
<!-- jQuery & Select2 -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<!-- ì™¸ë¶€ CSS ë° JS íŒŒì¼ ë¡œë“œ -->
<link href="{% static 'css/style.css' %}?v={{ STATIC_BUILD_DATE }}" rel="stylesheet" />
<link href="{% static 'css/label_creation_modern.css' %}?v={{ STATIC_BUILD_DATE }}" rel="stylesheet" />
<!-- ìì£¼ ì‚¬ìš©í•˜ëŠ” ë¬¸êµ¬ ë°ì´í„° ì‚½ì… -->
<script id="phrases-data" type="application/json">
  {{ phrases_json|safe }}
</script>
<script id="regulations-data" type="application/json">
    {{ regulations_json|safe }}
</script>
<script id="smart-recommendation-data" type="application/json">
    {{ smart_recommendations_json|safe }}
</script>
<script src="{% static 'js/label/label_creation.js' %}?v={{ STATIC_BUILD_DATE }}"></script>
<script src="{% static 'js/label/ocr_processor.js' %}?v={{ STATIC_BUILD_DATE }}"></script>
<!-- í†µí•© ìŠ¤ë§ˆíŠ¸ ì¶”ì²œ ì‹œìŠ¤í…œ (ë‹¨ì¼ íŒŒì¼) -->
<script src="{% static 'js/unified_recommendation.js' %}?v={{ STATIC_BUILD_DATE }}"></script>

<!-- OCR ìë™ ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸ -->
<script>
// ê°œë°œ ì¤‘ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜ (ì „ì—­ í•¨ìˆ˜ë¡œ ì •ì˜)
function showDevelopmentMessage() {
    alert('ğŸš€ ì»¤ë° ìˆœ~! ì‚¬ì§„ìœ¼ë¡œ ìë™ ì…ë ¥ ê¸°ëŠ¥ì„ ì—´ì‹¬íˆ ê°œë°œ ì¤‘ì…ë‹ˆë‹¤! ğŸ˜Š');
    return false; // ëª¨ë‹¬ ì—´ê¸° ë°©ì§€
}

document.addEventListener('DOMContentLoaded', function() {
    // URL íŒŒë¼ë¯¸í„°ì—ì„œ ocr=autoê°€ ìˆìœ¼ë©´ OCR ëª¨ë‹¬ ìë™ ì—´ê¸°
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('ocr') === 'auto') {
        setTimeout(() => {
            const ocrModal = new bootstrap.Modal(document.getElementById('ocrUploadModal'));
            ocrModal.show();
            
            // URLì—ì„œ íŒŒë¼ë¯¸í„° ì œê±° (ë¸Œë¼ìš°ì € íˆìŠ¤í† ë¦¬ ì •ë¦¬)
            window.history.replaceState({}, document.title, window.location.pathname);
        }, 500);
    }
    
    // ë¼ë²¨ëª… ë™ê¸°í™” ê¸°ëŠ¥
    function syncLabelName() {
        const topInput = document.getElementById('my_label_name_top');
        const hiddenInput = document.getElementById('my_label_name_hidden');
        
        if (topInput && hiddenInput) {
            // ìƒë‹¨ ì…ë ¥ í•„ë“œ ë³€ê²½ ì‹œ ìˆ¨ê²¨ì§„ í•„ë“œ ì—…ë°ì´íŠ¸
            topInput.addEventListener('input', function() {
                hiddenInput.value = this.value;
            });
            
            // ì´ˆê¸°ê°’ ë™ê¸°í™”
            if (hiddenInput.value && !topInput.value) {
                topInput.value = hiddenInput.value;
            } else if (topInput.value && !hiddenInput.value) {
                hiddenInput.value = topInput.value;
            }
        }
    }
    
    // ë¼ë²¨ëª… ë™ê¸°í™” ì´ˆê¸°í™”
    syncLabelName();
    
    // ì¶”ì²œ ì‹œìŠ¤í…œ ì¶”ê°€ ì´ˆê¸°í™” (DOM ë¡œë“œ í›„ ì‹¤í–‰)
    function initRecommendationSystem() {
        if (window.recommendationSystem) {
            
            // Select2ë¡œ ë³€í™˜ëœ í•„ë“œë“¤ì— ëŒ€í•´ íŠ¹ë³„ ì²˜ë¦¬
            $('#country_of_origin').on('select2:open', function() {
                // ì›ì‚°ì§€ í•„ë“œìš© ì¸ê¸°ê°’ í‘œì‹œ (Select2ëŠ” ìì²´ ë“œë¡­ë‹¤ìš´ ì‚¬ìš©)
            });
            
            // ì›ì¬ë£Œëª… í•„ë“œë“¤ (ë™ì ìœ¼ë¡œ ì¶”ê°€ë˜ëŠ” í•„ë“œë“¤)ì— ì¶”ì²œ ê¸°ëŠ¥ ì ìš©
            $(document).on('focus', 'input[name^="ingr_kor_nm"]', function() {
                if (!this.hasAttribute('data-recommendation-enabled')) {
                    window.recommendationSystem.setupFieldRecommendations(this, 'ingr_kor_nm');
                }
            });
            
            // ì¶”ê°€ ì›ì¬ë£Œ ë²„íŠ¼ í´ë¦­ ì‹œ ìƒˆ í•„ë“œì— ì¶”ì²œ ê¸°ëŠ¥ ì ìš©
            $(document).on('click', '.add-ingredient-btn', function() {
                setTimeout(function() {
                    $('input[name^="ingr_kor_nm"]:not([data-recommendation-enabled])').each(function() {
                        window.recommendationSystem.setupFieldRecommendations(this, 'ingr_kor_nm');
                    });
                }, 100);
            });
            
            // í…ŒìŠ¤íŠ¸ìš© ìˆ˜ë™ ì¶”ì²œ í™œì„±í™” í•¨ìˆ˜
            window.testRecommendations = function() {
                const testFields = ['storage_method', 'cautions', 'content_weight', 'bssh_nm'];
                testFields.forEach(fieldName => {
                    const element = document.querySelector(`[name="${fieldName}"]`);
                    if (element) {
                        // ê¸°ì¡´ ì¶”ì²œ ê¸°ëŠ¥ ì œê±° í›„ ì¬ì„¤ì •
                        element.removeAttribute('data-recommendation-enabled');
                        window.recommendationSystem.setupFieldRecommendations(element, fieldName);
                    }
                });
            };
            
            // ìë™ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
            window.testRecommendations();
            
            // í†µí•© ìŠ¤ë§ˆíŠ¸ ì¶”ì²œ ì‹œìŠ¤í…œ ì´ˆê¸°í™”
            if (window.unifiedSmartRecommendation) {
                try {
                    window.unifiedSmartRecommendation.initializeSystem();
                } catch (error) {
                    console.error('âŒ í†µí•© ìŠ¤ë§ˆíŠ¸ ì¶”ì²œ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                }
            }
            
            return true; // ì´ˆê¸°í™” ì„±ê³µ
        } else {
            return false; // ì´ˆê¸°í™” ì‹¤íŒ¨
        }
    }
    
    // ì¶”ì²œ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¬ì‹œë„ ë¡œì§
    let retryCount = 0;
    const maxRetries = 10;
    
    function tryInitRecommendationSystem() {
        if (initRecommendationSystem()) {
            return;
        }
        
        retryCount++;
        if (retryCount < maxRetries) {
            setTimeout(tryInitRecommendationSystem, 1000);
        }
    }
    
    // ì´ˆê¸°í™” ì‹œì‘
    setTimeout(tryInitRecommendationSystem, 1000);
});
</script>

<!-- ë¼ë²¨ IDë¥¼ JavaScriptì— ì „ë‹¬í•˜ê¸° ìœ„í•œ ìˆ¨ê²¨ì§„ ì…ë ¥ í•„ë“œ -->
<input type="hidden" id="label_id" value="{{ label.my_label_id }}">

<!-- ìƒë‹¨ í—¤ë” - ê³ ì • ë° ì»´íŒ©íŠ¸ -->
<div class="fixed-header-container">
  <div class="container">
    <div class="compact-header">
      <div class="header-left">
        <h4 class="page-title-compact">
          <i class="fas fa-edit me-2"></i>í‘œì‹œì‚¬í•­ ì‘ì„±
        </h4>
        <div class="label-name-compact">
          <label for="my_label_name_top" class="label-name-label-compact">ë¼ë²¨ëª…</label>
          <input type="text" id="my_label_name_top" name="my_label_name_top"
                 class="form-control label-name-input-compact"
                 placeholder="ë¼ë²¨ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"
                 value="{{ label.my_label_name|default:'' }}">
        </div>
      </div>
      
      <div class="header-right">
        <span class="last-update-compact">
          <i class="fas fa-clock me-1"></i>{{ label.update_datetime|date:"m/d H:i" }}
        </span>
        <div class="action-buttons-compact">
          <button type="button" class="btn btn-success btn-sm" 
                  id="smartRecommendationToggleBtn"
                  title="ìŠ¤ë§ˆíŠ¸ ì¶”ì²œ í™œì„±í™”ë¨ (í´ë¦­í•˜ì—¬ ë„ê¸°)">
            <i class="fas fa-lightbulb me-1"></i>
            <span id="smartToggleText">ìŠ¤ë§ˆíŠ¸ ì¶”ì²œ</span>
            <span id="smartToggleIcon" class="ms-1">
              <i class="fas fa-toggle-on text-light"></i>
            </span>
          </button>
          <button type="button" class="btn btn-outline-info btn-sm" 
                  title="ì‚¬ì§„ìœ¼ë¡œ ìë™ ì…ë ¥"
                  onclick="showDevelopmentMessage(); return false;">
            <i class="fas fa-camera"></i>
          </button>
          <button type="button" class="btn btn-outline-primary btn-sm" onclick="openPreviewPopup()">
            <i class="fas fa-eye me-1"></i>ë¯¸ë¦¬ë³´ê¸°
          </button>
          <button type="submit" form="labelForm" class="btn btn-success btn-sm">
            <i class="fas fa-save me-1"></i>ì €ì¥
          </button>
          <button type="button" class="btn btn-outline-secondary btn-sm" 
                  onclick="window.location.href='{% url 'label:my_label_list' %}'"
                  title="í‘œì‹œì‚¬í•­ ì‘ì„± ë¦¬ìŠ¤íŠ¸ë¡œ ëŒì•„ê°€ê¸°">
            <i class="fas fa-times me-1"></i>ë‹«ê¸°
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- í—¤ë” ë†’ì´ë§Œí¼ ìƒë‹¨ ì—¬ë°± -->
<div class="header-spacer"></div>

<!-- Step1. ê¸°ë³¸ ì„¤ì • -->
<div class="container mt-1" id="step1-row">
  <div class="card modern-card">
    <div class="card-header modern-card-header" id="step1-summary-bar">
      <div class="card-header-content">
        <div class="card-title-section">
          <div class="d-flex align-items-center gap-2">
            <h5 class="card-title mb-0">
              <i class="fas fa-cog me-2"></i>1. ê¸°ë³¸ì •ë³´ ì„¤ì •
            </h5>
            <div class="food-type-summary" id="food-type-summary-display" style="display: none;">
              <span class="badge bg-primary text-white px-3 py-2 clickable-summary" id="selected-food-type" 
                    title="í´ë¦­í•˜ë©´ ì•„ë˜ ì‹í’ˆìœ í˜• í•„ë“œì— ì…ë ¥ë©ë‹ˆë‹¤" style="cursor: pointer;">
                <i class="fas fa-tag me-1"></i>ì‹í’ˆìœ í˜• ì„ íƒë¨
              </span>
            </div>
          </div>
          <!-- ê¸°ì¡´ ìš”ì•½ í‘œì‹œ ì˜ì—­ ì œê±° ë˜ëŠ” ìˆ¨ê¹€ -->
          <div class="summary-display d-none" id="summary-step1">
            ê¸°ë³¸ ì„¤ì •ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”
          </div>
        </div>
        <div class="card-actions">
          <button type="button" class="btn btn-primary btn-sm" id="applyStep1Btn">
            <i class="fas fa-check me-1"></i>í•„ìˆ˜í•­ëª© ì ìš© í›„ ì ‘ê¸°
          </button>
          <button type="button" class="btn btn-outline-primary btn-sm" id="expandStep1Btn" style="display:none;">
            <i class="fas fa-expand me-1"></i>í¼ì¹˜ê¸°
          </button>
        </div>
      </div>
    </div>
    <div class="card-body" id="step1-body">
      <div id="food-type-section" class="mb-1">
        <div class="row g-2">
          <div class="col-md-6">
            <!-- ì‹í’ˆìœ í˜• ì„ íƒ -->
            <div class="field-row-modern mb-2">
              <div class="field-label-section">
                <label class="field-label-modern">
                  <i class="fas fa-utensils me-2"></i>ì‹í’ˆìœ í˜•
                </label>
              </div>
              <div class="field-input-section">
                <div class="input-container-modern">
                  <div class="row g-2">
                    <div class="col-7">
                      <select id="food_group" name="food_group" class="form-select">
                        <option value="">ëŒ€ë¶„ë¥˜ ì„ íƒ</option>
                        {% for group in food_groups %}
                        <option value="{{ group }}" {% if label.food_group == group %}selected{% endif %}>{{ group }}</option>
                        {% endfor %}
                      </select>
                    </div>
                    <div class="col-5">
                      <select id="food_type" name="food_type" class="form-select">
                        <option value="">ì†Œë¶„ë¥˜ ì„ íƒ</option>
                        {% for type in food_types %}
                        <option value="{{ type.food_type }}" 
                                data-group="{{ type.food_group }}"
                                {% if label.food_type == type.food_type %}selected{% endif %}>
                          {{ type.food_type }}
                        </option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- ì¥ê¸°ë³´ì¡´ì‹í’ˆ -->
            <div class="field-row-modern mb-2">
              <div class="field-label-section">
                <label class="field-label-modern">
                  <i class="fas fa-snowflake me-2"></i>ì¥ê¸°ë³´ì¡´ì‹í’ˆ
                </label>
              </div>
              <div class="field-input-section">
                <div class="input-container-modern">
                  <div class="checkbox-group-modern">
                    <div class="form-check-modern">
                      <input type="checkbox" id="chk_frozen_heated" name="preservation_type" value="frozen_heated" class="form-check-input-modern" {% if form.preservation_type.value == "frozen_heated" %}checked{% endif %}>
                      <label for="chk_frozen_heated" class="form-check-label-modern">ëƒ‰ë™(ê°€ì—´)</label>
                    </div>
                    <div class="form-check-modern">
                      <input type="checkbox" id="chk_frozen_nonheated" name="preservation_type" value="frozen_nonheated" class="form-check-input-modern" {% if form.preservation_type.value == "frozen_nonheated" %}checked{% endif %}>
                      <label for="chk_frozen_nonheated" class="form-check-label-modern">ëƒ‰ë™(ë¹„ê°€ì—´)</label>
                    </div>
                    <div class="form-check-modern">
                      <input type="checkbox" id="chk_canned" name="preservation_type" value="canned" class="form-check-input-modern" {% if form.preservation_type.value == "canned" %}checked{% endif %}>
                      <label for="chk_canned" class="form-check-label-modern">í†µ.ë³‘ì¡°ë¦¼</label>
                    </div>
                    <div class="form-check-modern">
                      <input type="checkbox" id="chk_retort" name="preservation_type" value="retort" class="form-check-input-modern" {% if form.preservation_type.value == "retort" %}checked{% endif %}>
                      <label for="chk_retort" class="form-check-label-modern">ë ˆí† ë¥´íŠ¸</label>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="col-md-6">
            <!-- ì œì¡°ë°©ë²• -->
            <div class="field-row-modern mb-2">
              <div class="field-label-section">
                <label class="field-label-modern">
                  <i class="fas fa-industry me-2"></i>ì œì¡°ë°©ë²•
                </label>
              </div>
              <div class="field-input-section">
                <div class="input-container-modern">
                  <div class="checkbox-group-modern">
                    <div class="form-check-modern">
                      <input type="checkbox" id="chk_sanitized" name="processing_method" value="sanitized" class="form-check-input-modern" {% if form.processing_method.value == "sanitized" %}checked{% endif %}>
                      <label for="chk_sanitized" class="form-check-label-modern">ì‚´ê· </label>
                    </div>
                    <div class="form-check-modern">
                      <input type="checkbox" id="chk_aseptic" name="processing_method" value="aseptic" class="form-check-input-modern" {% if form.processing_method.value == "aseptic" %}checked{% endif %}>
                      <label for="chk_aseptic" class="form-check-label-modern">ë©¸ê· </label>
                    </div>
                    <div class="form-check-modern">
                      <input type="checkbox" id="chk_yutang" name="processing_method" value="yutang" class="form-check-input-modern" {% if form.processing_method.value == "yutang" %}checked{% endif %}>
                      <label for="chk_yutang" class="form-check-label-modern">ìœ íƒ•/ìœ ì²˜ë¦¬</label>
                    </div>
                    <div class="form-check-modern">
                      <input type="checkbox" id="chk_sterilization_other" name="chk_sterilization_other" class="form-check-input-modern" {% if form.processing_condition.value %}checked{% endif %}>
                      <label for="chk_sterilization_other" class="form-check-label-modern">ê¸°íƒ€ ì¡°ê±´</label>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- ì¡°ê±´ ìƒì„¸ -->
            <div class="field-row-modern mb-2">
              <div class="field-label-section">
                <label class="field-label-modern">
                  <i class="fas fa-edit me-2"></i>ì¡°ê±´ ìƒì„¸
                </label>
              </div>
              <div class="field-input-section">
                <div class="input-container-modern">
                  <input type="text" name="processing_condition" class="form-control"
                         placeholder="ê¸°íƒ€ ì¡°ê±´ì„ ì…ë ¥í•˜ì„¸ìš”"
                         value="{{ form.processing_condition.value|default:'' }}">
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Step2. ìƒì„¸ ì…ë ¥ ì˜ì—­ -->
<div class="container mt-1" id="step2-card">
  <div class="card modern-card">
    <div class="card-header modern-card-header">
      <div class="card-header-content">
        <div class="card-title-section">
          <h5 class="card-title">
            <i class="fas fa-edit me-2"></i>2. ìƒì„¸ ì…ë ¥
          </h5>
        </div>
        <div class="card-actions">
          <button type="button" class="btn btn-outline-info btn-sm" id="linkedLabelsBtn">
            <i class="fas fa-link me-1"></i>ì—°ê²°ëœ ì›ë£Œ({{ count_ingredient_relations|default:0 }}í’ˆëª©) ì¡°íšŒ
          </button>
          <button type="button" class="btn btn-outline-primary btn-sm" onclick="openPhrasePopup()" title="ë‚´ ë¬¸êµ¬ ê´€ë¦¬">
            <i class="fas fa-bookmark me-1"></i>ë‚´ ë¬¸êµ¬ ê´€ë¦¬
          </button>
        </div>
      </div>
    </div>
    <div class="card-body">
      <div class="layout-container" style="display: flex; gap: 10px; align-items: flex-start;">
        <div class="left-panel flex-grow-1 position-relative" style="flex-basis: 70%;">
          <form method="post" id="labelForm">
            {% csrf_token %}
            <!-- ë¼ë²¨ëª… í•„ë“œë¥¼ ì‹¤ì œ í¼ í•„ë“œë¡œ í¬í•¨ - name ì†ì„± í™•ì¸ -->
            <input type="hidden" name="my_label_name" id="my_label_name_hidden" value="{{ label.my_label_name|default:'' }}">
            <input type="hidden" id="hidden_food_group" name="food_group" value="{{ label.food_group }}">
            <input type="hidden" id="hidden_food_type" name="food_type" value="{{ label.food_type }}">
            <input type="hidden" id="hidden_preservation_type" name="preservation_type" value="{{ label.preservation_type }}">
            <input type="hidden" id="hidden_processing_method" name="processing_method" value="{{ label.processing_method }}">
            <input type="hidden" id="hidden_processing_condition" name="processing_condition" value="{{ label.processing_condition }}">
            <input type="hidden" name="chckd_label_nm" value="{{ label.chckd_label_nm|default:'N' }}">
            <input type="hidden" name="chckd_prdlst_dcnm" value="{{ label.chckd_prdlst_dcnm|default:'N' }}">
            <input type="hidden" name="chckd_prdlst_nm" value="{{ label.chckd_prdlst_nm|default:'Y' }}">
            <input type="hidden" name="chckd_ingredient_info" value="{{ label.chckd_ingredient_info|default:'N' }}">
            <input type="hidden" name="chckd_content_weight" value="{{ label.chckd_content_weight|default:'Y' }}">
            <input type="hidden" name="chckd_weight_calorie" value="{{ label.chckd_weight_calorie|default:'N' }}">
            <input type="hidden" name="chckd_prdlst_report_no" value="{{ label.chckd_prdlst_report_no|default:'N' }}">
            <input type="hidden" name="chckd_country_of_origin" value="{{ label.chckd_country_of_origin|default:'N' }}">
            <input type="hidden" name="chckd_storage_method" value="{{ label.chckd_storage_method|default:'N' }}">
            <input type="hidden" name="chckd_frmlc_mtrqlt" value="{{ label.chckd_frmlc_mtrqlt|default:'N' }}">
            <input type="hidden" name="chckd_bssh_nm" value="{{ label.chckd_bssh_nm|default:'Y' }}">
            <input type="hidden" name="chckd_distributor_address" value="{{ label.chckd_distributor_address|default:'N' }}">
            <input type="hidden" name="chckd_repacker_address" value="{{ label.chckd_repacker_address|default:'N' }}">
            <input type="hidden" name="chckd_importer_address" value="{{ label.chckd_importer_address|default:'N' }}">
            <input type="hidden" name="chckd_pog_daycnt" value="{{ label.chckd_pog_daycnt|default:'Y' }}">
            <input type="hidden" name="chckd_rawmtrl_nm_display" value="{{ label.chckd_rawmtrl_nm_display|default:'N' }}">
            <input type="hidden" name="chckd_cautions" value="{{ label.chckd_cautions|default:'N' }}">
            <input type="hidden" name="chckd_additional_info" value="{{ label.chckd_additional_info|default:'N' }}">
            <input type="hidden" name="chckd_nutrition_text" value="{{ label.chckd_nutrition_text|default:'N' }}">

            <!-- ì œí’ˆëª… | ì„±ë¶„ëª… ë° í•¨ëŸ‰ -->
            <div class="row g-2 mb-1">
              <div class="col-md-6">
                <div class="field-row-modern">
                  <div class="field-checkbox-section">
                    <input type="checkbox" id="chk_prdlst_nm" name="chk_prdlst_nm" class="field-checkbox-modern" 
                           {% if label.chckd_prdlst_nm == "Y" %}checked{% endif %}>
                    <label for="chk_prdlst_nm" class="field-label-modern">
                      <i class="fas fa-box me-1"></i>ì œí’ˆëª…
                    </label>
                  </div>
                  <div class="field-input-section">
                    <div class="input-container-modern">
                      <input type="text" name="prdlst_nm" class="form-control auto-expand" 
                             placeholder="ì œí’ˆëª…ì„ ì…ë ¥í•˜ì„¸ìš”" value="{{ form.prdlst_nm.value|default:'' }}">
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="field-row-modern">
                  <div class="field-checkbox-section">
                    <input type="checkbox" id="chk_ingredient_info" name="chk_ingredient_info" class="field-checkbox-modern" 
                           {% if label.chckd_ingredient_info == "Y" %}checked{% endif %}>
                    <label for="chk_ingredient_info" class="field-label-modern">
                      <i class="fas fa-percentage me-1"></i>íŠ¹ì •ì„±ë¶„ í•¨ëŸ‰
                    </label>
                  </div>
                  <div class="field-input-section">
                    <div class="input-container-modern">
                      <input type="text" name="ingredient_info" class="form-control auto-expand" 
                             placeholder="ì˜ˆ) ë ˆëª¬ì¦™ 5%" value="{{ form.ingredient_info.value|default:'' }}">
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <!-- ì‹í’ˆìœ í˜• | í’ˆëª©ë³´ê³ ë²ˆí˜¸ -->
            <div class="row g-3 mb-2">
              <div class="col-md-6">
                <div class="field-row-modern">
                  <div class="field-checkbox-section">
                    <input type="checkbox" id="chk_prdlst_dcnm" name="chk_prdlst_dcnm" class="field-checkbox-modern" 
                           {% if label.chckd_prdlst_dcnm == "Y" %}checked{% endif %}>
                    <label for="chk_prdlst_dcnm" class="field-label-modern">
                      <i class="fas fa-tags me-1"></i>ì‹í’ˆìœ í˜•
                    </label>
                  </div>
                  <div class="field-input-section">
                    <div class="input-container-modern">
                      <input type="text" name="prdlst_dcnm" class="form-control auto-expand" 
                             placeholder="ìƒë‹¨ì˜ ì‹í’ˆìœ í˜•ì„ ì°¸ê³ í•˜ì—¬ ì…ë ¥í•˜ì„¸ìš”" value="{{ form.prdlst_dcnm.value|default:'' }}">
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="field-row-modern">
                  <div class="field-checkbox-section">
                    <input type="checkbox" id="chk_prdlst_report_no" name="chk_prdlst_report_no" class="field-checkbox-modern" 
                           {% if label.chckd_prdlst_report_no == "Y" %}checked{% endif %}>
                    <label for="chk_prdlst_report_no" class="field-label-modern">
                      <i class="fas fa-barcode me-1"></i>í’ˆëª©ë³´ê³ ë²ˆí˜¸
                    </label>
                  </div>
                  <div class="field-input-section">
                    <div class="input-container-modern d-flex align-items-center gap-2">
                      <input type="text" name="prdlst_report_no" class="form-control flex-grow-1" 
                             placeholder="0000000000000 (13ìë¦¬)"
                             maxlength="15"
                             value="{{ form.prdlst_report_no.value|default:'' }}">
                      <button type="button" class="btn btn-outline-info btn-sm flex-shrink-0" 
                                id="verifyReportNoBtn" 
                                onclick="verifyReportNo(document.getElementById('label_id')?.value)"
                                title="API ì¤‘ë³µ ê²€ì‚¬ ë° ë²ˆí˜¸ ê·œì¹™ ê²€ì¦">
                          <i class="fas fa-search"></i><span>ì¤‘ë³µê²€ì¦</span>
                        </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>            <!-- ë‚´ìš©ëŸ‰ | ì›ì‚°ì§€ -->
            <div class="row g-3 mb-2">
              <div class="col-md-6">
                <div class="field-row-modern">
                  <div class="field-checkbox-section">
                    <input type="checkbox" id="chk_content_weight" name="chk_content_weight" class="field-checkbox-modern" 
                           {% if label.chckd_content_weight == "Y" or label.chckd_weight_calorie == "Y" %}checked{% endif %}>
                    <label class="field-label-modern">
                      <i class="fas fa-weight me-1"></i><span id="content_type_display">ë‚´ìš©ëŸ‰</span>
                    </label>
                    <input type="hidden" id="content_type_value" name="content_type" value="content_weight">
                  </div>
                  <div class="field-input-section">
                    <div class="input-container-modern">
                      <input type="text" id="content_weight_input" name="content_weight" class="form-control auto-expand" 
                             placeholder="ë‚´ìš©ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”" value="{{ form.content_weight.value|default:'' }}">
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="field-row-modern">
                  <div class="field-checkbox-section">
                    <input type="checkbox" id="chk_country_of_origin" name="chk_country_of_origin" class="field-checkbox-modern" 
                           {% if label.chckd_country_of_origin == "Y" %}checked{% endif %}>
                    <label for="chk_country_of_origin" class="field-label-modern">
                      <i class="fas fa-globe me-1"></i>ì›ì‚°ì§€
                    </label>
                  </div>
                  <div class="field-input-section">
                    <div class="input-container-modern">
                      <select name="country_of_origin" class="form-control select2-country" style="width: 100%;">
                        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        {% for c in country_list %}
                        <option value="{{ c.country_code2 }}" {% if form.country_of_origin.value == c.country_code2 %}selected{% endif %}>{{ c.country_name_ko }}</option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- ë³´ê´€ë°©ë²• | ìš©ê¸°.í¬ì¥ì¬ì§ˆ -->
            <div class="row g-3 mb-2">
              <div class="col-md-6">
                <div class="field-row-modern">
                  <div class="field-checkbox-section">
                    <input type="checkbox" id="chk_storage_method" name="chk_storage_method" class="field-checkbox-modern" 
                           {% if label.chckd_storage_method == "Y" %}checked{% endif %}>
                    <label for="chk_storage_method" class="field-label-modern">
                      <i class="fas fa-thermometer-half me-1"></i>ë³´ê´€ë°©ë²•
                    </label>
                  </div>
                  <div class="field-input-section">
                    <div class="input-container-modern">
                      <input type="text" name="storage_method" class="form-control auto-expand" 
                             placeholder="ë³´ê´€ë°©ë²•ì„ ì…ë ¥í•˜ê±°ë‚˜ ë‚´ë¬¸êµ¬ë¥¼ ì„ íƒí•˜ì„¸ìš”" value="{{ form.storage_method.value|default:'' }}">
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="field-row-modern">
                  <div class="field-checkbox-section">
                    <input type="checkbox" id="chk_frmlc_mtrqlt" name="chk_frmlc_mtrqlt" class="field-checkbox-modern" 
                           {% if label.chckd_frmlc_mtrqlt == "Y" %}checked{% endif %}>
                    <label for="chk_frmlc_mtrqlt" class="field-label-modern">
                      <i class="fas fa-cube me-1"></i>ìš©ê¸°.í¬ì¥ì¬ì§ˆ
                    </label>
                  </div>
                  <div class="field-input-section">
                    <div class="input-container-modern">
                      <input type="text" name="frmlc_mtrqlt" class="form-control auto-expand" 
                             placeholder="ìš©ê¸°.í¬ì¥ì¬ì§ˆì„ ì…ë ¥í•˜ê±°ë‚˜ ë‚´ë¬¸êµ¬ë¥¼ ì„ íƒí•˜ì„¸ìš”" value="{{ form.frmlc_mtrqlt.value|default:'' }}">
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- ì œì¡°ì› ì†Œì¬ì§€ -->
            <div class="row g-3 mb-2">
              <div class="col-12">
                <div class="field-row-modern">
                  <div class="field-checkbox-section">
                    <input type="checkbox" id="chk_bssh_nm" name="chk_bssh_nm" class="field-checkbox-modern" 
                           {% if label.chckd_bssh_nm == "Y" %}checked{% endif %}>
                    <label for="chk_bssh_nm" class="field-label-modern">
                      <i class="fas fa-building me-1"></i>ì œì¡°ì› ì†Œì¬ì§€
                    </label>
                    <button type="button" class="btn btn-outline-primary btn-sm ms-2" 
                              id="toggleManufacturerBtn"
                              data-bs-toggle="collapse" data-bs-target="#other-manufacturers" aria-expanded="false"
                              aria-controls="other-manufacturers"
                              title="ì¶”ê°€ ì œì¡°ì› ì •ë³´">
                        <i class="fas fa-chevron-down"></i>
                      </button>
                  </div>
                  <div class="field-input-section">
                    <div class="input-container-modern">
                      <input type="text" name="bssh_nm" class="form-control auto-expand" 
                             placeholder="ì œì¡°ì›ì„ ì…ë ¥í•˜ê±°ë‚˜ ë‚´ë¬¸êµ¬ë¥¼ ì„ íƒí•˜ì„¸ìš”" value="{{ form.bssh_nm.value|default:'' }}">
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <!-- ì ‘í˜ ì˜ì—­ -->
            <div class="collapse mb-2" id="other-manufacturers">
              <div class="row g-3 mb-2">
                <div class="col-12">
                  <div class="field-row-modern">
                    <div class="field-checkbox-section">
                      <input type="checkbox" id="chk_distributor_address" name="chk_distributor_address" class="field-checkbox-modern" 
                             {% if label.chckd_distributor_address == "Y" %}checked{% endif %}>
                      <label for="chk_distributor_address" class="field-label-modern">
                        <i class="fas fa-truck me-1"></i>ìœ í†µì „ë¬¸íŒë§¤ì›
                      </label>
                    </div>
                    <div class="field-input-section">
                      <div class="input-container-modern">
                        <input type="text" name="distributor_address" class="form-control auto-expand" 
                               placeholder="ìœ í†µì „ë¬¸íŒë§¤ì›ì„ ì…ë ¥í•˜ê±°ë‚˜ ë‚´ë¬¸êµ¬ë¥¼ ì„ íƒí•˜ì„¸ìš”"
                               value="{{ form.distributor_address.value|default:'' }}">
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="row g-3 mb-2">
                <div class="col-12">
                  <div class="field-row-modern">
                    <div class="field-checkbox-section">
                      <input type="checkbox" id="chk_repacker_address" name="chk_repacker_address" class="field-checkbox-modern" 
                             {% if label.chckd_repacker_address == "Y" %}checked{% endif %}>
                      <label for="chk_repacker_address" class="field-label-modern">
                        <i class="fas fa-box-open me-1"></i>ì†Œë¶„ì›
                      </label>
                    </div>
                    <div class="field-input-section">
                      <div class="input-container-modern">
                        <input type="text" name="repacker_address" class="form-control auto-expand" 
                               placeholder="ì†Œë¶„ì›ì„ ì…ë ¥í•˜ê±°ë‚˜ ë‚´ë¬¸êµ¬ë¥¼ ì„ íƒí•˜ì„¸ìš”"
                               value="{{ form.repacker_address.value|default:'' }}">
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="row g-3 mb-2">
                <div class="col-12">
                  <div class="field-row-modern">
                    <div class="field-checkbox-section">
                      <input type="checkbox" id="chk_importer_address" name="chk_importer_address" class="field-checkbox-modern" 
                             {% if label.chckd_importer_address == "Y" %}checked{% endif %}>
                      <label for="chk_importer_address" class="field-label-modern">
                        <i class="fas fa-ship me-1"></i>ìˆ˜ì…ì›
                      </label>
                    </div>
                    <div class="field-input-section">
                      <div class="input-container-modern">
                        <input type="text" name="importer_address" class="form-control auto-expand" 
                               placeholder="ìˆ˜ì…ì›ì„ ì…ë ¥í•˜ê±°ë‚˜ ë‚´ë¬¸êµ¬ë¥¼ ì„ íƒí•˜ì„¸ìš”"
                               value="{{ form.importer_address.value|default:'' }}">
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- ì†Œë¹„ê¸°í•œ/í’ˆì§ˆìœ ì§€ê¸°í•œ/ì œì¡°ì—°ì›”ì¼/ìƒì‚°ì—°ë„ -->
            <div class="row g-3 mb-2">
              <div class="col-12">
                <div class="field-row-modern">
                  <div class="field-checkbox-section">
                    <input type="checkbox" id="chk_pog_daycnt" name="chk_pog_daycnt" class="field-checkbox-modern" 
                           {% if label.chckd_pog_daycnt == "Y" %}checked{% endif %}>
                    <label class="field-label-modern">
                      <i class="fas fa-calendar me-1"></i>
                      <select name="date_option" class="form-select form-select-sm ms-1" style="width: auto; display: inline-block;">
                        <option value="ì†Œë¹„ê¸°í•œ" {% if form.date_option.value == "ì†Œë¹„ê¸°í•œ" or not form.date_option.value %}selected{% endif %}>ì†Œë¹„ê¸°í•œ</option>
                        <option value="í’ˆì§ˆìœ ì§€ê¸°í•œ" {% if form.date_option.value == "í’ˆì§ˆìœ ì§€ê¸°í•œ" %}selected{% endif %}>í’ˆì§ˆìœ ì§€ê¸°í•œ</option>
                        <option value="ì œì¡°ì—°ì›”ì¼" {% if form.date_option.value == "ì œì¡°ì—°ì›”ì¼" %}selected{% endif %}>ì œì¡°ì—°ì›”ì¼</option>
                        <option value="ìƒì‚°ì—°ë„" {% if form.date_option.value == "ìƒì‚°ì—°ë„" %}selected{% endif %}>ìƒì‚°ì—°ë„</option>
                      </select>
                    </label>
                  </div>
                  <div class="field-input-section">
                    <div class="input-container-modern">
                      <input type="text" name="pog_daycnt" class="form-control auto-expand" 
                             placeholder="ì†Œë¹„ê¸°í•œ ë“±ì„ ì…ë ¥í•˜ê±°ë‚˜ ë‚´ë¬¸êµ¬ë¥¼ ì„ íƒí•˜ì„¸ìš”" value="{{ form.pog_daycnt.value|default:'' }}">
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- ì›ì¬ë£Œëª…(í‘œì‹œ) -->
            <div class="row g-3 mb-2">
              <div class="col-12">
                <div class="field-row-modern">
                  <div class="field-checkbox-section">
                    <input type="checkbox" id="chk_rawmtrl_nm_display" name="chk_rawmtrl_nm_display" class="field-checkbox-modern" 
                           {% if label.chckd_rawmtrl_nm_display == "Y" %}checked{% endif %}>
                    <div class="label-button-container">
                      <label for="chk_rawmtrl_nm_display" class="field-label-modern">
                        <i class="fas fa-list me-1"></i>ì›ì¬ë£Œëª…(í‘œì‹œ)
                      </label>
                      <button type="button" class="btn btn-outline-primary btn-sm" 
                                onclick="handleIngredientPopup()"
                                title="í‘œë¡œ ì…ë ¥">
                          <i class="fas fa-table me-1"></i>í‘œë¡œ ì…ë ¥
                        </button>
                    </div>
                  </div>
                  <div class="field-input-section">
                    <div class="input-container-modern">
                      <textarea name="rawmtrl_nm_display" class="form-control auto-expand textarea" rows="4" 
                                placeholder="ì›ì¬ë£Œëª…(í‘œì‹œ)ì„ ì…ë ¥í•˜ì„¸ìš”">{{ form.rawmtrl_nm_display.value|default:form.rawmtrl_nm.value|default:'' }}</textarea>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <!-- ì›ì¬ë£Œëª… (ì°¸ê³ ) -->
            {% if has_ingredient_relations %}
            <div class="row g-3 mb-2" id="rawmtrl_nm_section">
              <div class="col-12">
                <div class="field-row-modern">
                  <div class="field-checkbox-section">
                    <input type="checkbox" id="chk_rawmtrl_nm" name="chk_rawmtrl_nm" class="field-checkbox-modern" 
                           {% if label.chckd_rawmtrl_nm == "Y" %}checked{% endif %} disabled>
                    <label for="chk_rawmtrl_nm" class="field-label-modern">
                      <i class="fas fa-info-circle me-1"></i>ì›ì¬ë£Œëª…(ì°¸ê³ )
                    </label>
                  </div>
                  <div class="field-input-section">
                    <div class="input-container-modern">
                      <textarea name="rawmtrl_nm" class="form-control auto-expand textarea disabled-textarea" rows="4" 
                                placeholder="ì›ì¬ë£Œëª…ì„ ì…ë ¥í•˜ì„¸ìš”" disabled readonly>{{ form.rawmtrl_nm.value|default:'' }}</textarea>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            {% endif %}

            <!-- ì£¼ì˜ì‚¬í•­ -->
            <div class="row g-3 mb-2">
              <div class="col-12">
                <div class="field-row-modern">
                  <div class="field-checkbox-section">
                    <input type="checkbox" id="chk_cautions" name="chk_cautions" class="field-checkbox-modern" 
                           {% if label.chckd_cautions == "Y" %}checked{% endif %}>
                    <label for="chk_cautions" class="field-label-modern">
                      <i class="fas fa-exclamation-triangle me-1"></i>ì£¼ì˜ì‚¬í•­
                    </label>
                  </div>
                  <div class="field-input-section">
                    <div class="input-container-modern">
                      <textarea name="cautions" class="form-control auto-expand textarea" rows="4" 
                                placeholder="ì£¼ì˜ì‚¬í•­ì„ ì…ë ¥í•˜ê±°ë‚˜ ë‚´ë¬¸êµ¬ë¥¼ ì„ íƒí•˜ì„¸ìš”. ì—¬ëŸ¬ í•­ëª©ì„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.">{{ form.cautions.value|default:'' }}</textarea>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- ê¸°íƒ€ í‘œì‹œì‚¬í•­ -->
            <div class="row g-3 mb-2">
              <div class="col-12">
                <div class="field-row-modern">
                  <div class="field-checkbox-section">
                    <input type="checkbox" id="chk_additional_info" name="chk_additional_info" class="field-checkbox-modern" 
                           {% if label.chckd_additional_info == "Y" %}checked{% endif %}>
                    <label for="chk_additional_info" class="field-label-modern">
                      <i class="fas fa-plus-circle me-1"></i>ê¸°íƒ€í‘œì‹œì‚¬í•­
                    </label>
                  </div>
                  <div class="field-input-section">
                    <div class="input-container-modern">
                      <textarea name="additional_info" class="form-control auto-expand textarea" rows="4" 
                                placeholder="ê¸°íƒ€ í‘œì‹œì‚¬í•­ì„ ì…ë ¥í•˜ê±°ë‚˜ ë‚´ë¬¸êµ¬ë¥¼ ì„ íƒí•˜ì„¸ìš”. ì—¬ëŸ¬ í•­ëª©ì„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.">{{ form.additional_info.value|default:'' }}</textarea>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- ì˜ì–‘ì„±ë¶„ -->
            <div class="row g-3 mb-2">
              <div class="col-12">
                <div class="field-row-modern">
                  <div class="field-checkbox-section">
                    <input type="checkbox" id="chk_nutrition_text" name="chk_nutrition_text" class="field-checkbox-modern" 
                           {% if label.chckd_nutrition_text == "Y" %}checked{% endif %} style="display: none;">
                    <div class="label-button-container">
                      <label for="chk_nutrition_text" class="field-label-modern">
                        <i class="fas fa-calculator me-1"></i>ì˜ì–‘ì„±ë¶„
                      </label>
                      <button type="button" class="btn btn-outline-success btn-sm" 
                                onclick="handleNutritionTablePopup()"
                                title="ì˜ì–‘ì„±ë¶„í‘œ">
                          <i class="fas fa-table me-1"></i>ì˜ì–‘ì„±ë¶„í‘œ
                        </button>
                    </div>
                  </div>
                  <div class="field-input-section">
                    <div class="input-container-modern">
                      <textarea name="nutrition_text" class="form-control auto-expand textarea" rows="5" 
                                placeholder="ì˜ì–‘ì„±ë¶„ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”">{{ form.nutrition_text.value|default:'' }}</textarea>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- ì˜ì–‘ì„±ë¶„ hidden í•„ë“œ -->
            <div style="display: none;">
              <input type="hidden" name="serving_size" value="{{ form.serving_size.value|default:'' }}">
              <input type="hidden" name="serving_size_unit" value="{{ form.serving_size_unit.value|default:'' }}">
              <input type="hidden" name="units_per_package" value="{{ form.units_per_package.value|default:'' }}">
              <input type="hidden" name="nutrition_display_unit" value="{{ form.nutrition_display_unit.value|default:'' }}">
              <!-- ì˜ì–‘ì„±ë¶„ í‘œì‹œ ìŠ¤íƒ€ì¼ ë° ê¸°ì¤€ -->
              <input type="hidden" name="nutrition_style" value="{{ form.nutrition_style.value|default:'' }}">
              <input type="hidden" name="nutrition_display_type" value="{{ form.nutrition_display_type.value|default:'' }}">
              <input type="hidden" name="nutrition_base_amount" value="{{ form.nutrition_base_amount.value|default:'' }}">
              <input type="hidden" name="nutrition_base_amount_unit" value="{{ form.nutrition_base_amount_unit.value|default:'' }}">
              <!-- ì˜ì–‘ì„±ë¶„ ê°’ í•„ë“œ -->
              <input type="hidden" name="calories" value="{{ form.calories.value|default:'' }}">
              <input type="hidden" name="calories_unit" value="{{ form.calories_unit.value|default:'' }}">
              <input type="hidden" name="natriums" value="{{ form.natriums.value|default:'' }}">
              <input type="hidden" name="natriums_unit" value="{{ form.natriums_unit.value|default:'' }}">
              <input type="hidden" name="carbohydrates" value="{{ form.carbohydrates.value|default:'' }}">
              <input type="hidden" name="carbohydrates_unit" value="{{ form.carbohydrates_unit.value|default:'' }}">
              <input type="hidden" name="sugars" value="{{ form.sugars.value|default:'' }}">
              <input type="hidden" name="sugars_unit" value="{{ form.sugars_unit.value|default:'' }}">
              <input type="hidden" name="fats" value="{{ form.fats.value|default:'' }}">
              <input type="hidden" name="fats_unit" value="{{ form.fats_unit.value|default:'' }}">
              <input type="hidden" name="trans_fats" value="{{ form.trans_fats.value|default:'' }}">
              <input type="hidden" name="trans_fats_unit" value="{{ form.trans_fats_unit.value|default:'' }}">
              <input type="hidden" name="saturated_fats" value="{{ form.saturated_fats.value|default:'' }}">
              <input type="hidden" name="saturated_fats_unit" value="{{ form.saturated_fats_unit.value|default:'' }}">
              <input type="hidden" name="cholesterols" value="{{ form.cholesterols.value|default:'' }}">
              <input type="hidden" name="cholesterols_unit" value="{{ form.cholesterols_unit.value|default:'' }}">
              <input type="hidden" name="proteins" value="{{ form.proteins.value|default:'' }}">
              <input type="hidden" name="proteins_unit" value="{{ form.proteins_unit.value|default:'' }}">
            </div>
          </form>
        </div>
      </div>    
    </div>
  </div>
</div>

<!-- OCR ì—…ë¡œë“œ ëª¨ë‹¬ -->
<div class="modal fade" id="ocrUploadModal" tabindex="-1" aria-labelledby="ocrUploadModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="ocrUploadModalLabel">
          <i class="fas fa-camera me-2"></i>í‘œì‹œì‚¬í•­ ì‚¬ì§„ìœ¼ë¡œ ìë™ ì…ë ¥
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- ì—…ë¡œë“œ ë°©ì‹ ì„ íƒ íƒ­ -->
        <ul class="nav nav-tabs mb-3" id="uploadTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="camera-tab" data-bs-toggle="tab" data-bs-target="#camera-pane" type="button" role="tab">
              <i class="fas fa-camera me-2"></i>ì‚¬ì§„ ì´¬ì˜
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="file-tab" data-bs-toggle="tab" data-bs-target="#file-pane" type="button" role="tab">
              <i class="fas fa-image me-2"></i>ì´ë¯¸ì§€ íŒŒì¼
            </button>
          </li>
        </ul>

        <div class="tab-content" id="uploadTabsContent">
          <!-- ì‚¬ì§„ ì´¬ì˜ íƒ­ -->
          <div class="tab-pane fade show active" id="camera-pane" role="tabpanel">
            <div class="upload-area text-center p-4 border border-dashed rounded" 
                 id="uploadArea" 
                 style="border-color: #dee2e6; background-color: #f8f9fa; cursor: pointer;">
              <div class="upload-placeholder">
                <i class="fas fa-camera fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">í‘œì‹œì‚¬í•­ ì‚¬ì§„ì„ ì´¬ì˜í•˜ì„¸ìš”</h5>
                <p class="text-muted small mb-0">
                  ë“œë˜ê·¸ ì•¤ ë“œë¡­í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì‚¬ì§„ì„ ì´¬ì˜í•˜ì„¸ìš”<br>
                  JPG, PNG íŒŒì¼ ì§€ì› (ìµœëŒ€ 5MB)
                </p>
              </div>
              <input type="file" id="imageInput" accept="image/*" capture="environment" style="display: none;">
            </div>
          </div>

          <!-- ì´ë¯¸ì§€ íŒŒì¼ íƒ­ -->
          <div class="tab-pane fade" id="file-pane" role="tabpanel">
            <div class="upload-area text-center p-4 border border-dashed rounded" 
                 id="fileUploadArea" 
                 style="border-color: #dee2e6; background-color: #f8f9fa; cursor: pointer;">
              <div class="upload-placeholder">
                <i class="fas fa-image fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">í‘œì‹œì‚¬í•­ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”</h5>
                <p class="text-muted small mb-0">
                  í´ë¦­í•˜ì—¬ ì´ë¯¸ì§€ íŒŒì¼ì„ ì„ íƒí•˜ê±°ë‚˜<br>
                  ë“œë˜ê·¸ ì•¤ ë“œë¡­ìœ¼ë¡œ ì—…ë¡œë“œí•˜ì„¸ìš”<br>
                  JPG, PNG, GIF, BMP íŒŒì¼ ì§€ì› (ìµœëŒ€ 10MB)
                </p>
                <button type="button" class="btn btn-outline-primary mt-3" onclick="document.getElementById('fileInput').click()">
                  <i class="fas fa-folder-open me-2"></i>íŒŒì¼ ì„ íƒ
                </button>
              </div>
              <input type="file" id="fileInput" accept="image/*" style="display: none;">
            </div>
          </div>
        </div>
        
        <!-- ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° -->
        <div id="imagePreview" style="display: none;">
          <div class="text-center mb-3">
            <img id="previewImg" class="img-fluid border rounded" style="max-height: 300px;">
          </div>
          <div class="d-flex justify-content-between">
            <button type="button" class="btn btn-outline-secondary" onclick="resetUpload()">
              <i class="fas fa-redo me-1"></i>ë‹¤ì‹œ ì„ íƒ
            </button>
            <button type="button" class="btn btn-primary" onclick="processOCR()" id="processBtn">
              <span id="processText">
                <i class="fas fa-magic me-1"></i>í…ìŠ¤íŠ¸ ì¶”ì¶œí•˜ê¸°
              </span>
              <span id="processSpinner" class="spinner-border spinner-border-sm ms-2" style="display: none;"></span>
            </button>
          </div>
        </div>
        
        <!-- OCR ê²°ê³¼ í‘œì‹œ -->
        <div id="ocrResults" style="display: none;">
          <div class="mb-3">
            <h6><i class="fas fa-file-text me-2"></i>ì¶”ì¶œëœ í…ìŠ¤íŠ¸</h6>
            <div class="border rounded p-3 bg-light" style="max-height: 150px; overflow-y: auto;">
              <pre id="extractedText" class="mb-0 small" style="white-space: pre-wrap;"></pre>
            </div>
          </div>
          
          <!-- í•„ë“œë³„ ë§¤í•‘ ê²°ê³¼ -->
          <div class="mb-3">
            <h6><i class="fas fa-list-check me-2"></i>ìë™ ë¶„ë¥˜ ê²°ê³¼</h6>
            <div id="fieldMappings" class="border rounded p-2" style="max-height: 300px; overflow-y: auto;">
              <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë  í•„ë“œ ë§¤í•‘ ê²°ê³¼ -->
            </div>
          </div>
          
          <div class="d-flex justify-content-between">
            <button type="button" class="btn btn-outline-secondary" onclick="resetUpload()">
              <i class="fas fa-arrow-left me-1"></i>ì²˜ìŒìœ¼ë¡œ
            </button>
            <div>
              <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">ì·¨ì†Œ</button>
              <button type="button" class="btn btn-success" onclick="applyOCRResults()">
                <i class="fas fa-check me-1"></i>ì ìš©í•˜ê¸°
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- OCR ê´€ë ¨ ìŠ¤íƒ€ì¼ -->
<style>
.upload-area {
  transition: all 0.3s ease;
  min-height: 200px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.upload-area:hover {
  background-color: #e9ecef !important;
  border-color: #adb5bd !important;
}

.upload-area.dragover {
  background-color: #cff4fc !important;
  border-color: #0dcaf0 !important;
}

.field-mapping-item {
  transition: all 0.2s ease;
}

.field-mapping-item:hover {
  background-color: #f8f9fa;
}

.confidence-badge {
  font-size: 0.75em;
}

.confidence-high {
  background-color: #28a745 !important;
}

.confidence-medium {
  background-color: #ffc107 !important;
}

.confidence-low {
  background-color: #dc3545 !important;
}

#extractedText {
  font-family: 'Courier New', monospace;
  font-size: 0.85em;
  line-height: 1.3;
}

/* OCR íƒ­ ìŠ¤íƒ€ì¼ */
.nav-tabs .nav-link {
  border: 1px solid transparent;
  border-top-left-radius: 0.375rem;
  border-top-right-radius: 0.375rem;
  color: #6c757d;
  transition: all 0.3s ease;
}

.nav-tabs .nav-link:hover {
  border-color: #e9ecef #e9ecef #dee2e6;
  color: #0d6efd;
}

.nav-tabs .nav-link.active {
  color: #0d6efd;
  background-color: #fff;
  border-color: #dee2e6 #dee2e6 #fff;
  font-weight: 600;
}

.nav-tabs .nav-link i {
  margin-right: 0.5rem;
}

/* íŒŒì¼ ì—…ë¡œë“œ ì˜ì—­ ê°œì„  */
#fileUploadArea .upload-placeholder {
  padding: 2rem 1rem;
}

#fileUploadArea .btn {
  margin-top: 1rem;
  min-width: 120px;
}

/* ëª¨ë‹¬ í¬ê¸° ì¡°ì • */
@media (min-width: 992px) {
  .modal-lg {
    max-width: 900px;
  }
}

/* ì—…ë¡œë“œ ì˜ì—­ ë°˜ì‘í˜• */
@media (max-width: 768px) {
  .upload-area {
    min-height: 150px;
  }
  
  .upload-placeholder h5 {
    font-size: 1.1rem;
  }
  
  .upload-placeholder p {
    font-size: 0.85rem;
  }
}

/* í†µí•© ì¶”ì²œ ì‹œìŠ¤í…œ ìŠ¤íƒ€ì¼ */
.integrated-recommendations .hover-highlight:hover {
  background-color: #f8f9fa !important;
  border-color: #007bff !important;
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(0,123,255,0.15);
}

.integrated-recommendations .recommendation-item {
  transition: all 0.2s ease;
  border: 1px solid #dee2e6;
}

.integrated-recommendations .card-header {
  font-size: 0.9rem;
  font-weight: 600;
}

.integrated-recommendations .badge {
  background-color: rgba(255,255,255,0.2) !important;
  color: inherit !important;
}

.integrated-recommendations .recommendation-text {
  font-size: 0.9rem;
  line-height: 1.3;
  margin-bottom: 2px;
}

.integrated-recommendations .btn-sm {
  padding: 0.25rem 0.5rem;
  font-size: 0.75rem;
}

.integrated-recommendations .card {
  border: none;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  margin-bottom: 1rem;
}

.integrated-recommendations .card-body {
  background-color: #fafafa;
}
</style>
{% endblock %}