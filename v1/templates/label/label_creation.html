{% extends 'base.html' %}
{% load static %}

{% block title %}í‘œì‹œì‚¬í•­ ì‘ì„±{% endblock %}

{% block content %}
<!-- jQuery & Select2 -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<!-- ì™¸ë¶€ CSS ë° JS íŒŒì¼ ë¡œë“œ -->
<link href="{% static 'css/style.css' %}?v={{ STATIC_BUILD_DATE }}" rel="stylesheet" />
<link href="{% static 'css/label_creation_modern.css' %}?v={{ STATIC_BUILD_DATE }}" rel="stylesheet" />

<!-- í´ë¦­ ì „ìš© í•„ë“œ ìŠ¤íƒ€ì¼ì€ CSS íŒŒì¼ì—ì„œ ê´€ë¦¬ -->
<style>
.readonly-field-info {
    color: #6c757d;
    font-size: 0.875rem;
}

.readonly-field-info i {
    color: #0d6efd;
}

/* HTML ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ì´ CSS íŒŒì¼ ìŠ¤íƒ€ì¼ì„ ëŒ€ì²´í•¨ */

/* ì˜ì–‘ì„±ë¶„ í‘œë¡œ ì…ë ¥ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
.btn-xs {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
    line-height: 1.2;
    border-radius: 0.25rem;
}

.label-button-container {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 0.25rem;
}
</style>

<!-- ìì£¼ ì‚¬ìš©í•˜ëŠ” ë¬¸êµ¬ ë°ì´í„° ì‚½ì… -->
<script id="phrases-data" type="application/json">
  {{ phrases_json|safe }}
</script>
<script id="regulations-data" type="application/json">
    {{ regulations_json|safe }}
</script>

<!-- ê¸°ë³¸ JavaScript íŒŒì¼ë“¤ -->
<script src="{% static 'js/label/label_creation.js' %}?v={{ STATIC_BUILD_DATE }}"></script>
<script src="{% static 'js/label/ocr_processor.js' %}?v={{ STATIC_BUILD_DATE }}"></script>

<!-- ê¸°ë³¸ ì¶”ì²œ ì‹œìŠ¤í…œ -->
<script src="{% static 'js/label/recommendation_system.js' %}?v={{ STATIC_BUILD_DATE }}"></script>

<!-- í…ŒìŠ¤íŠ¸ ë„êµ¬ ì œê±°ë¨ -->

<!-- ğŸ”§ ì§ì ‘ ì „ì—­ í•¨ìˆ˜ ì •ì˜ (ë‹¨ìˆœí•˜ê³  í™•ì‹¤í•œ ë°©ë²•) -->
<script>
// ê°œë°œ ì¤‘ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
function showDevelopmentMessage() {
    alert('ğŸš€ Coming Soon~! ì‚¬ì§„ìœ¼ë¡œ ìë™ ì…ë ¥ ê¸°ëŠ¥ì„ ì—´ì‹¬íˆ ê°œë°œ ì¤‘ì…ë‹ˆë‹¤! ğŸ˜Š');
    return false;
}

// ë‚´ ë¬¸êµ¬ ê´€ë¦¬ í•¨ìˆ˜ ì œê±°ë¨ (ê¸°ë³¸ ì¶”ì²œ ì‹œìŠ¤í…œìœ¼ë¡œ ëŒ€ì²´)

// ğŸ”— íŒì—… ì°¨ë‹¨ í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ (ê°€ì¥ ë¨¼ì € ì •ì˜)

// ğŸ”— ì›ì¬ë£Œëª… í•„ë“œ ê°•ì œ ì—°ê²° í•¨ìˆ˜
function forceRawMaterialFieldConnection() {
    console.log('ğŸ”— ì›ì¬ë£Œëª… í•„ë“œ ê°•ì œ ì—°ê²° ì‹œì‘');
    const rawMaterialField = document.getElementById('rawmtrl_nm');
    
    if (!rawMaterialField) {
        console.error('âŒ ì›ì¬ë£Œëª… í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
        return false;
    }
    
    console.log('âœ… ì›ì¬ë£Œëª… í•„ë“œ ë°œê²¬:', rawMaterialField);
    
    // ê°•ë ¥í•œ í´ë¦­ ì´ë²¤íŠ¸ ì—°ê²°
    rawMaterialField.addEventListener('click', function(e) {
        console.log('ğŸ–±ï¸ ì›ì¬ë£Œëª… í•„ë“œ í´ë¦­ë¨!');
        e.preventDefault();
        e.stopPropagation();
        
        // ë¼ë²¨ ID í™•ì¸
        const labelId = document.getElementById('label_id')?.value || '';
        console.log('ğŸ·ï¸ ì‚¬ìš©í•  ë¼ë²¨ ID:', labelId);
        
        // ê°„ë‹¨í•œ í™•ì¸ í›„ ë°”ë¡œ íŒì—… ì—´ê¸°
        if (confirm('ì›ì¬ë£Œ í‘œë¡œ ì…ë ¥ íŒì—…ì„ ì—´ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            openIngredientPopupDirect(labelId);
        }
    }, true); // useCapture = trueë¡œ í™•ì‹¤í•˜ê²Œ
    
    // í¬ì»¤ìŠ¤ ì´ë²¤íŠ¸ë„ ì—°ê²°
    rawMaterialField.addEventListener('focus', function(e) {
        console.log('ğŸ¯ ì›ì¬ë£Œëª… í•„ë“œ í¬ì»¤ìŠ¤');
        e.preventDefault();
        rawMaterialField.blur();
        setTimeout(() => {
            rawMaterialField.click();
        }, 10);
    }, true);
    
    console.log('âœ… ì›ì¬ë£Œëª… í•„ë“œ ì´ë²¤íŠ¸ ì—°ê²° ì™„ë£Œ');
    return true;
}

//  ì „ì²´ ìƒí™© ì§„ë‹¨ í•¨ìˆ˜ (ê°•í™”ëœ ë²„ì „)
function diagnoseAll() {
    console.log('ğŸ©º ì „ì²´ ìƒí™© ì§„ë‹¨ ì‹œì‘');
    console.log('ğŸ“‹ ì „ì—­ í•¨ìˆ˜ë“¤ ìƒíƒœ:', {
        testPopupBlocking: typeof testPopupBlocking,
        testIngredientPopup: typeof testIngredientPopup,
        testRawMaterialClick: typeof testRawMaterialClick,
        forceRawMaterialFieldConnection: typeof forceRawMaterialFieldConnection,
        forceConnectRawMaterialField: typeof forceConnectRawMaterialField
    });
    
    console.log('ğŸ” ì¤‘ìš” ìš”ì†Œë“¤ í™•ì¸:');
    const rawmtrlField = document.getElementById('rawmtrl_nm');
    const nutritionField = document.getElementById('nutrition_text');
    const labelIdField = document.getElementById('label_id');
    
    console.log('  - rawmtrl_nm í•„ë“œ:', rawmtrlField);
    console.log('  - nutrition_text í•„ë“œ:', nutritionField);
    console.log('  - label_id í•„ë“œ:', labelIdField);
    console.log('  - label_id ê°’:', labelIdField?.value);
    
    // í•„ë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ í™•ì¸
    if (rawmtrlField) {
        console.log('  - rawmtrl_nm ì´ë²¤íŠ¸:', {
            hasClickSetup: rawmtrlField.hasAttribute('data-click-setup'),
            onclick: !!rawmtrlField.onclick,
            eventListeners: 'addEventListenerë¡œ ë“±ë¡ëœ ì´ë²¤íŠ¸ëŠ” í™•ì¸ ë¶ˆê°€'
        });
    }
    
    console.log('ğŸ”§ íŒì—… ê´€ë ¨ í•¨ìˆ˜ë“¤:', {
        openIngredientTablePopup: typeof window.openIngredientTablePopup,
        openPopup: typeof window.openPopup,
        handleIngredientPopup: typeof window.handleIngredientPopup,
        openIngredientPopupDirect: typeof openIngredientPopupDirect
    });
    
    return {
        functions: typeof testPopupBlocking !== 'undefined',
        rawmtrlField: !!rawmtrlField,
        nutritionField: !!nutritionField,
        labelId: labelIdField?.value
    };
}

// ğŸ”¥ ìµœì¢… í•´ê²°ì±…: ì˜¤ë²„ë ˆì´ ê¸°ë°˜ í´ë¦­ í•¸ë“¤ëŸ¬
function createFieldOverlays() {
    
    const fields = [
        { id: 'rawmtrl_nm', handler: 'rawmaterial', label: 'ì›ì¬ë£Œëª…(ì°¸ê³ )' },
        { id: 'nutrition_text', handler: 'nutrition', label: 'ì˜ì–‘ì„±ë¶„' }
    ];
    
    fields.forEach(fieldInfo => {
        const field = document.getElementById(fieldInfo.id);
        if (!field) {
            console.warn(`âš ï¸ ${fieldInfo.label} í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ`);
            return;
        }
        
        // ê¸°ì¡´ ì˜¤ë²„ë ˆì´ ì œê±°
        const existingOverlay = document.getElementById(`${fieldInfo.id}_overlay`);
        if (existingOverlay) {
            existingOverlay.remove();
        }
        
        // í•„ë“œì˜ ìœ„ì¹˜ì™€ í¬ê¸° ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const fieldRect = field.getBoundingClientRect();
        const fieldStyle = getComputedStyle(field);
        
        // ì˜¤ë²„ë ˆì´ DIV ìƒì„±
        const overlay = document.createElement('div');
        overlay.id = `${fieldInfo.id}_overlay`;
        overlay.style.cssText = `
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            cursor: pointer;
            z-index: 10;
            border-radius: ${fieldStyle.borderRadius};
        `;
        
        // í•„ë“œì˜ ë¶€ëª¨ ì»¨í…Œì´ë„ˆì— relative í¬ì§€ì…˜ ì„¤ì •
        const container = field.closest('.input-container-modern') || field.parentElement;
        if (container && getComputedStyle(container).position === 'static') {
            container.style.position = 'relative';
        }
        
        // ì˜¤ë²„ë ˆì´ë¥¼ í•„ë“œ ë‹¤ìŒì— ì‚½ì…
        field.parentNode.insertBefore(overlay, field.nextSibling);
        
        // í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë“±ë¡
        overlay.addEventListener('click', function(e) {
            console.log(`ğŸ–±ï¸ ${fieldInfo.label} ì˜¤ë²„ë ˆì´ í´ë¦­!`);
            e.preventDefault();
            e.stopPropagation();
            
            if (fieldInfo.handler === 'rawmaterial') {
                handleRawMaterialPopup();
            } else if (fieldInfo.handler === 'nutrition') {
                handleNutritionPopup();
            }
        });
        
        // í˜¸ë²„ íš¨ê³¼
        overlay.addEventListener('mouseenter', function() {
            field.style.backgroundColor = '#e9ecef';
            field.style.borderColor = '#86b7fe';
            overlay.style.backgroundColor = 'rgba(0, 123, 255, 0.05)';
        });
        
        overlay.addEventListener('mouseleave', function() {
            field.style.backgroundColor = '#f8f9fa';
            field.style.borderColor = '#e3e6f0';
            overlay.style.backgroundColor = 'transparent';
        });
        
        console.log(`âœ… ${fieldInfo.label} ì˜¤ë²„ë ˆì´ ìƒì„± ì™„ë£Œ`);
    });
}

// ì›ì¬ë£Œëª… íŒì—… í•¸ë“¤ëŸ¬
function handleRawMaterialPopup() {

    // 3ê°€ì§€ ì„ íƒì§€ ëª¨ë‹¬ ì°½ í‘œì‹œ
    showRawMaterialOptionsModal();
}

// ì›ì¬ë£Œëª… 3ê°€ì§€ ì„ íƒì§€ ëª¨ë‹¬ í•¨ìˆ˜
function showRawMaterialOptionsModal() {

    // ê¸°ì¡´ ëª¨ë‹¬ ì œê±°
    const existingModal = document.getElementById('rawMaterialOptionsModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    const modalHtml = `
        <div id="rawMaterialOptionsModal" style="
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        ">
            <div onclick="event.stopPropagation()" style="
                background: white;
                border-radius: 15px;
                padding: 35px;
                box-shadow: 0 6px 30px rgba(0, 0, 0, 0.3);
                text-align: center;
                max-width: 450px;
                width: 90%;
            ">
                <h4 style="margin-bottom: 25px; color: #333; font-size: 1.3rem;">ğŸ¥˜ ì›ì¬ë£Œëª…(ì°¸ê³ ) ì˜µì…˜</h4>
                <p style="margin-bottom: 30px; color: #666; line-height: 1.6; font-size: 0.95rem;">
                    ì›ì¬ë£Œëª… ì²˜ë¦¬ ë°©ë²•ì„ ì„ íƒí•´ì£¼ì„¸ìš”
                </p>
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <button type="button" onclick="selectRawMaterialOption('table')" style="
                        background: linear-gradient(135deg, #28a745, #20c997);
                        color: white;
                        border: none;
                        padding: 15px 25px;
                        border-radius: 10px;
                        font-size: 15px;
                        font-weight: 500;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        box-shadow: 0 3px 10px rgba(40, 167, 69, 0.3);
                    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 5px 15px rgba(40, 167, 69, 0.4)'" 
                       onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 3px 10px rgba(40, 167, 69, 0.3)'">
                        ğŸ“Š í‘œë¡œ ì…ë ¥ (íŒì—…)
                    </button>
                    <button type="button" onclick="selectRawMaterialOption('copy')" style="
                        background: linear-gradient(135deg, #007bff, #0056b3);
                        color: white;
                        border: none;
                        padding: 15px 25px;
                        border-radius: 10px;
                        font-size: 15px;
                        font-weight: 500;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        box-shadow: 0 3px 10px rgba(0, 123, 255, 0.3);
                    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 5px 15px rgba(0, 123, 255, 0.4)'" 
                       onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 3px 10px rgba(0, 123, 255, 0.3)'">
                        ğŸ“‹ ì›ì¬ë£Œëª…(í‘œì‹œ)ì— ë³µì‚¬
                    </button>
                    <button type="button" onclick="selectRawMaterialOption('cancel')" style="
                        background: linear-gradient(135deg, #6c757d, #5a6268);
                        color: white;
                        border: none;
                        padding: 15px 25px;
                        border-radius: 10px;
                        font-size: 15px;
                        font-weight: 500;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        box-shadow: 0 3px 10px rgba(108, 117, 125, 0.3);
                    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 5px 15px rgba(108, 117, 125, 0.4)'" 
                       onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 3px 10px rgba(108, 117, 125, 0.3)'">
                        âŒ ì·¨ì†Œ
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
    const modal = document.getElementById('rawMaterialOptionsModal');
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.remove();
        }
    });
    
    // ESC í‚¤ë¡œ ë‹«ê¸°
    const escHandler = function(e) {
        if (e.key === 'Escape') {
            modal.remove();
            document.removeEventListener('keydown', escHandler);
        }
    };
    document.addEventListener('keydown', escHandler);
}

// ì›ì¬ë£Œëª… ì„ íƒì§€ ì²˜ë¦¬ í•¨ìˆ˜
window.selectRawMaterialOption = function(option) {

    const modal = document.getElementById('rawMaterialOptionsModal');
    if (modal) {
        modal.remove();
    }
    
    if (option === 'table') {
        // í‘œë¡œ ì…ë ¥ íŒì—… ì—´ê¸°
        console.log('ğŸ“Š í‘œë¡œ ì…ë ¥ ì„ íƒë¨');
        const labelId = document.getElementById('label_id')?.value || '';
        
        try {
            if (typeof window.openIngredientTablePopup === 'function') {
                console.log('ğŸ“¦ openIngredientTablePopup í˜¸ì¶œ');
                window.openIngredientTablePopup();
            } else if (typeof window.openPopup === 'function') {
                console.log('ğŸ”§ openPopup ì§ì ‘ í˜¸ì¶œ');
                const url = `/label/ingredient-popup/?label_id=${labelId}`;
                window.openPopup(url, 'IngredientPopup', 1000, 800);
            } else {
                console.log('ğŸš€ ì§ì ‘ íŒì—… ì—´ê¸°');
                openIngredientPopupDirect(labelId);
            }
        } catch (error) {
            console.error('âŒ íŒì—… ì—´ê¸° ì˜¤ë¥˜:', error);
            alert('íŒì—…ì„ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + error.message);
        }
    } else if (option === 'copy') {
        // ì›ì¬ë£Œëª…(í‘œì‹œ)ì— ë³µì‚¬

        copyRawMaterialToDisplay();
    } else {
        console.log('âŒ ì·¨ì†Œ ì„ íƒë¨');
    }
};

// ì›ì¬ë£Œëª…(í‘œì‹œ) í•„ë“œë¡œ ë³µì‚¬í•˜ëŠ” í•¨ìˆ˜
function copyRawMaterialToDisplay() {
    const sourceField = document.getElementById('rawmtrl_nm');
    const targetField = document.querySelector('textarea[name="rawmtrl_nm_display"]');
    const targetCheckbox = document.getElementById('chk_rawmtrl_nm_display');
    
    if (sourceField && targetField) {
        const sourceValue = sourceField.value.trim();
        
        if (sourceValue) {
            // ë³µì‚¬ ë‚´ìš©ì´ ê¸¸ë©´ ì¶•ì•½í•´ì„œ í‘œì‹œ
            const previewText = sourceValue.length > 150 ? 
                sourceValue.substring(0, 150) + '...' : sourceValue;
            
            targetField.value = sourceValue;
            
            // ì›ì¬ë£Œëª…(í‘œì‹œ) ì²´í¬ë°•ìŠ¤ ìë™ ì²´í¬
            if (targetCheckbox) {
                targetCheckbox.checked = true;
            }
            
            // textarea ë†’ì´ ìë™ ì¡°ì ˆ
            if (window.updateTextareaHeight) {
                window.updateTextareaHeight(targetField);
            } else {
                targetField.style.height = '1px';
                targetField.style.height = Math.max(48, targetField.scrollHeight) + 'px';
            }
            
            // ì„±ê³µ ì•Œë¦¼ ëª¨ë‹¬
            showSuccessModal('ì›ì¬ë£Œëª…(í‘œì‹œ) í•„ë“œì— ë³µì‚¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!<br>ì²´í¬ë°•ìŠ¤ë„ ìë™ìœ¼ë¡œ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤.');
        } else {
            alert('ì›ì¬ë£Œëª…(ì°¸ê³ ) í•„ë“œì— ë³µì‚¬í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.\n\në¨¼ì € ì›ì¬ë£Œ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        }
    } else {
        console.error('âŒ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        alert('í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
    }
}

// ì„±ê³µ ì•Œë¦¼ ëª¨ë‹¬
function showSuccessModal(message) {
    const modalHtml = `
        <div id="successModal" style="
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10001;
        ">
            <div onclick="event.stopPropagation()" style="
                background: white;
                border-radius: 15px;
                padding: 30px;
                box-shadow: 0 6px 30px rgba(0, 0, 0, 0.3);
                text-align: center;
                max-width: 400px;
                width: 90%;
            ">
                <div style="font-size: 3rem; margin-bottom: 20px;">âœ…</div>
                <h4 style="margin-bottom: 20px; color: #28a745; font-size: 1.2rem;">ì™„ë£Œ!</h4>
                <p style="margin-bottom: 25px; color: #666; line-height: 1.5;">${message}</p>
                <button type="button" onclick="document.getElementById('successModal').remove()" style="
                    background: #28a745;
                    color: white;
                    border: none;
                    padding: 12px 25px;
                    border-radius: 8px;
                    font-size: 14px;
                    cursor: pointer;
                    transition: background 0.2s;
                " onmouseover="this.style.background='#1e7e34'" onmouseout="this.style.background='#28a745'">
                    í™•ì¸
                </button>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // 3ì´ˆ í›„ ìë™ ë‹«ê¸°
    setTimeout(() => {
        const modal = document.getElementById('successModal');
        if (modal) {
            modal.remove();
        }
    }, 3000);
}

// ì˜ì–‘ì„±ë¶„ íŒì—… í•¸ë“¤ëŸ¬
function handleNutritionPopup() {

    // ì˜ì–‘ì„±ë¶„ ê³„ì‚°ê¸° ëª¨ë‹¬ í‘œì‹œ
    if (typeof window.closeNutritionCalculatorModal === 'function') {
        // ê¸°ì¡´ ëª¨ë‹¬ ë‹«ê¸°
        window.closeNutritionCalculatorModal();
    }
    
    // ê°œì„ ëœ ëª¨ë‹¬ í‘œì‹œ
    setTimeout(() => {
        const modalHtml = `
            <div id="nutritionCalculatorModal" style="
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            ">
                <div onclick="event.stopPropagation()" style="
                    background: white;
                    border-radius: 15px;
                    padding: 35px;
                    box-shadow: 0 6px 30px rgba(0, 0, 0, 0.3);
                    text-align: center;
                    max-width: 450px;
                    width: 90%;
                ">
                    <div style="font-size: 3rem; margin-bottom: 20px;">ğŸ§®</div>
                    <h4 style="margin-bottom: 25px; color: #333; font-size: 1.3rem;">ì˜ì–‘ì„±ë¶„ ê³„ì‚°ê¸°</h4>
                    <p style="margin-bottom: 30px; color: #666; line-height: 1.6; font-size: 0.95rem;">
                        ì˜ì–‘ì„±ë¶„ ê³„ì‚°ê¸°ë¥¼ ì—´ì–´ì„œ<br>ì˜ì–‘ì •ë³´ë¥¼ ìë™ìœ¼ë¡œ ê³„ì‚°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
                    </p>
                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <button type="button" onclick="openNutritionCalculatorFromModal()" style="
                            background: linear-gradient(135deg, #28a745, #20c997);
                            color: white;
                            border: none;
                            padding: 15px 25px;
                            border-radius: 10px;
                            font-size: 15px;
                            font-weight: 500;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            box-shadow: 0 3px 10px rgba(40, 167, 69, 0.3);
                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 5px 15px rgba(40, 167, 69, 0.4)'" 
                           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 3px 10px rgba(40, 167, 69, 0.3)'">
                            âœ… ê³„ì‚°ê¸° ì—´ê¸°
                        </button>
                        <button type="button" onclick="closeNutritionCalculatorModal()" style="
                            background: linear-gradient(135deg, #6c757d, #5a6268);
                            color: white;
                            border: none;
                            padding: 15px 25px;
                            border-radius: 10px;
                            font-size: 15px;
                            font-weight: 500;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            box-shadow: 0 3px 10px rgba(108, 117, 125, 0.3);
                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 5px 15px rgba(108, 117, 125, 0.4)'" 
                           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 3px 10px rgba(108, 117, 125, 0.3)'">
                            âŒ ì·¨ì†Œ
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
        const modal = document.getElementById('nutritionCalculatorModal');
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                modal.remove();
            }
        });
        
        // ESC í‚¤ë¡œ ë‹«ê¸°
        const escHandler = function(e) {
            if (e.key === 'Escape') {
                modal.remove();
                document.removeEventListener('keydown', escHandler);
            }
        };
        document.addEventListener('keydown', escHandler);
    }, 100);
}

// ì „ì—­ í•¨ìˆ˜ë¡œ ë“±ë¡
window.createFieldOverlays = createFieldOverlays;
window.handleRawMaterialPopup = handleRawMaterialPopup;
window.handleNutritionPopup = handleNutritionPopup;
window.showRawMaterialOptionsModal = showRawMaterialOptionsModal;
window.copyRawMaterialToDisplay = copyRawMaterialToDisplay;
window.showSuccessModal = showSuccessModal;

// ğŸ§® ì˜ì–‘ì„±ë¶„ ê³„ì‚°ê¸° í•¨ìˆ˜ ë¯¸ë¦¬ ì •ì˜ (í˜¸ì¶œ ì „ì— ì •ì˜í•´ì•¼ í•¨)
window.openNutritionCalculatorFromModal = function() {
    console.log('ğŸ§® ì˜ì–‘ì„±ë¶„ ê³„ì‚°ê¸° ì—´ê¸° ì‹œë„');
    const modal = document.getElementById('nutritionCalculatorModal');
    if (modal) {
        modal.remove();
    }
    
    try {
        const labelId = document.getElementById('label_id')?.value || '';
        console.log('ğŸ§® ë¼ë²¨ ID:', labelId);
        
        if (labelId) {
            // ì‹¤ì œ í”„ë¡œì íŠ¸ URL íŒ¨í„´ì— ë§ê²Œ ìˆ˜ì • (í•˜ì´í”ˆ ì‚¬ìš©)
            const possibleUrls = [
                `/label/nutrition-calculator-popup/?label_id=${labelId}`,
                `/label/nutrition-popup/?label_id=${labelId}`
            ];
            
            console.log('ğŸ§® ì‹œë„í•  URLë“¤:', possibleUrls);
            
            // URL ì‹œë„ í•¨ìˆ˜
            function tryOpenCalculator(urlIndex = 0) {
                if (urlIndex >= possibleUrls.length) {
                    console.error('âŒ ëª¨ë“  URL ì‹œë„ ì‹¤íŒ¨');
                    alert('ì˜ì–‘ì„±ë¶„ ê³„ì‚°ê¸°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\nê°œë°œìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                const currentUrl = possibleUrls[urlIndex];
                console.log(`ğŸ§® URL ì‹œë„ ì¤‘ (${urlIndex + 1}/${possibleUrls.length}):`, currentUrl);
                
                try {
                    const popup = window.open(currentUrl, 'NutritionCalculator', 'width=1200,height=800,scrollbars=yes,resizable=yes,menubar=no,toolbar=no,location=no,status=no');
                    
                    if (popup) {
                        console.log('âœ… ì˜ì–‘ì„±ë¶„ ê³„ì‚°ê¸° íŒì—… ì—´ê¸° ì„±ê³µ');
                        
                        // íŒì—… ë¡œë“œ í™•ì¸
                        let hasLoaded = false;
                        
                        // íŒì—…ì´ ë‹«í ë•Œ ì²˜ë¦¬
                        const checkClosed = setInterval(() => {
                            if (popup.closed) {
                                clearInterval(checkClosed);
                                
                                if (!hasLoaded && urlIndex + 1 < possibleUrls.length) {
                                    console.warn(`âš ï¸ íŒì—…ì´ ë¹¨ë¦¬ ë‹«í˜”ìŠµë‹ˆë‹¤. ë‹¤ìŒ URL ì‹œë„: ${currentUrl}`);
                                    setTimeout(() => tryOpenCalculator(urlIndex + 1), 500);
                                    return;
                                }
                                
                                console.log('ğŸ“„ ì˜ì–‘ì„±ë¶„ ê³„ì‚°ê¸° íŒì—…ì´ ë‹«í˜”ìŠµë‹ˆë‹¤.');
                                
                                // ì˜ì–‘ì„±ë¶„ í•„ë“œ ì—…ë°ì´íŠ¸ í™•ì¸
                                setTimeout(() => {
                                    const nutritionField = document.getElementById('nutrition_text');
                                    if (nutritionField) {
                                        console.log('ğŸ”„ ì˜ì–‘ì„±ë¶„ ë°ì´í„° í™•ì¸ ì¤‘...');
                                    }
                                }, 500);
                            }
                        }, 1000);
                        
                        // 3ì´ˆ í›„ ë¡œë“œ ì„±ê³µìœ¼ë¡œ ê°„ì£¼
                        setTimeout(() => {
                            hasLoaded = true;
                            console.log('âœ… ì˜ì–‘ì„±ë¶„ ê³„ì‚°ê¸° ë¡œë“œ ì„±ê³µìœ¼ë¡œ ê°„ì£¼');
                        }, 3000);
                        
                    } else {
                        console.error('âŒ íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤');
                        alert('íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.\n\në¸Œë¼ìš°ì €ì—ì„œ íŒì—…ì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
                    }
                } catch (error) {
                    console.error(`âŒ URL ì˜¤ë¥˜ (${currentUrl}):`, error);
                    if (urlIndex + 1 < possibleUrls.length) {
                        console.log('ë‹¤ìŒ URL ì‹œë„...');
                        tryOpenCalculator(urlIndex + 1);
                    } else {
                        alert('ì˜ì–‘ì„±ë¶„ ê³„ì‚°ê¸°ë¥¼ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\nì˜¤ë¥˜: ' + error.message);
                    }
                }
            }
            
            // ê³„ì‚°ê¸° ì—´ê¸° ì‹œë„
            tryOpenCalculator();
        } else {
            console.error('âŒ ë¼ë²¨ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
            alert('ë¼ë²¨ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\ní˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
        }
    } catch (error) {
        console.error('âŒ ì˜ì–‘ì„±ë¶„ ê³„ì‚°ê¸° ì—´ê¸° ì˜¤ë¥˜:', error);
        alert('ì˜ì–‘ì„±ë¶„ ê³„ì‚°ê¸°ë¥¼ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\nì˜¤ë¥˜: ' + error.message);
    }
};

window.closeNutritionCalculatorModal = function() {
    const modal = document.getElementById('nutritionCalculatorModal');
    if (modal) {
        modal.remove();
    }
};

// ğŸ§® ì˜ì–‘ì„±ë¶„ ê³„ì‚°ê¸° ì„¤ì • í•¨ìˆ˜ (í´ë¦­ ì‹œì—ë§Œ ì‘ë™)
function setupNutritionCalculator() {
    console.log('ğŸ§® ì˜ì–‘ì„±ë¶„ ê³„ì‚°ê¸° ì„¤ì • ì‹œì‘');
    
    // ì˜ì–‘ì„±ë¶„ ê³„ì‚°ê¸° í™•ì¸ ëª¨ë‹¬ í•¨ìˆ˜
    function showNutritionCalculatorConfirm() {
        console.log('ğŸ§® ì˜ì–‘ì„±ë¶„ ê³„ì‚°ê¸° ëª¨ë‹¬ í‘œì‹œ');
        
        const modalHtml = `
            <div id="nutritionCalculatorModal" style="
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            ">
                <div onclick="event.stopPropagation()" style="
                    background: white;
                    border-radius: 10px;
                    padding: 30px;
                    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
                    text-align: center;
                    max-width: 400px;
                    width: 90%;
                ">
                    <h4 style="margin-bottom: 20px; color: #333;">ğŸ§® ì˜ì–‘ì„±ë¶„ ê³„ì‚°ê¸°</h4>
                    <p style="margin-bottom: 25px; color: #666; line-height: 1.5;">
                        ì˜ì–‘ì„±ë¶„ ê³„ì‚°ê¸°ë¥¼ ì—´ì–´ì„œ<br>ì˜ì–‘ì •ë³´ë¥¼ ìë™ìœ¼ë¡œ ê³„ì‚°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
                    </p>
                    <div style="display: flex; gap: 12px; justify-content: center;">
                        <button type="button" onclick="openNutritionCalculatorFromModal()" style="
                            background: #28a745;
                            color: white;
                            border: none;
                            padding: 12px 20px;
                            border-radius: 6px;
                            font-size: 14px;
                            cursor: pointer;
                            transition: background 0.2s;
                        " onmouseover="this.style.background='#1e7e34'" onmouseout="this.style.background='#28a745'">
                            âœ… ê³„ì‚°ê¸° ì—´ê¸°
                        </button>
                        <button type="button" onclick="closeNutritionCalculatorModal()" style="
                            background: #6c757d;
                            color: white;
                            border: none;
                            padding: 12px 20px;
                            border-radius: 6px;
                            font-size: 14px;
                            cursor: pointer;
                            transition: background 0.2s;
                        " onmouseover="this.style.background='#545b62'" onmouseout="this.style.background='#6c757d'">
                            âŒ ì·¨ì†Œ
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        // ê¸°ì¡´ ëª¨ë‹¬ ì œê±°
        const existingModal = document.getElementById('nutritionCalculatorModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // ìƒˆ ëª¨ë‹¬ ì¶”ê°€
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
        const modal = document.getElementById('nutritionCalculatorModal');
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                modal.remove();
            }
        });
        
        // ESC í‚¤ë¡œ ë‹«ê¸°
        const escHandler = function(e) {
            if (e.key === 'Escape') {
                modal.remove();
                document.removeEventListener('keydown', escHandler);
            }
        };
        document.addEventListener('keydown', escHandler);
    }
    
    // ì˜ì–‘ì„±ë¶„ textarea í´ë¦­ ì´ë²¤íŠ¸ ì„¤ì • (ë” ê°•ë ¥í•œ ë°©ì‹)
    function connectNutritionField() {
        const nutritionTextarea = document.getElementById('nutrition_text');
        if (nutritionTextarea) {
            console.log('ğŸ§® ì˜ì–‘ì„±ë¶„ í•„ë“œ ë°œê²¬, ì´ë²¤íŠ¸ ì—°ê²° ì‹œì‘');
            let isProcessing = false; // ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
            
            // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°ë¥¼ ìœ„í•´ ë³µì œ
            const newTextarea = nutritionTextarea.cloneNode(true);
            nutritionTextarea.parentNode.replaceChild(newTextarea, nutritionTextarea);
            
            // ê°•ë ¥í•œ í´ë¦­ ì´ë²¤íŠ¸ ì—°ê²°
            newTextarea.addEventListener('click', function(event) {
                console.log('ğŸ§® ì˜ì–‘ì„±ë¶„ í•„ë“œ í´ë¦­ë¨!');
                event.preventDefault();
                event.stopPropagation();
                
                if (isProcessing) {
                    console.log('ğŸ§® ì˜ì–‘ì„±ë¶„ ê³„ì‚°ê¸° ì²˜ë¦¬ ì¤‘, ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€');
                    return;
                }
                
                isProcessing = true;
                showNutritionCalculatorConfirm();
                
                setTimeout(() => {
                    isProcessing = false;
                }, 1000);
            }, true); // useCapture = true
            
            // í¬ì»¤ìŠ¤ ì´ë²¤íŠ¸ë„ ì¶”ê°€
            newTextarea.addEventListener('focus', function(event) {
                console.log('ğŸ§® ì˜ì–‘ì„±ë¶„ í•„ë“œ í¬ì»¤ìŠ¤!');
                event.preventDefault();
                newTextarea.blur(); // ì¦‰ì‹œ í¬ì»¤ìŠ¤ í•´ì œ
                setTimeout(() => {
                    newTextarea.click();
                }, 10);
            }, true);
            
            console.log('âœ… ì˜ì–‘ì„±ë¶„ ê³„ì‚°ê¸° ê°•ë ¥ ì—°ê²° ì™„ë£Œ');
            return true;
        } else {
            console.warn('âš ï¸ nutrition_text í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
            return false;
        }
    }
    
    // ì¦‰ì‹œ ì‹œë„ ë° ì¬ì‹œë„ ë¡œì§
    if (!connectNutritionField()) {
        setTimeout(connectNutritionField, 1000);
        setTimeout(connectNutritionField, 3000);
        setTimeout(connectNutritionField, 5000);
    }
}

// ë” ê°•ë ¥í•œ ì›ì¬ë£Œëª… í•„ë“œ ì—°ê²° í•¨ìˆ˜
function forceConnectRawMaterialField() {
    const rawMaterialField = document.getElementById('rawmtrl_nm');
    
    if (!rawMaterialField) {
        console.error('âŒ ì›ì¬ë£Œëª… í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
        return false;
    }
    
    console.log('âœ… ì›ì¬ë£Œëª… í•„ë“œ ë°œê²¬, ê°•ë ¥í•œ ì´ë²¤íŠ¸ ì—°ê²° ì‹œì‘');
    
    // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°ë¥¼ ìœ„í•´ ë³µì œ
    const newField = rawMaterialField.cloneNode(true);
    rawMaterialField.parentNode.replaceChild(newField, rawMaterialField);
    
    // ê°•ë ¥í•œ í´ë¦­ ì´ë²¤íŠ¸ ì—°ê²°
    newField.addEventListener('click', function(e) {
        console.log('ğŸ–±ï¸ ì›ì¬ë£Œëª… í•„ë“œ í´ë¦­ë¨!');
        e.preventDefault();
        e.stopPropagation();
        
        // ë¼ë²¨ ID í™•ì¸
        const labelId = document.getElementById('label_id')?.value || '';
        console.log('ğŸ·ï¸ ì‚¬ìš©í•  ë¼ë²¨ ID:', labelId);
        
        // ê°„ë‹¨í•œ í™•ì¸ í›„ ë°”ë¡œ íŒì—… ì—´ê¸°
        if (confirm('ì›ì¬ë£Œ í‘œë¡œ ì…ë ¥ íŒì—…ì„ ì—´ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            openIngredientPopupDirect(labelId);
        }
    }, true); // useCapture = trueë¡œ í™•ì‹¤í•˜ê²Œ
    
    // í¬ì»¤ìŠ¤ ì´ë²¤íŠ¸ë„ ì—°ê²°
    newField.addEventListener('focus', function(e) {
        console.log('ğŸ¯ ì›ì¬ë£Œëª… í•„ë“œ í¬ì»¤ìŠ¤');
        e.preventDefault();
        newField.blur();
        setTimeout(() => {
            newField.click();
        }, 10);
    }, true);
    
    console.log('âœ… ì›ì¬ë£Œëª… í•„ë“œ ê°•ë ¥ ì—°ê²° ì™„ë£Œ');
    return true;
}

// ì¦‰ì‹œ ì§„ë‹¨ ì‹¤í–‰ ë° ê°•ë ¥í•œ í•„ë“œ ì—°ê²°
console.log('ğŸš€ ì „ì—­ í•¨ìˆ˜ ì •ì˜ ì™„ë£Œ');
setTimeout(() => {
    console.log('ğŸ” 1ì´ˆ í›„ ìë™ ì§„ë‹¨ ë° ì—°ê²°...');
    diagnoseAll();
    
    // ğŸ”¥ ì˜¤ë²„ë ˆì´ ê¸°ë°˜ í´ë¦­ í•¸ë“¤ëŸ¬ ìƒì„±
    createFieldOverlays();
    
    // ê°•ë ¥í•œ ì›ì¬ë£Œëª… í•„ë“œ ì—°ê²° ì‹œë„ (ë°±ì—…ìš©)
    if (forceConnectRawMaterialField()) {
        console.log('âœ… ì›ì¬ë£Œëª… í•„ë“œ ê°•ë ¥ ì—°ê²° ì„±ê³µ');
    } else {
        console.log('âŒ ì›ì¬ë£Œëª… í•„ë“œ ê°•ë ¥ ì—°ê²° ì‹¤íŒ¨ - ì¬ì‹œë„ ì˜ˆì •');
        // ì¬ì‹œë„
        setTimeout(forceConnectRawMaterialField, 2000);
        setTimeout(forceConnectRawMaterialField, 5000);
    }
}, 1000);
</script>

<!-- ğŸ§ª ì¶”ê°€ í…ŒìŠ¤íŠ¸ìš© ìŠ¤í¬ë¦½íŠ¸ -->
<script>
// DOM ë¡œë“œ ì™„ë£Œ í›„ ì‹¤í–‰ë˜ëŠ” ì¶”ê°€ í…ŒìŠ¤íŠ¸
document.addEventListener('DOMContentLoaded', function() {

    // 3ì´ˆ í›„ ìë™ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    setTimeout(() => {
        console.log('ï¿½ 3ì´ˆ í›„ ìë™ í…ŒìŠ¤íŠ¸ ì‹¤í–‰...');
        
        if (typeof diagnoseAll === 'function') {
            const diagnosis = diagnoseAll();
            console.log('ğŸ“Š ì§„ë‹¨ ê²°ê³¼:', diagnosis);
            
            if (diagnosis.functions && diagnosis.field) {
                console.log('âœ… ëª¨ë“  ì¡°ê±´ ì¶©ì¡± - í…ŒìŠ¤íŠ¸ ì¤€ë¹„ ì™„ë£Œ');
                console.log('ğŸ§ª ì½˜ì†”ì—ì„œ ë‹¤ìŒ ëª…ë ¹ì–´ë“¤ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:');
                console.log('  - testPopupBlocking() : íŒì—… ì°¨ë‹¨ í…ŒìŠ¤íŠ¸');
                console.log('  - testIngredientPopup() : í‘œë¡œì…ë ¥ íŒì—… í…ŒìŠ¤íŠ¸');
                console.log('  - testRawMaterialClick() : ì›ì¬ë£Œëª… í•„ë“œ í´ë¦­ í…ŒìŠ¤íŠ¸');
                console.log('  - forceRawMaterialFieldConnection() : ê°•ì œ í•„ë“œ ì—°ê²°');
                console.log('  - diagnoseAll() : ì „ì²´ ìƒí™© ì§„ë‹¨');
            } else {
                console.warn('âš ï¸ ì¼ë¶€ ì¡°ê±´ì´ ì¶©ì¡±ë˜ì§€ ì•ŠìŒ:', diagnosis);
            }
        }
    }, 3000);
});
</script>

<script>
// ì „ì—­ handleIngredientPopup í•¨ìˆ˜ ì •ì˜ (í•­ìƒ ì‚¬ìš© ê°€ëŠ¥)
window.handleIngredientPopup = function() {
    console.log('ğŸ–±ï¸ ì›ì¬ë£Œ í‘œë¡œ ì…ë ¥ ë²„íŠ¼ í´ë¦­');

    console.log('  - openIngredientTablePopup:', typeof openIngredientTablePopup);
    console.log('  - window.openIngredientTablePopup:', typeof window.openIngredientTablePopup);
    console.log('  - openPopup:', typeof openPopup);
    console.log('  - window.openPopup:', typeof window.openPopup);
    
    try {
        if (typeof window.openIngredientTablePopup === 'function') {
            console.log('âœ… window.openIngredientTablePopupì´ ì¡´ì¬í•©ë‹ˆë‹¤');
            window.openIngredientTablePopup();
        } else if (typeof openIngredientTablePopup === 'function') {
            console.log('âœ… openIngredientTablePopupì´ ì¡´ì¬í•©ë‹ˆë‹¤');
            openIngredientTablePopup();
        } else {
            console.warn('âš ï¸ openIngredientTablePopup í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            console.log('ğŸ“‹ í˜„ì¬ window ê°ì²´ì˜ ê´€ë ¨ í•¨ìˆ˜ë“¤:');
            Object.keys(window).filter(key => key.toLowerCase().includes('ingredient')).forEach(key => {
                console.log(`  - ${key}:`, typeof window[key]);
            });
            
            // ê°•ì œë¡œ í•¨ìˆ˜ ì •ì˜ ì‹œë„
            if (typeof window.openPopup === 'function') {
                console.log('ğŸ”§ openPopup í•¨ìˆ˜ê°€ ì¡´ì¬í•˜ë¯€ë¡œ ì§ì ‘ í˜¸ì¶œ ì‹œë„');
                const labelId = document.getElementById('label_id')?.value || '';
                const url = `/label/ingredient-popup/?label_id=${labelId}`;
                window.openPopup(url, 'IngredientPopup', 1000, 800);
            } else {
                alert('ì›ì¬ë£Œ í‘œë¡œ ì…ë ¥ ê¸°ëŠ¥ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        }
    } catch (error) {
        console.error('ğŸ’¥ ì›ì¬ë£Œ í‘œë¡œ ì…ë ¥ ì—´ê¸° ì˜¤ë¥˜:', error);
        alert('ì›ì¬ë£Œ í‘œë¡œ ì…ë ¥ì„ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
    }
};



document.addEventListener('DOMContentLoaded', function() {
    // URL íŒŒë¼ë¯¸í„°ì—ì„œ ocr=autoê°€ ìˆìœ¼ë©´ OCR ëª¨ë‹¬ ìë™ ì—´ê¸°
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('ocr') === 'auto') {
        setTimeout(() => {
            const ocrModal = new bootstrap.Modal(document.getElementById('ocrUploadModal'));
            ocrModal.show();
            
            // URLì—ì„œ íŒŒë¼ë¯¸í„° ì œê±° (ë¸Œë¼ìš°ì € íˆìŠ¤í† ë¦¬ ì •ë¦¬)
            window.history.replaceState({}, document.title, window.location.pathname);
        }, 500);
    }
    
    // ë¼ë²¨ëª… ë™ê¸°í™” ê¸°ëŠ¥
    function syncLabelName() {
        const topInput = document.getElementById('my_label_name_top');
        const hiddenInput = document.getElementById('my_label_name_hidden');
        
        if (topInput && hiddenInput) {
            // ìƒë‹¨ ì…ë ¥ í•„ë“œ ë³€ê²½ ì‹œ ìˆ¨ê²¨ì§„ í•„ë“œ ì—…ë°ì´íŠ¸
            topInput.addEventListener('input', function() {
                hiddenInput.value = this.value;
            });
            
            // ì´ˆê¸°ê°’ ë™ê¸°í™”
            if (hiddenInput.value && !topInput.value) {
                topInput.value = hiddenInput.value;
            } else if (topInput.value && !hiddenInput.value) {
                hiddenInput.value = topInput.value;
            }
        }
    }
    
    // ë¼ë²¨ëª… ë™ê¸°í™” ì´ˆê¸°í™”
    syncLabelName();
    
    // ì¶”ì²œ ì‹œìŠ¤í…œ ì¶”ê°€ ì´ˆê¸°í™” (DOM ë¡œë“œ í›„ ì‹¤í–‰)
    function initRecommendationSystem() {
        if (window.recommendationSystem) {
            
            // Select2ë¡œ ë³€í™˜ëœ í•„ë“œë“¤ì— ëŒ€í•´ íŠ¹ë³„ ì²˜ë¦¬
            $('#country_of_origin').on('select2:open', function() {
                // ì›ì‚°ì§€ í•„ë“œìš© ì¸ê¸°ê°’ í‘œì‹œ (Select2ëŠ” ìì²´ ë“œë¡­ë‹¤ìš´ ì‚¬ìš©)
            });
            
            // ì›ì¬ë£Œëª… í•„ë“œë“¤ (ë™ì ìœ¼ë¡œ ì¶”ê°€ë˜ëŠ” í•„ë“œë“¤)ì— ì¶”ì²œ ê¸°ëŠ¥ ì ìš©
            $(document).on('focus', 'input[name^="ingr_kor_nm"]', function() {
                if (!this.hasAttribute('data-recommendation-enabled')) {
                    window.recommendationSystem.setupFieldRecommendations(this, 'ingr_kor_nm');
                }
            });
            
            // ì¶”ê°€ ì›ì¬ë£Œ ë²„íŠ¼ í´ë¦­ ì‹œ ìƒˆ í•„ë“œì— ì¶”ì²œ ê¸°ëŠ¥ ì ìš©
            $(document).on('click', '.add-ingredient-btn', function() {
                setTimeout(function() {
                    $('input[name^="ingr_kor_nm"]:not([data-recommendation-enabled])').each(function() {
                        window.recommendationSystem.setupFieldRecommendations(this, 'ingr_kor_nm');
                    });
                }, 100);
            });
            
            // í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ ì œê±°ë¨
            

            

            
            return true; // ì´ˆê¸°í™” ì„±ê³µ
        } else {
            return false; // ì´ˆê¸°í™” ì‹¤íŒ¨
        }
    }
    
    // ì¶”ì²œ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¬ì‹œë„ ë¡œì§
    let retryCount = 0;
    const maxRetries = 10;
    
    function tryInitRecommendationSystem() {
        if (initRecommendationSystem()) {
            return;
        }
        
        retryCount++;
        if (retryCount < maxRetries) {
            setTimeout(tryInitRecommendationSystem, 1000);
        }
    }
    
    // ì´ˆê¸°í™” ì‹œì‘ - ì¦‰ì‹œ ì‹¤í–‰
    setTimeout(() => {
        console.log('ğŸ¯ ì¶”ì²œ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì‹œì‘...');
        tryInitRecommendationSystem();
    }, 500);
    

    
    // ğŸ§® ì˜ì–‘ì„±ë¶„ ê³„ì‚°ê¸° ê´€ë ¨ í•¨ìˆ˜ë“¤ (í´ë¦­ ì‹œì—ë§Œ ì‹¤í–‰)
    setupNutritionCalculator();
    
    // ğŸ“‹ ì¤‘ë³µ ì œê±°ë¨ - ì´ë¯¸ ì „ì—­ì—ì„œ ì •ì˜ë¨

    // ì›ì¬ë£Œëª…(ì°¸ê³ ) textarea í´ë¦­ ì‹œ í™•ì¸ í›„ ì›ì¬ë£Œ í‘œë¡œ ì…ë ¥ íŒì—… ì—´ê¸°
    function setupRawMaterialClickEvent() {
        const rawMaterialTextarea = document.getElementById('rawmtrl_nm');
        console.log('ğŸ” rawmtrl_nm ìš”ì†Œ ê²€ìƒ‰ ê²°ê³¼:', rawMaterialTextarea);
        
        if (rawMaterialTextarea) {
            console.log('âœ… rawmtrl_nm ìš”ì†Œ ë°œê²¬, ë‹¤ì¤‘ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€');
            let isRawMaterialProcessing = false; // ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
            
            // í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ í•¨ìˆ˜ - 3ê°œ ì„ íƒì§€ ë©”ë‰´ (ì „ì—­ í•¨ìˆ˜ë¡œ ì •ì˜)
            window.handleRawMaterialClick = async function(event) {
                console.log('ğŸ–±ï¸ rawmtrl_nm í•„ë“œ í´ë¦­ë¨ - ì´ë²¤íŠ¸ íƒ€ì…:', event.type);
                
                if (isRawMaterialProcessing) {
                    console.log('â³ ì›ì¬ë£Œ í‘œë¡œ ì…ë ¥ ì²˜ë¦¬ ì¤‘, ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€');
                    return;
                }
                
                // 3ê°œ ì„ íƒì§€ ë©”ë‰´ í‘œì‹œ (Promise ê¸°ë°˜)
                const choice = await showRawMaterialMenu();
                
                if (choice === 'table') {
                    console.log('âœ… ì‚¬ìš©ìê°€ í‘œë¡œ ì…ë ¥ ì„ íƒ');
                    isRawMaterialProcessing = true;
                    
                    try {
                        // í•¨ìˆ˜ ì¡´ì¬ í™•ì¸ ë° í˜¸ì¶œ
                        console.log('ğŸ” íŒì—… í•¨ìˆ˜ ì¡´ì¬ í™•ì¸:', {
                            openIngredientTablePopup: typeof window.openIngredientTablePopup,
                            openPopup: typeof window.openPopup
                        });
                        
                        if (typeof window.openIngredientTablePopup === 'function') {
                            console.log('ğŸ“¦ openIngredientTablePopup í˜¸ì¶œ');
                            window.openIngredientTablePopup();
                        } else if (typeof window.openPopup === 'function') {
                            console.log('ğŸ”§ openPopup ì§ì ‘ í˜¸ì¶œ');
                            const labelId = document.getElementById('label_id')?.value || '';
                            const url = `/label/ingredient-popup/?label_id=${labelId}`;
                            window.openPopup(url, 'IngredientPopup', 1000, 800);
                        } else {
                            console.error('âŒ íŒì—… í•¨ìˆ˜ë“¤ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                            alert('íŒì—… ê¸°ëŠ¥ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                        }
                    } catch (error) {
                        console.error('ğŸ’¥ ì›ì¬ë£Œ í‘œë¡œ ì…ë ¥ ì—´ê¸° ì˜¤ë¥˜:', error);
                        alert('íŒì—…ì„ ì—¬ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                    } finally {
                        setTimeout(() => {
                            isRawMaterialProcessing = false;
                        }, 1000);
                    }
                } else if (choice === 'copy') {
                    console.log('ğŸ“‹ ì‚¬ìš©ìê°€ ì›ì¬ë£Œëª…(í‘œì‹œ)ì— ë³µì‚¬ ì„ íƒ');
                    copyToDisplayField();
                } else {
                    console.log('âŒ ì‚¬ìš©ìê°€ ì·¨ì†Œ ì„ íƒ');
                }
            }
            
            // 3ê°œ ì„ íƒì§€ ë©”ë‰´ í‘œì‹œ í•¨ìˆ˜ - ê°„ë‹¨í•œ confirm ë°©ì‹
            function showRawMaterialMenu() {
                return new Promise((resolve) => {
                    // ê°„ë‹¨í•œ confirm ëŒ€í™”ìƒì ì‚¬ìš©
                    const choice = confirm('ì›ì¬ë£Œ í‘œë¡œ ì…ë ¥ íŒì—…ì„ ì—´ì‹œê² ìŠµë‹ˆê¹Œ?\n\ní™•ì¸: í‘œë¡œ ì…ë ¥\nì·¨ì†Œ: ì·¨ì†Œ');
                    
                    if (choice) {
                        resolve('table');
                    } else {
                        resolve('cancel');
                    }
                });
            }
            
            // ì›ì¬ë£Œëª…(í‘œì‹œ) í•„ë“œë¡œ ë³µì‚¬í•˜ëŠ” í•¨ìˆ˜
            function copyToDisplayField() {
                const sourceField = document.getElementById('rawmtrl_nm');
                const targetField = document.querySelector('textarea[name="rawmtrl_nm_display"]');
                const targetCheckbox = document.getElementById('chk_rawmtrl_nm_display');
                
                if (sourceField && targetField) {
                    const sourceValue = sourceField.value.trim();
                    
                    if (sourceValue) {
                        // ë³µì‚¬ ë‚´ìš©ì´ ê¸¸ë©´ ì¶•ì•½í•´ì„œ í‘œì‹œ
                        const previewText = sourceValue.length > 150 ? 
                            sourceValue.substring(0, 150) + '...' : sourceValue;
                        
                        targetField.value = sourceValue;
                        
                        // ì›ì¬ë£Œëª…(í‘œì‹œ) ì²´í¬ë°•ìŠ¤ ìë™ ì²´í¬
                        if (targetCheckbox) {
                            targetCheckbox.checked = true;
                        }
                        
                        // textarea ë†’ì´ ìë™ ì¡°ì ˆ
                        if (window.updateTextareaHeight) {
                            updateTextareaHeight(targetField);
                        }
                        
                        console.log('âœ… ì›ì¬ë£Œëª…(í‘œì‹œ)ì— ë³µì‚¬ ì™„ë£Œ');
                        alert('ì›ì¬ë£Œëª…(í‘œì‹œ) í•„ë“œì— ë³µì‚¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\n\n' + 
                              'ì²´í¬ë°•ìŠ¤ë„ ìë™ìœ¼ë¡œ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤.');
                    } else {
                        alert('ì›ì¬ë£Œëª…(ì°¸ê³ ) í•„ë“œì— ë³µì‚¬í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.\n\n' +
                              'ë¨¼ì € "í‘œë¡œ ì…ë ¥"ì„ í†µí•´ ë°ì´í„°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    }
                } else {
                    console.error('âŒ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                    alert('í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
                }
            }
            
            // ì¤‘ë³µ ì´ë²¤íŠ¸ ì œê±° - ì˜¤ë²„ë ˆì´ì—ì„œë§Œ ì²˜ë¦¬
            
            window.checkRawMaterialElements = function() {
                console.log('ğŸ” ì›ì¬ë£Œëª… ìš”ì†Œë“¤ í™•ì¸:');
                console.log('  - rawmtrl_nm textarea:', document.getElementById('rawmtrl_nm'));
                console.log('  - rawmtrl_nm_overlay:', document.getElementById('rawmtrl_nm_overlay'));
                console.log('  - rawmtrl_nm_section:', document.getElementById('rawmtrl_nm_section'));
            };
            
            // textarea ì§ì ‘ í´ë¦­ ì´ë²¤íŠ¸ë„ ì¶”ê°€
            if (!rawMaterialTextarea.hasAttribute('data-click-setup')) {
                rawMaterialTextarea.addEventListener('click', function(event) {
                    console.log('ğŸ–±ï¸ rawmtrl_nm textarea ì§ì ‘ í´ë¦­!');
                    event.preventDefault();
                    event.stopPropagation();
                    window.handleRawMaterialClick(event);
                });
                
                // í¬ì»¤ìŠ¤ ì´ë²¤íŠ¸ë„ ì¶”ê°€
                rawMaterialTextarea.addEventListener('focus', function(event) {
                    console.log('ğŸ” rawmtrl_nm textarea í¬ì»¤ìŠ¤!');
                    event.preventDefault();
                    rawMaterialTextarea.blur(); // ì¦‰ì‹œ í¬ì»¤ìŠ¤ í•´ì œ
                    window.handleRawMaterialClick(event);
                });
                
                rawMaterialTextarea.setAttribute('data-click-setup', 'true');
            }
            
            // ì˜¤ë²„ë ˆì´ ìš”ì†Œì—ë„ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
            const overlay = document.getElementById('rawmtrl_nm_overlay');
            if (overlay) {
                console.log('ğŸ”„ rawmtrl_nm ì˜¤ë²„ë ˆì´ ë°œê²¬, í´ë¦­ ë° hover ì´ë²¤íŠ¸ ì¶”ê°€');
                
                // í´ë¦­ ì´ë²¤íŠ¸ - ì¤‘ë³µ ë°©ì§€ë¥¼ ìœ„í•´ ë‹¨ì¼ ì´ë²¤íŠ¸ë§Œ ë“±ë¡
                overlay.addEventListener('click', function(event) {
                    console.log('ğŸ–±ï¸ ì˜¤ë²„ë ˆì´ í´ë¦­ ì´ë²¤íŠ¸ ì‹œì‘!');
                    console.log('ğŸ“ í´ë¦­ ì¢Œí‘œ:', event.clientX, event.clientY);
                    event.preventDefault();
                    event.stopPropagation();
                    window.handleRawMaterialClick(event);
                }, { once: false });
                
                // ì¶”ê°€ ì•ˆì „ì¥ì¹˜: ë”ë¸”í´ë¦­ë„ ì²˜ë¦¬
                overlay.addEventListener('dblclick', function(event) {
                    console.log('ğŸ–±ï¸ ì˜¤ë²„ë ˆì´ ë”ë¸”í´ë¦­ ì´ë²¤íŠ¸!');
                    event.preventDefault();
                    event.stopPropagation();
                    window.handleRawMaterialClick(event);
                });
                
                // hover ì´ë²¤íŠ¸ë¡œ textarea ìŠ¤íƒ€ì¼ ë³€ê²½
                overlay.addEventListener('mouseenter', function() {
                    console.log('ğŸ–±ï¸ rawmtrl_nm ì˜¤ë²„ë ˆì´ hover ì‹œì‘');
                    rawMaterialTextarea.style.backgroundColor = '#e9ecef';
                    rawMaterialTextarea.style.borderColor = '#86b7fe';
                });
                
                overlay.addEventListener('mouseleave', function() {
                    console.log('ğŸ–±ï¸ rawmtrl_nm ì˜¤ë²„ë ˆì´ hover ì¢…ë£Œ');
                    rawMaterialTextarea.style.backgroundColor = '#f8f9fa';
                    rawMaterialTextarea.style.borderColor = '#e3e6f0'; // modern-gray-200 ìƒ‰ìƒê°’
                });
            }
            
            console.log('âœ… rawmtrl_nm ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì™„ë£Œ');
            console.log('ğŸ§ª í…ŒìŠ¤íŠ¸ ëª…ë ¹ì–´:');
            console.log('  - testRawMaterialClick() : ëª¨ë‹¬ í…ŒìŠ¤íŠ¸');
            console.log('  - testIngredientPopup() : í‘œë¡œì…ë ¥ íŒì—… í…ŒìŠ¤íŠ¸');
            console.log('  - handleIngredientPopup() : ì§ì ‘ íŒì—… ì—´ê¸°');
            
        } else {
            console.warn('âš ï¸ rawmtrl_nm ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤ - DOMì´ ì•„ì§ ì™„ì „íˆ ë¡œë“œë˜ì§€ ì•Šì•˜ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤');
        }
    }
    
    // ï¿½ ì¤‘ë³µ ì œê±°ë¨ - ì´ë¯¸ ì „ì—­ì—ì„œ ì •ì˜ë¨
    
    // ì¦‰ì‹œ ì‹¤í–‰
    setupRawMaterialClickEvent();
    
    // í•¨ìˆ˜ ê°€ìš©ì„± ë””ë²„ê¹… (5ì´ˆ í›„ í™•ì¸)
    setTimeout(() => {
        console.log('ğŸ” 5ì´ˆ í›„ í•¨ìˆ˜ ê°€ìš©ì„± í™•ì¸:');
        console.log('  - openIngredientTablePopup:', typeof window.openIngredientTablePopup);
        console.log('  - openPopup:', typeof window.openPopup);
        console.log('  - handleIngredientPopup:', typeof window.handleIngredientPopup);
        
        if (typeof window.openIngredientTablePopup !== 'function') {
            console.warn('âš ï¸ openIngredientTablePopupì´ 5ì´ˆ í›„ì—ë„ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
        }
    }, 5000);
    
    // DOM ë³€ê²½ ê°ì§€í•˜ì—¬ ì¬ì‹œë„
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'childList') {
                const rawMaterialTextarea = document.getElementById('rawmtrl_nm');
                if (rawMaterialTextarea && !rawMaterialTextarea.hasAttribute('data-click-setup')) {
                    console.log('ï¿½ DOM ë³€ê²½ ê°ì§€ë¡œ rawmtrl_nm ì¬ì„¤ì •');
                    rawMaterialTextarea.setAttribute('data-click-setup', 'true');
                    setupRawMaterialClickEvent();
                }
            }
        });
    });
    
    observer.observe(document.body, {
        childList: true,
        subtree: true
    });
    
    // ìµœì í™”ëœ textarea ë†’ì´ ì¡°ì ˆ í•¨ìˆ˜ (ì „ì—­ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€)
    if (!window.globalTextareaInitialized) {
        window.globalTextareaInitialized = true;
    
    function simpleTextareaResize() {
        if (textareaInitialized) {
            return;
        }
        console.log('ğŸ”§ textarea ìë™ í¬ê¸° ì¡°ì ˆ ì´ˆê¸°í™”');
        const textareas = document.querySelectorAll('textarea');
        
        let setupCount = 0;
        
        textareas.forEach(textarea => {
            if (!textarea.hasAttribute('data-auto-resize')) {
                textarea.setAttribute('data-auto-resize', 'true');
                
                function resizeTextarea() {
                    textarea.style.height = '1px';
                    const newHeight = Math.max(48, textarea.scrollHeight);
                    textarea.style.height = newHeight + 'px';
                    console.log(`ï¿½ ${textarea.name || 'textarea'}: ${newHeight}px`);
                }
                
                // ì´ˆê¸° í¬ê¸° ì„¤ì •
                resizeTextarea();
                
                // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
                textarea.addEventListener('input', resizeTextarea);
                textarea.addEventListener('paste', () => setTimeout(resizeTextarea, 0));
                setupCount++;
            }
        });
        
        if (setupCount > 0) {
            console.log(`âœ… ${setupCount}ê°œ textarea ì„¤ì • ì™„ë£Œ`);
        }
        textareaInitialized = true;
    }
    
    // ğŸš« ì¤‘ë³µ í•¨ìˆ˜ ì‹¤í–‰ ì œê±° (ì„±ëŠ¥ ìµœì í™”)
    // setTimeout(simpleTextareaResize, 100);
    
    // ì „ì—­ í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
    window.testTextareas = () => {
        console.log('ğŸ§ª textarea í…ŒìŠ¤íŠ¸ ì‹¤í–‰');
        document.querySelectorAll('textarea').forEach(textarea => {
            const oldHeight = textarea.style.height;
            textarea.style.height = '1px';
            const newHeight = Math.max(48, textarea.scrollHeight) + 'px';
            textarea.style.height = newHeight;
            console.log(`ğŸ“ ${textarea.name || 'textarea'}: ${oldHeight} â†’ ${newHeight}`);
        });
    };
    
    // ï¿½ ì¤‘ë³µ í•¨ìˆ˜ ì œê±°ë¨ (ë³„ë„ ìŠ¤í¬ë¦½íŠ¸ ë¸”ë¡ìœ¼ë¡œ ì´ë™)
    
    // ì»¨í…Œì´ë„ˆ ì •ë³´ í™•ì¸ í•¨ìˆ˜
    window.checkTextareaContainers = () => {
        console.log('ğŸ” textarea ì»¨í…Œì´ë„ˆ ë¶„ì„');
        document.querySelectorAll('textarea').forEach(textarea => {
            const container = textarea.closest('.input-container-modern');
            const fieldSection = textarea.closest('.field-input-section');
            const fieldRow = textarea.closest('.field-row-modern');
            
            console.log(`ğŸ“¦ ${textarea.name}:`);
            console.log('  - textarea styles:', {
                height: textarea.style.height,
                scrollHeight: textarea.scrollHeight,
                overflow: getComputedStyle(textarea).overflow,
                maxHeight: getComputedStyle(textarea).maxHeight,
                padding: getComputedStyle(textarea).padding,
                lineHeight: getComputedStyle(textarea).lineHeight
            });
            if (container) {
                console.log('  - container styles:', {
                    height: getComputedStyle(container).height,
                    maxHeight: getComputedStyle(container).maxHeight,
                    alignItems: getComputedStyle(container).alignItems,
                    padding: getComputedStyle(container).padding
                });
            }
            if (fieldRow) {
                console.log('  - field-row styles:', {
                    height: getComputedStyle(fieldRow).height,
                    maxHeight: getComputedStyle(fieldRow).maxHeight,
                    alignItems: getComputedStyle(fieldRow).alignItems,
                    padding: getComputedStyle(fieldRow).padding
                });
            }
        });
    };
    
    // âœ… ì„±ëŠ¥ ìµœì í™”ëœ textarea ì‹œìŠ¤í…œ ì‹¤í–‰
    setTimeout(window.initOptimizedTextareaSystem, 200);

    // ï¿½ í…ìŠ¤íŠ¸ì˜ì—­ì„ contenteditable divë¡œ ëŒ€ì²´í•˜ëŠ” í•µì‹¬ í•¨ìˆ˜
    window.replaceTextareaWithDiv = () => {
        console.log('ğŸ’¥ textareaë¥¼ contenteditable divë¡œ ëŒ€ì²´ ì‹œì‘');
        
        // íŠ¹ë³„ ê´€ì‹¬ ëŒ€ìƒ textareaë“¤
        const targetSelectors = [
            'textarea[name="rawmtrl_nm_display"]',
            'textarea[name="rawmtrl_nm"]',
            'textarea[name="caution"]',
            'textarea[name="additional_info"]',
            'textarea[name="nutrition_text"]'
        ];
        
        // ê° textarea ì²˜ë¦¬
        targetSelectors.forEach(selector => {
            const textarea = document.querySelector(selector);
            if (!textarea) {
                console.log(`âš ï¸ ${selector} ì°¾ì„ ìˆ˜ ì—†ìŒ`);
                return;
            }
            
            // ì´ë¯¸ ì²˜ë¦¬ëœ ê²½ìš° ìŠ¤í‚µ
            if (textarea.dataset.replaced === 'true') {
                console.log(`âš ï¸ ${selector}ëŠ” ì´ë¯¸ ëŒ€ì²´ë¨`);
                return;
            }
            
            // textareaì˜ ìœ„ì¹˜ì™€ ì†ì„± ì •ë³´ ì €ì¥
            const parent = textarea.parentNode;
            const name = textarea.getAttribute('name');
            const id = textarea.getAttribute('id');
            const classes = textarea.getAttribute('class');
            const value = textarea.value;
            
            // contenteditable div ìƒì„±
            const div = document.createElement('div');
            div.setAttribute('contenteditable', 'true');
            div.setAttribute('data-name', name);
            div.innerHTML = value.replace(/\n/g, '<br>');
            
            if (id) div.id = id + '_editor';
            if (classes) div.className = classes + ' contenteditable-textarea';
            
            // ìŠ¤íƒ€ì¼ ì„¤ì •
            div.style.cssText = `
                min-height: 48px;
                padding: 0.5rem 0.75rem;
                width: 100%;
                border: 2px solid var(--modern-gray-200);
                border-radius: 6px;
                font-family: inherit;
                font-size: 0.875rem;
                line-height: 1.4;
                white-space: pre-wrap;
                overflow-wrap: break-word;
                background-color: #ffffff;
                outline: none;
                box-sizing: border-box;
                overflow: hidden;
            `;
            
            // ìˆ¨ê²¨ì§„ textarea ì¤€ë¹„ (í¼ ì œì¶œìš©)
            textarea.style.display = 'none';
            textarea.dataset.replaced = 'true';
            
            // div ì‚½ì…
            parent.insertBefore(div, textarea);
            
            // div ì…ë ¥ ì‹œ ì›ë˜ textarea ì—…ë°ì´íŠ¸
            div.addEventListener('input', () => {
                textarea.value = div.innerText;
            });
            
            // blur ì‹œ textarea ê°’ ì„¤ì •
            div.addEventListener('blur', () => {
                textarea.value = div.innerText;
            });
            
            console.log(`âœ… ${selector} â†’ contenteditable div ë³€í™˜ ì™„ë£Œ`);
        });
        
        console.log('ğŸ’¥ ëª¨ë“  ëŒ€ìƒ textarea ëŒ€ì²´ ì™„ë£Œ');
    };
    
    // ï¿½ğŸ“Œ MutationObserver ì ‘ê·¼ë²•
    window.setupMutationObserver = () => {
        console.log('ğŸ“Œ MutationObserver ì„¤ì • ì‹œì‘');
        
        const textarea = document.querySelector('textarea[name="rawmtrl_nm_display"]');
        if (!textarea) {
            console.log('âŒ textareaë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            return;
        }
        
        // ì´ì „ observer ì œê±°
        if (window.textareaObserver) {
            window.textareaObserver.disconnect();
            console.log('ê¸°ì¡´ observer í•´ì œ');
        }
        
        // ì‹¤ì‹œê°„ìœ¼ë¡œ ë†’ì´ ë³€í™” ê°ì§€ ë° ê°•ì œ ì„¤ì •
        window.textareaObserver = new MutationObserver((mutations) => {
            // textarea ì‹¤ì œ í•„ìš” ë†’ì´ ê³„ì‚°
            textarea.style.height = '1px';
            const newHeight = Math.max(48, textarea.scrollHeight);
            
            // ê°•ì œ ì„¤ì • (ê°€ì¥ ê°•ë ¥í•œ ë°©ë²•)
            textarea.setAttribute('style', `height: ${newHeight}px !important; min-height: ${newHeight}px !important; max-height: none !important; overflow-y: hidden !important;`);
            
            console.log(`ğŸ“Œ Observer: ë†’ì´ ${newHeight}pxë¡œ ì„¤ì •`);
            
            // ë¶€ëª¨ ì»¨í…Œì´ë„ˆë„ ì¡°ì •
            const container = textarea.closest('.input-container-modern');
            if (container) {
                container.setAttribute('style', `height: auto !important; min-height: ${newHeight}px !important; align-items: flex-start !important; overflow: visible !important;`);
            }
        });
        
        // ì†ì„± ë³€í™” ë° ìì‹ ë…¸ë“œ ë³€í™” ê°ì§€
        
        window.textareaObserver.observe(textarea, {
            attributes: true,
            attributeFilter: ['style', 'class'],
            characterData: true,
            childList: true,
            subtree: true
        });
        
        console.log('ğŸ“Œ MutationObserver ì„¤ì • ì™„ë£Œ - ì´ì œ í…ìŠ¤íŠ¸ë¥¼ ë³€ê²½í•˜ë©´ ìë™ìœ¼ë¡œ ë†’ì´ê°€ ì¡°ì •ë©ë‹ˆë‹¤');
    };
    
    // ìµœì í™”ëœ í†µí•© textarea ë†’ì´ ì¡°ì ˆ ì‹œìŠ¤í…œ (ì„±ëŠ¥ ê°œì„ )
    window.initOptimizedTextareaSystem = function() {
        // ì „ì—­ ì´ˆê¸°í™” ì¤‘ë³µ ë°©ì§€
        if (window.textareaSystemInitialized) {
            console.log('âš ï¸ Textarea ì‹œìŠ¤í…œ ì´ë¯¸ ì´ˆê¸°í™”ë¨ - ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€');
            return;
        }
        window.textareaSystemInitialized = true;
        console.log('ï¿½ ê°„ë‹¨í•œ textarea ìë™ í™•ì¥ ì´ˆê¸°í™”');
        
        console.log('ğŸ¯ ìµœì í™”ëœ textarea ë†’ì´ ì¡°ì ˆ ì‹œìŠ¤í…œ ì´ˆê¸°í™”');
        
        const textareas = document.querySelectorAll('textarea');
        let processedCount = 0;
        
        textareas.forEach(textarea => {
            if (!textarea.hasAttribute('data-optimized-resize')) {
                textarea.setAttribute('data-optimized-resize', 'true');
                processedCount++;
                
                // ì„±ëŠ¥ ìµœì í™”ëœ ë¦¬ì‚¬ì´ì¦ˆ í•¨ìˆ˜ (ë””ë°”ìš´ìŠ¤ ì ìš©)
                let resizeTimer;
                function performResize() {
                    clearTimeout(resizeTimer);
                    resizeTimer = setTimeout(() => {
                        textarea.style.height = 'auto';
                        const newHeight = Math.max(48, textarea.scrollHeight);
                        textarea.style.height = newHeight + 'px';
                    }, 50); // ë””ë°”ìš´ìŠ¤ ì‹œê°„ìœ¼ë¡œ ì„±ëŠ¥ ê°œì„ 
                }
                
                // ì´ˆê¸° ë†’ì´ ì„¤ì •
                performResize();
                
                // ìµœì í™”ëœ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (passive ì˜µì…˜ìœ¼ë¡œ ì„±ëŠ¥ í–¥ìƒ)
                textarea.addEventListener('input', performResize, { passive: true });
                textarea.addEventListener('paste', () => setTimeout(performResize, 100));
            }
        });
        
        console.log(`âœ… ${processedCount}ê°œ textarea ìµœì í™” ì™„ë£Œ (ì„œë²„ ë¶€í•˜ ê°ì†Œ)`);
    }
});
</script>

<!-- ğŸ”§ ëª¨ë‹¬ ì—°ê²° ë””ë²„ê¹… ë° ìˆ˜ì • ìŠ¤í¬ë¦½íŠ¸ -->
<script>
// ğŸ”§ ì›ì¬ë£Œëª… ëª¨ë‹¬ ì—°ê²° ì§„ë‹¨ í•¨ìˆ˜
window.diagnoseRawMaterialModal = function() {
    console.log('ğŸ©º ì›ì¬ë£Œëª… ëª¨ë‹¬ ì—°ê²° ì§„ë‹¨ ì‹œì‘');
    
    // 1. ì›ì¬ë£Œëª… í•„ë“œ í™•ì¸
    const rawmtrlField = document.querySelector('textarea[name="rawmtrl_nm"]');
    console.log('ğŸ“‹ ì›ì¬ë£Œëª… í•„ë“œ:', rawmtrlField ? 'ì°¾ìŒ' : 'ì—†ìŒ', rawmtrlField);
    
    if (rawmtrlField) {
        console.log('  - í•„ë“œ ì†ì„±:', {
            id: rawmtrlField.id,
            name: rawmtrlField.name,
            value: rawmtrlField.value.substring(0, 50) + (rawmtrlField.value.length > 50 ? '...' : ''),
            readOnly: rawmtrlField.readOnly,
            disabled: rawmtrlField.disabled,
            classList: Array.from(rawmtrlField.classList)
        });
    }
    
    // 2. íŒì—… ê´€ë ¨ ìš”ì†Œë“¤ í™•ì¸
    const labelId = document.getElementById('label_id')?.value || '';
    console.log('ğŸ¢ ë¼ë²¨ ID:', labelId ? 'ì°¾ìŒ' : 'ì—†ìŒ', labelId);
    
    // 3. íŒì—… í•¨ìˆ˜ë“¤ í™•ì¸
    console.log('ğŸ”§ íŒì—… í•¨ìˆ˜ë“¤:', {
        openIngredientTablePopup: typeof window.openIngredientTablePopup,
        handleIngredientPopup: typeof window.handleIngredientPopup,
        openPopup: typeof window.openPopup
    });
    
    // 4. ì¶”ê°€ í•¨ìˆ˜ë“¤ í™•ì¸
    console.log('ğŸ”§ í•¨ìˆ˜ í™•ì¸:', {
        setupRawMaterialClickEvent: typeof window.setupRawMaterialClickEvent,
        handleIngredientPopup: typeof window.handleIngredientPopup,
        openIngredientTablePopup: typeof window.openIngredientTablePopup
    });
    
    console.log('ğŸ©º ì§„ë‹¨ ì™„ë£Œ');
    return {rawmtrlField, labelId};
};

// ğŸš€ ì›ì¬ë£Œëª… íŒì—… ê°•ì œ ì—°ê²° í•¨ìˆ˜ (íŒì—… ìœˆë„ìš° ë°©ì‹)
window.forceConnectRawMaterialModal = function() {
    console.log('ğŸ”— ì›ì¬ë£Œëª… íŒì—… ê°•ì œ ì—°ê²° ì‹œì‘');
    
    const rawmtrlField = document.querySelector('textarea[name="rawmtrl_nm"]');
    
    if (!rawmtrlField) {
        console.error('âŒ ì›ì¬ë£Œëª… í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
        return false;
    }
    
    try {
        // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°ë¥¼ ìœ„í•´ ë³µì œ
        const newField = rawmtrlField.cloneNode(true);
        rawmtrlField.parentNode.replaceChild(newField, rawmtrlField);
        
        // ê°•ë ¥í•œ í´ë¦­ ì´ë²¤íŠ¸ ì—°ê²°
        newField.addEventListener('click', function(e) {
            console.log('ğŸ–±ï¸ ê°•ì œ ì—°ê²°ëœ ì›ì¬ë£Œëª… í•„ë“œ í´ë¦­!');
            e.preventDefault();
            e.stopPropagation();
            
            try {
                // ê¸°ì¡´ íŒì—… í•¨ìˆ˜ë“¤ì„ ì‹œë„
                if (typeof window.openIngredientTablePopup === 'function') {
                    console.log('ğŸ“¦ openIngredientTablePopup í•¨ìˆ˜ë¡œ íŒì—… ì—´ê¸°');
                    window.openIngredientTablePopup();
                } else if (typeof window.handleIngredientPopup === 'function') {
                    console.log('ğŸ“¦ handleIngredientPopup í•¨ìˆ˜ë¡œ íŒì—… ì—´ê¸°');
                    window.handleIngredientPopup();
                } else if (typeof window.openPopup === 'function') {
                    console.log('ğŸ”§ ì§ì ‘ íŒì—… ì—´ê¸° ì‹œë„');
                    const labelId = document.getElementById('label_id')?.value || '';
                    const url = `/label/ingredient-popup/?label_id=${labelId}`;
                    window.openPopup(url, 'IngredientPopup', 1000, 800);
                } else {
                    console.error('âŒ ì‚¬ìš© ê°€ëŠ¥í•œ íŒì—… í•¨ìˆ˜ê°€ ì—†ìŒ');
                    alert('ì›ì¬ë£Œ í‘œë¡œ ì…ë ¥ ê¸°ëŠ¥ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤.');
                }
                console.log('âœ… íŒì—… ì—´ê¸° ì„±ê³µ!');
            } catch (error) {
                console.error('âŒ íŒì—… ì—´ê¸° ì‹¤íŒ¨:', error);
                alert('ì›ì¬ë£Œ í‘œë¡œ ì…ë ¥ì„ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        }, true);
        
        // í¬ì»¤ìŠ¤ ì´ë²¤íŠ¸ë„ ì—°ê²°
        newField.addEventListener('focus', function(e) {
            console.log('ğŸ¯ í¬ì»¤ìŠ¤ë¡œ íŒì—… ì—´ê¸°');
            newField.click();
        });
        
        console.log('âœ… ì›ì¬ë£Œëª… íŒì—… ê°•ì œ ì—°ê²° ì™„ë£Œ');
        return true;
        
    } catch (error) {
        console.error('âŒ ê°•ì œ ì—°ê²° ì‹¤íŒ¨:', error);
        return false;
    }
};

// ğŸ§ª ì›ì¬ë£Œëª… íŒì—… í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
window.testRawMaterialPopup = function() {
    console.log('ğŸ§ª ì›ì¬ë£Œëª… íŒì—… í…ŒìŠ¤íŠ¸ ì‹œì‘');
    
    try {
        if (typeof window.openIngredientTablePopup === 'function') {
            console.log('ğŸ“¦ openIngredientTablePopup í•¨ìˆ˜ í˜¸ì¶œ');
            window.openIngredientTablePopup();
            return true;
        } else if (typeof window.handleIngredientPopup === 'function') {
            console.log('ğŸ“¦ handleIngredientPopup í•¨ìˆ˜ í˜¸ì¶œ');
            window.handleIngredientPopup();
            return true;
        } else if (typeof window.openPopup === 'function') {
            console.log('ğŸ”§ ì§ì ‘ íŒì—… ì—´ê¸°');
            const labelId = document.getElementById('label_id')?.value || '';
            const url = `/label/ingredient-popup/?label_id=${labelId}`;
            window.openPopup(url, 'IngredientPopup', 1000, 800);
            return true;
        } else {
            console.error('âŒ ì‚¬ìš© ê°€ëŠ¥í•œ íŒì—… í•¨ìˆ˜ê°€ ì—†ìŒ');
            return false;
        }
    } catch (error) {
        console.error('âŒ íŒì—… í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error);
        return false;
    }
};

// í˜ì´ì§€ ë¡œë“œ í›„ ìë™ ì—°ê²° ì‹œë„ (ì¡°ê±´ë¶€)
setTimeout(() => {
    const rawmtrlField = document.querySelector('textarea[name="rawmtrl_nm"]');
    if (rawmtrlField) {
        console.log('ğŸ”— ì›ì¬ë£Œëª… í•„ë“œ ë°œê²¬ - ìë™ ì—°ê²° ì‹œë„');
        window.forceConnectRawMaterialModal();
    } else {
        console.log('âš ï¸ ì›ì¬ë£Œëª… í•„ë“œê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•ŠìŒ');
    }
}, 1000);

</script>

<!-- ë¼ë²¨ IDë¥¼ JavaScriptì— ì „ë‹¬í•˜ê¸° ìœ„í•œ ìˆ¨ê²¨ì§„ ì…ë ¥ í•„ë“œ -->
<input type="hidden" id="label_id" value="{{ label.my_label_id }}">

<!-- ìƒë‹¨ í—¤ë” - ê³ ì • ë° ì»´íŒ©íŠ¸ -->
<div class="fixed-header-container">
  <div class="container">
    <div class="compact-header">
      <div class="header-left">
        <h4 class="page-title-compact">
          <i class="fas fa-file-alt me-2"></i>í‘œì‹œì‚¬í•­ ì‘ì„±
        </h4>
        <div class="label-name-compact" style="margin-left: 50px; display: flex; align-items: center; gap: 10px;">
          <label for="my_label_name_top" class="label-name-label-compact">ë¼ë²¨ëª…</label>
          <input type="text" id="my_label_name_top" name="my_label_name_top"
                 class="form-control label-name-input-compact"
                 placeholder="ë¼ë²¨ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"
                 value="{{ label.my_label_name|default:'' }}"
                 style="min-width: 200px; flex: 1;">
          <button type="button" class="btn btn-outline-secondary btn-sm" 
                  onclick="window.location.href='{% url 'label:my_label_list' %}'"
                  title="í‘œì‹œì‚¬í•­ ì‘ì„± ë¦¬ìŠ¤íŠ¸ë¡œ ëŒì•„ê°€ê¸°">
            <i class="fas fa-list me-1"></i>í‘œì‹œì‚¬í•­ ë¦¬ìŠ¤íŠ¸ ë³´ê¸°
          </button>
          <!-- ì˜ì–‘ì„±ë¶„ ê³„ì‚°ê¸° ë²„íŠ¼ì´ ì˜¤ë¥¸ìª½ìœ¼ë¡œ ì´ë™ë¨ -->
        </div>
      </div>
      
      <div class="header-right">
        <span class="last-update-compact">
          <i class="fas fa-pencil-alt me-1"></i>{{ label.update_datetime|date:"m/d H:i" }}
        </span>
        <div class="action-buttons-compact">
          <button type="button" class="btn btn-outline-info btn-sm" 
                  title="ì‚¬ì§„ìœ¼ë¡œ ìë™ ì…ë ¥"
                  onclick="try { showDevelopmentMessage(); return false; } catch(e) { console.error('onclick error:', e); }">
            <i class="fas fa-camera"></i>
          </button>
          <button type="button" class="btn btn-outline-primary btn-sm" onclick="try { openPreviewPopup(); } catch(e) { console.error('onclick error:', e); }">
            <i class="fas fa-eye me-1"></i>ë¯¸ë¦¬ë³´ê¸°
          </button>
          <button type="submit" form="labelForm" class="btn btn-primary btn-sm">
            <i class="fas fa-save me-1"></i>ì €ì¥
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- í—¤ë” ë†’ì´ë§Œí¼ ìƒë‹¨ ì—¬ë°± -->
<div class="header-spacer"></div>

<!-- Step1. ê¸°ë³¸ ì„¤ì • -->
<div class="container" id="step1-row">
  <div class="card modern-card">
    <div class="card-header modern-card-header" id="step1-summary-bar">
      <div class="card-header-content">
        <div class="card-title-section">
          <div class="d-flex align-items-center gap-2">
            <h5 class="card-title mb-0">
              <i class="fas fa-cog me-2"></i>1. ê¸°ë³¸ì •ë³´ ì„¤ì •
            </h5>
            <div class="food-type-summary" id="food-type-summary-display" style="display: none;">
              <span class="badge bg-primary text-white px-3 py-2 clickable-summary" id="selected-food-type" 
                    title="í´ë¦­í•˜ë©´ ì•„ë˜ ì‹í’ˆìœ í˜• í•„ë“œì— ì…ë ¥ë©ë‹ˆë‹¤" style="cursor: pointer;">
                <i class="fas fa-tag me-1"></i>ì‹í’ˆìœ í˜• ì„ íƒë¨
              </span>
            </div>
          </div>
          <!-- ê¸°ì¡´ ìš”ì•½ í‘œì‹œ ì˜ì—­ ì œê±° ë˜ëŠ” ìˆ¨ê¹€ -->
          <div class="summary-display d-none" id="summary-step1">
            ê¸°ë³¸ ì„¤ì •ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”
          </div>
        </div>
        <div class="card-actions">
          <button type="button" class="btn btn-outline-primary btn-sm" id="applyStep1Btn">
            <i class="fas fa-check me-1"></i>í•„ìˆ˜í•­ëª© ì ìš© í›„ ì ‘ê¸°
          </button>
          <button type="button" class="btn btn-outline-primary btn-sm" id="expandStep1Btn">
            <i class="fas fa-expand me-1"></i>í¼ì¹˜ê¸°
          </button>
        </div>
      </div>
    </div>
    <div class="card-body" id="step1-body">
      <div id="food-type-section" class="mb-3">
        <!-- ì‹í’ˆìœ í˜• ì„ íƒê³¼ ì¥ê¸°ë³´ì¡´ì‹í’ˆì„ ê°™ì€ ì¤„ì— 50:50 ë°°ì¹˜ -->
        <div class="row g-3 mb-3">
          <div class="col-6">
            <div class="field-row-modern mb-3">
              <div class="field-label-section">
                <label class="field-label-modern">
                  <i class="fas fa-utensils me-2"></i>ì‹í’ˆìœ í˜•
                </label>
              </div>
              <div class="field-input-section">
                <div class="input-container-modern">
                  <div class="row g-2">
                    <div class="col-6">
                      <select id="food_group" name="food_group" class="form-select form-select-sm">
                        <option value="">ëŒ€ë¶„ë¥˜ ì„ íƒ</option>
                        {% for group in food_groups %}
                        <option value="{{ group }}" {% if label.food_group == group %}selected{% endif %}>{{ group }}</option>
                        {% endfor %}
                      </select>
                    </div>
                    <div class="col-6">
                      <select id="food_type" name="food_type" class="form-select form-select-sm">
                        <option value="">ì†Œë¶„ë¥˜ ì„ íƒ</option>
                        {% for type in food_types %}
                        <option value="{{ type.food_type }}" 
                                data-group="{{ type.food_group }}"
                                {% if label.food_type == type.food_type %}selected{% endif %}>
                          {{ type.food_type }}
                        </option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="col-6">
            <!-- ì¥ê¸°ë³´ì¡´ì‹í’ˆ -->
            <div class="field-row-modern mb-3">
              <div class="field-label-section">
                <label class="field-label-modern">
                  <i class="fas fa-snowflake me-2"></i>ì¥ê¸°ë³´ì¡´ì‹í’ˆ
                </label>
              </div>
              <div class="field-input-section">
                <div class="input-container-modern">
                  <div class="row g-2">
                    <div class="col-3">
                      <div class="form-check-modern form-check-compact">
                        <input type="checkbox" id="chk_frozen_heated" name="preservation_type" value="ëƒ‰ë™(ê°€ì—´)" class="form-check-input-modern" {% if "ëƒ‰ë™(ê°€ì—´)" in label.preservation_type|default:'' %}checked{% endif %}>
                        <label for="chk_frozen_heated" class="form-check-label-modern">ëƒ‰ë™(ê°€ì—´)</label>
                      </div>
                    </div>
                    <div class="col-3">
                      <div class="form-check-modern form-check-compact">
                        <input type="checkbox" id="chk_frozen_nonheated" name="preservation_type" value="ëƒ‰ë™(ë¹„ê°€ì—´)" class="form-check-input-modern" {% if "ëƒ‰ë™(ë¹„ê°€ì—´)" in label.preservation_type|default:'' %}checked{% endif %}>
                        <label for="chk_frozen_nonheated" class="form-check-label-modern">ëƒ‰ë™(ë¹„ê°€ì—´)</label>
                      </div>
                    </div>
                    <div class="col-3">
                      <div class="form-check-modern form-check-compact">
                        <input type="checkbox" id="chk_canned" name="preservation_type" value="í†µ.ë³‘ì¡°ë¦¼" class="form-check-input-modern" {% if "í†µ.ë³‘ì¡°ë¦¼" in label.preservation_type|default:'' %}checked{% endif %}>
                        <label for="chk_canned" class="form-check-label-modern">í†µ.ë³‘ì¡°ë¦¼</label>
                      </div>
                    </div>
                    <div class="col-3">
                      <div class="form-check-modern form-check-compact">
                        <input type="checkbox" id="chk_retort" name="preservation_type" value="ë ˆí† ë¥´íŠ¸" class="form-check-input-modern" {% if "ë ˆí† ë¥´íŠ¸" in label.preservation_type|default:'' %}checked{% endif %}>
                        <label for="chk_retort" class="form-check-label-modern">ë ˆí† ë¥´íŠ¸</label>
                      </div>
                    </div>
                  </div>

                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- ì œì¡°ë°©ë²•ê³¼ ì¡°ê±´ìƒì„¸ë¥¼ 50:50ìœ¼ë¡œ 1ì¤„ì— ë°°ì¹˜ -->
        <div class="row g-3 mb-3">
          <div class="col-6">
            <!-- ì œì¡°ë°©ë²• -->
            <div class="field-row-modern">
              <div class="field-label-section">
                <label class="field-label-modern">
                  <i class="fas fa-industry me-2"></i>ì œì¡°ë°©ë²•
                </label>
              </div>
              <div class="field-input-section">
                <div class="input-container-modern">
                  <div class="row g-2">
                    <div class="col-3">
                      <div class="form-check-modern form-check-compact">
                        <input type="checkbox" id="chk_sanitized" name="processing_method" value="ì‚´ê· " class="form-check-input-modern" {% if "ì‚´ê· " in label.processing_method|default:'' %}checked{% endif %}>
                        <label for="chk_sanitized" class="form-check-label-modern">ì‚´ê· </label>
                      </div>
                    </div>
                    <div class="col-3">
                      <div class="form-check-modern form-check-compact">
                        <input type="checkbox" id="chk_aseptic" name="processing_method" value="ë©¸ê· " class="form-check-input-modern" {% if "ë©¸ê· " in label.processing_method|default:'' %}checked{% endif %}>
                        <label for="chk_aseptic" class="form-check-label-modern">ë©¸ê· </label>
                      </div>
                    </div>
                    <div class="col-3">
                      <div class="form-check-modern form-check-compact">
                        <input type="checkbox" id="chk_yutang" name="processing_method" value="ìœ íƒ•/ìœ ì²˜ë¦¬" class="form-check-input-modern" {% if "ìœ íƒ•/ìœ ì²˜ë¦¬" in label.processing_method|default:'' %}checked{% endif %}>
                        <label for="chk_yutang" class="form-check-label-modern">ìœ íƒ•/ìœ ì²˜ë¦¬</label>
                      </div>
                    </div>

                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="col-6">
            <!-- ì¡°ê±´ ìƒì„¸ -->
            <div class="field-row-modern">
              <div class="field-label-section">
                <label class="field-label-modern">
                  <i class="fas fa-edit me-2"></i>ì¡°ê±´ ìƒì„¸
                </label>
              </div>
              <div class="field-input-section">
                <div class="input-container-modern">
                  <input type="text" name="processing_condition" class="form-control"
                         placeholder="ê¸°íƒ€ ì¡°ê±´ì„ ì…ë ¥í•˜ì„¸ìš”"
                         value="{{ form.processing_condition.value|default:'' }}">
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Step2. ìƒì„¸ ì…ë ¥ ì˜ì—­ -->
<div class="container" id="step2-card">
  <div class="card modern-card">
    <div class="card-header modern-card-header">
      <div class="card-header-content">
        <div class="card-title-section">
          <div class="title-and-buttons" style="display: flex; align-items: center; gap: 15px;">
            <h5 class="card-title">
              <i class="fas fa-edit me-2"></i>2. ìƒì„¸ ì…ë ¥
            </h5>
            <!-- ì›ì¬ë£Œ ê´€ë ¨ ë²„íŠ¼ë“¤ì´ ì˜¤ë¥¸ìª½ìœ¼ë¡œ ì´ë™ë¨ -->
          </div>
        </div>
        <div class="card-actions">
          <div style="display: inline-flex; gap: 5px; flex-wrap: nowrap;">
            <button type="button" class="btn btn-outline-primary btn-sm" style="white-space: nowrap; font-size: 0.85rem; padding: 0.25rem 0.5rem;"
                      onclick="handleIngredientPopup()"
                      title="ì›ì¬ë£Œ í‘œë¡œ ì…ë ¥">
              <i class="fas fa-table me-1"></i>ì›ì¬ë£Œ í‘œë¡œ ì…ë ¥
            </button>
            <button type="button" class="btn btn-outline-primary btn-sm" style="white-space: nowrap; font-size: 0.85rem; padding: 0.25rem 0.5rem;" id="linkedLabelsBtn">
              <i class="fas fa-link me-1"></i>ì—°ê²°ëœ ì›ë£Œ({{ count_ingredient_relations|default:0 }}í’ˆëª©) ì¡°íšŒ
            </button>
            <button type="button" class="btn btn-outline-primary btn-sm" style="white-space: nowrap; font-size: 0.85rem; padding: 0.25rem 0.5rem;"
                      onclick="try { window.openNutritionCalculator(); } catch(e) { console.error('onclick error:', e); }"
                      title="ì˜ì–‘ì„±ë¶„ ê³„ì‚°ê¸°">
              <i class="fas fa-calculator me-1"></i>ì˜ì–‘ì„±ë¶„ ê³„ì‚°ê¸°
            </button>
          </div>
        </div>
      </div>
    </div>
    <div class="card-body">
      <div class="layout-container" style="display: flex; gap: 10px; align-items: flex-start;">
        <div class="left-panel flex-grow-1 position-relative" style="flex-basis: 70%;">
          <form method="post" id="labelForm">
            {% csrf_token %}
            <!-- ë¼ë²¨ëª… í•„ë“œë¥¼ ì‹¤ì œ í¼ í•„ë“œë¡œ í¬í•¨ - name ì†ì„± í™•ì¸ -->
            <input type="hidden" name="my_label_name" id="my_label_name_hidden" value="{{ label.my_label_name|default:'' }}">
            <input type="hidden" id="hidden_food_group" name="food_group" value="{{ label.food_group }}">
            <input type="hidden" id="hidden_food_type" name="food_type" value="{{ label.food_type }}">
            <input type="hidden" id="hidden_preservation_type" name="preservation_type" value="{{ label.preservation_type }}">
            <input type="hidden" id="hidden_processing_method" name="processing_method" value="{{ label.processing_method }}">
            <input type="hidden" id="hidden_processing_condition" name="processing_condition" value="{{ label.processing_condition }}">
            <input type="hidden" name="chckd_label_nm" value="{{ label.chckd_label_nm|default:'N' }}">
            <input type="hidden" name="chckd_prdlst_dcnm" value="{{ label.chckd_prdlst_dcnm|default:'N' }}">
            <input type="hidden" name="chckd_prdlst_nm" value="{{ label.chckd_prdlst_nm|default:'Y' }}">
            <input type="hidden" name="chckd_ingredient_info" value="{{ label.chckd_ingredient_info|default:'N' }}">
            <input type="hidden" name="chckd_content_weight" value="{{ label.chckd_content_weight|default:'Y' }}">
            <input type="hidden" name="chckd_weight_calorie" value="{{ label.chckd_weight_calorie|default:'N' }}">
            <input type="hidden" name="chckd_prdlst_report_no" value="{{ label.chckd_prdlst_report_no|default:'N' }}">
            <input type="hidden" name="chckd_country_of_origin" value="{{ label.chckd_country_of_origin|default:'N' }}">
            <input type="hidden" name="chckd_storage_method" value="{{ label.chckd_storage_method|default:'N' }}">
            <input type="hidden" name="chckd_frmlc_mtrqlt" value="{{ label.chckd_frmlc_mtrqlt|default:'N' }}">
            <input type="hidden" name="chckd_bssh_nm" value="{{ label.chckd_bssh_nm|default:'Y' }}">
            <input type="hidden" name="chckd_distributor_address" value="{{ label.chckd_distributor_address|default:'N' }}">
            <input type="hidden" name="chckd_repacker_address" value="{{ label.chckd_repacker_address|default:'N' }}">
            <input type="hidden" name="chckd_importer_address" value="{{ label.chckd_importer_address|default:'N' }}">
            <input type="hidden" name="chckd_pog_daycnt" value="{{ label.chckd_pog_daycnt|default:'Y' }}">
            <input type="hidden" name="chckd_rawmtrl_nm_display" value="{{ label.chckd_rawmtrl_nm_display|default:'N' }}">
            <input type="hidden" name="chckd_cautions" value="{{ label.chckd_cautions|default:'N' }}">
            <input type="hidden" name="chckd_additional_info" value="{{ label.chckd_additional_info|default:'N' }}">
            <input type="hidden" name="chckd_nutrition_text" value="{{ label.chckd_nutrition_text|default:'N' }}">

            <!-- ì œí’ˆëª… | ì„±ë¶„ëª… ë° í•¨ëŸ‰ -->
            <div class="row g-2 mb-1">
              <div class="col-md-6">
                <div class="field-row-modern">
                  <div class="field-checkbox-section">
                    <input type="checkbox" id="chk_prdlst_nm" name="chk_prdlst_nm" class="field-checkbox-modern" 
                           {% if label.chckd_prdlst_nm == "Y" %}checked{% endif %}>
                    <label for="chk_prdlst_nm" class="field-label-modern">
                      ì œí’ˆëª…
                    </label>
                  </div>
                  <div class="field-input-section">
                    <div class="input-container-modern">
                      <input type="text" name="prdlst_nm" class="form-control auto-expand" 
                             placeholder="ì œí’ˆëª…ì„ ì…ë ¥í•˜ì„¸ìš”" value="{{ form.prdlst_nm.value|default:'' }}">
                    </div>
                  </div>
                  
                </div>
              </div>
              <div class="col-md-6">
                <div class="field-row-modern">
                  <div class="field-checkbox-section">
                    <input type="checkbox" id="chk_ingredient_info" name="chk_ingredient_info" class="field-checkbox-modern" 
                           {% if label.chckd_ingredient_info == "Y" %}checked{% endif %}>
                    <label for="chk_ingredient_info" class="field-label-modern">
                      íŠ¹ì •ì„±ë¶„ í•¨ëŸ‰
                    </label>
                  </div>
                  <div class="field-input-section">
                    <div class="input-container-modern">
                      <input type="text" name="ingredient_info" class="form-control auto-expand" 
                             placeholder="ì˜ˆ) ë ˆëª¬ì¦™ 5%" value="{{ form.ingredient_info.value|default:'' }}">
                    </div>
                  </div>
                  
                </div>
                  </div>
                </div>
              </div>
            </div>
            <!-- ì‹í’ˆìœ í˜• | í’ˆëª©ë³´ê³ ë²ˆí˜¸ -->
            <div class="row g-3 mb-2">
              <div class="col-md-6">
                <div class="field-row-modern">
                  <div class="field-checkbox-section">
                    <input type="checkbox" id="chk_prdlst_dcnm" name="chk_prdlst_dcnm" class="field-checkbox-modern" 
                           {% if label.chckd_prdlst_dcnm == "Y" %}checked{% endif %}>
                    <label for="chk_prdlst_dcnm" class="field-label-modern">
                      ì‹í’ˆìœ í˜•
                    </label>
                  </div>
                  <div class="field-input-section">
                    <div class="input-container-modern">
                      <input type="text" name="prdlst_dcnm" class="form-control auto-expand" 
                             placeholder="ìƒë‹¨ì˜ ì‹í’ˆìœ í˜•ì„ ì°¸ê³ í•˜ì—¬ ì…ë ¥í•˜ì„¸ìš”" value="{{ form.prdlst_dcnm.value|default:'' }}">
                    </div>
                  </div>
                  
                </div>
              </div>
              <div class="col-md-6">
                <div class="field-row-modern">
                  <div class="field-checkbox-section">
                    <input type="checkbox" id="chk_prdlst_report_no" name="chk_prdlst_report_no" class="field-checkbox-modern" 
                           {% if label.chckd_prdlst_report_no == "Y" %}checked{% endif %}>
                    <label for="chk_prdlst_report_no" class="field-label-modern">
                      í’ˆëª©ë³´ê³ ë²ˆí˜¸
                    </label>
                  </div>
                  <div class="field-input-section">
                    <div class="input-container-modern d-flex align-items-center gap-2">
                      <input type="text" name="prdlst_report_no" class="form-control flex-grow-1" 
                             placeholder="0000000000000 (13-14ìë¦¬)"
                             maxlength="15"
                             value="{{ form.prdlst_report_no.value|default:'' }}"
                             style="flex: 1; min-width: 200px;">
                      <button type="button" class="btn btn-outline-primary btn-sm flex-shrink-0" 
                                id="verifyReportNoBtn" 
                                onclick="verifyReportNo(document.getElementById('label_id')?.value)"
                                title="API ì¤‘ë³µ ê²€ì‚¬ ë° ë²ˆí˜¸ ê·œì¹™ ê²€ì¦"
                                style="margin-left: auto;">
                          <i class="fas fa-search me-1"></i>ì¤‘ë³µê²€ì¦
                        </button>
                    </div>
                  </div>
                  
                </div>
              </div>
            </div>            <!-- ë‚´ìš©ëŸ‰ | ì›ì‚°ì§€ -->
            <div class="row g-3 mb-2">
              <div class="col-md-6">
                <div class="field-row-modern">
                  <div class="field-checkbox-section">
                    <input type="checkbox" id="chk_content_weight" name="chk_content_weight" class="field-checkbox-modern" 
                           {% if label.chckd_content_weight == "Y" or label.chckd_weight_calorie == "Y" %}checked{% endif %}>
                    <label class="field-label-modern">
                      <span id="content_type_display">ë‚´ìš©ëŸ‰</span>
                    </label>
                    <input type="hidden" id="content_type_value" name="content_type" value="content_weight">
                  </div>
                  <div class="field-input-section">
                    <div class="input-container-modern">
                      <input type="text" id="content_weight_input" name="content_weight" class="form-control auto-expand" 
                             placeholder="ë‚´ìš©ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”" value="{{ form.content_weight.value|default:'' }}">
                    </div>
                  </div>
                  
                </div>
              </div>
              <div class="col-md-6">
                <div class="field-row-modern">
                  <div class="field-checkbox-section">
                    <input type="checkbox" id="chk_country_of_origin" name="chk_country_of_origin" class="field-checkbox-modern" 
                           {% if label.chckd_country_of_origin == "Y" %}checked{% endif %}>
                    <label for="chk_country_of_origin" class="field-label-modern">
                      ì›ì‚°ì§€
                    </label>
                  </div>
                  <div class="field-input-section">
                    <div class="input-container-modern">
                      <select name="country_of_origin" class="form-control select2-country" style="width: 100%;">
                        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        {% for c in country_list %}
                        <option value="{{ c.country_code2 }}" {% if form.country_of_origin.value == c.country_code2 %}selected{% endif %}>{{ c.country_name_ko }}</option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>
                  
                </div>
              </div>
            </div>

            <!-- ë³´ê´€ë°©ë²• | ìš©ê¸°.í¬ì¥ì¬ì§ˆ -->
            <div class="row g-3 mb-2">
              <div class="col-md-6">
                <div class="field-row-modern">
                  <div class="field-checkbox-section">
                    <input type="checkbox" id="chk_storage_method" name="chk_storage_method" class="field-checkbox-modern" 
                           {% if label.chckd_storage_method == "Y" %}checked{% endif %}>
                    <label for="chk_storage_method" class="field-label-modern">
                      ë³´ê´€ë°©ë²•
                    </label>
                  </div>
                  <div class="field-input-section">
                    <div class="input-container-modern">
                      <input type="text" name="storage_method" class="form-control auto-expand" 
                             placeholder="ë³´ê´€ë°©ë²•ì„ ì…ë ¥í•˜ê±°ë‚˜ ë‚´ë¬¸êµ¬ë¥¼ ì„ íƒí•˜ì„¸ìš”" value="{{ form.storage_method.value|default:'' }}">
                    </div>
                  </div>
                  
                </div>
              </div>
              <div class="col-md-6">
                <div class="field-row-modern">
                  <div class="field-checkbox-section">
                    <input type="checkbox" id="chk_frmlc_mtrqlt" name="chk_frmlc_mtrqlt" class="field-checkbox-modern" 
                           {% if label.chckd_frmlc_mtrqlt == "Y" %}checked{% endif %}>
                    <label for="chk_frmlc_mtrqlt" class="field-label-modern">
                      ìš©ê¸°.í¬ì¥ì¬ì§ˆ
                    </label>
                  </div>
                  <div class="field-input-section">
                    <div class="input-container-modern">
                      <input type="text" name="frmlc_mtrqlt" class="form-control auto-expand" 
                             placeholder="ìš©ê¸°.í¬ì¥ì¬ì§ˆì„ ì…ë ¥í•˜ê±°ë‚˜ ë‚´ë¬¸êµ¬ë¥¼ ì„ íƒí•˜ì„¸ìš”" value="{{ form.frmlc_mtrqlt.value|default:'' }}">
                    </div>
                  </div>
                  
                </div>
              </div>
            </div>

            <!-- ì œì¡°ì› ì†Œì¬ì§€ -->
            <div class="row g-3 mb-2">
              <div class="col-12">
                <div class="field-row-modern">
                  <div class="field-checkbox-section field-checkbox-section-vertical-center">
                    <input type="checkbox" id="chk_bssh_nm" name="chk_bssh_nm" class="field-checkbox-modern" 
                           {% if label.chckd_bssh_nm == "Y" %}checked{% endif %}>
                    <label for="chk_bssh_nm" class="field-label-modern">
                      ì œì¡°ì› ì†Œì¬ì§€
                    </label>
                    <button type="button" class="btn btn-outline-primary btn-sm ms-2" 
                              id="toggleManufacturerBtn"
                              data-bs-toggle="collapse" data-bs-target="#other-manufacturers" aria-expanded="false"
                              aria-controls="other-manufacturers"
                              title="ì¶”ê°€ ì œì¡°ì› ì •ë³´"
                              style="min-width: 40px; padding: 0.375rem 0.75rem;">
                        <i class="fas fa-chevron-down"></i>
                      </button>
                  </div>
                  <div class="field-input-section">
                    <div class="input-container-modern">
                      <input type="text" name="bssh_nm" class="form-control auto-expand" 
                             placeholder="ì œì¡°ì›ì„ ì…ë ¥í•˜ê±°ë‚˜ ë‚´ë¬¸êµ¬ë¥¼ ì„ íƒí•˜ì„¸ìš”" value="{{ form.bssh_nm.value|default:'' }}">
                    </div>
                  </div>
                  
                </div>
              </div>
            </div>
            <!-- ì ‘í˜ ì˜ì—­ -->
            <div class="collapse mb-2" id="other-manufacturers">
              <div class="row g-3 mb-2">
                <div class="col-12">
                  <div class="field-row-modern">
                    <div class="field-checkbox-section">
                      <input type="checkbox" id="chk_distributor_address" name="chk_distributor_address" class="field-checkbox-modern" 
                             {% if label.chckd_distributor_address == "Y" %}checked{% endif %}>
                      <label for="chk_distributor_address" class="field-label-modern">
                        ìœ í†µì „ë¬¸íŒë§¤ì›
                      </label>
                    </div>
                    <div class="field-input-section">
                      <div class="input-container-modern">
                        <input type="text" name="distributor_address" class="form-control auto-expand" 
                               placeholder="ìœ í†µì „ë¬¸íŒë§¤ì›ì„ ì…ë ¥í•˜ê±°ë‚˜ ë‚´ë¬¸êµ¬ë¥¼ ì„ íƒí•˜ì„¸ìš”"
                               value="{{ form.distributor_address.value|default:'' }}">
                      </div>
                    </div>
                    
                  </div>
                </div>
              </div>
              <div class="row g-3 mb-2">
                <div class="col-12">
                  <div class="field-row-modern">
                    <div class="field-checkbox-section">
                      <input type="checkbox" id="chk_repacker_address" name="chk_repacker_address" class="field-checkbox-modern" 
                             {% if label.chckd_repacker_address == "Y" %}checked{% endif %}>
                      <label for="chk_repacker_address" class="field-label-modern">
                        ì†Œë¶„ì›
                      </label>
                    </div>
                    <div class="field-input-section">
                      <div class="input-container-modern">
                        <input type="text" name="repacker_address" class="form-control auto-expand" 
                               placeholder="ì†Œë¶„ì›ì„ ì…ë ¥í•˜ê±°ë‚˜ ë‚´ë¬¸êµ¬ë¥¼ ì„ íƒí•˜ì„¸ìš”"
                               value="{{ form.repacker_address.value|default:'' }}">
                      </div>
                    </div>
                    
                  </div>
                </div>
              </div>
              <div class="row g-3 mb-2">
                <div class="col-12">
                  <div class="field-row-modern">
                    <div class="field-checkbox-section">
                      <input type="checkbox" id="chk_importer_address" name="chk_importer_address" class="field-checkbox-modern" 
                             {% if label.chckd_importer_address == "Y" %}checked{% endif %}>
                      <label for="chk_importer_address" class="field-label-modern">
                        ìˆ˜ì…ì›
                      </label>
                    </div>
                    <div class="field-input-section">
                      <div class="input-container-modern">
                        <input type="text" name="importer_address" class="form-control auto-expand" 
                               placeholder="ìˆ˜ì…ì›ì„ ì…ë ¥í•˜ê±°ë‚˜ ë‚´ë¬¸êµ¬ë¥¼ ì„ íƒí•˜ì„¸ìš”"
                               value="{{ form.importer_address.value|default:'' }}">
                      </div>
                    </div>
                    
                  </div>
                </div>
              </div>
            </div>

            <!-- ì†Œë¹„ê¸°í•œ/í’ˆì§ˆìœ ì§€ê¸°í•œ/ì œì¡°ì—°ì›”ì¼/ìƒì‚°ì—°ë„ -->
            <div class="row g-3 mb-2">
              <div class="col-12">
                <div class="field-row-modern">
                  <div class="field-checkbox-section">
                    <input type="checkbox" id="chk_pog_daycnt" name="chk_pog_daycnt" class="field-checkbox-modern" 
                           {% if label.chckd_pog_daycnt == "Y" %}checked{% endif %}>
                    <label class="field-label-modern">
                      <select name="date_option" class="form-select form-select-sm ms-1" style="width: auto; display: inline-block;">
                        <option value="ì†Œë¹„ê¸°í•œ" {% if form.date_option.value == "ì†Œë¹„ê¸°í•œ" or not form.date_option.value %}selected{% endif %}>ì†Œë¹„ê¸°í•œ</option>
                        <option value="í’ˆì§ˆìœ ì§€ê¸°í•œ" {% if form.date_option.value == "í’ˆì§ˆìœ ì§€ê¸°í•œ" %}selected{% endif %}>í’ˆì§ˆìœ ì§€ê¸°í•œ</option>
                        <option value="ì œì¡°ì—°ì›”ì¼" {% if form.date_option.value == "ì œì¡°ì—°ì›”ì¼" %}selected{% endif %}>ì œì¡°ì—°ì›”ì¼</option>
                        <option value="ìƒì‚°ì—°ë„" {% if form.date_option.value == "ìƒì‚°ì—°ë„" %}selected{% endif %}>ìƒì‚°ì—°ë„</option>
                      </select>
                    </label>
                  </div>
                  <div class="field-input-section">
                    <div class="input-container-modern">
                      <input type="text" name="pog_daycnt" class="form-control auto-expand" 
                             placeholder="ì†Œë¹„ê¸°í•œ ë“±ì„ ì…ë ¥í•˜ê±°ë‚˜ ë‚´ë¬¸êµ¬ë¥¼ ì„ íƒí•˜ì„¸ìš”" value="{{ form.pog_daycnt.value|default:'' }}">
                    </div>
                  </div>
                  
                </div>
              </div>
            </div>

            <!-- ì›ì¬ë£Œëª…(í‘œì‹œ) -->
            <div class="row g-3 mb-2">
              <div class="col-12">
                <div class="field-row-modern">
                  <div class="field-checkbox-section field-checkbox-section-vertical-center">
                    <input type="checkbox" id="chk_rawmtrl_nm_display" name="chk_rawmtrl_nm_display" class="field-checkbox-modern" 
                           {% if label.chckd_rawmtrl_nm_display == "Y" %}checked{% endif %}>
                    <div class="label-button-container">
                      <label for="chk_rawmtrl_nm_display" class="field-label-modern">
                        ì›ì¬ë£Œëª…(í‘œì‹œ)
                      </label>
                    </div>
                  </div>
                  <div class="field-input-section">
                    <div class="input-container-modern">
                      <textarea name="rawmtrl_nm_display" class="form-control auto-expand textarea" rows="2" 
                                placeholder="ì›ì¬ë£Œëª…(í‘œì‹œ)ì„ ì…ë ¥í•˜ì„¸ìš”">{{ form.rawmtrl_nm_display.value|default:form.rawmtrl_nm.value|default:'' }}</textarea>
                    </div>
                  </div>
                  
                </div>
              </div>
            </div>
            <!-- ì›ì¬ë£Œëª… (ì°¸ê³ ) - í•­ìƒ í‘œì‹œ -->
            <div class="row g-3 mb-2" id="rawmtrl_nm_section">
              <div class="col-12">
                <div class="field-row-modern">
                  <div class="field-checkbox-section">
                    <input type="checkbox" id="chk_rawmtrl_nm" name="chk_rawmtrl_nm" class="field-checkbox-modern" 
                           {% if label.chckd_rawmtrl_nm == "Y" %}checked{% endif %}>
                    <label for="chk_rawmtrl_nm" class="field-label-modern">
                      <i class="fas fa-info-circle me-1"></i>ì›ì¬ë£Œëª…(ì°¸ê³ )
                    </label>
                  </div>
                  <div class="field-input-section">
                    <div class="input-container-modern" style="position: relative;">
                      <textarea name="rawmtrl_nm" id="rawmtrl_nm" class="form-control auto-expand textarea" rows="2" 
                                placeholder="ì›ì¬ë£Œ í‘œë¡œ ì…ë ¥ì„ ì‚¬ìš©í•˜ì—¬ ì…ë ¥í•˜ì„¸ìš”" readonly>{{ form.rawmtrl_nm.value|default:'' }}</textarea>
                      <!-- í´ë¦­ ê°ì§€ë¥¼ ìœ„í•œ íˆ¬ëª… ì˜¤ë²„ë ˆì´ -->
                      <div id="rawmtrl_nm_overlay" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; 
                           background: transparent; cursor: pointer; z-index: 10;" 
                           title="í´ë¦­í•˜ì—¬ ì›ì¬ë£Œ í‘œë¡œ ì…ë ¥"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- ì£¼ì˜ì‚¬í•­ -->
            <div class="row g-3 mb-2">
              <div class="col-12">
                <div class="field-row-modern">
                  <div class="field-checkbox-section field-checkbox-section-vertical-center">
                    <input type="checkbox" id="chk_cautions" name="chk_cautions" class="field-checkbox-modern" 
                           {% if label.chckd_cautions == "Y" %}checked{% endif %}>
                    <label for="chk_cautions" class="field-label-modern">
                      ì£¼ì˜ì‚¬í•­
                    </label>
                  </div>
                  <div class="field-input-section">
                    <div class="input-container-modern">
                      <textarea name="cautions" class="form-control auto-expand textarea" rows="2" 
                                placeholder="ì£¼ì˜ì‚¬í•­ì„ ì…ë ¥í•˜ê±°ë‚˜ ë‚´ë¬¸êµ¬ë¥¼ ì„ íƒí•˜ì„¸ìš”. ì—¬ëŸ¬ í•­ëª©ì„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.">{{ form.cautions.value|default:'' }}</textarea>
                    </div>
                  </div>
                  
                </div>
              </div>
            </div>

            <!-- ê¸°íƒ€ í‘œì‹œì‚¬í•­ -->
            <div class="row g-3 mb-2">
              <div class="col-12">
                <div class="field-row-modern">
                  <div class="field-checkbox-section field-checkbox-section-vertical-center">
                    <input type="checkbox" id="chk_additional_info" name="chk_additional_info" class="field-checkbox-modern" 
                           {% if label.chckd_additional_info == "Y" %}checked{% endif %}>
                    <label for="chk_additional_info" class="field-label-modern">
                      ê¸°íƒ€í‘œì‹œì‚¬í•­
                    </label>
                  </div>
                  <div class="field-input-section">
                    <div class="input-container-modern">
                      <textarea name="additional_info" class="form-control auto-expand textarea" rows="2" 
                                placeholder="ê¸°íƒ€ í‘œì‹œì‚¬í•­ì„ ì…ë ¥í•˜ê±°ë‚˜ ë‚´ë¬¸êµ¬ë¥¼ ì„ íƒí•˜ì„¸ìš”. ì—¬ëŸ¬ í•­ëª©ì„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.">{{ form.additional_info.value|default:'' }}</textarea>
                    </div>
                  </div>
                  
                </div>
              </div>
            </div>

            <!-- ì˜ì–‘ì„±ë¶„ -->
            <div class="row g-3 mb-2">
              <div class="col-12">
                <div class="field-row-modern">
                  <div class="field-checkbox-section field-checkbox-section-vertical-center">
                    <input type="checkbox" id="chk_nutrition_text" name="chk_nutrition_text" class="field-checkbox-modern" 
                           {% if label.chckd_nutrition_text == "Y" %}checked{% endif %} style="display: none;">
                    <div class="label-button-container">
                      <label for="chk_nutrition_text" class="field-label-modern">
                        <i class="fas fa-calculator me-1"></i>ì˜ì–‘ì„±ë¶„
                      </label>
                    </div>
                  </div>
                  <div class="field-input-section">
                    <div class="input-container-modern">
                      <textarea name="nutrition_text" id="nutrition_text" class="form-control auto-expand textarea" rows="2" 
                                placeholder="ì˜ì–‘ì„±ë¶„ ê³„ì‚°ê¸°ë¥¼ ì‚¬ìš©í•˜ì—¬ ì…ë ¥í•˜ì„¸ìš”" readonly>{{ form.nutrition_text.value|default:'' }}</textarea>
                    </div>
                  </div>
                </div>
                </div>
              </div>
            </div>
            
            <!-- ì˜ì–‘ì„±ë¶„ hidden í•„ë“œ -->
            <div style="display: none;">
              <input type="hidden" name="serving_size" value="{{ form.serving_size.value|default:'' }}">
              <input type="hidden" name="serving_size_unit" value="{{ form.serving_size_unit.value|default:'' }}">
              <input type="hidden" name="units_per_package" value="{{ form.units_per_package.value|default:'' }}">
              <input type="hidden" name="nutrition_display_unit" value="{{ form.nutrition_display_unit.value|default:'' }}">
              <!-- ì˜ì–‘ì„±ë¶„ í‘œì‹œ ìŠ¤íƒ€ì¼ ë° ê¸°ì¤€ -->
              <input type="hidden" name="nutrition_style" value="{{ form.nutrition_style.value|default:'' }}">
              <input type="hidden" name="nutrition_display_type" value="{{ form.nutrition_display_type.value|default:'' }}">
              <input type="hidden" name="nutrition_base_amount" value="{{ form.nutrition_base_amount.value|default:'' }}">
              <input type="hidden" name="nutrition_base_amount_unit" value="{{ form.nutrition_base_amount_unit.value|default:'' }}">
              <!-- ì˜ì–‘ì„±ë¶„ ê°’ í•„ë“œ -->
              <!-- DEBUG: calories = "{{ form.calories.value|default:'ì—†ìŒ' }}" -->
              <input type="hidden" name="calories" value="{{ form.calories.value|default:'' }}">
              <input type="hidden" name="calories_unit" value="{{ form.calories_unit.value|default:'' }}">
              <!-- DEBUG: natriums = "{{ form.natriums.value|default:'ì—†ìŒ' }}" -->
              <input type="hidden" name="natriums" value="{{ form.natriums.value|default:'' }}">
              <input type="hidden" name="natriums_unit" value="{{ form.natriums_unit.value|default:'' }}">
              <input type="hidden" name="carbohydrates" value="{{ form.carbohydrates.value|default:'' }}">
              <input type="hidden" name="carbohydrates_unit" value="{{ form.carbohydrates_unit.value|default:'' }}">
              <input type="hidden" name="sugars" value="{{ form.sugars.value|default:'' }}">
              <input type="hidden" name="sugars_unit" value="{{ form.sugars_unit.value|default:'' }}">
              <input type="hidden" name="fats" value="{{ form.fats.value|default:'' }}">
              <input type="hidden" name="fats_unit" value="{{ form.fats_unit.value|default:'' }}">
              <input type="hidden" name="trans_fats" value="{{ form.trans_fats.value|default:'' }}">
              <input type="hidden" name="trans_fats_unit" value="{{ form.trans_fats_unit.value|default:'' }}">
              <input type="hidden" name="saturated_fats" value="{{ form.saturated_fats.value|default:'' }}">
              <input type="hidden" name="saturated_fats_unit" value="{{ form.saturated_fats_unit.value|default:'' }}">
              <input type="hidden" name="cholesterols" value="{{ form.cholesterols.value|default:'' }}">
              <input type="hidden" name="cholesterols_unit" value="{{ form.cholesterols_unit.value|default:'' }}">
              <input type="hidden" name="proteins" value="{{ form.proteins.value|default:'' }}">
              <input type="hidden" name="proteins_unit" value="{{ form.proteins_unit.value|default:'' }}">
              <!-- ì¶”ê°€ ì˜ì–‘ì„±ë¶„ í•„ë“œë“¤ -->
              <input type="hidden" name="dietary_fiber" value="{{ form.dietary_fiber.value|default:'' }}">
              <input type="hidden" name="dietary_fiber_unit" value="{{ form.dietary_fiber_unit.value|default:'' }}">
              <input type="hidden" name="calcium" value="{{ form.calcium.value|default:'' }}">
              <input type="hidden" name="calcium_unit" value="{{ form.calcium_unit.value|default:'' }}">
              <input type="hidden" name="iron" value="{{ form.iron.value|default:'' }}">
              <input type="hidden" name="iron_unit" value="{{ form.iron_unit.value|default:'' }}">
              <input type="hidden" name="potassium" value="{{ form.potassium.value|default:'' }}">
              <input type="hidden" name="potassium_unit" value="{{ form.potassium_unit.value|default:'' }}">
              <input type="hidden" name="magnesium" value="{{ form.magnesium.value|default:'' }}">
              <input type="hidden" name="magnesium_unit" value="{{ form.magnesium_unit.value|default:'' }}">
              <input type="hidden" name="zinc" value="{{ form.zinc.value|default:'' }}">
              <input type="hidden" name="zinc_unit" value="{{ form.zinc_unit.value|default:'' }}">
              <input type="hidden" name="phosphorus" value="{{ form.phosphorus.value|default:'' }}">
              <input type="hidden" name="phosphorus_unit" value="{{ form.phosphorus_unit.value|default:'' }}">
              <input type="hidden" name="vitamin_a" value="{{ form.vitamin_a.value|default:'' }}">
              <input type="hidden" name="vitamin_a_unit" value="{{ form.vitamin_a_unit.value|default:'' }}">
              <input type="hidden" name="vitamin_d" value="{{ form.vitamin_d.value|default:'' }}">
              <input type="hidden" name="vitamin_d_unit" value="{{ form.vitamin_d_unit.value|default:'' }}">
              <input type="hidden" name="vitamin_e" value="{{ form.vitamin_e.value|default:'' }}">
              <input type="hidden" name="vitamin_e_unit" value="{{ form.vitamin_e_unit.value|default:'' }}">
              <input type="hidden" name="vitamin_c" value="{{ form.vitamin_c.value|default:'' }}">
              <input type="hidden" name="vitamin_c_unit" value="{{ form.vitamin_c_unit.value|default:'' }}">
              <input type="hidden" name="vitamin_b1" value="{{ form.vitamin_b1.value|default:'' }}">
              <input type="hidden" name="vitamin_b1_unit" value="{{ form.vitamin_b1_unit.value|default:'' }}">
              <input type="hidden" name="vitamin_b2" value="{{ form.vitamin_b2.value|default:'' }}">
              <input type="hidden" name="vitamin_b2_unit" value="{{ form.vitamin_b2_unit.value|default:'' }}">
              <input type="hidden" name="vitamin_b6" value="{{ form.vitamin_b6.value|default:'' }}">
              <input type="hidden" name="vitamin_b6_unit" value="{{ form.vitamin_b6_unit.value|default:'' }}">
              <input type="hidden" name="vitamin_b12" value="{{ form.vitamin_b12.value|default:'' }}">
              <input type="hidden" name="vitamin_b12_unit" value="{{ form.vitamin_b12_unit.value|default:'' }}">
              <input type="hidden" name="folic_acid" value="{{ form.folic_acid.value|default:'' }}">
              <input type="hidden" name="folic_acid_unit" value="{{ form.folic_acid_unit.value|default:'' }}">
              <input type="hidden" name="niacin" value="{{ form.niacin.value|default:'' }}">
              <input type="hidden" name="niacin_unit" value="{{ form.niacin_unit.value|default:'' }}">
              <input type="hidden" name="pantothenic_acid" value="{{ form.pantothenic_acid.value|default:'' }}">
              <input type="hidden" name="pantothenic_acid_unit" value="{{ form.pantothenic_acid_unit.value|default:'' }}">
              <input type="hidden" name="biotin" value="{{ form.biotin.value|default:'' }}">
              <input type="hidden" name="biotin_unit" value="{{ form.biotin_unit.value|default:'' }}">
              <input type="hidden" name="selenium" value="{{ form.selenium.value|default:'' }}">
              <input type="hidden" name="selenium_unit" value="{{ form.selenium_unit.value|default:'' }}">
              <input type="hidden" name="iodine" value="{{ form.iodine.value|default:'' }}">
              <input type="hidden" name="iodine_unit" value="{{ form.iodine_unit.value|default:'' }}">
            </div>
          </form>
        </div>
      </div>    
    </div>
  </div>
</div>

<!-- OCR ì—…ë¡œë“œ ëª¨ë‹¬ -->
<div class="modal fade" id="ocrUploadModal" tabindex="-1" aria-labelledby="ocrUploadModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="ocrUploadModalLabel">
          <i class="fas fa-camera me-2"></i>í‘œì‹œì‚¬í•­ ì‚¬ì§„ìœ¼ë¡œ ìë™ ì…ë ¥
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- ì—…ë¡œë“œ ë°©ì‹ ì„ íƒ íƒ­ -->
        <ul class="nav nav-tabs mb-3" id="uploadTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="camera-tab" data-bs-toggle="tab" data-bs-target="#camera-pane" type="button" role="tab">
              <i class="fas fa-camera me-2"></i>ì‚¬ì§„ ì´¬ì˜
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="file-tab" data-bs-toggle="tab" data-bs-target="#file-pane" type="button" role="tab">
              <i class="fas fa-image me-2"></i>ì´ë¯¸ì§€ íŒŒì¼
            </button>
          </li>
        </ul>

        <div class="tab-content" id="uploadTabsContent">
          <!-- ì‚¬ì§„ ì´¬ì˜ íƒ­ -->
          <div class="tab-pane fade show active" id="camera-pane" role="tabpanel">
            <div class="upload-area text-center p-4 border border-dashed rounded" 
                 id="uploadArea" 
                 style="border-color: #dee2e6; background-color: #f8f9fa; cursor: pointer;">
              <div class="upload-placeholder">
                <i class="fas fa-camera fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">í‘œì‹œì‚¬í•­ ì‚¬ì§„ì„ ì´¬ì˜í•˜ì„¸ìš”</h5>
                <p class="text-muted small mb-0">
                  ë“œë˜ê·¸ ì•¤ ë“œë¡­í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì‚¬ì§„ì„ ì´¬ì˜í•˜ì„¸ìš”<br>
                  JPG, PNG íŒŒì¼ ì§€ì› (ìµœëŒ€ 5MB)
                </p>
              </div>
              <input type="file" id="imageInput" accept="image/*" capture="environment" style="display: none;">
            </div>
          </div>

          <!-- ì´ë¯¸ì§€ íŒŒì¼ íƒ­ -->
          <div class="tab-pane fade" id="file-pane" role="tabpanel">
            <div class="upload-area text-center p-4 border border-dashed rounded" 
                 id="fileUploadArea" 
                 style="border-color: #dee2e6; background-color: #f8f9fa; cursor: pointer;">
              <div class="upload-placeholder">
                <i class="fas fa-image fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">í‘œì‹œì‚¬í•­ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”</h5>
                <p class="text-muted small mb-0">
                  í´ë¦­í•˜ì—¬ ì´ë¯¸ì§€ íŒŒì¼ì„ ì„ íƒí•˜ê±°ë‚˜<br>
                  ë“œë˜ê·¸ ì•¤ ë“œë¡­ìœ¼ë¡œ ì—…ë¡œë“œí•˜ì„¸ìš”<br>
                  JPG, PNG, GIF, BMP íŒŒì¼ ì§€ì› (ìµœëŒ€ 10MB)
                </p>
                <button type="button" class="btn btn-outline-primary btn-sm mt-3" onclick="document.getElementById('fileInput').click()">
                  <i class="fas fa-folder-open me-2"></i>íŒŒì¼ ì„ íƒ
                </button>
              </div>
              <input type="file" id="fileInput" accept="image/*" style="display: none;">
            </div>
          </div>
        </div>
        
        <!-- ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° -->
        <div id="imagePreview" style="display: none;">
          <div class="text-center mb-3">
            <img id="previewImg" class="img-fluid border rounded" style="max-height: 300px;">
          </div>
          <div class="d-flex justify-content-between">
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="resetUpload()">
              <i class="fas fa-redo me-1"></i>ë‹¤ì‹œ ì„ íƒ
            </button>
            <button type="button" class="btn btn-primary btn-sm" onclick="processOCR()" id="processBtn">
              <span id="processText">
                <i class="fas fa-magic me-1"></i>í…ìŠ¤íŠ¸ ì¶”ì¶œí•˜ê¸°
              </span>
              <span id="processSpinner" class="spinner-border spinner-border-sm ms-2" style="display: none;"></span>
            </button>
          </div>
        </div>
        
        <!-- OCR ê²°ê³¼ í‘œì‹œ -->
        <div id="ocrResults" style="display: none;">
          <div class="mb-3">
            <h6><i class="fas fa-file-text me-2"></i>ì¶”ì¶œëœ í…ìŠ¤íŠ¸</h6>
            <div class="border rounded p-3 bg-light" style="max-height: 150px; overflow-y: auto;">
              <pre id="extractedText" class="mb-0 small" style="white-space: pre-wrap;"></pre>
            </div>
          </div>
          
          <!-- í•„ë“œë³„ ë§¤í•‘ ê²°ê³¼ -->
          <div class="mb-3">
            <h6><i class="fas fa-list-check me-2"></i>ìë™ ë¶„ë¥˜ ê²°ê³¼</h6>
            <div id="fieldMappings" class="border rounded p-2" style="max-height: 300px; overflow-y: auto;">
              <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë  í•„ë“œ ë§¤í•‘ ê²°ê³¼ -->
            </div>
          </div>
          
          <div class="d-flex justify-content-between">
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="resetUpload()">
              <i class="fas fa-arrow-left me-1"></i>ì²˜ìŒìœ¼ë¡œ
            </button>
            <div>
              <button type="button" class="btn btn-secondary btn-sm me-2" data-bs-dismiss="modal">ì·¨ì†Œ</button>
              <button type="button" class="btn btn-success btn-sm" onclick="applyOCRResults()">
                <i class="fas fa-check me-1"></i>ì ìš©í•˜ê¸°
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- OCR ê´€ë ¨ ìŠ¤íƒ€ì¼ -->
<style>
.upload-area {
  transition: all 0.3s ease;
  min-height: 200px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.upload-area:hover {
  background-color: #e9ecef !important;
  border-color: #adb5bd !important;
}

.upload-area.dragover {
  background-color: #cff4fc !important;
  border-color: #0dcaf0 !important;
}

.field-mapping-item {
  transition: all 0.2s ease;
}

.field-mapping-item:hover {
  background-color: #f8f9fa;
}

.confidence-badge {
  font-size: 0.75em;
}

.confidence-high {
  background-color: #28a745 !important;
}

.confidence-medium {
  background-color: #ffc107 !important;
}

.confidence-low {
  background-color: #dc3545 !important;
}

#extractedText {
  font-family: 'Courier New', monospace;
  font-size: 0.85em;
  line-height: 1.3;
}

/* OCR íƒ­ ìŠ¤íƒ€ì¼ */
.nav-tabs .nav-link {
  border: 1px solid transparent;
  border-top-left-radius: 0.375rem;
  border-top-right-radius: 0.375rem;
  color: #6c757d;
  transition: all 0.3s ease;
}

.nav-tabs .nav-link:hover {
  border-color: #e9ecef #e9ecef #dee2e6;
  color: #0d6efd;
}

.nav-tabs .nav-link.active {
  color: #0d6efd;
  background-color: #fff;
  border-color: #dee2e6 #dee2e6 #fff;
  font-weight: 600;
}

.nav-tabs .nav-link i {
  margin-right: 0.5rem;
}

/* íŒŒì¼ ì—…ë¡œë“œ ì˜ì—­ ê°œì„  */
#fileUploadArea .upload-placeholder {
  padding: 2rem 1rem;
}

#fileUploadArea .btn {
  margin-top: 1rem;
  min-width: 120px;
}

/* ëª¨ë‹¬ í¬ê¸° ì¡°ì • */
@media (min-width: 992px) {
  .modal-lg {
    max-width: 900px;
  }
}

/* ì—…ë¡œë“œ ì˜ì—­ ë°˜ì‘í˜• */
@media (max-width: 768px) {
  .upload-area {
    min-height: 150px;
  }
  
  .upload-placeholder h5 {
    font-size: 1.1rem;
  }
  
  .upload-placeholder p {
    font-size: 0.85rem;
  }
}

/* í†µí•© ì¶”ì²œ ì‹œìŠ¤í…œ ìŠ¤íƒ€ì¼ */
.integrated-recommendations .hover-highlight:hover {
  background-color: #f8f9fa !important;
  border-color: #007bff !important;
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(0,123,255,0.15);
}

.integrated-recommendations .recommendation-item {
  transition: all 0.2s ease;
  border: 1px solid #dee2e6;
}

.integrated-recommendations .card-header {
  font-size: 0.9rem;
  font-weight: 600;
}

.integrated-recommendations .badge {
  background-color: rgba(255,255,255,0.2) !important;
  color: inherit !important;
}

.integrated-recommendations .recommendation-text {
  font-size: 0.9rem;
  line-height: 1.3;
  margin-bottom: 2px;
}

.integrated-recommendations .btn-sm {
  padding: 0.25rem 0.5rem;
  font-size: 0.75rem;
}

.integrated-recommendations .card {
  border: none;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  margin-bottom: 1rem;
}

.integrated-recommendations .card-body {
  background-color: #fafafa;
}
</style>

<!-- ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì œì¶œì„ ìœ„í•œ JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // í¼ ì œì¶œ ì‹œ ì²´í¬ë°•ìŠ¤ ìƒíƒœë¥¼ í™•ì‹¤íˆ ì „ì†¡
    const form = document.getElementById('labelForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            console.log('=== í¼ ì œì¶œ ì‹œ ì²´í¬ë°•ìŠ¤ ìƒíƒœ í™•ì¸ ===');
            
            // ì¥ê¸°ë³´ì¡´ì‹í’ˆ ì²´í¬ë°•ìŠ¤ë“¤
            const preservationTypes = [];
            document.querySelectorAll('input[name="preservation_type"]:checked').forEach(cb => {
                preservationTypes.push(cb.value);
                console.log('ì„ íƒëœ ì¥ê¸°ë³´ì¡´ì‹í’ˆ:', cb.value);
            });
            
            // ì œì¡°ë°©ë²• ì²´í¬ë°•ìŠ¤ë“¤
            const processingMethods = [];
            document.querySelectorAll('input[name="processing_method"]:checked').forEach(cb => {
                processingMethods.push(cb.value);
                console.log('ì„ íƒëœ ì œì¡°ë°©ë²•:', cb.value);
            });
            
            // ì¡°ê±´ ìƒì„¸
            const processingCondition = document.querySelector('input[name="processing_condition"]');
            console.log('ì¡°ê±´ ìƒì„¸:', processingCondition ? processingCondition.value : 'NULL');
            
            console.log('ì¥ê¸°ë³´ì¡´ì‹í’ˆ ë°°ì—´:', preservationTypes);
            console.log('ì œì¡°ë°©ë²• ë°°ì—´:', processingMethods);
            console.log('========================================');
        });
    }
});
</script>

{% endblock %}