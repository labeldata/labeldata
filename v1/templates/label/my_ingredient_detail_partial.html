{% load static %}
<style>
  /* ===== BOM 스타일 기반 원료 상세 정보 ===== */

  /* 컨테이너 카드 */
  .popup-container {
    border: 1px solid #e6e9f2;
    border-radius: 12px;
    overflow: visible;
    background: #ffffff;
    box-shadow: 0 1px 4px rgba(0,0,0,0.06);
  }

  /* 패널 헤더 */
  .panel-header {
    background: #ffffff;
    border-bottom: 1px solid #eef1f6;
    padding: 10px 14px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 6px;
  }

  .panel-title {
    font-size: 13px;
    font-weight: 700;
    color: #111827;
    margin: 0;
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 6px;
  }

  .panel-actions {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;    align-items: center;  }

  /* 폼 테이블 */
  .nutrition-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }

  .nutrition-table th {
    font-size: 12px;
    color: #6b7280;
    font-weight: 600;
    padding: 9px 12px;
    background: #f8f9fb;
    border-bottom: 1px solid #eef1f6;
    vertical-align: top;
    width: 110px;
    min-width: 110px;
    line-height: 1.4;
  }

  .nutrition-table td {
    padding: 8px 12px;
    border-bottom: 1px solid #eef1f6;
    vertical-align: middle;
    color: #111827;
  }

  .nutrition-table tr:last-child th,
  .nutrition-table tr:last-child td {
    border-bottom: none;
  }

  /* 입력 필드 */
  .nutrition-table .form-control {
    font-size: 12px;
    border-color: #e6e9f2;
    border-radius: 6px;
    padding: 6px 10px;
    transition: border-color 0.15s, box-shadow 0.15s;
  }

  .nutrition-table .form-control:focus {
    border-color: #1a73e8;
    box-shadow: 0 0 0 3px rgba(26,115,232,0.12);
    outline: none;
  }

  /* 알레르기/GMO 선택 패널 */
  .allergy-gmo-panel {
    border: 1px solid #e6e9f2 !important;
    border-radius: 8px !important;
    padding: 10px !important;
    background-color: #f8f9fb !important;
  }

  /* 알레르기/GMO 버튼 - Bootstrap btn-outline-primary / btn-primary override */
  .allergy-btn.btn-outline-primary,
  .gmo-btn.btn-outline-primary {
    font-size: 11px;
    padding: 3px 10px;
    border-radius: 14px;
    font-weight: 600;
    transition: all 0.15s ease;
    border: 1px solid #dadce0 !important;
    background: white !important;
    color: #374151 !important;
  }

  .allergy-btn.btn-outline-primary:hover,
  .gmo-btn.btn-outline-primary:hover {
    background-color: rgba(60,64,67,0.08) !important;
    border-color: #5f6368 !important;
    color: #111827 !important;
  }

  .allergy-btn.btn-primary,
  .gmo-btn.btn-primary {
    font-size: 11px;
    padding: 3px 10px;
    border-radius: 14px;
    font-weight: 600;
    background-color: #1a73e8 !important;
    border-color: #1a73e8 !important;
    color: #ffffff !important;
  }

  .allergy-btn.btn-primary:hover,
  .gmo-btn.btn-primary:hover {
    background-color: #1765cc !important;
    border-color: #1765cc !important;
  }

  /* 선택 표시 텍스트 */
  .selected-display {
    font-size: 11px;
    color: #6b7280;
    flex: 1;
  }

  /* readonly 필드 */
  .readonly-bg {
    background-color: #f1f3f4 !important;
    border-color: #e6e9f2 !important;
    color: #5f6368 !important;
  }

  /* 버튼 스타일 정렬 */
  .btn-outline-cancel {
    color: #5f6368;
    border-color: #dadce0;
    background: white;
  }

  .btn-outline-cancel:hover {
    background: #f1f3f4;
    border-color: #5f6368;
    color: #202124;
  }

  /* ===== M3 패널 버튼 ===== */
  .panel-btn {
    font-size: 12px;
    font-weight: 500;
    padding: 5px 14px;
    border-radius: 20px;
    border: 1px solid #dadce0;
    background: #ffffff;
    color: #444746;
    cursor: pointer;
    transition: all 0.15s cubic-bezier(0.4,0,0.2,1);
    display: inline-flex;
    align-items: center;
    gap: 4px;
    white-space: nowrap;
  }
  .panel-btn:hover {
    background: #f1f3f4;
    border-color: #bdc1c6;
  }
  .panel-btn.primary {
    background: #1a73e8;
    border-color: #1a73e8;
    color: #ffffff;
    box-shadow: 0 1px 2px rgba(60,64,67,0.3);
  }
  .panel-btn.primary:hover {
    background: #1765cc;
    border-color: #1765cc;
  }
  .panel-btn.danger {
    border-color: #f28b82;
    color: #c5221f;
  }
  .panel-btn.danger:hover {
    background: #fce8e6;
  }
  .panel-btn.linked {
    border-color: #e0e8ff;
    color: #1a73e8;
    background: #f0f4ff;
    font-size: 11px;
  }
  .panel-btn.linked:hover {
    background: #e0e8ff;
  }

  /* ===== 식품첨가물 표시규정 카드 ===== */
  .regulation-card {
    background: #f0f4ff;
    border: 1px solid #c4d3f8;
    border-left: 3px solid #4a80f0;
    border-radius: 8px;
    padding: 10px 14px;
  }

  .regulation-card-header {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 6px;
    font-weight: 700;
    font-size: 0.76rem;
    color: #2c4fa0;
    letter-spacing: 0.2px;
  }

  .regulation-card-header i {
    color: #4a80f0;
    font-size: 0.82rem;
  }

  .regulation-card-text {
    font-size: 0.78rem;
    color: #374060;
    white-space: pre-wrap;
    line-height: 1.55;
  }

  .regulation-card-buttons {
    margin-top: 8px;
  }
</style>
<div class="popup-container" id="ingredient-detail-container-partial">
    <div class="panel-header">
        <h5 class="panel-title">
            {% if mode == "create" %}
              <span>원료 등록</span>
            {% else %}
              <span>원료 수정</span>
            {% endif %}
            <button type="button" class="panel-btn linked" id="linkedLabelsBtn">
                <i class="bi bi-link-45deg"></i> 연결 표시사항(0품목)
            </button>
        </h5>
        <div class="panel-actions">
            <button type="button" class="panel-btn" id="closeBtn">입력 초기화</button>
            {% if mode == 'edit' and user.username != 'guest@labeasylabel.com' %}<button type="button" class="panel-btn danger" id="deleteBtn"><i class="bi bi-trash"></i> 삭제</button>{% endif %}
            <button type="submit" form="ingredientForm" class="panel-btn primary"><i class="bi bi-check-lg"></i> 저장</button>
        </div>
    </div>

    <div>
        <form method="post" id="ingredientForm">
            {% csrf_token %}
            <!-- 숨겨진 원료 ID 필드 추가 -->
            <input type="hidden" id="my_ingredient_id" name="my_ingredient_id" value="{{ ingredient.my_ingredient_id|default:'' }}">
            
            <table class="nutrition-table">
                <tbody>
                    <!-- 1행: 식품 구분 (라디오 버튼) -->
                    <tr>
                        <th>식품 구분 <span class="text-danger">*</span></th>
                        <td colspan="3">
                            <div class="d-flex flex-wrap align-items-center gap-3">
                                <div class="d-flex gap-3">
                                    <div class="form-check form-check-inline mb-0">
                                        <input class="form-check-input" type="radio" name="food_category" id="foodCategoryProcessed" value="processed" {% if ingredient.food_category == "processed" or not ingredient.food_category %}checked{% endif %}>
                                        <label class="form-check-label" for="foodCategoryProcessed">가공식품</label>
                                    </div>
                                    <div class="form-check form-check-inline mb-0">
                                        <input class="form-check-input" type="radio" name="food_category" id="foodCategoryAdditive" value="additive" {% if ingredient.food_category == "additive" %}checked{% endif %}>
                                        <label class="form-check-label" for="foodCategoryAdditive">식품첨가물</label>
                                    </div>
                                    <div class="form-check form-check-inline mb-0">
                                        <input class="form-check-input" type="radio" name="food_category" id="foodCategoryAgricultural" value="agricultural" {% if ingredient.food_category == "agricultural" %}checked{% endif %}>
                                        <label class="form-check-label" for="foodCategoryAgricultural">농수산물</label>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    <!-- 2행: 품목보고번호 (가공식품/식품첨가물만) -->
                    <tr id="reportNoRow">
                        <th>품목보고번호</th>
                        <td colspan="3">
                            <div class="d-flex align-items-center gap-2">
                                <input type="text" class="form-control" name="prdlst_report_no" id="prdlst_report_no" value="{{ ingredient.prdlst_report_no|default:'' }}" maxlength="15" placeholder="예: 19950000000000" style="flex: 1;">
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="fetchFoodItemByReportNo()" title="품목보고번호로 불러오기" style="white-space: nowrap;">
                                    <i class="bi bi-download"></i> 불러오기
                                </button>
                            </div>
                            <small class="text-muted d-block mt-1">품목보고번호를 입력하고 불러오기 버튼을 클릭하면 정보가 자동으로 입력됩니다.</small>
                        </td>
                    </tr>
                    <!-- 3행: 원재료명 / 식품유형 -->
                    <tr>
                        <th style="width: 120px;">원재료명 <span class="text-danger">*</span></th>
                        <td style="width: 60%;">
                            <input type="text" class="form-control" name="prdlst_nm" id="prdlst_nm" value="{{ ingredient.prdlst_nm|default:'' }}" placeholder="예: 밀가루">
                        </td>
                        <th style="width: 120px;">식품유형</th>
                        <td style="width: auto;">
                            <select id="foodTypeSelect" name="prdlst_dcnm" class="form-control form-control-sm" data-selected="{{ ingredient.prdlst_dcnm|default:'' }}"></select>
                        </td>
                    </tr>
                    <!-- 4행: 제조사명 -->
                    <tr>
                        <th>제조사명</th>
                        <td colspan="3">
                            <input type="text" class="form-control" name="bssh_nm" id="bssh_nm" value="{{ ingredient.bssh_nm|default:'' }}">
                        </td>
                    </tr>
                    <!-- 5행: 원재료 표시명 -->
                    <tr>
                        <th>원재료 표시명</th>
                        <td colspan="3">
                            <textarea class="auto-expand form-control" name="ingredient_display_name" id="ingredient_display_name" placeholder="원재료 표시명을 입력하세요" rows="1" style="overflow:hidden; resize:vertical;">{{ ingredient.ingredient_display_name|default:'' }}</textarea>
                            <small class="text-muted d-block mt-1" id="ingredient_display_name_help">제품 라벨에 표시될 원재료명을 입력하세요. (예: 밀가루(미국산), 정제수)</small>
                            <!-- 식품첨가물 표시규정 (식품첨가물인 경우) -->
                            <div id="display-regulation-info" style="display: none; margin-top: 8px;">
                                <div class="regulation-card">
                                    <div class="regulation-card-header">
                                        <i class="bi bi-info-circle-fill"></i>
                                        <span>식품첨가물 표시규정</span>
                                    </div>
                                    <div id="display_regulation_display" class="regulation-card-text"></div>
                                    <div id="display_regulation_buttons" style="display: none;" class="regulation-card-buttons d-flex flex-wrap gap-2"></div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    <!-- 6행: 식품첨가물 표시규정 제거 (위로 이동) -->
                    <!-- 7행: 알레르기 -->
                    <tr>
                        <th>알레르기</th>
                        <td colspan="3">
                            <div class="allergy-gmo-panel">
                                <div class="d-flex align-items-center justify-content-between mb-2">
                                    <div id="allergySelectedDisplay" class="selected-display">선택된 항목 없음</div>
                                    <div class="d-flex gap-1">
                                        <button type="button" class="btn btn-sm btn-outline-secondary" id="allergyAutoDetectBtn" style="font-size: 0.7rem; padding: 0.15rem 0.5rem; border-radius: 12px;" title="원재료명으로 알레르기 자동감지">
                                            <i class="fas fa-sync-alt"></i> 자동감지
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" id="allergyToggleBtn" style="font-size: 0.7rem; padding: 0.15rem 0.5rem; border-radius: 12px;">전체선택</button>
                                    </div>
                                </div>
                                <div id="allergyBtnList" class="d-flex flex-wrap gap-1 mb-1">
                                    {% for allergen in allergen_list %}
                                    <button type="button" class="btn btn-sm btn-outline-primary allergy-btn" data-allergen="{{ allergen }}">{{ allergen }}</button>
                                    {% endfor %}
                                </div>
                                <input type="hidden" name="allergens" id="allergy_info" value="{{ ingredient.allergens|default:'' }}">
                            </div>
                        </td>
                    </tr>
                    <!-- 8행: GMO -->
                    <tr>
                        <th>GMO</th>
                        <td colspan="3">
                            <div class="allergy-gmo-panel">
                                <div class="d-flex align-items-center justify-content-between mb-2">
                                    <div id="gmoSelectedDisplay" class="selected-display">선택된 항목 없음</div>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" id="gmoToggleBtn" style="font-size: 0.7rem; padding: 0.15rem 0.5rem; border-radius: 12px;">전체선택</button>
                                </div>
                                <div id="gmoBtnList" class="d-flex flex-wrap gap-1 mb-1">
                                    {% for gmo in gmo_list %}
                                    <button type="button" class="btn btn-sm btn-outline-primary gmo-btn" data-gmo="{{ gmo }}">{{ gmo }}</button>
                                    {% endfor %}
                                </div>
                                <input type="hidden" name="gmo" id="gmo_info" value="{{ ingredient.gmo|default:'' }}">
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </form>
    </div>
</div>

{{ food_types|json_script:"food-types-data" }}
{{ agricultural_products|json_script:"agricultural-products-data" }}
{{ food_additives|json_script:"food-additives-data" }}

<script>
// 원료 상세 데이터 최초 로드시 window.originalIngredientData에 값 저장 (JSON 안전하게)
window.originalIngredientData = {
    prdlst_nm: "{{ ingredient.prdlst_nm|default:''|escapejs }}",
    prdlst_report_no: "{{ ingredient.prdlst_report_no|default:''|escapejs }}",
    food_category: "{{ ingredient.food_category|default:''|escapejs }}",
    prdlst_dcnm: "{{ ingredient.prdlst_dcnm|default:''|escapejs }}",
    bssh_nm: "{{ ingredient.bssh_nm|default:''|escapejs }}",
    ingredient_display_name: `{{ ingredient.ingredient_display_name|default:''|escapejs }}`,
    allergens: "{{ ingredient.allergens|default:''|escapejs }}",
    gmo: "{{ ingredient.gmo|default:''|escapejs }}"
};
</script>