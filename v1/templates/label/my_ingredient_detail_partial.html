{% load static %}
<style>
  /* 알레르기/GMO 필드 회색 배경 */
  .readonly-bg {
    background-color: #e9ecef !important;
    border-color: #ced4da !important;
  }
  
  .readonly-bg:focus {
    background-color: #e9ecef !important;
    border-color: #ced4da !important;
    box-shadow: 0 0 0 0.2rem rgba(206, 212, 218, 0.25) !important;
  }
  
  /* 더 구체적인 선택자로 우선순위 높이기 */
  #allergy_info.readonly-bg,
  #gmo_info.readonly-bg {
    background-color: #e9ecef !important;
    color: #6c757d !important;
  }
  
  /* th 너비 통일 */
  .nutrition-table th {
    width: 120px;
    min-width: 120px;
  }
</style>
<div class="popup-container" id="ingredient-detail-container-partial">
    <div class="panel-header">
        <h5 class="panel-title">
            {% if mode == "create" %}
              원료 등록
            {% else %}
              원료 수정
            {% endif %}
            <button type="button" class="btn btn-outline-cancel btn-sm ms-2" id="linkedLabelsBtn">
                연결된 표시사항(0품목) 조회
            </button>
        </h5>
        <div class="panel-actions">
            <button type="submit" form="ingredientForm" class="btn btn-outline-primary btn-sm">저장</button>
            <button type="button" class="btn btn-outline-cancel btn-sm" id="closeBtn">초기화</button>
            {% if mode == 'edit' and user.username != 'guest@labeasylabel.com' %}<button type="button" class="btn btn-outline-danger btn-sm" id="deleteBtn">삭제</button>{% endif %}
        </div>
    </div>

    <div>
        <form method="post" id="ingredientForm">
            {% csrf_token %}
            <!-- 숨겨진 원료 ID 필드 추가 -->
            <input type="hidden" id="my_ingredient_id" name="my_ingredient_id" value="{{ ingredient.my_ingredient_id|default:'' }}">
            
            <table class="nutrition-table">
                <tbody>
                    <!-- 1행: 식품 구분 (라디오 버튼) -->
                    <tr>
                        <th>식품 구분 <span class="text-danger">*</span></th>
                        <td colspan="3">
                            <div class="d-flex flex-wrap align-items-center gap-3">
                                <div class="d-flex gap-3">
                                    <div class="form-check form-check-inline mb-0">
                                        <input class="form-check-input" type="radio" name="food_category" id="foodCategoryProcessed" value="processed" {% if ingredient.food_category == "processed" or not ingredient.food_category %}checked{% endif %}>
                                        <label class="form-check-label" for="foodCategoryProcessed">가공식품</label>
                                    </div>
                                    <div class="form-check form-check-inline mb-0">
                                        <input class="form-check-input" type="radio" name="food_category" id="foodCategoryAdditive" value="additive" {% if ingredient.food_category == "additive" %}checked{% endif %}>
                                        <label class="form-check-label" for="foodCategoryAdditive">식품첨가물</label>
                                    </div>
                                    <div class="form-check form-check-inline mb-0">
                                        <input class="form-check-input" type="radio" name="food_category" id="foodCategoryAgricultural" value="agricultural" {% if ingredient.food_category == "agricultural" %}checked{% endif %}>
                                        <label class="form-check-label" for="foodCategoryAgricultural">농수산물</label>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    <!-- 2행: 품목보고번호 (가공식품/식품첨가물만) -->
                    <tr id="reportNoRow">
                        <th>품목보고번호</th>
                        <td colspan="3">
                            <div class="d-flex align-items-center gap-2">
                                <input type="text" class="form-control" name="prdlst_report_no" id="prdlst_report_no" value="{{ ingredient.prdlst_report_no|default:'' }}" maxlength="15" placeholder="예: 19950000000000" style="flex: 1;">
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="fetchFoodItemByReportNo()" title="품목보고번호로 불러오기" style="white-space: nowrap;">
                                    <i class="bi bi-download"></i> 불러오기
                                </button>
                            </div>
                            <small class="text-muted d-block mt-1">품목보고번호를 입력하고 불러오기 버튼을 클릭하면 정보가 자동으로 입력됩니다.</small>
                        </td>
                    </tr>
                    <!-- 3행: 원재료명 / 식품유형 -->
                    <tr>
                        <th style="width: 120px;">원재료명 <span class="text-danger">*</span></th>
                        <td style="width: 60%;">
                            <input type="text" class="form-control" name="prdlst_nm" id="prdlst_nm" value="{{ ingredient.prdlst_nm|default:'' }}" placeholder="예: 밀가루">
                        </td>
                        <th style="width: 120px;">식품유형</th>
                        <td style="width: auto;">
                            <select id="foodTypeSelect" name="prdlst_dcnm" class="form-control form-control-sm" data-selected="{{ ingredient.prdlst_dcnm|default:'' }}"></select>
                        </td>
                    </tr>
                    <!-- 4행: 제조사명 -->
                    <tr>
                        <th>제조사명</th>
                        <td colspan="3">
                            <input type="text" class="form-control" name="bssh_nm" id="bssh_nm" value="{{ ingredient.bssh_nm|default:'' }}">
                        </td>
                    </tr>
                    <!-- 5행: 원재료 표시명 -->
                    <tr>
                        <th>원재료 표시명</th>
                        <td colspan="3">
                            <textarea class="auto-expand form-control" name="ingredient_display_name" id="ingredient_display_name" placeholder="원재료 표시명을 입력하세요" rows="1" style="overflow:hidden; resize:vertical;">{{ ingredient.ingredient_display_name|default:'' }}</textarea>
                            <small class="text-muted d-block mt-1" id="ingredient_display_name_help">제품 라벨에 표시될 원재료명을 입력하세요. (예: 밀가루(미국산), 정제수)</small>
                            <!-- 식품첨가물 표시규정 (식품첨가물인 경우) -->
                            <div id="display-regulation-info" style="display: none; margin-top: 8px;">
                                <div class="alert alert-info mb-0" style="font-size: 0.85rem; padding: 0.5rem 0.75rem;">
                                    <strong><i class="bi bi-info-circle"></i> 식품첨가물 표시규정</strong>
                                    <div id="display_regulation_display" style="margin-top: 8px; white-space: pre-wrap;"></div>
                                    <div id="display_regulation_buttons" style="margin-top: 8px; display: none;" class="d-flex flex-wrap gap-2"></div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    <!-- 6행: 식품첨가물 표시규정 제거 (위로 이동) -->
                    <!-- 7행: 알레르기 -->
                    <tr>
                        <th>알레르기</th>
                        <td colspan="3">
                            <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 8px; background-color: #f8f9fa;">
                                <div class="d-flex align-items-center justify-content-between mb-2">
                                    <div id="allergySelectedDisplay" style="font-size: 0.75rem; color: #6b7280; flex: 1;">
                                        선택된 항목 없음
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-primary" id="allergyToggleBtn" style="font-size: 0.75rem; padding: 0.15rem 0.5rem;">전체선택</button>
                                </div>
                                <div id="allergyBtnList" class="d-flex flex-wrap gap-1 mb-1">
                                    {% for allergen in allergen_list %}
                                    <button type="button" class="btn btn-sm btn-outline-primary allergy-btn" data-allergen="{{ allergen }}" style="font-size: 0.7rem; padding: 0.2rem 0.5rem;">{{ allergen }}</button>
                                    {% endfor %}
                                </div>
                                <input type="hidden" name="allergens" id="allergy_info" value="{{ ingredient.allergens|default:'' }}">
                                <small class="text-muted">알레르기 유발 성분을 선택하세요. 버튼 클릭으로 선택/해제할 수 있습니다.</small>
                            </div>
                        </td>
                    </tr>
                    <!-- 8행: GMO -->
                    <tr>
                        <th>GMO</th>
                        <td colspan="3">
                            <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 8px; background-color: #f8f9fa;">
                                <div class="d-flex align-items-center justify-content-between mb-2">
                                    <div id="gmoSelectedDisplay" style="font-size: 0.75rem; color: #6b7280; flex: 1;">
                                        선택된 항목 없음
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-primary" id="gmoToggleBtn" style="font-size: 0.75rem; padding: 0.15rem 0.5rem;">전체선택</button>
                                </div>
                                <div id="gmoBtnList" class="d-flex flex-wrap gap-1 mb-1">
                                    {% for gmo in gmo_list %}
                                    <button type="button" class="btn btn-sm btn-outline-primary gmo-btn" data-gmo="{{ gmo }}" style="font-size: 0.7rem; padding: 0.2rem 0.5rem;">{{ gmo }}</button>
                                    {% endfor %}
                                </div>
                                <input type="hidden" name="gmo" id="gmo_info" value="{{ ingredient.gmo|default:'' }}">
                                <small class="text-muted">GMO 성분을 선택하세요. 버튼 클릭으로 선택/해제할 수 있습니다.</small>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </form>
    </div>
</div>

<!-- food_types, agricultural_products, food_additives 데이터 전달 -->
{{ food_types|json_script:"food-types-data" }}
{{ agricultural_products|json_script:"agricultural-products-data" }}
{{ food_additives|json_script:"food-additives-data" }}

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="{% static 'js/label/my_ingredient_detail_partial.js' %}?v={{ STATIC_BUILD_DATE }}"></script>
<script>
// 원료 상세 데이터 최초 로드시 window.originalIngredientData에 값 저장 (JSON 안전하게)
window.originalIngredientData = {
    prdlst_nm: "{{ ingredient.prdlst_nm|default:''|escapejs }}",
    prdlst_report_no: "{{ ingredient.prdlst_report_no|default:''|escapejs }}",
    food_category: "{{ ingredient.food_category|default:''|escapejs }}",
    prdlst_dcnm: "{{ ingredient.prdlst_dcnm|default:''|escapejs }}",
    bssh_nm: "{{ ingredient.bssh_nm|default:''|escapejs }}",
    ingredient_display_name: `{{ ingredient.ingredient_display_name|default:''|escapejs }}`,
    allergens: "{{ ingredient.allergens|default:''|escapejs }}",
    gmo: "{{ ingredient.gmo|default:''|escapejs }}"
};
</script>