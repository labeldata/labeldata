{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì˜ì–‘ì„±ë¶„ ê³„ì‚°ê¸°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link href="{% static 'css/popup.css' %}?v={{ STATIC_BUILD_DATE }}" rel="stylesheet">
  <link href="{% static 'css/nutrition_table_styles.css' %}?v={{ STATIC_BUILD_DATE }}" rel="stylesheet">
  <link href="{% static 'css/label_creation_modern.css' %}?v={{ STATIC_BUILD_DATE }}" rel="stylesheet">
  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="{% static 'img/favicon.ico' %}">
  <style>
    body {
      font-size: 0.8rem;
      font-family: 'Noto Sans KR', sans-serif;
      background-color: #f8f9fa;
      margin: 0;
      padding: 0;
      height: 100vh;
      overflow: hidden;
    }
    
    .nutrition-calculator-container {
      background: white;
      height: 100vh;
      display: flex;
      overflow: hidden;
    }
    
    /* ì™¼ìª½ ì…ë ¥ íŒ¨ë„ */
    .input-panel {
      width: 50%;
      padding: 20px;
      border-right: 2px solid #dee2e6;
      overflow-y: auto;
      background: #f8f9fa;
    }
    
    /* ì˜¤ë¥¸ìª½ í‘œì‹œ íŒ¨ë„ */
    .display-panel {
      width: 50%;
      padding: 20px;
      background: white;
      display: flex;
      flex-direction: column;
    }
    
    .panel-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: #333;
      margin-bottom: 15px;
      padding-bottom: 8px;
      border-bottom: 2px solid #000;
    }
    
    /* íŒ¨ë„ í—¤ë” (ì œëª©ê³¼ ë²„íŠ¼) */
    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .panel-header .panel-title {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }
    
    /* ê¸°ë³¸ ì •ë³´ ì…ë ¥ í–‰ */
    .basic-info-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .info-group {
      display: flex;
      align-items: center;
      gap: 6px;
      width: 100%;
    }
    
    .info-group label {
      min-width: 90px;
      font-weight: 500;
      color: #495057;
      font-size: 0.8rem;
      flex-shrink: 0;
    }
    
    .info-group input {
      width: 80px;
      font-size: 0.8rem;
      border: 1px solid #ced4da;
      border-radius: 4px;
      padding: 6px 8px;
      flex-shrink: 0;
    }
    
    .info-group select {
      width: 60px;
      font-size: 0.8rem;
      border: 1px solid #ced4da;
      border-radius: 4px;
      padding: 6px 8px;
      flex-shrink: 0;
    }
    
    .info-group .unit-label {
      font-size: 0.8rem;
      color: #6c757d;
      margin-left: 4px;
      flex-shrink: 0;
    }
    
    /* í‘œì‹œ ë°©ì‹ ì…ë ¥ í–‰ */
    .display-style-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .display-style-row .info-group input,
    .display-style-row .info-group select {
      width: 140px;
    }
    
    /* ì˜ì–‘ì„±ë¶„ ì…ë ¥ ê·¸ë¦¬ë“œ */
    .nutrients-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    
    .nutrient-item {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 6px;
      padding: 6px 8px;
      background: #ffffff;
      border-radius: 4px;
      border: 1px solid #e9ecef;
    }
    
    .nutrient-item.sub-item {
      background: #f0f8ff;
      border-color: #bee5eb;
    }
    
    .nutrient-item label {
      min-width: 70px;
      font-weight: 500;
      color: #495057;
      font-size: 0.8rem;
    }
    
    .nutrient-item label.indent {
      padding-left: 12px;
      font-weight: 400;
      color: #6c757d;
    }
    
    .nutrient-item input {
      width: 80px;
      font-size: 0.8rem;
      border: 1px solid #ced4da;
      border-radius: 4px;
      padding: 4px 6px;
      flex-shrink: 0;
    }
    
    .nutrient-item select {
      width: 70px;
      font-size: 0.8rem;
      border: 1px solid #ced4da;
      border-radius: 4px;
      padding: 4px 6px;
      flex-shrink: 0;
    }
      border: 1px solid #ced4da;
      border-radius: 4px;
      padding: 4px 6px;
      flex-shrink: 0;
    }
    
    /* ë²„íŠ¼ ì˜ì—­ */
    .button-row {
      display: flex;
      gap: 8px;
    }
    
    /* ì˜ì–‘ì„±ë¶„ ì„¹ì…˜ */
    .nutrition-section {
      margin-top: 20px;
    }
    
    .nutrition-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      cursor: pointer;
      margin-bottom: 15px;
    }
    
    .nutrition-header:hover {
      background: #e9ecef;
    }
    
    .toggle-text {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.85rem;
      color: #6c757d;
    }
    
    .toggle-icon {
      font-size: 0.9rem;
      color: #6c757d;
      transition: transform 0.3s ease;
    }
    
    .toggle-icon.rotated {
      transform: rotate(180deg);
    }
    
    .basic-nutrients {
      margin-bottom: 15px;
    }
    
    .additional-nutrients {
      border-top: 1px solid #dee2e6;
      padding-top: 15px;
    }
    
    /* ì €ì¥ ì™„ë£Œ ìƒíƒœ ìŠ¤íƒ€ì¼ */
    .saved-state {
      opacity: 0.7;
      pointer-events: none;
    }
    
    .saved-state input,
    .saved-state select,
    .saved-state button {
      background-color: #f8f9fa !important;
      color: #6c757d !important;
      border-color: #dee2e6 !important;
      cursor: not-allowed !important;
    }
    
    .saved-indicator {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      background: #d4edda;
      color: #155724;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
      margin-left: 10px;
    }
    
    .additional-header {
      font-size: 0.9rem;
      font-weight: 600;
      color: #495057;
      margin-bottom: 10px;
      padding-left: 5px;
    }
    
    /* ê²°ê³¼ í‘œì‹œ ì˜ì—­ */
    .result-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .result-buttons {
      display: flex;
      gap: 8px;
      padding: 10px 0;
      justify-content: center;
      flex-wrap: wrap;
    }
    
    .result-display {
      flex: 1;
      overflow-y: auto;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 10px;
      background: #ffffff;
    }
    
    .empty-result {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #6c757d;
      font-style: italic;
    }
    
    /* í•˜ìœ„ ì˜µì…˜ í‘œì‹œ/ìˆ¨ê¹€ */
    .sub-options {
      display: none;
    }
    
    .sub-options.show {
      display: block;
    }
    
    /* ì˜ì–‘ì„±ë¶„í‘œ ìŠ¤íƒ€ì¼ */
    .nutrition-result-table {
      font-family: 'Noto Sans KR', sans-serif;
      background: white;
      overflow: hidden;
      width: 100%;
    }
    
    /* ê¸°ë³¸í˜• ìŠ¤íƒ€ì¼ */
    .nutrition-style-basic .nutrition-table {
      border: 3px solid #000;
      border-collapse: collapse;
      width: 100%;
      background: white;
      color: #000;
    }
    
    .nutrition-style-basic .nutrition-header {
      background: #000;
      color: white;
      text-align: center;
      padding: 8px;
      font-weight: bold;
      font-size: 14px;
    }
    
    .nutrition-style-basic .nutrition-subheader {
      background: #000;
      color: white;
      text-align: center;
      padding: 4px 8px;
      font-size: 11px;
      border-bottom: 1px solid #000;
    }
    
    .nutrition-style-basic .nutrition-row td {
      border-bottom: 1px solid #000;
      padding: 3px 8px;
      font-size: 11px;
      vertical-align: middle;
      background: white;
      color: #000;
    }
    
    .nutrition-style-basic .nutrition-name {
      font-weight: bold;
      text-align: left;
      width: 60%;
    }
    
    .nutrition-style-basic .nutrition-value {
      text-align: right;
      font-weight: bold;
      width: 40%;
    }
    
    .nutrition-style-basic .nutrition-indent {
      padding-left: 20px !important;
    }
    
    .nutrition-style-basic .nutrition-footer {
      font-size: 9px;
      padding: 6px 8px;
      text-align: center;
      border-top: 1px solid #000;
      background: white;
      color: #000;
    }
    
    /* ì„¸ë¡œí˜• ìŠ¤íƒ€ì¼ */
    .nutrition-style-vertical .nutrition-table {
      border: 3px solid #000;
      border-collapse: collapse;
      width: 100%;
      background: white;
      color: #000;
    }
    
    .nutrition-style-vertical .nutrition-header {
      background: #000;
      color: white;
      text-align: center;
      padding: 8px;
      font-weight: bold;
      font-size: 14px;
      border-bottom: 1px solid #000;
    }
    
    .nutrition-style-vertical .nutrition-subheader {
      background: #000;
      color: white;
      text-align: center;
      padding: 4px 8px;
      font-size: 11px;
      border-bottom: 1px solid #000;
    }
    
    .nutrition-style-vertical .nutrition-row td {
      border-bottom: 1px solid #000;
      padding: 3px 8px;
      font-size: 11px;
      vertical-align: middle;
      background: white;
      color: #000;
    }
    
    .nutrition-style-vertical .nutrition-name {
      font-weight: bold;
      text-align: left;
      width: 60%;
    }
    
    .nutrition-style-vertical .nutrition-value {
      text-align: right;
      font-weight: bold;
      width: 40%;
    }
    
    .nutrition-style-vertical .nutrition-indent {
      padding-left: 20px !important;
    }
    
    .nutrition-style-vertical .nutrition-footer {
      font-size: 9px;
      padding: 6px 8px;
      text-align: center;
      border-top: 1px solid #000;
      background: white;
      color: #000;
    }
    
    /* ë³‘í–‰í‘œì‹œ ìŠ¤íƒ€ì¼ */
    .nutrition-style-parallel .nutrition-table {
      border: 3px solid #000;
      border-collapse: collapse;
      width: 100%;
      background: white;
      color: #000;
    }
    
    .nutrition-style-parallel .nutrition-header {
      background: #000;
      color: white;
      text-align: center;
      padding: 8px;
      font-weight: bold;
      font-size: 14px;
    }
    
    .nutrition-style-parallel .nutrition-subheader {
      background: #000;
      color: white;
      text-align: center;
      padding: 4px;
      font-size: 10px;
      border: 1px solid #000;
    }
    
    .nutrition-style-parallel .nutrition-row td {
      border: 1px solid #000;
      padding: 2px 4px;
      font-size: 10px;
      text-align: center;
      vertical-align: middle;
      background: white;
      color: #000;
    }
    
    .nutrition-style-parallel .nutrition-name {
      font-weight: bold;
      text-align: left !important;
      width: 25%;
    }
    
    .nutrition-style-parallel .nutrition-value {
      width: 18.75%;
    }
    
    .nutrition-style-parallel .nutrition-footer {
      font-size: 8px;
      padding: 4px;
      text-align: center;
      border-top: 2px solid #000;
      background: white;
      color: #000;
    }
  </style>
</head>
<body>
<div class="nutrition-calculator-container">
  <!-- ì™¼ìª½ ì…ë ¥ íŒ¨ë„ -->
  <div class="input-panel">
    <div class="panel-header">
      <div class="panel-title">ğŸ“Š ì˜ì–‘ì„±ë¶„ ì…ë ¥</div>
      <!-- ê³„ì‚°/ì´ˆê¸°í™” ë²„íŠ¼ì„ ìš°ì¸¡ ìƒë‹¨ìœ¼ë¡œ ì´ë™ -->
      <div class="button-row">
        <button type="button" class="btn btn-primary btn-sm" id="calculateBtn" onclick="calculateNutrition()">
          <i class="fas fa-calculator me-1"></i>ê³„ì‚°
        </button>
        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="resetFormAndParent()">
          <i class="fas fa-redo me-1"></i>ì´ˆê¸°í™”
        </button>
      </div>
    </div>
    
    <!-- ê¸°ë³¸ ì •ë³´ -->
    <div class="basic-info-row">
      <div class="info-group">
        <label>ë‹¨ìœ„ë‚´ìš©ëŸ‰</label>
        <input type="number" id="base_amount" placeholder="100">
        <select id="base_amount_unit">
          <option value="g" selected>g</option>
          <option value="ml">ml</option>
        </select>
      </div>
      <div class="info-group">
        <label>í¬ì¥ ë‹¹ ê°¯ìˆ˜</label>
        <input type="number" id="servings_per_package" placeholder="1">
        <span class="unit-label">ê°œ</span>
      </div>
    </div>
    
    <!-- í‘œì‹œ ë°©ì‹ -->
    <div class="display-style-row">
      <div class="info-group">
        <label>í‘œì‹œ ìŠ¤íƒ€ì¼</label>
        <select id="nutrition_style" onchange="toggleStyleOptions()">
          <option value="basic">ê¸°ë³¸í˜•</option>
          <option value="vertical">ì„¸ë¡œí˜•</option>
          <option value="parallel">ë³‘í–‰í‘œì‹œ</option>
        </select>
      </div>
      <div class="info-group">
        <!-- ê¸°ë³¸í˜•/ì„¸ë¡œí˜• ì„¸ë¶€ ì˜µì…˜ -->
        <div id="basic-vertical-options" class="sub-options show">
          <label>í‘œì‹œ ê¸°ì¤€</label>
          <select id="basic_display_type">
            <option value="total">ì´ ë‚´ìš©ëŸ‰ë‹¹</option>
            <option value="unit">ë‹¨ìœ„ë‚´ìš©ëŸ‰ë‹¹</option>
            <option value="100g">100g(ml)ë‹¹</option>
          </select>
        </div>
        <!-- ë³‘í–‰í‘œì‹œ ì„¸ë¶€ ì˜µì…˜ -->
        <div id="parallel-options" class="sub-options">
          <label>ë³‘í–‰í‘œì‹œ ìœ í˜•</label>
          <select id="parallel_display_type">
            <option value="unit_total">ë‹¨ìœ„ë‚´ìš©ëŸ‰ë‹¹ + ì´ë‚´ìš©ëŸ‰ë‹¹</option>
            <option value="unit_100g">ë‹¨ìœ„ë‚´ìš©ëŸ‰ë‹¹ + 100gë‹¹</option>
            <option value="serving_total">1íšŒ ì„­ì·¨ì°¸ê³ ëŸ‰ë‹¹ + ì´ë‚´ìš©ëŸ‰ë‹¹</option>
            <option value="serving_100ml">1íšŒ ì„­ì·¨ì°¸ê³ ëŸ‰ë‹¹ + 100mlë‹¹</option>
          </select>
        </div>
      </div>
    </div>
    
    <!-- ì˜ì–‘ì„±ë¶„ ì…ë ¥ -->
    <div class="nutrition-section">
      <div class="nutrition-header" onclick="toggleNutritionSection()">
        <span class="panel-title">ğŸ¥„ ì˜ì–‘ì„±ë¶„ (100g ê¸°ì¤€)</span>
        <span class="toggle-text">
          <span id="nutrition-toggle-text">ì„±ë¶„ ì¶”ê°€</span>
          <span class="toggle-icon" id="nutrition-toggle">â–¼</span>
        </span>
      </div>
      
      <!-- ê¸°ë³¸ ì˜ì–‘ì„±ë¶„ (í•­ìƒ í‘œì‹œ) -->
      <div class="basic-nutrients">
        <div class="nutrients-grid" id="basic-nutrient-inputs"></div>
      </div>
      
      <!-- ì¶”ê°€ ì˜ì–‘ì„±ë¶„ (ì ‘ì—ˆë‹¤ í¼ì¹  ìˆ˜ ìˆìŒ) -->
      <div class="additional-nutrients" id="additional-nutrients" style="display: none;">
        <div class="additional-header">
          <span>ğŸ“‹ ì¶”ê°€ ì˜ì–‘ì„±ë¶„</span>
        </div>
        <div class="nutrients-grid" id="additional-nutrient-inputs"></div>
      </div>
    </div>
  </div>
  
  <!-- ì˜¤ë¥¸ìª½ í‘œì‹œ íŒ¨ë„ -->
  <div class="display-panel">
    <div class="result-header">
      <div class="panel-title">ğŸ“‹ ì˜ì–‘ì„±ë¶„í‘œ</div>
      <div class="result-buttons">
        <button type="button" class="btn btn-outline-primary btn-sm" onclick="exportToPDF()">
          <i class="fas fa-file-pdf me-1"></i>PDF ì €ì¥
        </button>
        <button type="button" class="btn btn-success btn-sm" onclick="sendNutritionDataToParent()">
          <i class="fas fa-save me-1"></i>ë°ì´í„° ì €ì¥
        </button>
        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="window.close()">
          <i class="fas fa-times me-1"></i>ë‹«ê¸°
        </button>
      </div>
    </div>
    
    <div class="result-display" id="resultDisplay">
      <div class="empty-result">ì˜ì–‘ì„±ë¶„ì„ ì…ë ¥í•˜ê³  ê³„ì‚° ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="{% static 'js/label/nutrition_calculator_popup.js' %}?v={{ STATIC_BUILD_DATE }}"></script>
<script>
  // ì „ì—­ í•¨ìˆ˜ë¡œ toggleStyleOptionsì™€ toggleNutritionSection ë…¸ì¶œ
  window.toggleStyleOptions = function() {
    const style = document.getElementById('nutrition_style').value;
    const basicVerticalOptions = document.getElementById('basic-vertical-options');
    const parallelOptions = document.getElementById('parallel-options');
    
    if (style === 'parallel') {
      basicVerticalOptions.classList.remove('show');
      parallelOptions.classList.add('show');
    } else {
      basicVerticalOptions.classList.add('show');
      parallelOptions.classList.remove('show');
    }
    
    // ìŠ¤íƒ€ì¼ ë³€ê²½ ì‹œ ìë™ ê³„ì‚°
    if (document.getElementById('base_amount').value && document.getElementById('servings_per_package').value) {
      calculateNutrition();
    }
  };

  window.toggleNutritionSection = function() {
    const additionalSection = document.getElementById('additional-nutrients');
    const toggleIcon = document.getElementById('nutrition-toggle');
    const toggleText = document.getElementById('nutrition-toggle-text');
    
    if (additionalSection.style.display === 'none') {
      additionalSection.style.display = 'block';
      toggleIcon.textContent = 'â–²';
      toggleIcon.classList.add('rotated');
      toggleText.textContent = 'ì„±ë¶„ ì ‘ê¸°';
    } else {
      additionalSection.style.display = 'none';
      toggleIcon.textContent = 'â–¼';
      toggleIcon.classList.remove('rotated');
      toggleText.textContent = 'ì„±ë¶„ ì¶”ê°€';
    }
  };

  document.addEventListener('nutrition-calculator-ready', function() {
    const dataStr = "{{ nutrition_data|escapejs }}";
    if (dataStr && dataStr !== "{}") {
      try {
        const data = JSON.parse(dataStr);
        if (data && Object.keys(data).length > 0) {
          loadExistingData(data);
        }
      } catch (e) {
        console.error("ì˜ì–‘ì„±ë¶„ ë°ì´í„° ì˜¤ë¥˜:", e);
      }
    }
  });
</script>
</body>
</html>
