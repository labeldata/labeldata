{% load static %}
{% load django_bootstrap5 %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}Food RegTech V2{% endblock %}</title>
    <link rel="icon" type="image/x-icon" href="{% static 'img/favicon.ico' %}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    {% bootstrap_css %}
    <link rel="stylesheet" href="{% static 'css/style.css' %}?v=20250413">
    <link rel="stylesheet" href="{% static 'css/products_common.css' %}?v=20260222">
    {% block extra_head %}{% endblock %}
    {% block extra_css %}{% endblock %}
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
</head>
<body><div class="v2-wrapper">
        <nav class="v2-sidebar">
            <div class="px-2">
                <a href="{% url 'main:home_dashboard' %}" class="v2-sidebar-logo">
                    <i class="bi bi-grid-3x3-gap-fill me-2" style="color:#1967d2;"></i>Food Data Portal
                </a>
            </div>

            <div class="px-2">
                <a class="btn btn-white shadow-sm rounded-pill py-2 px-3 w-100 text-start border" href="{% url 'products:product_create' %}">
                    <i class="bi bi-plus-lg me-2 text-primary"></i><span class="fw-medium">새로 만들기</span>
                </a>
            </div>

            <div class="nav flex-column v2-sidebar-nav">
                <a href="{% url 'products:product_explorer' %}" class="nav-link {% if request.resolver_match.url_name == 'product_explorer' or request.resolver_match.url_name == 'product_list' or request.resolver_match.url_name == 'product_detail' or request.resolver_match.url_name == 'product_detail_new' %}{% if request.GET.from != 'collab' %}active{% endif %}{% endif %}">
                    <i class="bi bi-hdd-stack me-3"></i>제품 관리
                </a>
                <a href="{% url 'label:my_ingredient_list_combined' %}" class="nav-link {% if request.resolver_match.url_name == 'my_ingredient_list_combined' %}active{% endif %}">
                    <i class="bi bi-box-seam me-3"></i>원료 관리
                </a>
                <div class="border-top my-3"></div>

                <a href="{% url 'products:inbox' %}" class="nav-link {% if request.resolver_match.url_name == 'inbox' or request.GET.from == 'collab' %}active{% endif %}">
                    <i class="bi bi-people me-3"></i>공동 작업
                </a>
                <a href="{% url 'products:contacts' %}" class="nav-link {% if request.resolver_match.url_name == 'contacts' or request.resolver_match.url_name == 'doc_requests_dashboard' %}active{% endif %}">
                    <i class="bi bi-person-lines-fill me-3"></i>연락처 관리
                </a>
                <div class="border-top my-3"></div>

                <!-- 제품 조회 메뉴 -->
                <a href="{% url 'label:food_item_list_domestic' %}" class="nav-link {% if request.resolver_match.url_name == 'food_item_list_domestic' %}active{% endif %}">
                    <i class="bi bi-search me-3"></i>제품 조회(국내)
                </a>
                <a href="{% url 'label:food_item_list_imported' %}" class="nav-link {% if request.resolver_match.url_name == 'food_item_list_imported' %}active{% endif %}">
                    <i class="bi bi-globe me-3"></i>제품 조회(수입)
                </a>
                <a href="{% url 'label:food_additive_search' %}" class="nav-link {% if request.resolver_match.url_name == 'food_additive_search' %}active{% endif %}">
                    <i class="bi bi-database me-3"></i>식품첨가물 DB
                </a>
                <div class="border-top my-3"></div>

                <a href="{% url 'board:list' %}" class="nav-link {% if request.resolver_match.namespace == 'board' %}active{% endif %}">
                    <i class="bi bi-chat-dots me-3"></i>게시판
                </a>
            </div>

            <div class="v2-sidebar-footer">
                <p class="v2-sf-copy">&copy; 2025 Lab.E.L.</p>
                <p class="v2-sf-links">
                    <a href="{% url 'board:list' %}">공지사항</a>
                    <span class="v2-sf-dot">&middot;</span>
                    <a href="{% url 'main:home_v1' %}">기존 사이트 이동</a>
                </p>
            </div>
        </nav>

        <div class="v2-main">
            <header class="v2-topbar">
                {% block topbar %}
                <form class="input-group v2-topbar-search" style="max-width: 600px;" method="get" action="{% url 'products:product_explorer' %}">
                    <span class="input-group-text bg-light border-0 rounded-start-pill ps-3">
                        <i class="bi bi-search"></i>
                    </span>
                    <input type="text" name="q" class="form-control bg-light border-0 rounded-end-pill" placeholder="제품, 원료, 문서 검색" value="{{ search_query }}">
                </form>
                {% include "includes/_topbar_account.html" %}
                {% endblock %}
            </header>

            <main class="v2-content">
                {% if messages %}
                    {% for message in messages %}
                        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    {% endfor %}
                {% endif %}
                {% block content %}{% endblock %}
            </main>
        </div>
    </div>

    {% bootstrap_javascript %}
    {% block extra_js %}{% endblock %}

    <!-- ── 전역 Snackbar (구글 Material 스타일) ── -->
    <div id="v2Snackbar" style="
      position:fixed; bottom:1.5rem; left:50%; transform:translateX(-50%) translateY(calc(100% + 2rem));
      background:#323232; color:#fff; padding:.75rem 1.25rem; border-radius:4px;
      font-size:.875rem; line-height:1.4; font-family:'Roboto','Noto Sans KR',sans-serif;
      box-shadow:0 3px 8px rgba(0,0,0,.35),0 1px 3px rgba(0,0,0,.2);
      display:flex; align-items:center; gap:1rem;
      max-width:min(480px,calc(100vw - 2rem)); z-index:10000;
      transition:transform .25s cubic-bezier(.4,0,.2,1),opacity .25s;
      opacity:0; pointer-events:none;" aria-live="polite">
      <span id="v2SnackbarMsg" style="flex:1;"></span>
      <button onclick="hideSnackbar()" style="background:none;border:none;color:#90caf9;
        font-size:.8rem;font-weight:600;cursor:pointer;padding:0;flex-shrink:0;letter-spacing:.05em;">닫기</button>
    </div>
    <style>
      #v2Snackbar.snack-show   { transform:translateX(-50%) translateY(0); opacity:1; pointer-events:auto; }
      #v2Snackbar.snack-error  { background:#b71c1c; }
      #v2Snackbar.snack-warning{ background:#e65100; }
    </style>
    <script>
    (function(){
      let _t = null;
      window.showSnackbar = function(message, type) {
        /* type: 'success'|'error'|'warning'|'info' */
        var el  = document.getElementById('v2Snackbar');
        var msg = document.getElementById('v2SnackbarMsg');
        if (!el || !msg) return;
        if (_t) { clearTimeout(_t); _t = null; }
        el.classList.remove('snack-show','snack-error','snack-warning');
        msg.textContent = message;
        if (type === 'error')        el.classList.add('snack-error');
        else if (type === 'warning') el.classList.add('snack-warning');
        void el.offsetWidth;
        el.classList.add('snack-show');
        var dur = (type === 'error' || type === 'warning') ? 6000 : 4000;
        _t = setTimeout(window.hideSnackbar, dur);
      };
      window.hideSnackbar = function() {
        var el = document.getElementById('v2Snackbar');
        if (el) el.classList.remove('snack-show','snack-error','snack-warning');
        if (_t) { clearTimeout(_t); _t = null; }
      };
    })();
    </script>

    <script>
    /* ── 테이블 셀 오버플로우 시 마우스오버 툴팁 자동 등록 ──────────── */
    (function () {
        function setTooltip(el) {
            if (!el) return;
            /* 실제로 잘린 경우에만 title 설정 */
            if (el.scrollWidth > el.clientWidth + 2 && !el.hasAttribute('title')) {
                el.setAttribute('title', el.innerText.trim());
            }
        }
        /* 이벤트 위임 - hover 시점에만 검사 (성능 최적화) */
        document.addEventListener('mouseover', function (e) {
            var el = e.target;
            /* td/th 또는 .text-truncate 요소 타겟 */
            if (el.matches('td, th, .text-truncate, [data-tt]')) {
                setTooltip(el);
            } else {
                /* 자식 요소에서 버블링된 경우 부모 td/th 검사 */
                var cell = el.closest('td, th');
                if (cell) setTooltip(cell);
            }
        }, { passive: true });
    })();
    </script>
</body>
</html>
