{% extends "base_v2.html" %}
{% load static %}

{% block title %}문서 요청 관리 - Food Data Portal{% endblock %}

{% block topbar %}
<div class="v2-topbar-title-wrapper">
    <i class="bi bi-envelope-paper me-2 v2-topbar-icon"></i>
    <span class="v2-topbar-title">문서 요청 관리</span>
    <span class="ms-3 d-none d-md-inline v2-topbar-subtitle">연락처에 요청한 문서 현황과 접수 결과를 조회합니다</span>
</div>
{% include "includes/_topbar_account.html" %}
{% endblock %}

{% block extra_css %}
<style>
.dr-page { padding: 24px 28px; max-width: 1200px; }

/* 탭 */
.dr-tab-bar { display: flex; gap: 4px; margin-bottom: 20px; }
.dr-tab-btn {
    padding: 8px 20px; border: none; background: transparent;
    border-radius: 8px 8px 0 0; font-size: 14px; font-weight: 500;
    color: #5f6368; cursor: pointer; border-bottom: 2px solid transparent;
    transition: all .15s;
}
.dr-tab-btn.active { color: #1a73e8; border-bottom-color: #1a73e8; background: #f0f4ff; }
.dr-tab-btn .badge { font-size: 11px; }

/* 카드 */
.dr-card {
    background: #fff; border: 1px solid #e8eaed; border-radius: 10px;
    margin-bottom: 10px; padding: 16px 20px;
    display: flex; align-items: flex-start; gap: 16px;
}
.dr-card:hover { border-color: #1a73e8; box-shadow: 0 2px 8px rgba(26,115,232,.12); }
.dr-avatar {
    width: 42px; height: 42px; border-radius: 50%;
    background: #e8f0fe; color: #1a73e8;
    display: flex; align-items: center; justify-content: center;
    font-size: 18px; font-weight: 700; flex-shrink: 0;
}
.dr-meta { flex: 1; min-width: 0; }
.dr-meta-top { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; margin-bottom: 4px; }
.dr-name { font-weight: 600; font-size: 14px; color: #202124; }
.dr-email { font-size: 12px; color: #5f6368; }
.dr-company { font-size: 12px; color: #5f6368; }
.dr-date { font-size: 11px; color: #9aa0a6; margin-left: auto; }
.dr-doc-chips { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 6px; }
.dr-doc-chip {
    padding: 2px 8px; border-radius: 12px; font-size: 11px;
    background: #f1f3f4; color: #3c4043; border: 1px solid #e0e0e0;
}
.dr-message { font-size: 12px; color: #5f6368; margin-top: 6px; font-style: italic; }
.dr-actions { display: flex; flex-direction: column; gap: 6px; flex-shrink: 0; }

/* 상태 배지 */
.status-chip {
    display: inline-flex; align-items: center; gap: 4px;
    padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;
}
.status-PENDING   { background: #fef7e0; color: #b06000; }
.status-ACCEPTED  { background: #e6f4ea; color: #1e7e34; }
.status-REJECTED  { background: #fce8e6; color: #c5221f; }
.status-CANCELLED { background: #f1f3f4; color: #5f6368; }

.dr-empty {
    text-align: center; padding: 60px 20px;
    color: #9aa0a6; font-size: 14px;
}
.dr-empty i { font-size: 40px; display: block; margin-bottom: 12px; }
</style>
{% endblock %}

{% block content %}
<div class="dr-page">

    <!-- 탭 -->
    <div class="dr-tab-bar border-bottom">
        <button class="dr-tab-btn active" id="tabSentBtn" onclick="showTab('sent')">
            <i class="bi bi-send me-1"></i>보낸 요청
            <span class="badge bg-secondary rounded-pill ms-1">{{ sent_requests|length }}</span>
        </button>
        <button class="dr-tab-btn" id="tabRecvBtn" onclick="showTab('recv')">
            <i class="bi bi-inbox me-1"></i>받은 요청
            {% if pending_received %}
            <span class="badge bg-danger rounded-pill ms-1">{{ pending_received }}</span>
            {% else %}
            <span class="badge bg-secondary rounded-pill ms-1">{{ received_requests|length }}</span>
            {% endif %}
        </button>
    </div>

    <!-- ── 보낸 요청 탭 ── -->
    <div id="panelSent">
        {% if not sent_requests %}
        <div class="dr-empty">
            <i class="bi bi-send"></i>
            아직 보낸 문서 요청이 없습니다.<br>
            <small class="mt-2 d-block">연락처 관리에서 연락처를 선택해 문서 요청을 보내보세요.</small>
            <a href="{% url 'products:contacts' %}" class="btn btn-sm btn-primary mt-4">연락처 관리로 이동</a>
        </div>
        {% else %}
        {% for req in sent_requests %}
        <div class="dr-card">
            <div class="dr-avatar">{{ req.recipient_name|default:req.recipient_email|slice:":1"|upper }}</div>
            <div class="dr-meta">
                <div class="dr-meta-top">
                    <span class="dr-name">{{ req.recipient_name|default:"(이름 없음)" }}</span>
                    <span class="dr-email">{{ req.recipient_email }}</span>
                    {% if req.recipient_company %}<span class="dr-company">· {{ req.recipient_company }}</span>{% endif %}
                    <span class="dr-date">{{ req.created_datetime|date:"Y-m-d H:i" }}</span>
                </div>
                <div class="dr-doc-chips">
                    {% for dt in req.requested_documents %}
                    <span class="dr-doc-chip">{{ dt.type_name }}</span>
                    {% endfor %}
                </div>
                {% if req.message %}<div class="dr-message">"{{ req.message }}"</div>{% endif %}
            </div>
            <div class="dr-actions">
                <span class="status-chip status-{{ req.status }}">
                    {% if req.status == 'PENDING' %}<i class="bi bi-clock"></i>
                    {% elif req.status == 'ACCEPTED' %}<i class="bi bi-check-circle"></i>
                    {% elif req.status == 'REJECTED' %}<i class="bi bi-x-circle"></i>
                    {% else %}<i class="bi bi-slash-circle"></i>{% endif %}
                    {{ req.get_status_display }}
                </span>
                {% if req.status == 'PENDING' %}
                <button class="btn btn-sm btn-outline-danger"
                        onclick="cancelRequest({{ req.request_id }}, this)">
                    <i class="bi bi-x me-1"></i>취소
                </button>
                {% endif %}
            </div>
        </div>
        {% endfor %}
        {% endif %}
    </div>

    <!-- ── 받은 요청 탭 ── -->
    <div id="panelRecv" class="d-none">
        {% if not received_requests %}
        <div class="dr-empty">
            <i class="bi bi-inbox"></i>
            받은 문서 요청이 없습니다.
        </div>
        {% else %}
        {% for req in received_requests %}
        <div class="dr-card">
            <div class="dr-avatar">{{ req.requester.get_full_name|default:req.requester.username|slice:":1"|upper }}</div>
            <div class="dr-meta">
                <div class="dr-meta-top">
                    <span class="dr-name">{{ req.requester.get_full_name|default:req.requester.username }}</span>
                    <span class="dr-email">{{ req.requester.email }}</span>
                    <span class="dr-date">{{ req.created_datetime|date:"Y-m-d H:i" }}</span>
                </div>
                <div class="dr-doc-chips">
                    {% for dt in req.requested_documents %}
                    <span class="dr-doc-chip">{{ dt.type_name }}</span>
                    {% endfor %}
                </div>
                {% if req.message %}<div class="dr-message">"{{ req.message }}"</div>{% endif %}
            </div>
            <div class="dr-actions">
                <span class="status-chip status-{{ req.status }}">
                    {% if req.status == 'PENDING' %}<i class="bi bi-clock"></i>
                    {% elif req.status == 'ACCEPTED' %}<i class="bi bi-check-circle"></i>
                    {% elif req.status == 'REJECTED' %}<i class="bi bi-x-circle"></i>
                    {% else %}<i class="bi bi-slash-circle"></i>{% endif %}
                    {{ req.get_status_display }}
                </span>
                {% if req.status == 'PENDING' %}
                <button class="btn btn-sm btn-success"
                        onclick="acceptRequest({{ req.request_id }}, this)">
                    <i class="bi bi-check2 me-1"></i>수락
                </button>
                {% endif %}
            </div>
        </div>
        {% endfor %}
        {% endif %}
    </div>

</div><!-- /.dr-page -->
<script>
const CSRF_TOKEN = '{{ csrf_token }}';

function showTab(tab) {
    document.getElementById('panelSent').classList.toggle('d-none', tab !== 'sent');
    document.getElementById('panelRecv').classList.toggle('d-none', tab !== 'recv');
    document.getElementById('tabSentBtn').classList.toggle('active', tab === 'sent');
    document.getElementById('tabRecvBtn').classList.toggle('active', tab === 'recv');
}

async function cancelRequest(reqId, btn) {
    if (!confirm('이 요청을 취소하시겠습니까?')) return;
    btn.disabled = true;
    const res = await fetch(`/products/doc-requests/${reqId}/cancel/`, {
        method: 'POST', headers: {'X-CSRFToken': CSRF_TOKEN}
    });
    if (res.ok) location.reload();
    else { alert('취소에 실패했습니다.'); btn.disabled = false; }
}

async function acceptRequest(reqId, btn) {
    if (!confirm('이 문서 요청을 수락하시겠습니까?\n수락하면 상대방에게 접수 알림이 전송됩니다.')) return;
    btn.disabled = true;
    const res = await fetch(`/products/doc-requests/${reqId}/accept/`, {
        method: 'POST', headers: {'X-CSRFToken': CSRF_TOKEN}
    });
    if (res.ok) location.reload();
    else { alert('수락에 실패했습니다.'); btn.disabled = false; }
}
</script>
{% endblock %}
