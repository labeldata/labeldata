{% extends "base_v2.html" %}
{% load static %}

{% block title %}공동 작업 - Food Data Portal{% endblock %}

{% block topbar %}
<div class="v2-topbar-title-wrapper">
    <i class="bi bi-people me-2 v2-topbar-icon"></i>
    <span class="v2-topbar-title">공동 작업</span>
    <span class="ms-3 d-none d-md-inline v2-topbar-subtitle">공유받은 제품을 확인하고 작업하세요</span>
</div>
{% include "includes/_topbar_account.html" %}
{% endblock %}

{% block extra_css %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{% static 'css/sharing_inbox.css' %}?v=20260222b">
{% endblock %}

{% block content %}
<div class="inbox-page-container">

    {% comment %} 상단: 진행 단계 카드 스트립 {% endcomment %}
    <div class="inbox-stats-strip">
        <div class="inbox-stats-inner">

            {% comment %} 전체 카드 {% endcomment %}
            <a href="?{% if role_filter %}role={{ role_filter }}{% endif %}"
               class="inbox-stat-card {% if not status_filter %}isc-active-all{% endif %}">
                <div class="stat-icon stat-icon-default"><i class="bi bi-people"></i></div>
                <div>
                    <div class="stat-card-count">{{ total_count }}</div>
                    <div class="stat-card-label">전체</div>
                </div>
            </a>

            <div class="inbox-stage-sep"></div>

            {% comment %} 작성중 {% endcomment %}
            <a href="?status=DRAFT{% if role_filter %}&role={{ role_filter }}{% endif %}"
               class="inbox-stat-card isc-draft {% if status_filter == 'DRAFT' %}isc-active-DRAFT{% endif %}">
                <div class="stat-icon isc-icon-draft"><i class="bi bi-pencil"></i></div>
                <div>
                    <div class="stat-card-count">{{ status_counts.DRAFT|default:0 }}</div>
                    <div class="stat-card-label">작성 중</div>
                </div>
            </a>

            <div class="inbox-stage-arrow"><i class="bi bi-chevron-right"></i></div>

            {% comment %} 자료요청 {% endcomment %}
            <a href="?status=REQUESTING{% if role_filter %}&role={{ role_filter }}{% endif %}"
               class="inbox-stat-card isc-requesting {% if status_filter == 'REQUESTING' %}isc-active-REQUESTING{% endif %}">
                <div class="stat-icon isc-icon-requesting"><i class="bi bi-send"></i></div>
                <div>
                    <div class="stat-card-count">{{ status_counts.REQUESTING|default:0 }}</div>
                    <div class="stat-card-label">자료 요청</div>
                </div>
            </a>

            <div class="inbox-stage-arrow"><i class="bi bi-chevron-right"></i></div>

            {% comment %} 제출완료 {% endcomment %}
            <a href="?status=SUBMITTED{% if role_filter %}&role={{ role_filter }}{% endif %}"
               class="inbox-stat-card isc-submitted {% if status_filter == 'SUBMITTED' %}isc-active-SUBMITTED{% endif %}">
                <div class="stat-icon isc-icon-submitted"><i class="bi bi-check2-all"></i></div>
                <div>
                    <div class="stat-card-count">{{ status_counts.SUBMITTED|default:0 }}</div>
                    <div class="stat-card-label">제출 완료</div>
                </div>
            </a>

            <div class="inbox-stage-arrow"><i class="bi bi-chevron-right"></i></div>

            {% comment %} 검토중 {% endcomment %}
            <a href="?status=REVIEW{% if role_filter %}&role={{ role_filter }}{% endif %}"
               class="inbox-stat-card isc-review {% if status_filter == 'REVIEW' %}isc-active-REVIEW{% endif %}">
                <div class="stat-icon isc-icon-review"><i class="bi bi-eye"></i></div>
                <div>
                    <div class="stat-card-count">{{ status_counts.REVIEW|default:0 }}</div>
                    <div class="stat-card-label">검토 중</div>
                </div>
            </a>

            <div class="inbox-stage-arrow"><i class="bi bi-chevron-right"></i></div>

            {% comment %} 승인대기 {% endcomment %}
            <a href="?status=PENDING{% if role_filter %}&role={{ role_filter }}{% endif %}"
               class="inbox-stat-card isc-pending {% if status_filter == 'PENDING' %}isc-active-PENDING{% endif %}">
                <div class="stat-icon isc-icon-pending"><i class="bi bi-hourglass-split"></i></div>
                <div>
                    <div class="stat-card-count">{{ status_counts.PENDING|default:0 }}</div>
                    <div class="stat-card-label">승인 대기</div>
                </div>
            </a>

            <div class="inbox-stage-arrow"><i class="bi bi-chevron-right"></i></div>

            {% comment %} 승인완료 {% endcomment %}
            <a href="?status=CONFIRMED{% if role_filter %}&role={{ role_filter }}{% endif %}"
               class="inbox-stat-card isc-confirmed {% if status_filter == 'CONFIRMED' %}isc-active-CONFIRMED{% endif %}">
                <div class="stat-icon isc-icon-confirmed"><i class="bi bi-patch-check-fill"></i></div>
                <div>
                    <div class="stat-card-count">{{ status_counts.CONFIRMED|default:0 }}</div>
                    <div class="stat-card-label">승인 완료</div>
                </div>
            </a>

        </div>
    </div>

    {% comment %} 역할 필터 툴바 {% endcomment %}
    <div class="inbox-filter-bar">
        <ul class="nav role-pills mb-0">
            <li class="nav-item">
                <a class="nav-link {% if not role_filter %}active{% endif %}"
                   href="?{% if status_filter %}status={{ status_filter }}{% endif %}">
                    <i class="bi bi-people me-1"></i>전체 역할
                </a>
            </li>
            {% for code, label in role_choices %}
            <li class="nav-item">
                <a class="nav-link {% if role_filter == code %}active{% endif %}"
                   href="?role={{ code }}{% if status_filter %}&status={{ status_filter }}{% endif %}">
                    {{ label }}
                </a>
            </li>
            {% endfor %}
        </ul>

        <div class="ms-auto text-muted" style="font-size:13px;">
            {% if status_filter or role_filter %}
                <strong>{{ filtered_count }}</strong> / {{ total_count }}건
            {% else %}
                총 <strong>{{ total_count }}</strong>건
            {% endif %}
        </div>
    </div>

    {% comment %} 테이블 {% endcomment %}
    <div class="flex-grow-1 overflow-auto custom-scrollbar px-0">
        {% if received_shares %}
        <table class="table table-hover align-middle mb-0 inbox-table">
            <thead>
                <tr class="text-muted">
                    <th style="width:28%; text-align:left !important;">제품명</th>
                    <th style="width:12%;">공유자</th>
                    <th style="width:9%;">내 역할</th>
                    <th style="width:9%;">진행상태</th>
                    <th style="width:20%; text-align:left !important;">메시지</th>
                    <th style="width:9%;">공유일</th>
                    <th style="width:13%;">할 일</th>
                </tr>
            </thead>
            <tbody>
                {% for share in received_shares %}
                <tr onclick="window.location.href='{% url 'products:product_detail_new' share.label.my_label_id %}'">
                    <td style="text-align:left;">
                        <div class="d-flex align-items-center gap-2">
                            <div class="file-icon"><i class="bi bi-file-earmark-text"></i></div>
                            <div>
                                <div class="fw-semibold text-truncate" style="max-width:220px;">{{ share.label.my_label_name }}</div>
                                {% if share.metadata.product_code %}
                                <div class="text-muted" style="font-size:11px;">{{ share.metadata.product_code }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </td>
                    <td>
                        <div style="font-size:12px;">{{ share.created_by.get_full_name|default:share.created_by.username }}</div>
                        <div class="text-muted" style="font-size:11px;">{{ share.created_by.email }}</div>
                    </td>
                    <td>
                        {% with r=share.permission.role_code %}
                        <span class="status-badge-sm"
                            style="{% if r == 'EDITOR' %}background:#e6f4ea;color:#1e8e3e;
                            {% elif r == 'REVIEWER' %}background:#fef7e0;color:#c77700;
                            {% elif r == 'APPROVER' %}background:#f3e8fd;color:#9334e9;
                            {% elif r == 'UPLOADER' %}background:#e8f0fe;color:#1967d2;
                            {% else %}background:#f1f3f4;color:#5f6368;{% endif %}">
                            {{ share.permission.get_role_code_display }}
                        </span>
                        {% endwith %}
                    </td>
                    <td>
                        {% with s=share.metadata.status %}
                        {% if s == 'DRAFT' %}<span class="status-badge-sm" style="background:#e8f0fe;color:#1967d2;">작성 중</span>
                        {% elif s == 'REQUESTING' %}<span class="status-badge-sm" style="background:#fef7e0;color:#c77700;">자료 요청</span>
                        {% elif s == 'SUBMITTED' %}<span class="status-badge-sm" style="background:#e6f4ea;color:#0f9d58;">제출 완료</span>
                        {% elif s == 'REVIEW' %}<span class="status-badge-sm" style="background:#f3e8fd;color:#9334e9;">검토 중</span>
                        {% elif s == 'PENDING' %}<span class="status-badge-sm" style="background:#fff0e0;color:#e37400;">승인 대기</span>
                        {% elif s == 'CONFIRMED' %}<span class="status-badge-sm" style="background:#e6f4ea;color:#1e8e3e;">승인 완료</span>
                        {% else %}<span class="text-muted">-</span>
                        {% endif %}
                        {% endwith %}
                    </td>
                    <td style="text-align:left;" class="msg-cell" onclick="event.stopPropagation()">
                        {% if share.share_message %}
                        <div class="msg-text" title="{{ share.share_message }}">{{ share.share_message }}</div>
                        {% else %}
                        <span class="text-muted" style="font-size:12px;">-</span>
                        {% endif %}
                    </td>
                    <td>
                        <span class="text-muted" style="font-size:12px;">{{ share.share_start_date|date:"y.m.d" }}</span>
                    </td>
                    <td onclick="event.stopPropagation()">
                        {% if share.action_label %}
                        <a href="{% url 'products:product_detail_new' share.label.my_label_id %}"
                           class="btn btn-sm {{ share.action_style }}" style="border-radius:16px;font-size:12px;white-space:nowrap;">
                            {% if share.action_icon %}<i class="bi bi-{{ share.action_icon }} me-1"></i>{% endif %}
                            {{ share.action_label }}
                        </a>
                        {% else %}
                        <a href="{% url 'products:product_detail_new' share.label.my_label_id %}"
                           class="btn btn-sm btn-outline-secondary" style="border-radius:16px;font-size:12px;">
                            <i class="bi bi-eye me-1"></i>보기
                        </a>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="d-flex align-items-center justify-content-center" style="height:360px;">
            <div class="text-center">
                <i class="bi bi-inbox" style="font-size:56px;color:#dadce0;"></i>
                {% if status_filter or role_filter %}
                <p class="mt-3 text-muted">해당 조건에 맞는 공동 작업 항목이 없습니다</p>
                <a href="?" class="btn btn-outline-secondary btn-sm mt-2" style="border-radius:16px;">전체 보기</a>
                {% else %}
                <p class="mt-3 text-muted">공유받은 제품이 없습니다</p>
                <p class="text-muted" style="font-size:13px;">다른 사용자가 제품을 공유하면 이곳에 표시됩니다</p>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>

    {% comment %} 하단 바 {% endcomment %}
    <div class="bottom-bar">
        <span class="text-muted" style="font-size:13px;">
            {% if status_filter or role_filter %}
                필터 결과 <strong>{{ filtered_count }}</strong>건 / 전체 {{ total_count }}건
            {% else %}
                전체 <strong>{{ total_count }}</strong>건
            {% endif %}
        </span>
        <span></span>
    </div>

</div>
{% endblock %}
