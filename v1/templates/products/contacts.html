{% extends "base_v2.html" %}
{% load static %}

{% block title %}연락처 관리 - Food Data Portal{% endblock %}

{% block topbar %}
<div class="v2-topbar-title-wrapper">
    <i class="bi bi-person-lines-fill me-2 v2-topbar-icon"></i>
    <span class="v2-topbar-title">연락처 관리</span>
    <span class="ms-3 d-none d-md-inline v2-topbar-subtitle">공유 이력 기반 연락처와 공유 현황을 조회·관리하세요</span>
</div>
{% include "includes/_topbar_account.html" %}
{% endblock %}

{% block extra_css %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/handsontable@12.4.0/dist/handsontable.full.min.css" rel="stylesheet">
<link rel="stylesheet" href="{% static 'css/contacts.css' %}?v=20260222m">
{% endblock %}

{% block content %}
<div class="contacts-container">

    <!-- ── 왼쪽: 연락처 그리드 패널 ── -->
    <div class="contacts-left" id="contactsLeft">

        <!-- 패널 헤더 -->
        <div class="contacts-panel-header">
            <div class="d-flex align-items-center gap-2">
                <i class="bi bi-person-lines-fill text-primary"></i>
                <span class="fw-semibold" style="font-size:14px;">연락처</span>
                <span class="badge rounded-pill bg-primary ms-1" id="contactCount">{{ contacts_list|length }}</span>
            </div>
            <div class="d-flex align-items-center gap-2">
                {# ── 선택 시에만 표시되는 액션 바 ── #}
                <div id="selection-actions" class="d-none align-items-center">
                    <span class="badge bg-primary" style="font-size:12px;"><span id="selected-count">0</span>개 선택됨</span>
                    <button class="btn btn-sm btn-outline-danger" id="bulkDeleteBtn">
                        <i class="bi bi-trash me-1"></i>삭제
                    </button>
                    <button class="btn btn-sm btn-primary" id="bulkRequestBtn">
                        <i class="bi bi-envelope-paper me-1"></i>문서 요청
                    </button>
                </div>
                {# ── 검색 (항상 표시) ── #}
                <div class="input-group input-group-sm" style="width:200px;">
                    <span class="input-group-text bg-white border-end-0" style="padding:3px 8px;"><i class="bi bi-search text-muted"></i></span>
                    <input type="text" id="contactSearch" class="form-control border-start-0 ps-0" placeholder="이메일, 이름 검색..." autocomplete="off" style="font-size:12px;">
                </div>
                <button class="contacts-icon-btn" id="addRowBtn" title="행 추가">
                    <i class="bi bi-person-plus"></i>
                </button>
            </div>
        </div>

        <!-- 필터 바 -->
        <div id="contactsFilterBar" style="display:flex;align-items:center;gap:6px;padding:5px 12px;border-bottom:1px solid #e8eaed;background:#f8f9fa;flex-shrink:0;">
            <span style="font-size:11px;color:#80868b;margin-right:2px;">필터</span>
            <button class="contacts-filter-btn active" data-filter="all" onclick="setTableFilter('all',this)">전체</button>
            <button class="contacts-filter-btn" data-filter="requested" onclick="setTableFilter('requested',this)"><i class="bi bi-envelope-paper me-1"></i>요청 전송</button>
            <button class="contacts-filter-btn" data-filter="pending" onclick="setTableFilter('pending',this)"><i class="bi bi-clock-history me-1"></i>미회신</button>
            <button class="contacts-filter-btn" data-filter="received" onclick="setTableFilter('received',this)"><i class="bi bi-inbox me-1"></i>요청수신</button>
            <span style="width:1px;background:#dadce0;height:16px;margin:0 2px;"></span>
            <button class="contacts-filter-btn" id="recvReqFilterBtn" onclick="showReceivedRequests(this)">
                <i class="bi bi-inbox me-1"></i>받은 요청
                <span id="recvReqBadge" class="d-none" style="background:#d93025;color:#fff;border-radius:8px;padding:0 5px;font-size:10px;font-weight:700;margin-left:2px;"></span>
            </button>
            <span id="filterInfo" style="margin-left:auto;font-size:11px;color:#80868b;"></span>
        </div>

        <!-- Handsontable 그리드 -->
        <div class="contacts-grid-wrap">
            <div id="contactsGrid"></div>
        </div>

        <!-- 하단 상태바 -->
        <div class="contacts-statusbar">
            <span id="statusText">셀을 클릭해 선택 · 더블클릭해 편집 · Ctrl+C/V로 복사·붙여넣기 가능</span>
            <span id="rowInfo" style="margin-left:auto;"></span>
        </div>
    </div>

    <!-- ── 리사이즈 핸들 ── -->
    <div class="contacts-resizer" id="resizer"></div>

    <!-- ── 오른쪽: 공유 현황 패널 ── -->
    <div class="contacts-right" id="contactsRight">

        <!-- 선택 전 빈 상태 -->
        <div class="contacts-empty-state" id="emptyState">
            <i class="bi bi-arrow-left-circle" style="font-size:36px;color:#dadce0;"></i>
            <p class="mt-3 text-muted" style="font-size:14px;">왼쪽에서 연락처를 선택하세요</p>
            <p class="text-muted" style="font-size:12px;">연락처를 클릭하면 공유·자료요청 현황을,<br>체크박스로 복수 선택 후 <strong>자료 요청</strong>을 할 수 있습니다.</p>
        </div>

        <!-- 받은 자료 요청 패널 -->
        <div class="d-none" id="receivedReqView" style="display:flex;flex-direction:column;height:100%;overflow:hidden;">
            <div class="share-contact-header" style="flex-shrink:0;">
                <div>
                    <div style="font-size:15px;font-weight:600;color:#202124;">
                        <i class="bi bi-inbox me-2 text-danger"></i>내가 받은 자료 요청
                    </div>
                    <div class="text-muted mt-1" style="font-size:12px;">명의 담당자로서 처리해주세요</div>
                </div>
                <button class="btn btn-sm btn-light ms-auto" onclick="closeReceivedPanel()">
                    <i class="bi bi-x"></i>
                </button>
            </div>
            <div class="flex-grow-1 overflow-auto p-3" id="receivedReqList">
                <div class="text-center py-5 text-muted">
                    <div class="spinner-border spinner-border-sm"></div>
                    <span class="ms-2">불러오는 중...</span>
                </div>
            </div>
        </div>

        <!-- ── 문서 요청 패널 (복수 선택 시) ── -->
        <div class="d-none" id="docRequestView" style="display:flex;flex-direction:column;height:100%;overflow:hidden;">

            <!-- 헤더 -->
            <div class="share-contact-header">
                <div style="display:flex;flex-direction:column;">
                    <div style="font-size:15px;font-weight:600;color:#202124;">
                        <i class="bi bi-envelope-paper me-2 text-primary"></i>자료 요청 보내기
                    </div>
                    <div class="text-muted mt-1" style="font-size:12px;" id="docReqRecipientSummary">선택된 연락처 0명</div>
                </div>
                <button class="btn btn-sm btn-light ms-auto" onclick="closeDocRequestPanel()">
                    <i class="bi bi-x"></i>
                </button>
            </div>

            <div class="flex-grow-1 overflow-auto p-4">

                <!-- 선택 연락처 칩 -->
                <div class="mb-3">
                    <div class="fw-semibold mb-2" style="font-size:12px;color:#5f6368;text-transform:uppercase;letter-spacing:.5px;">요청 대상</div>
                    <div id="docReqChips" style="display:flex;flex-wrap:wrap;gap:4px;"></div>
                </div>

                <!-- 문서 유형 선택 -->
                <div class="mb-3">
                    <div class="fw-semibold mb-1" style="font-size:12px;color:#5f6368;text-transform:uppercase;letter-spacing:.5px;">요청 문서 종류 <span class="text-danger">*</span></div>
                    <div class="text-muted mb-2" style="font-size:11px;">✔ 체크한 문서를 <strong>수신자가 각 항목별로 업로드</strong>해야 하는 요청입니다. 요청 이력은 오른쪽 <strong>자료 요청</strong> 탭에서 확인할 수 있습니다.</div>
                    <div id="docTypeList">
                        <div class="text-center py-3 text-muted"><div class="spinner-border spinner-border-sm"></div> 불러오는 중...</div>
                    </div>
                </div>

                <!-- 메시지 -->
                <div class="mb-3">
                    <div class="fw-semibold mb-2" style="font-size:12px;color:#5f6368;text-transform:uppercase;letter-spacing:.5px;">메시지 (선택)</div>
                    <textarea id="docReqMessage" rows="3" class="form-control" style="font-size:13px;resize:none;"
                              placeholder="예) 수입통관을 위해 원산지 증명서 제출 부탁드립니다."></textarea>
                </div>

                <!-- 첨부 파일 -->
                <div class="mb-2">
                    <div class="fw-semibold mb-2" style="font-size:12px;color:#5f6368;text-transform:uppercase;letter-spacing:.5px;">첨부 파일 (선택)</div>
                    <label class="d-flex align-items-center gap-2 p-2 rounded" style="border:1px dashed #dadce0;cursor:pointer;background:#fafafa;font-size:13px;">
                        <i class="bi bi-paperclip text-muted"></i>
                        <span id="docReqFileName" class="text-muted flex-grow-1">양식, 참고 파일 등 첨부 (클릭)</span>
                        <input type="file" id="docReqFile" style="display:none;" onchange="updateFileName(this)">
                    </label>
                </div>

            </div>

            <!-- 전송 버튼 -->
            <div class="p-3 border-top" style="flex-shrink:0;">
                <button class="btn btn-primary w-100" id="sendDocReqBtn" onclick="sendDocRequest()">
                    <i class="bi bi-send me-2"></i>요청 보내기
                </button>
                <div class="text-muted text-center mt-2" style="font-size:11px;">
                    이메일로 요청이 전달되며, 연락처 목록의 '자료요청' 열에서 현황을 확인할 수 있습니다.
                </div>
            </div>
        </div>

        <!-- 선택 후 표시될 공유 현황 -->
        <div class="contacts-share-view d-none" id="shareView">

            <!-- 선택된 연락처 정보 헤더 -->
            <div class="share-contact-header">
                <div class="share-contact-avatar" id="shareAvatar">?</div>
                <div>
                    <div class="share-contact-name" id="shareContactName">–</div>
                    <div class="share-contact-email" id="shareContactEmail">–</div>
                    <div class="share-contact-company" id="shareContactCompany"></div>
                </div>
                <div class="ms-auto">
                    <button class="btn btn-sm btn-outline-primary" onclick="openQuickShare()" title="이 연락처에 새 제품 공유">
                        <i class="bi bi-share me-1"></i>제품 공유
                    </button>
                </div>
            </div>

            <!-- 공유 탭 -->
            <ul class="nav nav-tabs px-4 pt-2" id="shareTabs" role="tablist" style="border-bottom:1px solid #e8eaed;">
                <li class="nav-item">
                    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabSent" type="button">
                        <i class="bi bi-upload me-1"></i>내가 공유한 제품
                        <span class="badge rounded-pill bg-primary ms-1" id="sentBadge" style="font-size:10px;">0</span>
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabReceived" type="button">
                        <i class="bi bi-download me-1"></i>받은 공유 제품
                        <span class="badge rounded-pill bg-secondary ms-1" id="receivedBadge" style="font-size:10px;">0</span>
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabDocReq" type="button">
                        <i class="bi bi-envelope-paper me-1"></i>자료 요청
                        <span class="badge rounded-pill ms-1" id="docReqBadge" style="font-size:10px;background:#e37400;color:#fff;">0</span>
                    </button>
                </li>
            </ul>

            <div class="tab-content flex-grow-1 overflow-auto" style="min-height:0;">

                <!-- 내가 공유한 제품 탭 -->
                <div class="tab-pane fade show active p-4" id="tabSent">
                    <div id="sentLoading" class="text-center py-4 d-none">
                        <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                        <span class="ms-2 text-muted" style="font-size:13px;">불러오는 중...</span>
                    </div>
                    <div id="sentEmpty" class="text-center py-5 text-muted d-none">
                        <i class="bi bi-share" style="font-size:28px;display:block;margin-bottom:8px;"></i>
                        이 연락처에게 공유한 제품이 없습니다.
                    </div>
                    <table class="share-table d-none" id="sentTable">
                        <thead>
                            <tr>
                                <th>제품명</th>
                                <th style="width:110px;">역할</th>
                                <th style="width:100px;">공유일</th>
                                <th style="width:100px;">만료일</th>
                                <th style="width:80px; text-align:center;">관리</th>
                            </tr>
                        </thead>
                        <tbody id="sentTbody"></tbody>
                    </table>
                </div>

                <!-- 받은 공유 제품 탭 -->
                <div class="tab-pane fade p-4" id="tabReceived">
                    <div id="receivedLoading" class="text-center py-4 d-none">
                        <div class="spinner-border spinner-border-sm text-secondary" role="status"></div>
                        <span class="ms-2 text-muted" style="font-size:13px;">불러오는 중...</span>
                    </div>
                    <div id="receivedEmpty" class="text-center py-5 text-muted d-none">
                        <i class="bi bi-inbox" style="font-size:28px;display:block;margin-bottom:8px;"></i>
                        이 연락처로부터 받은 공유 제품이 없습니다.
                    </div>
                    <table class="share-table d-none" id="receivedTable">
                        <thead>
                            <tr>
                                <th>제품명</th>
                                <th style="width:110px;">역할</th>
                                <th style="width:100px;">공유일</th>
                                <th style="width:100px;">만료일</th>
                                <th style="width:80px; text-align:center;">바로가기</th>
                            </tr>
                        </thead>
                        <tbody id="receivedTbody"></tbody>
                    </table>
                </div>

                <!-- 자료 요청 탭 -->
                <div class="tab-pane fade p-4" id="tabDocReq">
                    <div id="docReqLoading" class="text-center py-4 d-none">
                        <div class="spinner-border spinner-border-sm text-warning" role="status"></div>
                        <span class="ms-2 text-muted" style="font-size:13px;">요청 이력 불러오는 중...</span>
                    </div>
                    <div id="docReqEmpty" class="text-center py-5 text-muted d-none">
                        <i class="bi bi-envelope-paper" style="font-size:28px;display:block;margin-bottom:8px;"></i>
                        이 연락처에게 보낸 자료 요청이 없습니다.
                    </div>
                    <div id="docReqList"></div>
                    <div class="mt-3 pt-3 border-top d-none" id="docReqSendShortcut">
                        <button class="btn btn-sm btn-outline-primary w-100" onclick="openDocRequestFromContact()">
                            <i class="bi bi-envelope-paper me-1"></i>이 연락처에게 새 자료 요청
                        </button>
                    </div>
                </div>

            </div><!-- /.tab-content -->
        </div><!-- /#shareView -->
    </div><!-- /.contacts-right -->

</div><!-- /.contacts-container -->

{# ── 문서 등록 및 수락 모달 ── #}
<div class="modal fade" id="submitDocModal" tabindex="-1" aria-labelledby="submitDocModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="submitDocModalLabel">
          <i class="bi bi-upload me-2 text-success"></i>문서 등록 및 수락
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
      </div>
      <div class="modal-body" id="submitDocModalBody">
        {# JS로 동적 채워짐 #}
      </div>
      <div class="modal-footer">
        <small class="text-muted me-auto">파일을 선택하지 않은 항목은 건너뜁니다.</small>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
        <button type="button" class="btn btn-success" id="submitDocBtn" onclick="submitDocFiles()">
          <i class="bi bi-upload me-1"></i>제출 및 수락
        </button>
      </div>
    </div>
  </div>
</div>

{# ── Django → JS 데이터 전달 (json_script 안전 방식) ── #}
{{ contacts_list|json_script:"contacts-init-data" }}
<script src="https://cdn.jsdelivr.net/npm/handsontable@12.4.0/dist/handsontable.full.min.js"></script>
<script>
const CSRF_TOKEN = '{{ csrf_token }}';
const CONTACTS_API_LIST   = '{% url "products:contacts_api_list" %}';
const CONTACTS_API_SHARES = '{% url "products:contacts_api_shares" %}';
const PRODUCT_DETAIL_URL  = '/products/';  // + label_id + '/new/'

// 서버에서 넘어온 초기 연락처 데이터 (json_script 안전 파싱)
const initRows = (JSON.parse(document.getElementById('contacts-init-data').textContent) || []).map(r => ({...r, _checked: false, doc_sent: r.doc_sent||0, doc_pending: r.doc_pending||0, doc_received: r.doc_received||0}));

const DOC_TYPES_API  = '{% url "products:api_doc_types" %}';
const SEND_DOC_REQ_API = '{% url "products:api_send_doc_request" %}';
const CONTACTS_API_DOC_REQUESTS = '{% url "products:contacts_api_doc_requests" %}';
const CONTACTS_API_RECEIVED = '{% url "products:contacts_api_received_doc_requests" %}';
const SUBMIT_DOC_REQ_API = '/products/doc-requests/'; // + req_id + '/submit/'

const ROLE_BADGE = {
    OWNER:    '<span class="role-chip role-owner">오너</span>',
    EDITOR:   '<span class="role-chip role-editor">공동편집</span>',
    UPLOADER: '<span class="role-chip role-requester">자료제출</span>',
    REVIEWER: '<span class="role-chip role-reviewer">검토자</span>',
    APPROVER: '<span class="role-chip role-approver">승인자</span>',
    VIEWER:   '<span class="role-chip role-viewer">조회</span>',
    '':       '<span class="role-chip role-none">미지정</span>',
};

let selectedEmail = null;
let hot = null;
let allRows = []; // 필터 원본 데이터 보관
let currentFilter = 'all';

// 필터 바 토글
function setTableFilter(filter, btn) {
    currentFilter = filter;
    document.querySelectorAll('.contacts-filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    let filtered;
    if (filter === 'requested') {
        filtered = allRows.filter(r => r.doc_sent > 0);
    } else if (filter === 'pending') {
        filtered = allRows.filter(r => r.doc_pending > 0);
    } else if (filter === 'received') {
        filtered = allRows.filter(r => r.doc_received > 0);
    } else {
        filtered = allRows;
    }

    const display = [...filtered];
    while (display.length < 20) display.push({ _checked: false, email: '', name: '', company: '', license_no: '', sent: 0, received: 0, doc_sent: 0, doc_pending: 0, doc_received: 0 });

    const infoEl = document.getElementById('filterInfo');
    infoEl.textContent = filter === 'all' ? '' : `${filtered.length}연락처 해당`;

    // 필터 시 행 추가 버튼 비활성관리 (필터 중엔 신규행 추가 불가)
    const addBtn = document.getElementById('addRowBtn');
    if (addBtn) addBtn.disabled = filter !== 'all';

    hot.loadData(display);
    updateSelectionUI();

    // 받은 요청 패널이 열려 있으면 닫기
    document.getElementById('receivedReqView').classList.add('d-none');
    document.getElementById('emptyState').classList.remove('d-none');
    document.getElementById('recvReqFilterBtn').classList.remove('active');
}

// ─────────────── 받은 자료 요청 패널 ───────────────
async function showReceivedRequests(btn) {
    // 그리드 필터 버튼 해제
    document.querySelectorAll('.contacts-filter-btn[data-filter]').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    // 오른쪽 패널 전환
    document.getElementById('emptyState').classList.add('d-none');
    document.getElementById('shareView').classList.add('d-none');
    document.getElementById('docRequestView').classList.add('d-none');
    const panel = document.getElementById('receivedReqView');
    panel.classList.remove('d-none');
    panel.style.display = 'flex';

    await loadReceivedDocRequests();
}

function closeReceivedPanel() {
    document.getElementById('receivedReqView').classList.add('d-none');
    document.getElementById('emptyState').classList.remove('d-none');
    document.getElementById('recvReqFilterBtn').classList.remove('active');
}

async function loadReceivedDocRequests() {
    const listEl = document.getElementById('receivedReqList');
    listEl.innerHTML = '<div class="text-center py-5 text-muted"><div class="spinner-border spinner-border-sm"></div><span class="ms-2">불러오는 중...</span></div>';

    try {
        const res  = await fetch(CONTACTS_API_RECEIVED);
        const data = await res.json();
        const reqs = data.requests || [];

        // 배지 업데이트
        const pending = reqs.filter(r => r.status === 'PENDING').length;
        const badgeEl = document.getElementById('recvReqBadge');
        if (pending > 0) {
            badgeEl.textContent = pending;
            badgeEl.classList.remove('d-none');
        } else {
            badgeEl.classList.add('d-none');
        }

        if (!reqs.length) {
            listEl.innerHTML = '<div class="text-center py-5 text-muted"><i class="bi bi-inbox" style="font-size:28px;display:block;margin-bottom:8px;"></i>받은 자료 요청이 없습니다.</div>';
            return;
        }

        const STATUS_STYLE = {
            PENDING:   { icon: 'bi-clock', color: '#e37400', bg: '#fce8b2', label: '대기 중' },
            ACCEPTED:  { icon: 'bi-check-circle', color: '#137333', bg: '#e6f4ea', label: '수락 완료' },
            REJECTED:  { icon: 'bi-x-circle', color: '#c5221f', bg: '#fce8b2', label: '거절됨' },
            CANCELLED: { icon: 'bi-slash-circle', color: '#80868b', bg: '#f1f3f4', label: '취소됨' },
        };

        listEl.innerHTML = reqs.map(r => {
            const st   = STATUS_STYLE[r.status] || STATUS_STYLE.PENDING;
            const docs = (r.requested_documents || []).map(d =>
                `<span style="background:#e8f0fe;color:#1a73e8;border-radius:8px;padding:1px 8px;font-size:11px;margin-right:3px;">${d.type_name}</span>`
            ).join('');
            const attach = r.attachment_url
                ? `<a href="${r.attachment_url}" target="_blank" class="btn btn-xs btn-outline-secondary py-0 px-2 ms-1" style="font-size:11px;">
                        <i class="bi bi-paperclip me-1"></i>첨부파일
                   </a>` : '';
            const acceptBtn = r.status === 'PENDING'
                ? `<button class="btn btn-sm btn-success" onclick="openSubmitModal(${r.request_id}, ${JSON.stringify(r.requested_documents||[]).replace(/"/g,'&quot;')})">
                        <i class="bi bi-upload me-1"></i>문서 등록 및 수락
                   </button>
                   <button class="btn btn-sm btn-outline-secondary ms-1" onclick="acceptReceivedReq(${r.request_id}, this)">
                        파일 없이 수락
                   </button>` : '';
            const submittedList = (r.submissions && r.submissions.length)
                ? `<div class="mt-2">${r.submissions.map(s => `
                    <div style="font-size:11px;background:#e6f4ea;border-radius:6px;padding:2px 8px;margin-bottom:2px;">
                        <i class="bi bi-file-earmark-check me-1 text-success"></i>${s.document_type}:
                        <a href="${s.file_url}" target="_blank">${s.filename}</a>
                    </div>`).join('')}</div>` : '';
            return `<div class="border rounded p-3 mb-2" style="font-size:13px;background:#fff;">
                <div class="d-flex align-items-start gap-2 mb-2">
                    <div style="width:36px;height:36px;border-radius:50%;background:#f1f3f4;display:flex;align-items:center;justify-content:center;font-weight:700;color:#5f6368;flex-shrink:0;font-size:15px;">
                        ${(r.requester_name||'?').slice(0,1).toUpperCase()}
                    </div>
                    <div class="flex-grow-1">
                        <div class="fw-semibold">${r.requester_name}</div>
                        <div class="text-muted" style="font-size:11px;">${r.requester_email}</div>
                    </div>
                    <span class="text-muted" style="font-size:11px;flex-shrink:0;">${r.created}</span>
                </div>
                <div class="mb-2">${docs || '<span style="color:#bdc1c6;font-size:12px;">요청 문서 미지정</span>'}</div>
                ${r.message ? `<div class="text-muted mb-2" style="font-size:12px;font-style:italic;">"${r.message}"</div>` : ''}
                ${r.due_date ? `<div style="font-size:11px;color:#c5221f;margin-bottom:6px;"><i class="bi bi-calendar me-1"></i>마감: ${r.due_date}</div>` : ''}
                <div class="d-flex align-items-center gap-2 flex-wrap">
                    <span style="background:${st.bg};color:${st.color};border-radius:10px;padding:2px 10px;font-size:11px;font-weight:600;">
                        <i class="bi ${st.icon} me-1"></i>${st.label}
                    </span>
                    ${attach}
                    ${acceptBtn}
                </div>
                ${submittedList}
            </div>`;
        }).join('');
    } catch(e) {
        listEl.innerHTML = '<p class="text-danger p-3" style="font-size:13px;">불러오기 실패</p>';
    }
}

async function acceptReceivedReq(reqId, btn) {
    if (!confirm('이 자료 요청을 수락하시겠습니까?\n수락하면 요청자에게 알림이 전송됩니다.')) return;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    const res = await fetch(`/products/doc-requests/${reqId}/accept/`, {
        method: 'POST', headers: { 'X-CSRFToken': CSRF_TOKEN }
    });
    if (res.ok) {
        await loadReceivedDocRequests();
    } else {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-check2 me-1"></i>파일 없이 수락';
        alert('수락에 실패했습니다.');
    }
}

function openSubmitModal(reqId, docTypesJson) {
    let docTypes = [];
    try {
        docTypes = typeof docTypesJson === 'string' ? JSON.parse(docTypesJson) : docTypesJson;
    } catch(e) { docTypes = []; }

    const body = document.getElementById('submitDocModalBody');
    if (!docTypes.length) {
        body.innerHTML = '<div class="alert alert-warning">요청된 문서 유형이 없습니다. 파일 없이 수락 버튼을 이용해 주세요.</div>';
    } else {
        body.innerHTML = docTypes.map(dt => `
            <div class="mb-3 p-3 border rounded">
                <label class="fw-semibold mb-2 d-block" style="font-size:13px;">
                    <i class="bi bi-file-earmark me-1 text-primary"></i>${dt.type_name}
                    <small class="text-muted fw-normal ms-2">(선택 사항)</small>
                </label>
                <input type="file" class="form-control form-control-sm doc-upload-input"
                       data-type="${dt.type_name}" accept="*/*">
            </div>`).join('');
    }
    const submitBtn = document.getElementById('submitDocBtn');
    submitBtn.dataset.reqId = reqId;
    submitBtn.disabled = false;
    submitBtn.innerHTML = '<i class="bi bi-upload me-1"></i>제출 및 수락';
    const modal = new bootstrap.Modal(document.getElementById('submitDocModal'));
    modal.show();
}

async function submitDocFiles() {
    const btn = document.getElementById('submitDocBtn');
    const reqId = btn.dataset.reqId;
    const inputs = document.querySelectorAll('.doc-upload-input');
    const fd = new FormData();
    let hasFile = false;
    inputs.forEach(inp => {
        if (inp.files && inp.files[0]) {
            fd.append(inp.dataset.type, inp.files[0]);
            hasFile = true;
        }
    });
    if (!hasFile) {
        alert('제출할 파일을 하나 이상 선택하세요.\n파일 없이 수락하려면 "파일 없이 수락" 버튼을 사용하세요.');
        return;
    }
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>제출 중...';
    try {
        const res = await fetch(`/products/doc-requests/${reqId}/submit/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': CSRF_TOKEN },
            body: fd
        });
        const data = await res.json();
        if (res.ok && data.success) {
            bootstrap.Modal.getInstance(document.getElementById('submitDocModal')).hide();
            await loadReceivedDocRequests();
            if (typeof hot !== 'undefined') hot.render();
        } else {
            alert(data.error || '제출에 실패했습니다.');
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-upload me-1"></i>제출 및 수락';
        }
    } catch(e) {
        alert('서버 오류: ' + e.message);
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-upload me-1"></i>제출 및 수락';
    }
}
function getColWidths() {
    const wrap = document.getElementById('contactsGrid');
    const total = wrap ? wrap.clientWidth : 800;
    const CHK  = 28; // 체크박스 콜럼
    const rest = total - CHK;
    // 이메일(25%) / 이름•회사명•인허가번호•공유•자료요청 각 15%
    const ratios = [0.25, 0.15, 0.15, 0.15, 0.15, 0.15];
    const widths = ratios.map(r => Math.floor(rest * r));
    const sum = widths.reduce((a, b) => a + b, 0);
    widths[widths.length - 1] += rest - sum;
    return [CHK, ...widths];
}

document.addEventListener('DOMContentLoaded', function () {
    const container = document.getElementById('contactsGrid');

    // 빈 행을 추가해 최소 20행 확보
    const emptyRow = () => ({ _checked: false, email: '', name: '', company: '', license_no: '', sent: 0, received: 0, doc_sent: 0, doc_pending: 0, doc_received: 0 });
    const tableData = [...initRows];
    while (tableData.length < 20) tableData.push(emptyRow());
    allRows = initRows; // 원본 보관 (필터용)

    hot = new Handsontable(container, {
        data: tableData,
        licenseKey: 'non-commercial-and-evaluation',
        rowHeaders: false,
        colHeaders: [
            '<input type="checkbox" id="checkAll" title="전체 선택" style="cursor:pointer;">',
            '이메일', '이름', '회사명', '인허가번호', '공유', '자료요청'
        ],
        columns: [
            {
                data: '_checked',
                renderer: function(hotInst, TD, row, col, prop, value) {
                    TD.innerHTML = '';
                    TD.style.cssText = 'text-align:center;vertical-align:middle;padding:2px;cursor:pointer;';
                    const chk = document.createElement('input');
                    chk.type = 'checkbox';
                    chk.checked = value === true;
                    chk.className = 'form-check-input';
                    chk.style.cssText = 'width:15px;height:15px;cursor:pointer;pointer-events:none;margin:0;';
                    TD.appendChild(chk);
                    return TD;
                },
                editor: false,
                className: 'htCenter htMiddle',
                width: 36
            },
            { data: 'email',      type: 'text', className: 'htMiddle' },
            { data: 'name',       type: 'text', className: 'htMiddle' },
            { data: 'company',    type: 'text', className: 'htMiddle' },
            { data: 'license_no', type: 'text', className: 'htMiddle' },
            {
                data: 'sent',
                type: 'text',
                readOnly: true,
                renderer: function (hotInst, TD, row, col, prop, value) {
                    const rowData = hotInst.getSourceDataAtRow(row);
                    const s = rowData?.sent     || 0;
                    const r = rowData?.received || 0;
                    TD.innerHTML = [
                        s > 0 ? `<span class="badge-sent">↑${s}</span>` : '',
                        r > 0 ? `<span class="badge-recv">↓${r}</span>` : '',
                        (s === 0 && r === 0) ? '<span style="color:#bdc1c6;">-</span>' : ''
                    ].join(' ');
                    TD.style.textAlign = 'center';
                    TD.style.verticalAlign = 'middle';
                    TD.style.padding = '4px 6px';
                    return TD;
                }
            },
            {
                data: 'doc_pending',
                type: 'text',
                readOnly: true,
                renderer: function (hotInst, TD, row, col, prop, value) {
                    const rowData = hotInst.getSourceDataAtRow(row);
                    const sent    = rowData?.doc_sent    || 0;
                    const pending = rowData?.doc_pending || 0;
                    if (sent === 0) {
                        TD.innerHTML = '<span style="color:#bdc1c6;">-</span>';
                    } else if (pending > 0) {
                        TD.innerHTML = `<span style="background:#fce8b2;color:#e37400;border-radius:10px;padding:1px 8px;font-size:11px;font-weight:500;white-space:nowrap;">⏳ 대기 ${pending}</span>`;
                    } else {
                        TD.innerHTML = '<span style="background:#e6f4ea;color:#137333;border-radius:10px;padding:1px 8px;font-size:11px;font-weight:500;">✓ 완료</span>';
                    }
                    TD.style.textAlign = 'center';
                    TD.style.verticalAlign = 'middle';
                    TD.style.padding = '4px 6px';
                    return TD;
                }
            }
        ],
        colWidths: getColWidths(),
        stretchH: 'last',
        height: '100%',
        manualColumnResize: true,
        manualRowMove: true,
        contextMenu: {
            items: {
                row_above:  { name: '위에 행 추가' },
                row_below:  { name: '아래에 행 추가' },
                sep1: '---------',
                remove_row: { name: '행 삭제' },
                sep2: '---------',
                undo: { name: '실행 취소 (Ctrl+Z)' },
                redo: { name: '다시 실행 (Ctrl+Y)' },
                sep3: '---------',
                copy: { name: '복사 (Ctrl+C)' },
                cut:  { name: '잘라내기 (Ctrl+X)' },
            }
        },
        copyPaste: true,
        undo: true,
        search: true,
        enterBeginsEditing: true,
        outsideClickDeselects: false,
        afterOnCellMouseDown: function(event, coords) {
            if (coords.col !== 0) return;

            if (coords.row === -1) {
                // ─ 헤더 체크박스 클릭: 전체 토글 ─
                const allChk = document.getElementById('checkAll');
                const newVal = allChk ? !allChk.checked : true;
                const src = this.getSourceData();
                const changes = [];
                src.forEach((row, i) => {
                    if (row.email) changes.push([i, '_checked', newVal]);
                });
                if (changes.length) this.setDataAtRowProp(changes);
            } else {
                // ─ 데이터 행 체크박스 클릭: 단일 토글 ─
                const rowData = this.getSourceDataAtRow(coords.row);
                if (rowData && rowData.email !== undefined) {
                    this.setDataAtRowProp(coords.row, '_checked', !rowData._checked);
                }
            }
        },
        afterCreateRow: function(index, amount) {
            // 붙여넣기나 행 추가 후 새 행을 allRows에 동기화
            const src = this.getSourceData();
            for (let i = index; i < index + amount; i++) {
                if (src[i] && !allRows.includes(src[i])) {
                    allRows.push(src[i]);
                }
            }
        },
        afterSelectionEnd: function (row, col) {
            // 체크박스 컬럼(0) 클릭 시는 연락처 선택 함수 호출 안 함
            if (col === 0) return;
            const rowData = this.getSourceDataAtRow(row);
            if (rowData && rowData.email) {
                onContactSelect(rowData);
            }
        },
        afterRender: function () {
            // 헤더 체크박스 표시 상태 동기화 (시각적 동기화 전용)
            const allChk = document.getElementById('checkAll');
            if (allChk) {
                const src = this.getSourceData().filter(r => r.email);
                if (src.length === 0) {
                    allChk.checked = false;
                    allChk.indeterminate = false;
                } else {
                    const n = src.filter(r => r._checked).length;
                    allChk.checked = (n === src.length);
                    allChk.indeterminate = (n > 0 && n < src.length);
                }
            }
        },
        afterChange: function (changes, source) {
            if (!changes || source === 'loadData') return;
            const hasCheckChange = changes.some(([, prop]) => prop === '_checked');
            if (hasCheckChange) {
                // 헤더 + 선택 UI 업데이트
                const allChk = document.getElementById('checkAll');
                if (allChk) {
                    const src = this.getSourceData().filter(r => r.email);
                    const n = src.filter(r => r._checked).length;
                    allChk.checked = src.length > 0 && n === src.length;
                    allChk.indeterminate = n > 0 && n < src.length;
                }
                if (hot) updateSelectionUI();
            }
            // 행 수 업데이트
            const filled = this.countRows() - this.countEmptyRows(true);
            document.getElementById('contactCount').textContent = filled;
        },
        cells: function (row, col) {
            if (col === 5 || col === 6) return { readOnly: true }; // 공유, 자료요청 콜럼
        }
    });

    // 반응형 컬럼 너비
    if (window.ResizeObserver) {
        let timer;
        new ResizeObserver(() => {
            clearTimeout(timer);
            timer = setTimeout(() => {
                if (hot) { hot.updateSettings({ colWidths: getColWidths() }); hot.render(); }
            }, 60);
        }).observe(container);
    }

    // ── 선택 UI 업데이트 ──
    function updateSelectionUI() {
        const checkedRows = allRows.filter(r => r._checked && r.email);
        const n = checkedRows.length;
        const actionBar = document.getElementById('selection-actions');
        const countEl   = document.getElementById('selected-count');
        if (n > 0) {
            actionBar.classList.remove('d-none');
            actionBar.classList.add('d-flex');
            countEl.textContent = n;
        } else {
            actionBar.classList.add('d-none');
            actionBar.classList.remove('d-flex');
        }
    }

    // 전체 체크박스는 afterRender에서 직접 DOM에 바인딩 처리됨

    // 행 추가
    document.getElementById('addRowBtn').addEventListener('click', () => {
        const input = prompt('추가할 행 수를 입력하세요', '1');
        if (input === null) return;  // 취소
        const count = Math.min(Math.max(parseInt(input) || 1, 1), 500);
        hot.alter('insert_row_below', hot.countRows() - 1, count);
        hot.selectCell(hot.countRows() - count, 1);
    });

    // 일괄 삭제
    document.getElementById('bulkDeleteBtn').addEventListener('click', () => {
        const checkedRows = allRows.filter(r => r._checked && r.email);
        if (!checkedRows.length) return;
        if (!confirm(`선택한 ${checkedRows.length}개 연락처를 목록에서 제거하시겠습니까?\n(DB에서 삭제되지 않으며 공유 이력은 유지됩니다)`)) return;
        // allRows에서 제거
        checkedRows.forEach(row => {
            const idx = allRows.indexOf(row);
            if (idx !== -1) allRows.splice(idx, 1);
        });
        // 필터 다시 적용해서 그리드 갱신
        const activeBtn = document.querySelector('.contacts-filter-btn.active');
        if (activeBtn) activeBtn.click(); else setTableFilter('all', document.querySelector('[data-filter="all"]'));
        updateSelectionUI();
    });

    // 문서 요청 버튼
    document.getElementById('bulkRequestBtn').addEventListener('click', () => {
        const checked = hot.getSourceData().filter(r => r._checked && r.email);
        if (!checked.length) { alert('요청를 보낼 연락처를 체크하세요.'); return; }
        openDocRequestPanel(checked);
    });

    // 검색
    const searchPlugin = hot.getPlugin('search');
    document.getElementById('contactSearch').addEventListener('input', function () {
        const results = searchPlugin.query(this.value);
        document.getElementById('rowInfo').textContent = this.value ? `${results.length}개 일치` : '';
        hot.render();
    });

    // 페이지 로드 시 받은 요청 배지 카운트
    fetch(CONTACTS_API_RECEIVED).then(r => r.json()).then(data => {
        const pending = (data.requests || []).filter(r => r.status === 'PENDING').length;
        const badgeEl = document.getElementById('recvReqBadge');
        if (pending > 0) { badgeEl.textContent = pending; badgeEl.classList.remove('d-none'); }
    }).catch(() => {});
});

// ─────────────── 연락처 선택 → 오른쪽 패널 ───────────────
function onContactSelect(rowData) {
    const email   = (rowData.email   || '').trim();
    const name    = (rowData.name    || '').trim() || email;
    const company = (rowData.company || '').trim();
    if (!email) return;

    selectedEmail = email;

    document.getElementById('emptyState').classList.add('d-none');
    document.getElementById('shareView').classList.remove('d-none');
    document.getElementById('receivedReqView').classList.add('d-none');
    document.getElementById('recvReqFilterBtn').classList.remove('active');
    document.getElementById('shareAvatar').textContent     = (name || email).slice(0, 1).toUpperCase();
    document.getElementById('shareContactName').textContent  = name;
    document.getElementById('shareContactEmail').textContent = email;
    document.getElementById('shareContactCompany').textContent = company;
    document.getElementById('statusText').textContent = `${name} 선택됨 · Ctrl+C/V로 복사·붙여넣기 가능`;

    loadShares(email);
    loadDocRequests(email);
}

// ─────────────── 문서 요청 패널 ───────────────
let cachedDocTypes = null;

function openDocRequestPanel(contacts) {
    document.getElementById('emptyState').classList.add('d-none');
    document.getElementById('shareView').classList.add('d-none');
    const panel = document.getElementById('docRequestView');
    panel.classList.remove('d-none');
    panel.style.display = 'flex';

    // 수신자 요약
    document.getElementById('docReqRecipientSummary').textContent = `선택된 연락처 ${contacts.length}명`;

    // 수신자 칩
    const chips = document.getElementById('docReqChips');
    chips.innerHTML = contacts.map(c =>
        `<span style="background:#e8f0fe;color:#1a73e8;border-radius:12px;padding:2px 10px;font-size:12px;display:inline-flex;align-items:center;gap:4px;">
            <i class="bi bi-person-fill"></i>${c.name || c.email}
         </span>`
    ).join('');

    // 전송 필드 초기화
    document.getElementById('docReqMessage').value = '';
    document.getElementById('docReqFile').value = '';
    document.getElementById('docReqFileName').textContent = '양식, 참고 파일 등 첨부 (클릭)';
    document.querySelectorAll('.doc-type-chk').forEach(c => c.checked = false);

    // 문서 유형 로드
    loadDocTypes();

    // 전송 시 참조할 contacts 저장
    panel._recipients = contacts;
}

function closeDocRequestPanel() {
    document.getElementById('docRequestView').classList.add('d-none');
    document.getElementById('emptyState').classList.remove('d-none');
}

async function loadDocTypes() {
    if (cachedDocTypes) { renderDocTypes(cachedDocTypes); return; }
    const res  = await fetch(DOC_TYPES_API);
    const data = await res.json();
    cachedDocTypes = data.doc_types;
    renderDocTypes(cachedDocTypes);
}

function renderDocTypes(types) {
    const el = document.getElementById('docTypeList');
    if (!types.length) {
        el.innerHTML = '<p class="text-muted" style="font-size:13px;">등록된 문서 유형이 없습니다.</p>';
        return;
    }
    el.innerHTML = types.map(t => `
        <label class="d-flex align-items-center gap-2 p-2 rounded mb-1" style="cursor:pointer;border:1px solid #e8eaed;font-size:13px;"
               onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background=''">
            <input type="checkbox" class="doc-type-chk" value="${t.type_id}" style="width:15px;height:15px;">
            <i class="bi ${t.icon || 'bi-file-earmark'}" style="color:${t.color || '#6c757d'};font-size:15px;"></i>
            <span>${t.type_name}</span>
            ${t.is_required ? '<span class="badge bg-danger ms-auto" style="font-size:10px;">필수</span>' : ''}
        </label>`
    ).join('');
}

async function sendDocRequest() {
    const panel = document.getElementById('docRequestView');
    const recipients = panel._recipients || [];
    const typeIds = [...document.querySelectorAll('.doc-type-chk:checked')].map(el => parseInt(el.value));
    const message  = document.getElementById('docReqMessage').value.trim();
    const fileInput = document.getElementById('docReqFile');

    if (!recipients.length) { alert('수신자가 없습니다.'); return; }
    if (!typeIds.length) { alert('요청할 문서 종류를 하나 이상 선택하세요.'); return; }

    const btn = document.getElementById('sendDocReqBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>전송 중...';

    const fd = new FormData();
    fd.append('recipients', JSON.stringify(recipients));
    fd.append('type_ids', JSON.stringify(typeIds));
    fd.append('message', message);
    if (fileInput.files[0]) fd.append('attachment', fileInput.files[0]);

    try {
        const res  = await fetch(SEND_DOC_REQ_API, {
            method: 'POST',
            headers: {'X-CSRFToken': CSRF_TOKEN},  // Content-Type은 브라우저가 multipart로 자동 설정
            body: fd,
        });
        let data;
        try { data = await res.json(); } catch(_) { data = {}; }
        if (res.ok && data.success) {
            alert(`${data.created}명에게 자료 요청을 보냈습니다.\n연락처 목록의 '자료요청' 열에서 현황을 확인할 수 있습니다.`);
            // 로컬 행 데이터 카운트 증가
            recipients.forEach(r => {
                const em = (r.email || '').toLowerCase();
                const match = allRows.find(row => (row.email || '').toLowerCase() === em);
                if (match) {
                    match.doc_sent    = (match.doc_sent    || 0) + 1;
                    match.doc_pending = (match.doc_pending || 0) + 1;
                }
            });
            hot.getSourceData().forEach(row => { row._checked = false; });
            hot.render();
            closeDocRequestPanel();
        } else {
            alert(data.error || `오류가 발생했습니다. (HTTP ${res.status})`);
        }
    } catch(e) {
        alert('서버에 연결할 수 없습니다. \n' + e.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-send me-2"></i>요청 보내기';
    }
}

function updateFileName(input) {
    const name = input.files[0] ? input.files[0].name : '양식, 참고 파일 등 첨부 (클릭)';
    document.getElementById('docReqFileName').textContent = name;
}

// ─────────────── 공유 현황 로드 ───────────────
async function loadShares(email) {
    ['sentLoading','receivedLoading'].forEach(id => document.getElementById(id).classList.remove('d-none'));
    ['sentTable','receivedTable','sentEmpty','receivedEmpty'].forEach(id => document.getElementById(id).classList.add('d-none'));

    const res  = await fetch(`${CONTACTS_API_SHARES}?email=${encodeURIComponent(email)}`);
    const data = await res.json();
    renderShareTable('sent',     data.sent,     'sentTbody',     'sentLoading',     'sentEmpty',     'sentTable',     'sentBadge');
    renderShareTable('received', data.received, 'receivedTbody', 'receivedLoading', 'receivedEmpty', 'receivedTable', 'receivedBadge');
}

// ─────────────── 자료 요청 이력 로드 ───────────────
async function loadDocRequests(email) {
    const listEl    = document.getElementById('docReqList');
    const loadingEl = document.getElementById('docReqLoading');
    const emptyEl   = document.getElementById('docReqEmpty');
    const badgeEl   = document.getElementById('docReqBadge');
    const shortcut  = document.getElementById('docReqSendShortcut');
    if (!listEl) return;

    loadingEl.classList.remove('d-none');
    listEl.innerHTML = '';
    emptyEl.classList.add('d-none');
    if (shortcut) shortcut.classList.add('d-none');

    try {
        const res  = await fetch(`${CONTACTS_API_DOC_REQUESTS}?email=${encodeURIComponent(email)}`);
        const data = await res.json();
        loadingEl.classList.add('d-none');

        const reqs = data.requests || [];
        badgeEl.textContent = reqs.length;

        if (!reqs.length) {
            emptyEl.classList.remove('d-none');
            if (shortcut) shortcut.classList.remove('d-none');
            return;
        }

        const STATUS_STYLE = {
            PENDING:   { icon: 'bi-clock', color: '#e37400', bg: '#fce8b2', label: '대기 중' },
            ACCEPTED:  { icon: 'bi-check-circle', color: '#137333', bg: '#e6f4ea', label: '완료' },
            REJECTED:  { icon: 'bi-x-circle', color: '#c5221f', bg: '#fce8b2', label: '거절' },
            CANCELLED: { icon: 'bi-slash-circle', color: '#80868b', bg: '#f1f3f4', label: '취소됨' },
        };

        listEl.innerHTML = reqs.map(r => {
            const st = STATUS_STYLE[r.status] || STATUS_STYLE.PENDING;
            const docs = (r.requested_documents || []).map(d =>
                `<span style="background:#f1f3f4;border-radius:8px;padding:1px 8px;font-size:11px;margin-right:3px;">${d.type_name}</span>`
            ).join('');
            const cancelBtn = r.status === 'PENDING'
                ? `<button class="btn btn-sm btn-outline-danger py-0 px-2 ms-auto" style="font-size:11px;"
                          onclick="cancelDocReq(${r.request_id}, this, '${email}')">취소</button>`
                : '';

            // 제출된 파일 목록 (ACCEPTED 상태이거나 파일이 있을 때)
            const subs = r.submissions || [];
            const submissionsHtml = subs.length
                ? `<div class="mt-2 pt-2" style="border-top:1px dashed #e8eaed;">
                    <div style="font-size:11px;color:#5f6368;font-weight:600;margin-bottom:4px;">
                        <i class="bi bi-paperclip me-1"></i>수신된 파일 (${subs.length}건)
                    </div>
                    ${subs.map(s => {
                        const kb = s.file_size > 0 ? (s.file_size >= 1048576
                            ? (s.file_size/1048576).toFixed(1)+' MB'
                            : Math.ceil(s.file_size/1024)+' KB') : '';
                        return `<div class="d-flex align-items-center gap-2 mb-1 p-2 rounded"
                                     style="background:#f0f7f0;font-size:12px;">
                            <i class="bi bi-file-earmark-check text-success" style="flex-shrink:0;font-size:14px;"></i>
                            <div class="flex-grow-1 overflow-hidden">
                                <div style="color:#137333;font-weight:600;font-size:11px;">${s.document_type}</div>
                                <div class="text-truncate text-muted" style="font-size:11px;" title="${s.filename}">${s.filename}</div>
                            </div>
                            ${kb ? `<span class="text-muted" style="font-size:10px;flex-shrink:0;">${kb}</span>` : ''}
                            <a href="${s.file_url}" download="${s.filename}"
                               class="btn btn-sm btn-outline-success py-0 px-2"
                               style="font-size:11px;flex-shrink:0;" title="파일 다운로드">
                                <i class="bi bi-download"></i>
                            </a>
                        </div>`;
                    }).join('')}
                   </div>`
                : '';

            return `<div class="border rounded p-3 mb-2" style="font-size:13px;">
                <div class="d-flex align-items-center gap-2 mb-1">
                    <span style="background:${st.bg};color:${st.color};border-radius:10px;padding:1px 8px;font-size:11px;font-weight:500;">
                        <i class="bi ${st.icon} me-1"></i>${st.label}
                    </span>
                    <span class="text-muted" style="font-size:11px;">${r.created}</span>
                    ${cancelBtn}
                </div>
                <div class="mb-1">${docs || '<span style="color:#bdc1c6;font-size:12px;">문서 종류 미지정</span>'}</div>
                ${r.message ? `<div class="text-muted" style="font-size:12px;">"${r.message}"</div>` : ''}
                ${r.due_date ? `<div style="font-size:11px;color:#5f6368;">마감: ${r.due_date}</div>` : ''}
                ${submissionsHtml}
            </div>`;
        }).join('');

        if (shortcut) shortcut.classList.remove('d-none');
    } catch(e) {
        loadingEl.classList.add('d-none');
        listEl.innerHTML = '<p class="text-danger" style="font-size:13px;">불러오기 실패</p>';
    }
}

async function cancelDocReq(reqId, btn, email) {
    if (!confirm('이 자료 요청을 취소하시겠습니까?')) return;
    btn.disabled = true;
    const res = await fetch(`/products/doc-requests/${reqId}/cancel/`, {
        method: 'POST', headers: { 'X-CSRFToken': CSRF_TOKEN }
    });
    if (res.ok) {
        // 테이블 카운트 감소
        const match = allRows.find(row => (row.email || '').toLowerCase() === email.toLowerCase());
        if (match && match.doc_pending > 0) match.doc_pending--;
        hot.render();
        loadDocRequests(email);
    } else {
        btn.disabled = false;
        alert('취소에 실패했습니다.');
    }
}

function openDocRequestFromContact() {
    if (!selectedEmail) return;
    const contact = allRows.find(r => (r.email || '').toLowerCase() === selectedEmail.toLowerCase());
    if (contact) openDocRequestPanel([contact]);
}

function renderShareTable(type, rows, tbodyId, loadingId, emptyId, tableId, badgeId) {
    document.getElementById(loadingId).classList.add('d-none');
    document.getElementById(badgeId).textContent = rows.length;
    if (!rows.length) { document.getElementById(emptyId).classList.remove('d-none'); return; }
    const tbody = document.getElementById(tbodyId);
    tbody.innerHTML = rows.map(r => {
        const roleBadge  = ROLE_BADGE[r.role] || ROLE_BADGE[''];
        const actionCell = type === 'sent'
            ? `<button class="contacts-icon-btn text-danger" onclick="revokeShare(${r.share_id})" title="공유 취소"><i class="bi bi-x-circle"></i></button>`
            : `<a href="${PRODUCT_DETAIL_URL}${r.label_id}/new/" class="contacts-icon-btn" title="제품 열기"><i class="bi bi-box-arrow-up-right"></i></a>`;
        return `<tr>
            <td><a href="${PRODUCT_DETAIL_URL}${r.label_id}/new/" class="text-decoration-none text-dark fw-medium">${r.label_name}</a></td>
            <td>${roleBadge}</td>
            <td style="font-size:12px;color:#5f6368;">${r.created_at || '-'}</td>
            <td style="font-size:12px;color:${r.share_end_date ? '#c5221f' : '#5f6368'};">${r.share_end_date || '무기한'}</td>
            <td style="text-align:center;">${actionCell}</td>
        </tr>`;
    }).join('');
    document.getElementById(tableId).classList.remove('d-none');
}

async function revokeShare(shareId) {
    if (!confirm('이 공유를 취소하시겠습니까?')) return;
    const res = await fetch(`/products/share/${shareId}/revoke/`, {
        method: 'POST',
        headers: {'X-CSRFToken': CSRF_TOKEN, 'Content-Type': 'application/json'},
        body: JSON.stringify({}),
    });
    if (res.ok) loadShares(selectedEmail);
    else alert('공유 취소에 실패했습니다.');
}

function openQuickShare() {
    alert('빠른 공유 기능은 준비 중입니다.\n제품 상세의 권한 설정 탭에서 공유하실 수 있습니다.');
}

// ─────────────── 리사이즈 핸들 ───────────────
(function () {
    const resizer = document.getElementById('resizer');
    const left    = document.getElementById('contactsLeft');
    let isDown = false, startX = 0, startW = 0;
    resizer.addEventListener('mousedown', (e) => {
        isDown = true; startX = e.clientX; startW = left.offsetWidth;
        document.body.style.cursor = 'col-resize';
        document.body.style.userSelect = 'none';
    });
    document.addEventListener('mousemove', (e) => {
        if (!isDown) return;
        const diff = e.clientX - startX;
        const newW = Math.max(320, Math.min(startW + diff, window.innerWidth - 300));
        left.style.width = newW + 'px';
        left.style.flex  = 'none';
        if (hot) { hot.updateSettings({ colWidths: getColWidths() }); hot.render(); }
    });
    document.addEventListener('mouseup', () => { isDown = false; document.body.style.cursor = ''; document.body.style.userSelect = ''; });
})();
</script>

{% endblock %}
