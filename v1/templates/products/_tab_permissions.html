<div class="permission-workspace">
    <!-- 3-column 레이아웃 -->
    <div class="permission-layout">
        <!-- 왼쪽: People Palette (인물 목록) -->
        <div class="people-palette" ondrop="dropPersonToPalette(event)" ondragover="allowDrop(event)" ondragleave="leaveDrop(event)">
            <button class="panel-toggle-btn" onclick="toggleLeftPanel()" title="패널 접기/펼치기">
                <i class="bi bi-chevron-left"></i>
            </button>
            <div class="palette-header">
                <div class="fw-bold mb-3" style="font-size: 13px; color: #202124;">
                    <i class="bi bi-people me-1"></i>팀 멤버
                </div>
                <button class="btn btn-sm btn-primary w-100 mb-3" type="button" onclick="openQuickInvite()" style="font-size: 13px;{% if user_role != 'OWNER' and user_role != 'EDITOR' %} display:none;{% endif %}">
                    <i class="bi bi-person-plus me-1"></i>새 사람 초대
                </button>
                <div class="mb-3">
                    <input type="text" class="form-control form-control-sm" id="palette-search" placeholder="이름 또는 이메일 검색..." onkeyup="filterPalette()" style="font-size: 12px;">
                </div>
                <div class="alert alert-warning mb-2" style="font-size: 11px; padding: 8px;">
                    <i class="bi bi-arrow-down-circle me-1"></i>
                    여기로 드래그하면 공유 취소 (권한 완전 제거)
                </div>
            </div>

            <!-- 탭: 전체 / 최근 -->
            <ul class="nav nav-pills mb-2" role="tablist" style="gap: 4px;">
                <li class="nav-item" role="presentation" style="flex: 1;">
                    <button class="nav-link active w-100" id="palette-all-tab" data-bs-toggle="tab" data-bs-target="#palette-all" type="button" style="font-size: 12px; padding: 6px 8px;">
                        전체
                    </button>
                </li>
                <li class="nav-item" role="presentation" style="flex: 1;">
                    <button class="nav-link w-100" id="palette-recent-tab" data-bs-toggle="tab" data-bs-target="#palette-recent" type="button" style="font-size: 12px; padding: 6px 8px;">
                        최근
                    </button>
                </li>
            </ul>

            <div class="tab-content" ondragover="allowDrop(event)" ondragleave="leaveDrop(event)">
                <!-- 전체 탭 -->
                <div class="tab-pane fade show active" id="palette-all">
                    <div class="palette-list" ondragover="allowDrop(event)" ondragleave="leaveDrop(event)">
                        <!-- Owner 카드 (항상 실제 소유자 표시) -->
                        <div class="person-card" onclick="selectPerson(this)" data-email="{{ label_owner.email }}" data-username="{{ label_owner.username }}" data-role="OWNER" data-is-owner="true">
                            <div class="avatar bg-secondary text-white">
                                {{ label_owner.username|slice:":1"|upper }}
                            </div>
                            <div class="person-info">
                                <div class="person-name">{{ label_owner.username }}</div>
                                <div class="person-email">{{ label_owner.email }}</div>
                            </div>
                            <span class="badge bg-secondary" style="font-size: 9px;">Owner</span>
                        </div>

                        <!-- 공유 멤버 카드 (모든 제품의 공유자) -->
                        {% for share in all_shared_users %}
                        <div class="person-card" 
                            draggable="true" ondragstart="dragStart(event)" ondragend="dragEnd(event)"
                            onclick="selectPerson(this)" 
                            data-email="{{ share.recipient_email }}" 
                            data-username="{{ share.display_name }}" 
                            {% if share.share_id %}data-share-id="{{ share.share_id }}"{% endif %}
                            {% if share.permission_record %}data-role="{{ share.permission_record.role_code }}"{% else %}data-role=""{% endif %}
                            data-name="{{ share.recipient_name|default:'' }}" 
                            data-company="{{ share.recipient_company|default:'' }}">
                            <div class="avatar bg-primary text-white">
                                {{ share.display_name|slice:":1"|upper }}
                            </div>
                            <div class="person-info">
                                <div class="person-name">{{ share.display_name }}</div>
                                <div class="person-email">{{ share.recipient_email }}</div>
                                {% if share.recipient_company %}
                                <div class="person-company" style="font-size: 9px; color: #6c757d;">{{ share.recipient_company }}</div>
                                {% endif %}
                            </div>
                            {% if share.permission_record %}
                                {% if share.permission_record.role_code == 'UPLOADER' %}
                                <span class="badge bg-primary" style="font-size: 9px;">자료제출</span>
                                {% elif share.permission_record.role_code == 'EDITOR' %}
                                <span class="badge bg-success" style="font-size: 9px;">편집</span>
                                {% elif share.permission_record.role_code == 'REVIEWER' %}
                                <span class="badge bg-warning text-dark" style="font-size: 9px;">검토</span>
                                {% elif share.permission_record.role_code == 'APPROVER' %}
                                <span class="badge bg-danger" style="font-size: 9px;">승인</span>
                                {% elif share.permission_record.role_code == 'VIEWER' %}
                                <span class="badge bg-info" style="font-size: 9px;">뷰어</span>
                                {% endif %}
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- 최근 탭 -->
                <div class="tab-pane fade" id="palette-recent">
                    <div class="palette-list" ondragover="allowDrop(event)" ondragleave="leaveDrop(event)">
                        {% for share in shares|slice:":5" %}
                        <div class="person-card" draggable="true" ondragstart="dragStart(event)" ondragend="dragEnd(event)" onclick="selectPerson(this)" data-email="{{ share.recipient_email }}" data-username="{{ share.display_name }}" data-share-id="{{ share.share_id }}" data-role="{{ share.permission_record.role_code }}" data-name="{{ share.recipient_name|default:'' }}" data-company="{{ share.recipient_company|default:'' }}">
                            <div class="avatar bg-primary text-white">
                                {{ share.display_name|slice:":1"|upper }}
                            </div>
                            <div class="person-info">
                                <div class="person-name">{{ share.display_name }}</div>
                                <div class="person-email">{{ share.recipient_email }}</div>
                                {% if share.recipient_company %}
                                <div class="person-company" style="font-size: 9px; color: #6c757d;">{{ share.recipient_company }}</div>
                                {% endif %}
                            </div>
                            {% if share.permission_record %}
                                {% if share.permission_record.role_code == 'UPLOADER' %}
                                <span class="badge bg-primary" style="font-size: 9px;">자료제출</span>
                                {% elif share.permission_record.role_code == 'EDITOR' %}
                                <span class="badge bg-success" style="font-size: 9px;">편집</span>
                                {% elif share.permission_record.role_code == 'REVIEWER' %}
                                <span class="badge bg-warning text-dark" style="font-size: 9px;">검토</span>
                                {% elif share.permission_record.role_code == 'APPROVER' %}
                                <span class="badge bg-danger" style="font-size: 9px;">승인</span>
                                {% elif share.permission_record.role_code == 'VIEWER' %}
                                <span class="badge bg-info" style="font-size: 9px;">뷰어</span>
                                {% endif %}
                            {% endif %}
                        </div>
                        {% empty %}
                        <div class="text-center text-muted py-3" style="font-size: 12px;">
                            아직 공유된 멤버가 없습니다
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- 중앙: Workflow Dropzones (상태 단계별) -->
        <div class="workflow-dropzones">

            <!-- ① 작성 중 (기초 작성) — 오너 + 공동 작성자 -->
            <div class="dropzone-card accent-top-draft {% if product_status == 'DRAFT' %}stage-active{% endif %}" data-role="OWNER">
                <div class="dropzone-header">
                    <span class="badge bg-secondary text-white">STAGE 1</span>
                    <div class="fw-bold">작성 중 <small class="text-muted">(기초 작성)</small></div>
                    <div class="text-muted small">오너 · 공동 작성자</div>
                    {% if product_status == 'DRAFT' %}<span class="badge bg-primary-subtle text-primary ms-auto" style="font-size:10px;">현재 단계</span>{% endif %}
                </div>
                <div class="dropzone-body" id="dropzone-owner" style="gap:4px;">
                    <!-- Owner (고정) -->
                    <div class="person-card owner-card mb-1">
                        <div class="avatar bg-secondary text-white">{{ label_owner.username|slice:":1" }}</div>
                        <div class="person-info">
                            <div class="person-name">{{ label_owner.username }}</div>
                            <div class="person-email">{{ label_owner.email }}</div>
                        </div>
                        <span class="badge bg-secondary" style="font-size:9px;">Owner</span>
                    </div>
                    <!-- EDITOR 드롭존 (공동 작성자) -->
                    <div id="dropzone-editor" ondrop="dropPerson(event, 'EDITOR')" ondragover="allowDrop(event)" ondragleave="leaveDrop(event)" style="width:100%; min-height:48px;">
                        {% for share in shares %}{% if share.permission_record and share.permission_record.role_code == 'EDITOR' %}
                        <div class="person-card" draggable="true" ondragstart="dragStart(event)" ondragend="dragEnd(event)" onclick="selectPerson(this)"
                            data-email="{{ share.recipient_email }}" data-username="{{ share.display_name }}"
                            data-share-id="{{ share.share_id }}" data-role="EDITOR"
                            data-name="{{ share.recipient_name|default:'' }}" data-company="{{ share.recipient_company|default:'' }}">
                            <div class="avatar bg-success text-white">{{ share.display_name|slice:":1"|upper }}</div>
                            <div class="person-info">
                                <div class="person-name">{{ share.display_name }}</div>
                                <div class="person-email">{{ share.recipient_email }}</div>
                            </div>
                            <span class="badge bg-success" style="font-size:9px;">편집</span>
                        </div>
                        {% endif %}{% endfor %}
                        <div class="dropzone-placeholder{% for share in shares %}{% if share.permission_record and share.permission_record.role_code == 'EDITOR' %} d-none{% endif %}{% endfor %}">
                            <i class="bi bi-person-plus"></i>
                            <span>공동 작성자 추가</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ② 자료 요청 (자료 제출) — 협력업체 -->
            <div class="dropzone-card accent-top-uploader {% if product_status == 'REQUESTING' %}stage-active{% endif %}" data-role="UPLOADER">
                <div class="dropzone-header">
                    <span class="badge bg-primary text-white">STAGE 2</span>
                    <div class="fw-bold">자료 요청 <small class="text-muted">(자료 제출)</small></div>
                    <div class="text-muted small">협력업체</div>
                    {% if product_status == 'REQUESTING' %}<span class="badge bg-primary-subtle text-primary ms-auto" style="font-size:10px;">현재 단계</span>{% endif %}
                </div>
                <div class="dropzone-body" id="dropzone-uploader" ondrop="dropPerson(event, 'UPLOADER')" ondragover="allowDrop(event)" ondragleave="leaveDrop(event)">
                    {% for share in shares %}{% if share.permission_record and share.permission_record.role_code == 'UPLOADER' %}
                    <div class="person-card" draggable="true" ondragstart="dragStart(event)" ondragend="dragEnd(event)" onclick="selectPerson(this)"
                        data-email="{{ share.recipient_email }}" data-username="{{ share.display_name }}"
                        data-share-id="{{ share.share_id }}" data-role="UPLOADER"
                        data-name="{{ share.recipient_name|default:'' }}" data-company="{{ share.recipient_company|default:'' }}">
                        <div class="avatar bg-primary text-white">{{ share.display_name|slice:":1"|upper }}</div>
                        <div class="person-info">
                            <div class="person-name">{{ share.display_name }}</div>
                            <div class="person-email">{{ share.recipient_email }}</div>
                        </div>
                        <span class="badge bg-primary" style="font-size:9px;">자료제출</span>
                    </div>
                    {% endif %}{% endfor %}
                    <div class="dropzone-placeholder{% for share in shares %}{% if share.permission_record and share.permission_record.role_code == 'UPLOADER' %} d-none{% endif %}{% endfor %}">
                        <i class="bi bi-plus-circle"></i>
                        <span>협력업체 담당자 추가</span>
                    </div>
                </div>
            </div>

            <!-- ③ 제출 완료 / 검토 중 — 검토자 -->
            <div class="dropzone-card accent-top-reviewer {% if product_status == 'SUBMITTED' or product_status == 'REVIEW' %}stage-active{% endif %}" data-role="REVIEWER">
                <div class="dropzone-header">
                    <span class="badge bg-warning text-dark">STAGE 3</span>
                    <div class="fw-bold">검토 중 <small class="text-muted">(검토 요청)</small></div>
                    <div class="text-muted small">검토자</div>
                    {% if product_status == 'SUBMITTED' or product_status == 'REVIEW' %}<span class="badge bg-warning-subtle text-warning-emphasis ms-auto" style="font-size:10px;">현재 단계</span>{% endif %}
                </div>
                <div class="dropzone-body" id="dropzone-reviewer" ondrop="dropPerson(event, 'REVIEWER')" ondragover="allowDrop(event)" ondragleave="leaveDrop(event)">
                    {% for share in shares %}{% if share.permission_record and share.permission_record.role_code == 'REVIEWER' %}
                    <div class="person-card" draggable="true" ondragstart="dragStart(event)" ondragend="dragEnd(event)" onclick="selectPerson(this)"
                        data-email="{{ share.recipient_email }}" data-username="{{ share.display_name }}"
                        data-share-id="{{ share.share_id }}" data-role="REVIEWER"
                        data-name="{{ share.recipient_name|default:'' }}" data-company="{{ share.recipient_company|default:'' }}">
                        <div class="avatar bg-warning text-dark">{{ share.display_name|slice:":1"|upper }}</div>
                        <div class="person-info">
                            <div class="person-name">{{ share.display_name }}</div>
                            <div class="person-email">{{ share.recipient_email }}</div>
                        </div>
                        <span class="badge bg-warning text-dark" style="font-size:9px;">검토</span>
                    </div>
                    {% endif %}{% endfor %}
                    <div class="dropzone-placeholder{% for share in shares %}{% if share.permission_record and share.permission_record.role_code == 'REVIEWER' %} d-none{% endif %}{% endfor %}">
                        <i class="bi bi-search"></i>
                        <span>검토자 추가</span>
                    </div>
                </div>
            </div>

            <!-- ④ 승인 대기 — 책임자 -->
            <div class="dropzone-card accent-top-approver {% if product_status == 'PENDING' %}stage-active{% endif %}" data-role="APPROVER">
                <div class="dropzone-header">
                    <span class="badge bg-danger text-white">STAGE 4</span>
                    <div class="fw-bold">승인 대기 <small class="text-muted">(최종 승인)</small></div>
                    <div class="text-muted small">책임자</div>
                    {% if product_status == 'PENDING' %}<span class="badge bg-danger-subtle text-danger ms-auto" style="font-size:10px;">현재 단계</span>{% endif %}
                </div>
                <div class="dropzone-body" id="dropzone-approver" ondrop="dropPerson(event, 'APPROVER')" ondragover="allowDrop(event)" ondragleave="leaveDrop(event)">
                    {% for share in shares %}{% if share.permission_record and share.permission_record.role_code == 'APPROVER' %}
                    <div class="person-card" draggable="true" ondragstart="dragStart(event)" ondragend="dragEnd(event)" onclick="selectPerson(this)"
                        data-email="{{ share.recipient_email }}" data-username="{{ share.display_name }}"
                        data-share-id="{{ share.share_id }}" data-role="APPROVER"
                        data-name="{{ share.recipient_name|default:'' }}" data-company="{{ share.recipient_company|default:'' }}">
                        <div class="avatar bg-danger text-white">{{ share.display_name|slice:":1"|upper }}</div>
                        <div class="person-info">
                            <div class="person-name">{{ share.display_name }}</div>
                            <div class="person-email">{{ share.recipient_email }}</div>
                        </div>
                        <span class="badge bg-danger" style="font-size:9px;">승인</span>
                    </div>
                    {% endif %}{% endfor %}
                    <div class="dropzone-placeholder{% for share in shares %}{% if share.permission_record and share.permission_record.role_code == 'APPROVER' %} d-none{% endif %}{% endfor %}">
                        <i class="bi bi-patch-check"></i>
                        <span>책임자 추가</span>
                    </div>
                </div>
            </div>

            <!-- 뷰어 (읽기 전용 — 단계 무관) -->
            <div class="dropzone-card accent-top-viewer" data-role="VIEWER" style="border-style: dashed;">
                <div class="dropzone-header">
                    <span class="badge bg-info text-white">읽기 전용</span>
                    <div class="fw-bold">뷰어</div>
                    <div class="text-muted small">단계 무관 · 조회+댓글만 가능</div>
                </div>
                <div class="dropzone-body" id="dropzone-viewer" ondrop="dropPerson(event, 'VIEWER')" ondragover="allowDrop(event)" ondragleave="leaveDrop(event)">
                    {% for share in shares %}{% if share.permission_record and share.permission_record.role_code == 'VIEWER' %}
                    <div class="person-card" draggable="true" ondragstart="dragStart(event)" ondragend="dragEnd(event)" onclick="selectPerson(this)"
                        data-email="{{ share.recipient_email }}" data-username="{{ share.display_name }}"
                        data-share-id="{{ share.share_id }}" data-role="VIEWER"
                        data-name="{{ share.recipient_name|default:'' }}" data-company="{{ share.recipient_company|default:'' }}">
                        <div class="avatar bg-info text-white">{{ share.display_name|slice:":1"|upper }}</div>
                        <div class="person-info">
                            <div class="person-name">{{ share.display_name }}</div>
                            <div class="person-email">{{ share.recipient_email }}</div>
                        </div>
                        <span class="badge bg-info" style="font-size:9px;">뷰어</span>
                    </div>
                    {% endif %}{% endfor %}
                    <div class="dropzone-placeholder{% for share in shares %}{% if share.permission_record and share.permission_record.role_code == 'VIEWER' %} d-none{% endif %}{% endfor %}">
                        <i class="bi bi-eye"></i>
                        <span>뷰어 추가</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 오른쪽: 인물 상세정보 패널 -->
        <div class="person-detail-panel">
            <button class="panel-toggle-btn" onclick="toggleRightPanel()" title="패널 접기/펼치기">
                <i class="bi bi-chevron-right"></i>
            </button>
            <div id="person-detail-empty" class="empty-state">
                <i class="bi bi-person-circle"></i>
                <div style="font-size: 13px;">왼쪽에서 멤버를 선택하세요</div>
                <small style="font-size: 11px;">이름, 회사, 역할을 수정하거나<br>계정을 삭제할 수 있습니다</small>
            </div>

            <div id="person-detail-content" style="display: none;">
                <div class="text-center mb-4">
                    <div class="detail-avatar bg-primary text-white" id="detail-avatar">
                        A
                    </div>
                    <div class="fw-bold" style="font-size: 14px; color: #202124;" id="detail-display-name">홍길동</div>
                    <div class="text-muted" style="font-size: 12px;" id="detail-email">hong@example.com</div>
                </div>

                <div class="mb-3">
                    <label class="form-label">이메일</label>
                    <input type="email" class="form-control form-control-sm" id="detail-email-input" disabled style="font-size: 12px; background: #e9ecef;">
                </div>

                <div class="mb-3">
                    <label class="form-label">이름</label>
                    <input type="text" class="form-control form-control-sm" id="detail-name-input" placeholder="이름을 입력하세요" style="font-size: 12px;">
                </div>

                <div class="mb-3">
                    <label class="form-label">회사명</label>
                    <input type="text" class="form-control form-control-sm" id="detail-company-input" placeholder="회사명을 입력하세요" style="font-size: 12px;">
                </div>

                <div class="mb-4">
                    <label class="form-label">역할</label>
                    <select class="form-select form-select-sm" id="detail-role-select" style="font-size: 12px;">
                        <option value="UPLOADER">자료 제출 (협력업체)</option>
                        <option value="EDITOR">공동 편집 (팀원)</option>
                        <option value="REVIEWER">검토/QA (팀장)</option>
                        <option value="APPROVER">최종 승인 (임원)</option>
                        <option value="VIEWER">뷰어 (읽기 전용)</option>
                    </select>
                </div>

                <div class="d-grid gap-2">
                    <button class="btn btn-sm btn-primary" onclick="savePersonDetails()" style="font-size: 12px;">
                        <i class="bi bi-check2 me-1"></i>변경사항 저장
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deletePerson()" id="delete-person-btn" style="font-size: 12px;">
                        <i class="bi bi-trash me-1"></i>공유 완전 삭제
                    </button>
                    <div class="alert alert-info mb-0 mt-2" style="font-size: 11px; padding: 8px;">
                        <i class="bi bi-info-circle me-1"></i>
                        팁: 공유를 취소하려면 카드를 왼쪽 팔레트로 드래그하세요
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* 권한설정 탭 전용 스타일 */
.permission-workspace {
    display: flex;
    flex-direction: column;
    width: 100%;
    min-height: 650px !important;
    height: auto !important;
    background: white;
    padding: 20px;
    overflow-y: auto;
}

.permission-layout {
    display: grid !important;
    grid-template-columns: 280px 1fr 320px !important;
    gap: 20px;
    align-items: flex-start;
    flex: 1 1 auto;
    min-height: 650px !important;
    height: auto !important;
}

/* 현재 단계 강조 */
.dropzone-card.stage-active {
    border: 2px solid #1a73e8 !important;
    box-shadow: 0 0 0 3px rgba(26,115,232,0.15);
}
.dropzone-card.stage-active .dropzone-header {
    background: rgba(26,115,232,0.06);
}
</style>

<script>
// 현재 로그인 사용자 컨텍스트 (권한 검사용)
var _currentUserRole  = '{{ user_role }}';
var _currentUserEmail = '{{ request.user.email|lower }}';

// 권한설정 탭 전용 스크립트
(function() {
    function forcePermissionHeight() {
        const tabPane = document.getElementById('tab-share');
        const workspace = document.querySelector('.permission-workspace');
        const layout = document.querySelector('.permission-layout');
        
        if (!tabPane || !workspace || !layout) return;
        
        // 뷰포트 높이 기준으로 계산 (헤더/네비 제외)
        const viewportHeight = window.innerHeight;
        const availableHeight = Math.max(650, viewportHeight - 200); // 최소 650px
        
        // 픽셀 단위로 강제 설정
        workspace.style.height = availableHeight + 'px';
        workspace.style.minHeight = availableHeight + 'px';
        
        layout.style.height = (availableHeight - 40) + 'px'; // padding 제외
        layout.style.minHeight = (availableHeight - 40) + 'px';
        
        // 강제 리플로우
        layout.style.display = 'none';
        void layout.offsetHeight;
        layout.style.display = 'grid';
    }
    
    function initPermissionTab() {
        const tabButton = document.querySelector('button[data-bs-target="#tab-share"]');
        if (tabButton) {
            tabButton.addEventListener('shown.bs.tab', function() {
                setTimeout(forcePermissionHeight, 100);
            });
        }
        
        // 창 크기 변경 시에도 재계산
        window.addEventListener('resize', function() {
            const tabPane = document.getElementById('tab-share');
            if (tabPane && tabPane.classList.contains('active')) {
                forcePermissionHeight();
            }
        });
        
        // 초기 로드 시 활성 탭이면 실행
        const tabPane = document.getElementById('tab-share');
        if (tabPane && tabPane.classList.contains('active')) {
            setTimeout(forcePermissionHeight, 500);
        }
    }

    // DOM 로드 완료 후 초기화
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initPermissionTab);
    } else {
        initPermissionTab();
    }
})();
</script>

<script>
/* ============================================================
   권한설정 탭 드래그&드롭 + 인물 상세 전역 함수
   (inline 이벤트 핸들러가 window 스코프에서 호출하므로 전역 선언)
   ============================================================ */

var _draggedPersonData = null;  // 드래그 중인 사람 데이터

/* CSRF 헬퍼 */
function _permCsrf() {
    var m = document.cookie.match(/csrftoken=([^;]+)/);
    return m ? m[1] : '';
}

/* form-urlencoded POST (Django 뷰가 request.POST.get() 사용) */
function _permPost(url, params) {
    var body = Object.keys(params).map(function(k) {
        return encodeURIComponent(k) + '=' + encodeURIComponent(params[k] == null ? '' : params[k]);
    }).join('&');
    return fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'X-CSRFToken': _permCsrf() },
        body: body
    }).then(function(r) {
        if (!r.ok) {
            return r.text().then(function(text) {
                throw new Error('HTTP ' + r.status + ' – ' + text.replace(/<[^>]+>/g, '').trim().substring(0, 300));
            });
        }
        return r.json();
    });
}

/* 저장/삭제 후 권한 탭 유지하며 새로고침 (sessionStorage 방식) */
function _reloadToPermissions() {
    sessionStorage.setItem('returnToTab', 'share');
    window.location.reload();
}

/* ── DOM 업데이트 헬퍼 ── */

/* 역할별 아바타 색상 */
var _roleColors = {
    'UPLOADER': ['bg-primary',  'text-white'],
    'EDITOR':   ['bg-success',  'text-white'],
    'REVIEWER': ['bg-warning',  'text-dark'],
    'APPROVER': ['bg-danger',   'text-white'],
    'VIEWER':   ['bg-info',     'text-white']
};

/* 드롭존 카드 DOM 생성 */
function _makeDropzoneCard(data, role) {
    var div = document.createElement('div');
    div.className = 'person-card';
    div.draggable = true;
    div.setAttribute('ondragstart', 'dragStart(event)');
    div.setAttribute('ondragend',   'dragEnd(event)');
    div.setAttribute('onclick',     'selectPerson(this)');
    div.dataset.email    = data.email;
    div.dataset.username = data.username;
    div.dataset.shareId  = data.shareId;
    div.dataset.role     = role;
    div.dataset.name     = data.name;
    div.dataset.company  = data.company;
    var displayName = data.name || data.username || data.email;
    var initial     = (displayName || '?').charAt(0).toUpperCase();
    var colors = _roleColors[role] || ['bg-primary', 'text-white'];
    div.innerHTML =
        '<div class="avatar ' + colors[0] + ' ' + colors[1] + '">' + initial + '</div>' +
        '<div class="person-info">' +
            '<div class="person-name">' + displayName + '</div>' +
            '<div class="person-email">' + data.email + '</div>' +
        '</div>';
    return div;
}

/* 드롭존에서 share_id 기준으로 카드 제거 */
function _removeCardFromDropzones(shareId) {
    if (!shareId) return;
    document.querySelectorAll('.workflow-dropzones .person-card[data-share-id="' + shareId + '"]')
        .forEach(function(el) { el.remove(); });
}

/* 드롭존의 placeholder 표시 여부 갱신 */
function _syncPlaceholder(zoneEl) {
    var ph = zoneEl && zoneEl.querySelector('.dropzone-placeholder');
    if (!ph) return;
    var hasPerson = zoneEl.querySelectorAll('.person-card').length > 0;
    ph.classList.toggle('d-none', hasPerson);
}

/* 팔레트 카드의 역할 뱃지 갱신 */
function _updatePaletteBadge(shareId, role) {
    var card = document.querySelector('.palette-list .person-card[data-share-id="' + shareId + '"]');
    if (!card) return;
    card.dataset.role = role || '';
    var old = card.querySelector('.badge:not(.bg-secondary)');
    if (old) old.remove();
    if (role) {
        var labels = { UPLOADER:'자료제출', EDITOR:'편집', REVIEWER:'검토', APPROVER:'승인', VIEWER:'뷰어' };
        var badgeClasses = { UPLOADER:'bg-primary', EDITOR:'bg-success', REVIEWER:'bg-warning text-dark', APPROVER:'bg-danger', VIEWER:'bg-info' };
        var b = document.createElement('span');
        b.className = 'badge ' + (badgeClasses[role] || 'bg-secondary');
        b.style.fontSize = '9px';
        b.textContent = labels[role] || role;
        card.appendChild(b);
    }
}

/* 페이지 URL에서 label_id 추출 (/products/<id>/) */
function _labelId() {
    var m = window.location.pathname.match(/\/products\/(\d+)/);
    return m ? m[1] : '';
}

/* ── 드래그 이벤트 ── */

function dragStart(event) {
    var card = event.currentTarget;
    var cardEmail  = (card.dataset.email || '').toLowerCase();
    var cardIsOwner = card.dataset.isOwner === 'true';

    // EDITOR는 소유자 카드와 본인 카드를 드래그할 수 없음
    if (_currentUserRole === 'EDITOR' && (cardIsOwner || cardEmail === _currentUserEmail)) {
        event.preventDefault();
        return;
    }
    // OWNER가 아니고 EDITOR도 아닌 사람은 드래그 불가
    if (_currentUserRole !== 'OWNER' && _currentUserRole !== 'EDITOR') {
        event.preventDefault();
        return;
    }

    _draggedPersonData = {
        email:    card.dataset.email    || '',
        username: card.dataset.username || '',
        shareId:  card.dataset.shareId  || '',
        role:     card.dataset.role     || '',
        name:     card.dataset.name     || '',
        company:  card.dataset.company  || ''
    };
    event.dataTransfer.setData('text/plain', _draggedPersonData.email);
    event.dataTransfer.effectAllowed = 'move';
    card.style.opacity = '0.5';
}

function dragEnd(event) {
    event.currentTarget.style.opacity = '';
    _draggedPersonData = null;
}

function allowDrop(event) {
    event.preventDefault();
    var zone = event.currentTarget;
    zone.style.background = 'rgba(26,115,232,0.07)';
    zone.style.borderColor = '#1a73e8';
}

function leaveDrop(event) {
    var zone = event.currentTarget;
    zone.style.background = '';
    zone.style.borderColor = '';
}

function dropPerson(event, role) {
    event.preventDefault();
    leaveDrop(event);

    if (!_draggedPersonData || !_draggedPersonData.email) return;

    var data    = Object.assign({}, _draggedPersonData); // 비동기 전에 복사
    var shareId = data.shareId;
    _draggedPersonData = null;

    if (!shareId) {
        /* 현재 제품 공유 없음 → 초대하면서 역할 지정 (새로고침 필요) */
        var labelId = _labelId();
        if (!labelId) { alert('라벨 ID를 찾을 수 없습니다.'); return; }
        _permPost('/products/share/create/' + labelId + '/', {
            email:   data.email,
            role:    role,
            name:    data.name    || '',
            company: data.company || ''
        })
        .then(function(res) {
            if (res.success) _reloadToPermissions();
            else alert(res.error || '초대에 실패했습니다.');
        })
        .catch(function(err) { alert('초대 오류: ' + (err && err.message ? err.message : err)); });
        return;
    }

    /* 같은 역할 드롭이면 무시 */
    if (data.role === role) return;

    /* 낙관적(Optimistic) DOM 업데이트 */
    _removeCardFromDropzones(shareId);
    var oldZoneId = 'dropzone-' + (data.role || '').toLowerCase();
    var oldZone = document.getElementById(oldZoneId);
    if (oldZone) _syncPlaceholder(oldZone);

    var newZone = document.getElementById('dropzone-' + role.toLowerCase());
    if (newZone) {
        newZone.appendChild(_makeDropzoneCard(data, role));
        _syncPlaceholder(newZone);
    }
    _updatePaletteBadge(shareId, role);

    /* API 호출 (실패 시 롤백) */
    _permPost('/products/share/' + shareId + '/update-permission/', { role: role })
    .then(function(res) {
        if (!res.success) {
            alert(res.error || '역할 변경에 실패했습니다. 새로고침합니다.');
            _reloadToPermissions();
        }
    })
    .catch(function(err) {
        alert('역할 변경 오류: ' + (err && err.message ? err.message : err) + '\n새로고침합니다.');
        _reloadToPermissions();
    });
}

function dropPersonToPalette(event) {
    event.preventDefault();
    leaveDrop(event);

    if (!_draggedPersonData || !_draggedPersonData.shareId) return;

    /* 팔레트 자체 카드에서 드래그한 경우(→ 이미 팔레트에 있음) 무시 */
    var data    = Object.assign({}, _draggedPersonData);
    var shareId = data.shareId;
    _draggedPersonData = null;

    if (!shareId) return;  /* 공유 없는 팔레트 자체 카드면 무시 */

    /* 낙관적 DOM 업데이트: 드롭존에서 카드 제거 + 팔레트 뱃지 제거 */
    _removeCardFromDropzones(shareId);
    document.querySelectorAll('.dropzone-body').forEach(_syncPlaceholder);
    _updatePaletteBadge(shareId, '');  /* 뱃지 완전 제거 */

    /* API 호출: 공유 완전 취소 (revoke) → 새로고침 후 드롭존·팔레트 모두 미노출 */
    _permPost('/products/share/' + shareId + '/revoke/', {})
    .then(function(res) {
        if (!res.success) {
            alert(res.error || '권한 제거에 실패했습니다. 새로고침합니다.');
            _reloadToPermissions();
        }
        /* 성공: DOM은 이미 낙관적 업데이트됨, 추가 액션 불필요 */
    })
    .catch(function(err) {
        alert('권한 제거 오류: ' + (err && err.message ? err.message : err) + '\n새로고침합니다.');
        _reloadToPermissions();
    });
}

/* ── 인물 상세 패널 ── */

function selectPerson(card) {
    document.querySelectorAll('.person-card').forEach(function(c) { c.classList.remove('selected'); });
    card.classList.add('selected');

    var isOwner = card.dataset.isOwner === 'true';
    var empty   = document.getElementById('person-detail-empty');
    var content = document.getElementById('person-detail-content');
    if (!empty || !content) return;

    empty.style.display   = 'none';
    content.style.display = 'block';

    var email   = card.dataset.email   || '';
    var name    = card.dataset.name    || card.dataset.username || '';
    var company = card.dataset.company || '';
    var role    = card.dataset.role    || '';
    var shareId = card.dataset.shareId || '';

    var el;
    el = document.getElementById('detail-avatar');        if (el) el.textContent = (name || email).charAt(0).toUpperCase();
    el = document.getElementById('detail-display-name'); if (el) el.textContent = name || email;
    el = document.getElementById('detail-email');         if (el) el.textContent = email;
    el = document.getElementById('detail-email-input');  if (el) el.value = email;
    el = document.getElementById('detail-name-input');   if (el) el.value = name;
    el = document.getElementById('detail-company-input');if (el) el.value = company;
    el = document.getElementById('detail-role-select');  if (el) el.value = role;

    // 현재 사용자가 이 카드를 편집할 수 있는지 판단
    //  - OWNER : 소유자 카드(isOwner) 제외 모든 카드 수정 가능
    //  - EDITOR: 소유자 카드 및 본인 카드 수정 불가, 나머지 가능
    //  - 그 외 : 편집 불가
    var isCurrentUser = (email.toLowerCase() === _currentUserEmail);
    var canManage;
    if (_currentUserRole === 'OWNER') {
        canManage = !isOwner;
    } else if (_currentUserRole === 'EDITOR') {
        canManage = !isOwner && !isCurrentUser;
    } else {
        canManage = false;
    }

    var saveBtn = document.querySelector('button[onclick="savePersonDetails()"]');
    if (saveBtn) saveBtn.style.display = canManage ? '' : 'none';

    var deleteBtn = document.getElementById('delete-person-btn');
    if (deleteBtn) {
        deleteBtn.style.display   = canManage ? '' : 'none';
        deleteBtn.dataset.shareId = shareId;
    }

    content.dataset.shareId = shareId;
}

function savePersonDetails() {
    var content = document.getElementById('person-detail-content');
    if (!content) return;
    var shareId = content.dataset.shareId;
    if (!shareId) { alert('저장할 공유 정보가 없습니다.'); return; }

    var name    = (document.getElementById('detail-name-input')    || {}).value || '';
    var company = (document.getElementById('detail-company-input') || {}).value || '';
    var role    = (document.getElementById('detail-role-select')   || {}).value || '';

    _permPost('/products/share/' + shareId + '/update-info/', { name: name, company: company, role: role })
    .then(function(data) {
        if (data.success) _reloadToPermissions();
        else alert(data.error || '저장에 실패했습니다.');
    })
    .catch(function(err) { alert('저장 오류: ' + (err && err.message ? err.message : err)); });
}

function deletePerson() {
    var deleteBtn = document.getElementById('delete-person-btn');
    if (!deleteBtn) return;
    var shareId = deleteBtn.dataset.shareId;
    if (!shareId) { alert('삭제할 공유 정보가 없습니다.'); return; }
    if (!confirm('이 멤버의 공유를 완전히 삭제하시겠습니까?')) return;

    _permPost('/products/share/' + shareId + '/revoke/', {})
    .then(function(data) {
        if (data.success) _reloadToPermissions();
        else alert(data.error || '삭제에 실패했습니다.');
    })
    .catch(function(err) { alert('삭제 오류: ' + (err && err.message ? err.message : err)); });
}

/* ── 패널 토글 ── */

function toggleLeftPanel() {
    var palette = document.querySelector('.people-palette');
    if (palette) palette.classList.toggle('collapsed');
}

function toggleRightPanel() {
    var panel = document.querySelector('.person-detail-panel');
    if (panel) panel.classList.toggle('collapsed');
}

/* ── 팔레트 검색 필터 ── */

function filterPalette() {
    var q = ((document.getElementById('palette-search') || {}).value || '').toLowerCase();
    document.querySelectorAll('.palette-list .person-card').forEach(function(card) {
        var name    = (card.dataset.name    || '').toLowerCase();
        var email   = (card.dataset.email   || '').toLowerCase();
        var company = (card.dataset.company || '').toLowerCase();
        card.style.display = (!q || name.includes(q) || email.includes(q) || company.includes(q)) ? '' : 'none';
    });
}

/* ── 간편 초대 ── */

function openQuickInvite() {
    var email = prompt('초대할 이메일 주소를 입력하세요:');
    if (email === null) return;
    if (!email || !email.includes('@')) { alert('유효한 이메일을 입력하세요.'); return; }

    var labelId = _labelId();
    if (!labelId) { alert('라벨 ID를 찾을 수 없습니다. 새로고침 후 다시 시도하세요.'); return; }

    _permPost('/products/share/create/' + labelId + '/', { email: email, role: 'VIEWER' })
    .then(function(data) {
        if (data.success) { alert(email + ' 을(를) 초대했습니다.'); _reloadToPermissions(); }
        else alert(data.error || '초대에 실패했습니다.');
    })
    .catch(function(err) { alert('초대 오류: ' + (err && err.message ? err.message : err)); });
}
</script>
