<!-- _tab_label.html: 표시사항 탭 – 미리보기 직접 임베드 -->
<style>
#ltRoot {
    flex: 1 1 auto;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    width: 100%;
    box-sizing: border-box;
}

#lt-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 12px;
    height: 300px;
    color: #5f6368;
}

#lt-preview-frame {
    width: 100%;
    flex: 1 1 0;      /* basis 0 + grow: 컨테이너 잔여 높이를 정확히 채움 */
    min-height: 0;    /* flex-shrink 허용 – 부모보다 커지지 않음 */
    border: none;
    display: block;
}
</style>

<div id="ltRoot">
    {% if not can_edit %}
    <div class="d-flex align-items-center gap-2 px-3 py-2 border-bottom bg-light flex-shrink-0">
        <span class="badge bg-secondary"><i class="bi bi-lock-fill me-1"></i>읽기 전용</span>
        <span class="text-muted" style="font-size:12px;">현재 역할로는 표시사항 설정을 수정하거나 PDF를 저장할 수 없습니다.</span>
    </div>
    {% endif %}
    <div id="lt-loading">
        <div class="spinner-border text-primary" style="width:1.8rem;height:1.8rem;" role="status"></div>
        <span>표시사항 미리보기를 불러오는 중...</span>
    </div>
    <iframe id="lt-preview-frame" src="" style="display:none;"></iframe>
</div>
<script>
(function () {
    var LABEL_ID    = '{{ product.my_label_id }}';
    var API_URL     = '{% url "label:label_tab_json" %}?label_id=' + LABEL_ID;
    var PREVIEW_URL = '{% url "label:preview_popup" %}?label_id=' + LABEL_ID + '&in_tab=1';
    var _loaded     = false;
    var _ltData     = null;

    function getFrame()   { return document.getElementById('lt-preview-frame'); }
    function getLoading() { return document.getElementById('lt-loading'); }

    /* DOM에서 현재 선택된 알레르기 목록 읽기 */
    function getCurrentAllergens() {
        var el = document.getElementById('field-allergens');
        var val = el ? el.value.trim() : '';
        if (val) {
            return val.split(',').map(function(a){ return a.trim(); }).filter(Boolean);
        }
        var rawEl = document.getElementById('field-rawmtrl-nm');
        if (rawEl && rawEl.value) {
            var m = rawEl.value.match(/\[알레르기\s*성분\s*:\s*([^\]]+)\]/);
            if (m) {
                return m[1].replace(/함유/g,'').split(',').map(function(a){ return a.trim(); }).filter(Boolean);
            }
        }
        return [];
    }

    /* iframe 즉시 표시 후 API 데이터는 백그라운드로 로드
       (requestPreviewData postMessage 응답에 사용) */
    function ltLoad() {
        if (_loaded) return;
        _loaded = true;
        showFrame();  // 즉시 iframe 표시

        // 백그라운드 fetch: postMessage 응답(previewCheckedFields)에 사용
        fetch(API_URL, { credentials: 'same-origin' })
            .then(function(r) { return r.ok ? r.json() : null; })
            .then(function(data) { if (data && data.success) _ltData = data; })
            .catch(function() {});
    }

    function showFrame() {
        var frame   = getFrame();
        var loading = getLoading();
        if (loading) loading.style.display = 'none';
        if (frame) {
            if (!frame.src || frame.src === window.location.href || frame.src === 'about:blank') {
                frame.src = PREVIEW_URL;
            }
            frame.style.display = 'block';
        }
    }

    /* ── _ltData 기반으로 previewCheckedFields 데이터를 빌드하는 헬퍼 ── */
    function _buildLabelData() {
        var labelData = {};
        if (!_ltData || !_ltData.preview_items) return labelData;
        var labelMap = {
            '식품유형': 'prdlst_dcnm',              '제품명': 'prdlst_nm',
            '성분명 및 함량': 'ingredient_info',    '내용량': 'content_weight',
            '내용량(열량)': 'weight_calorie',        '품목보고번호': 'prdlst_report_no',
            '원산지': 'country_of_origin',           '보관방법': 'storage_method',
            '포장재질': 'frmlc_mtrqlt',              '제조원': 'bssh_nm',
            '제조원 소재지': 'bssh_nm',
            '유통전문판매원': 'distributor_address', '소분원': 'repacker_address',
            '수입원': 'importer_address',            '소비기한': 'pog_daycnt',
            '원재료명': 'rawmtrl_nm_display',
            /* '원재료명(참고)': 'rawmtrl_nm' 은 의도적으로 제외.
               rawmtrl_nm 을 별도 키로 labelData 에 넣으면 iframe 의
               getFieldDefinitions() 가 '원재료명' 행을 중복 생성하고,
               rawmtrl_nm 키에는 원산지 굵게/알레르기 뱃지 처리가 없어
               표시 정보가 서로 다른 두 행이 나타나는 버그가 발생한다.
               rawmtrl_nm_display 가 비어있을 경우 아래에서 rawmtrl_nm 값으로 폴백한다. */
            '주의사항': 'cautions',                  '기타표시사항': 'additional_info'
        };
        _ltData.preview_items.forEach(function(it) {
            var key = labelMap[it.label];
            if (key) labelData[key] = it.value;
        });
        /* rawmtrl_nm_display 가 비어있으면 rawmtrl_nm(참고) 값으로 폴백 */
        if (!labelData.rawmtrl_nm_display) {
            _ltData.preview_items.forEach(function(it) {
                if (it.label === '원재료명(참고)' && it.value) {
                    labelData.rawmtrl_nm_display = it.value;
                }
            });
        }
        return labelData;
    }

    function _buildCustomFields() {
        var customFields = [];
        try {
            var cfEl = document.getElementById('field-custom-fields-json');
            if (cfEl && cfEl.value) {
                var parsed = JSON.parse(cfEl.value);
                if (Array.isArray(parsed) && parsed.length > 0) customFields = parsed;
            }
        } catch(e) {}
        if (!customFields.length && _ltData && _ltData.custom_fields) {
            customFields = _ltData.custom_fields;
        }
        return customFields;
    }

    /* target 윈도우에 previewCheckedFields 전송 */
    function _sendPreviewData(target) {
        if (!target) return;
        var allergens = getCurrentAllergens();
        if (!allergens.length && _ltData && _ltData.allergens) allergens = _ltData.allergens;
        target.postMessage({
            type: 'previewCheckedFields',
            checked: _buildLabelData(),
            allergens: allergens,
            customFields: _buildCustomFields(),
            update_datetime: new Date().toISOString().slice(0, 16).replace('T', ' ')
        }, '*');
    }

    /* iframe → 부모 방향 postMessage 수신:
       label_preview.js 가 requestPreviewData 를 보내면 previewCheckedFields 로 응답 */
    window.addEventListener('message', function(e) {
        if (!e.data || e.data.type !== 'requestPreviewData') return;
        _sendPreviewData(e.source);
    });

    /* 기본정보 저장 후 표시사항 탭 데이터를 즉시 갱신하는 함수
       product_detail.html 의 saveBasicInfo() 성공 핸들러에서 호출됨 */
    window.refreshLabelData = function() {
        _ltData = null;  // 캐시 초기화 → 다음 탭 전환 시 재요청 보장
        fetch(API_URL, { credentials: 'same-origin' })
            .then(function(r) { return r.ok ? r.json() : null; })
            .then(function(data) {
                if (data && data.success) {
                    _ltData = data;
                    // iframe 이 이미 표시 중이면 즉시 새 데이터 전송
                    var frame = getFrame();
                    if (frame && frame.style.display !== 'none' && frame.contentWindow) {
                        _sendPreviewData(frame.contentWindow);
                    }
                }
            })
            .catch(function() {});
    };

    function init() {
        var tabBtn = document.querySelector('button[data-bs-target="#tab-label"]');
        if (tabBtn) {
            tabBtn.addEventListener('shown.bs.tab', function() {
                ltLoad();
            });
        }

        requestAnimationFrame(function() {
            requestAnimationFrame(function() {
                var pane = document.getElementById('tab-label');
                if (pane && pane.classList.contains('active')) {
                    ltLoad();
                }
            });
        });
    }

    window.ltLoad = ltLoad;
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
    else init();
})();
</script>