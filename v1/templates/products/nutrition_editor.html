{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì˜ì–‘ì„±ë¶„ ì…ë ¥</title>
    
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Handsontable -->
    <link href="https://cdn.jsdelivr.net/npm/handsontable@12.4.0/dist/handsontable.full.min.css" rel="stylesheet">
    
    <!-- V1 ì˜ì–‘ì„±ë¶„ ê³„ì‚°ê¸° ìŠ¤íƒ€ì¼ -->
    <link href="{% static 'css/label_calculator.css' %}?v={{ STATIC_BUILD_DATE }}" rel="stylesheet">
    <!-- ì˜ì–‘ì„±ë¶„ í¸ì§‘ê¸° ì „ìš© ìŠ¤íƒ€ì¼ -->
    <link href="{% static 'css/nutrition_editor.css' %}?v={{ STATIC_BUILD_DATE }}" rel="stylesheet">
</head>
<body>

<script>
// JavaScript ì‹¤í–‰ ì‹œì‘
</script>

<div id="nutrition-container">
    <!-- ì™¼ìª½: ì…ë ¥ íŒ¨ë„ -->
    <div id="input-panel">
        {% if not can_edit %}
        <div class="d-flex align-items-center gap-2 mb-2 px-1 py-1">
            <span class="badge bg-secondary"><i class="bi bi-lock-fill me-1"></i>ì½ê¸° ì „ìš©</span>
            <span class="text-muted" style="font-size:12px;">í˜„ì¬ ì—­í• ë¡œëŠ” ì˜ì–‘ì„±ë¶„ì„ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</span>
        </div>
        {% endif %}
        <!-- ê¸°ë³¸ ì„¤ì • -->
        <div class="config-section">
            <div class="config-row">
                <div class="config-item">
                    <label class="config-label">ë‹¨ìœ„ëŸ‰</label>
                    <input type="text" class="form-control form-control-sm" id="serving_size" placeholder="100" style="width: 70px;">
                    <select class="form-select form-select-sm" id="serving_size_unit" style="width: 60px;">
                        <option value="g">g</option>
                        <option value="ml">ml</option>
                    </select>
                </div>
                
                <div class="config-item">
                    <label class="config-label">í¬ì¥ê°œìˆ˜</label>
                    <input type="text" class="form-control form-control-sm" id="units_per_package" placeholder="1" style="width: 70px;">
                    <span class="unit-label">ê°œ</span>
                </div>
                
            </div>
        </div>
        
        <!-- Handsontable ê·¸ë¦¬ë“œ -->
        <div id="grid-container">
            <div id="nutrition-grid"></div>
        </div>
    </div>
    
    <!-- ì˜¤ë¥¸ìª½: ë¯¸ë¦¬ë³´ê¸° íŒ¨ë„ -->
    <div id="preview-panel">
        <div class="preview-header">
            <div class="preview-controls">
                <div class="control-group">
                    <div class="control-title">ìŠ¤íƒ€ì¼</div>
                    <div class="style-selector" id="styleButtons">
                        <button class="style-btn active" type="button" data-style="basic">ê¸°ë³¸í˜•</button>
                        <button class="style-btn" type="button" data-style="parallel">ë³‘í–‰í‘œì‹œ</button>
                    </div>
                </div>

                <div class="control-group" id="basicDisplayTypeGroup">
                    <div class="control-title">í‘œì‹œê¸°ì¤€</div>
                    <div class="style-selector">
                        <button class="style-btn active" type="button" data-basic="total">ì´ë‚´ìš©ëŸ‰ë‹¹</button>
                        <button class="style-btn" type="button" data-basic="unit">ë‹¨ìœ„ë‚´ìš©ëŸ‰ë‹¹</button>
                        <button class="style-btn" type="button" data-basic="100g">100gë‹¹</button>
                    </div>
                </div>

                <div class="control-group" id="parallelDisplayTypeGroup" style="display: none;">
                    <div class="control-title">í‘œì‹œê¸°ì¤€</div>
                    <div class="style-selector">
                        <button class="style-btn active" type="button" data-parallel="unit_total">1ì¡°ê°/ì´ë‚´ìš©ëŸ‰</button>
                        <button class="style-btn" type="button" data-parallel="unit_100g">1ì¡°ê°/100g</button>
                        <button class="style-btn" type="button" data-parallel="serving_total">1íšŒëŸ‰/ì´ë‚´ìš©ëŸ‰</button>
                        <button class="style-btn" type="button" data-parallel="serving_100ml">1íšŒëŸ‰/100ml</button>
                    </div>
                </div>
            </div>

            <select id="basic_display_type" class="visually-hidden" aria-hidden="true">
                <option value="total" selected>ì´ë‚´ìš©ëŸ‰ë‹¹</option>
                <option value="unit">ë‹¨ìœ„ë‚´ìš©ëŸ‰ë‹¹</option>
                <option value="100g">100gë‹¹</option>
            </select>
            <select id="parallel_display_type" class="visually-hidden" aria-hidden="true">
                <option value="unit_total" selected>1ì¡°ê°/ì´ë‚´ìš©ëŸ‰</option>
                <option value="unit_100g">1ì¡°ê°/100g</option>
                <option value="serving_total">1íšŒëŸ‰/ì´ë‚´ìš©ëŸ‰</option>
                <option value="serving_100ml">1íšŒëŸ‰/100ml</option>
            </select>
            <input type="hidden" id="nutrition_display_unit" value="basic">
            
        </div>

        
        <div class="preview-content">
            <div class="result-display" id="resultDisplay">
                <div class="empty-result">
                    <div style="padding: 40px; text-align: center; color: #999;">
                        <p style="font-size: 12px; margin-bottom: 16px;">ğŸ“„ í˜ì´ì§€ ìƒíƒœ: ë¡œë“œ ì¤‘...</p>
                        <p style="font-size: 11px; color: #ccc; margin: 0;">
                            LABEL_ID: <code id="labelIdDisplay" style="background: #f0f0f0; padding: 2px 4px;">í™•ì¸ ì¤‘</code>
                        </p>
                        <div style="margin-top: 20px; font-size: 10px;">
                            <p id="loadStatus" style="color: #999; margin: 4px 0;">â³ ë°ì´í„° ë¡œë“œ ì¤‘...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/handsontable@12.4.0/dist/handsontable.full.min.js"></script>

<!-- V1 ì˜ì–‘ì„±ë¶„ ê³„ì‚°ê¸° ë¡œì§ -->
<script src="{% static 'js/label/constants.js' %}?v={{ STATIC_BUILD_DATE }}"></script>
<script src="{% static 'js/label/nutrition_calculator_popup.js' %}?v={{ STATIC_BUILD_DATE }}"></script>

<script>
// Django í…œí”Œë¦¿ ë Œë”ë§
const LABEL_ID_TEMPLATE = '{{ LABEL_ID }}';
const CAN_EDIT = {{ can_edit|yesno:'true,false' }};
const API_NUTRITION_LOAD_URL = '{% url "products:nutrition_data_api" LABEL_ID %}';
const API_NUTRITION_SAVE_URL = '{% url "products:nutrition_save_api" LABEL_ID %}';

// LABEL_ID íŒŒì‹±
let LABEL_ID = null;
try {
    if (LABEL_ID_TEMPLATE && LABEL_ID_TEMPLATE !== '' && LABEL_ID_TEMPLATE !== '{{ LABEL_ID }}') {
        LABEL_ID = parseInt(LABEL_ID_TEMPLATE, 10);
    } else {
        throw new Error('LABEL_ID í…œí”Œë¦¿ ë Œë”ë§ ì‹¤íŒ¨');
    }
} catch (error) {
    if (!isNaN(parseInt(LABEL_ID_TEMPLATE, 10))) {
        LABEL_ID = parseInt(LABEL_ID_TEMPLATE, 10);
    }
}

let hot = null;
let currentPreviewStyle = 'basic';

// ìƒíƒœ í‘œì‹œ ì˜ì—­ ì—…ë°ì´íŠ¸
function updateStatus(message) {
    const statusEl = document.getElementById('loadStatus');
    if (statusEl) {
        statusEl.textContent = message;
    }
}

// LABEL_ID í‘œì‹œ ì—…ë°ì´íŠ¸
function updateLabelIdDisplay() {
    const display = document.getElementById('labelIdDisplay');
    if (display && LABEL_ID) {
        display.textContent = LABEL_ID;
    }
}
const ALL_NUTRIENTS = [
    // í•„ìˆ˜ ì˜ì–‘ì„±ë¶„ 9ê°€ì§€ (ì‹ì•½ì²˜ í‘œì¤€ ìˆœì„œ)
    { field: 'calories', label: 'ì—´ëŸ‰', unit: 'kcal', unitOptions: ['kcal'], required: true },
    { field: 'carbohydrates', label: 'íƒ„ìˆ˜í™”ë¬¼', unit: 'g', unitOptions: ['g'], required: true },
    { field: 'sugars', label: 'ë‹¹ë¥˜', unit: 'g', unitOptions: ['g'], required: true },
    { field: 'fats', label: 'ì§€ë°©', unit: 'g', unitOptions: ['g'], required: true },
    { field: 'trans_fats', label: 'íŠ¸ëœìŠ¤ì§€ë°©', unit: 'g', unitOptions: ['g', 'mg'], required: true },
    { field: 'saturated_fats', label: 'í¬í™”ì§€ë°©', unit: 'g', unitOptions: ['g', 'mg'], required: true },
    { field: 'cholesterols', label: 'ì½œë ˆìŠ¤í…Œë¡¤', unit: 'mg', unitOptions: ['mg', 'g'], required: true },
    { field: 'proteins', label: 'ë‹¨ë°±ì§ˆ', unit: 'g', unitOptions: ['g'], required: true },
    { field: 'natriums', label: 'ë‚˜íŠ¸ë¥¨', unit: 'mg', unitOptions: ['mg', 'g'], required: true },
    // ì¶”ê°€ ì˜ì–‘ì„±ë¶„
    { field: 'dietary_fiber', label: 'ì‹ì´ì„¬ìœ ', unit: 'g', unitOptions: ['g'] },
    { field: 'calcium', label: 'ì¹¼ìŠ˜', unit: 'mg', unitOptions: ['mg', 'Î¼g'] },
    { field: 'iron', label: 'ì² ', unit: 'mg', unitOptions: ['mg', 'Î¼g'] },
    { field: 'magnesium', label: 'ë§ˆê·¸ë„¤ìŠ˜', unit: 'mg', unitOptions: ['mg'] },
    { field: 'phosphorus', label: 'ì¸', unit: 'mg', unitOptions: ['mg'] },
    { field: 'potassium', label: 'ì¹¼ë¥¨', unit: 'mg', unitOptions: ['mg', 'g'] },
    { field: 'zinc', label: 'ì•„ì—°', unit: 'mg', unitOptions: ['mg', 'Î¼g'] },
    { field: 'vitamin_a', label: 'ë¹„íƒ€ë¯¼A', unit: 'Î¼g RAE', unitOptions: ['Î¼g RAE', 'Î¼g', 'IU'] },
    { field: 'vitamin_d', label: 'ë¹„íƒ€ë¯¼D', unit: 'Î¼g', unitOptions: ['Î¼g', 'IU'] },
    { field: 'vitamin_c', label: 'ë¹„íƒ€ë¯¼C', unit: 'mg', unitOptions: ['mg'] },
    { field: 'thiamine', label: 'í‹°ì•„ë¯¼', unit: 'mg', unitOptions: ['mg'] },
    { field: 'riboflavin', label: 'ë¦¬ë³´í”Œë¼ë¹ˆ', unit: 'mg', unitOptions: ['mg'] },
    { field: 'niacin', label: 'ë‹ˆì•„ì‹ ', unit: 'mg NE', unitOptions: ['mg NE', 'mg'] },
    { field: 'vitamin_b6', label: 'ë¹„íƒ€ë¯¼B6', unit: 'mg', unitOptions: ['mg'] },
    { field: 'folic_acid', label: 'ì—½ì‚°', unit: 'Î¼g DFE', unitOptions: ['Î¼g DFE', 'Î¼g'] },
    { field: 'vitamin_b12', label: 'ë¹„íƒ€ë¯¼B12', unit: 'Î¼g', unitOptions: ['Î¼g'] }
];

// ì»¨í…Œì´ë„ˆ ë„ˆë¹„ ê¸°ì¤€ ë¹„ìœ¨ ì½œë„ˆë¹„ ê³„ì‚°
// ë¹„ìœ¨: ì˜ì–‘ì„±ë¶„ëª…(30%) : í•¨ëŸ‰(27%) : ë‹¨ìœ„(20%) : íŒì •(23%)
function getNutritionColWidths() {
    const container = document.getElementById('grid-container');
    const w = (container && container.clientWidth > 10) ? container.clientWidth : 600;
    const ratios = [0.30, 0.27, 0.20, 0.23];
    return ratios.map(r => Math.max(60, Math.floor(w * r)));
}

// Handsontable ì´ˆê¸°í™” - ì„¸ë¡œ í˜•ì‹ (25ê°œ í–‰)
function initGrid() {
    const container = document.getElementById('nutrition-grid');
    
    // ê° ì˜ì–‘ì„±ë¶„ì„ í•˜ë‚˜ì˜ í–‰ìœ¼ë¡œ êµ¬ì„±
    const data = ALL_NUTRIENTS.map(nutrient => [
        nutrient.label + (nutrient.required ? ' *' : ''),
        '',
        nutrient.unit,
        ''
    ]);
    
    hot = new Handsontable(container, {
        data: data,
        colHeaders: ['ì˜ì–‘ì„±ë¶„', 'í•¨ëŸ‰ (100gë‹¹)', 'ë‹¨ìœ„', 'ê°•ì¡°í‘œì‹œ íŒì •'],
        readOnly: !CAN_EDIT,
        columns: [
            {
                type: 'text',
                readOnly: true
            },
            {
                type: 'numeric',
                numericFormat: { pattern: '0.00' },
                readOnly: !CAN_EDIT
            },
            {
                type: 'dropdown',
                source: function(query, process) {
                    const row = this.row;
                    const nutrient = ALL_NUTRIENTS[row];
                    process(nutrient.unitOptions);
                },
                readOnly: !CAN_EDIT
            },
            {
                type: 'text',
                readOnly: true
            }
        ],
        rowHeaders: false,
        rowHeights: 22,
        height: 'auto',
        width: '100%',
        stretchH: 'all',
        licenseKey: 'non-commercial-and-evaluation',
        contextMenu: false,
        manualRowResize: false,
        manualColumnResize: false,
        autoWrapRow: false,
        autoWrapCol: false,
        colWidths: getNutritionColWidths(),
        afterChange: function(changes, source) {
            if (source === 'loadData' || source === 'internal') {
                return;
            }
            calculateAndPreview();
        }
    });

    // ì»¨í…Œì´ë„ˆ í¬ê¸° ë³€ê²½ ì‹œ ì»¬ëŸ¼ ë„ˆë¹„ ìë™ ì¬ê³„ì‚° (ë°˜ì‘í˜•)
    const gridContainer = document.getElementById('grid-container');
    if (gridContainer && window.ResizeObserver) {
        let resizeTimer;
        const resizeObserver = new ResizeObserver(() => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(() => {
                if (hot) {
                    hot.updateSettings({ colWidths: getNutritionColWidths() });
                    hot.render();
                }
            }, 50);
        });
        resizeObserver.observe(gridContainer);
    }
}

// ê·¸ë¦¬ë“œ ë°ì´í„°ë¥¼ ì˜ì–‘ì„±ë¶„ ê°ì²´ë¡œ ë³€í™˜
function getGridNutritionData() {
    const data = hot.getData();
    const nutritionData = {};
    
    ALL_NUTRIENTS.forEach((nutrient, index) => {
        if (index < data.length) {
            // ìˆ«ìë¡œ ë³€í™˜í•´ì„œ ì €ì¥
            const numericValue = getNumericValue(data[index][1]);
            if (numericValue !== null) {
                nutritionData[nutrient.field] = Math.round(numericValue * 100) / 100;
            } else {
                nutritionData[nutrient.field] = ''; // ë¹ˆ ê°’ì´ë©´ ë¹ˆ ë¬¸ìì—´
            }
        }
    });
    
    return nutritionData;
}

function getNumericValue(value) {
    if (value === null || value === undefined || value === '') {
        return null;
    }
    const parsed = parseFloat(String(value).replace(/,/g, ''));
    return Number.isNaN(parsed) ? null : parsed;
}

function getGridNutritionInputs() {
    const data = hot.getData();
    const nutritionInputs = {};
    
    ALL_NUTRIENTS.forEach((nutrient, index) => {
        if (index < data.length) {
            const numericValue = getNumericValue(data[index][1]);
            if (numericValue !== null) {
                nutritionInputs[nutrient.field] = Math.round(numericValue * 100) / 100;
            }
        }
    });
    
    return nutritionInputs;
}

// ì˜ì–‘ì„±ë¶„ ê°ì²´ë¥¼ ê·¸ë¦¬ë“œì— ë¡œë“œ
function setGridNutritionData(nutritionData) {
    // ê° ì˜ì–‘ì„±ë¶„ì„ ìœ„í•œ ìƒˆë¡œìš´ ë°ì´í„° ë°°ì—´ ìƒì„± (4ê°œ ì—´ í¬í•¨)
    const data = ALL_NUTRIENTS.map(nutrient => [
        nutrient.label + (nutrient.required ? ' *' : ''),
        nutritionData[nutrient.field] || '',  // value ì»¬ëŸ¼ (ìˆìœ¼ë©´ ë¡œë“œ, ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´)
        nutrient.unit,
        ''  // ê°•ì¡°í‘œì‹œ íŒì • (ì´ˆê¸°ì—ëŠ” ë¹„ì›€, calculateAndPreviewì—ì„œ ì—…ë°ì´íŠ¸)
    ]);
    
    hot.loadData(data);
}

// ë¯¸ë¦¬ë³´ê¸° ìŠ¤íƒ€ì¼ ì„¤ì •
function setPreviewStyle(style) {
    currentPreviewStyle = style;
    document.getElementById('nutrition_display_unit').value = style;
    document.querySelectorAll('#styleButtons .style-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.style === style);
    });
    document.getElementById('basicDisplayTypeGroup').style.display = style === 'basic' ? 'flex' : 'none';
    document.getElementById('parallelDisplayTypeGroup').style.display = style === 'parallel' ? 'flex' : 'none';
    calculateAndPreview();
}

function setBasicDisplayType(value) {
    document.getElementById('basic_display_type').value = value;
    document.querySelectorAll('[data-basic]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.basic === value);
    });
    calculateAndPreview();
}

function setParallelDisplayType(value) {
    document.getElementById('parallel_display_type').value = value;
    document.querySelectorAll('[data-parallel]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.parallel === value);
    });
    calculateAndPreview();
}

function bindPreviewControls() {
    document.querySelectorAll('[data-style]').forEach(btn => {
        btn.addEventListener('click', () => setPreviewStyle(btn.dataset.style));
    });
    document.querySelectorAll('[data-basic]').forEach(btn => {
        btn.addEventListener('click', () => setBasicDisplayType(btn.dataset.basic));
    });
    document.querySelectorAll('[data-parallel]').forEach(btn => {
        btn.addEventListener('click', () => setParallelDisplayType(btn.dataset.parallel));
    });
    document.getElementById('nutrition_display_unit').addEventListener('change', (event) => {
        setPreviewStyle(event.target.value);
    });
}

// ê°•ì¡°í‘œì‹œ íŒì • ê²°ê³¼ë¥¼ Handsontable 4ë²ˆì§¸ ì—´ì— ì—…ë°ì´íŠ¸
function updateEmphasisColumn() {
    const nutritionInputs = getGridNutritionInputs();
    
    ALL_NUTRIENTS.forEach((nutrient, index) => {
        const value = nutritionInputs[nutrient.field] || 0;
        let emphasisLabels = [];
        
        // ê°•ì¡°í‘œì‹œ íŒì • ë¡œì§
        if (value > 0 && window.EMPHASIS_CRITERIA) {
            // ë¬´ í•¨ìœ  ê¸°ì¤€ í™•ì¸
            if (window.EMPHASIS_CRITERIA.free && window.EMPHASIS_CRITERIA.free[nutrient.field]) {
                if (value < window.EMPHASIS_CRITERIA.free[nutrient.field].threshold) {
                    emphasisLabels.push(window.EMPHASIS_CRITERIA.free[nutrient.field].label);
                }
            }
            
            // ì € í•¨ìœ  ê¸°ì¤€ í™•ì¸
            if (window.EMPHASIS_CRITERIA.low && window.EMPHASIS_CRITERIA.low[nutrient.field]) {
                if (value <= window.EMPHASIS_CRITERIA.low[nutrient.field].threshold) {
                    emphasisLabels.push(window.EMPHASIS_CRITERIA.low[nutrient.field].label);
                }
            }
            
            // ê³  í•¨ìœ  ê¸°ì¤€ í™•ì¸
            if (window.EMPHASIS_CRITERIA.high && window.EMPHASIS_CRITERIA.high[nutrient.field]) {
                if (value >= window.EMPHASIS_CRITERIA.high[nutrient.field].threshold) {
                    emphasisLabels.push(window.EMPHASIS_CRITERIA.high[nutrient.field].label);
                }
            }
        }
        
        const emphasisLabel = emphasisLabels.join(', ');
        
        // 4ë²ˆì§¸ ì—´(index 3)ì— ê° ì…€ì„ ê°œë³„ì ìœ¼ë¡œ ì—…ë°ì´íŠ¸
        hot.setDataAtCell(index, 3, emphasisLabel, 'internal');
    });
}

// ë¯¸ë¦¬ë³´ê¸° ê³„ì‚° ë° ê°±ì‹ 
function calculateAndPreview() {
    const baseAmount = parseFloat(document.getElementById('serving_size').value.replace(/,/g, '')) || 100;
    const servingsPerPackage = parseFloat(document.getElementById('units_per_package').value.replace(/,/g, '')) || 1;
    const style = document.getElementById('nutrition_display_unit').value || 'basic';
    const nutritionInputs = getGridNutritionInputs();
    
    // ê°•ì¡°í‘œì‹œ íŒì • í•­ìƒ ì—…ë°ì´íŠ¸
    updateEmphasisColumn();
    
    if (Object.keys(nutritionInputs).length === 0) {
        document.getElementById('resultDisplay').innerHTML = '<div class="empty-result">ì˜ì–‘ì„±ë¶„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>';
        return;
    }
    
    let displayHTML = '';
    if (style === 'parallel') {
        displayHTML = window.generateParallelDisplayV3(nutritionInputs, baseAmount, servingsPerPackage);
    } else {
        displayHTML = window.generateBasicDisplayV3(nutritionInputs, baseAmount, servingsPerPackage);
    }
    
    document.getElementById('resultDisplay').innerHTML = displayHTML;
}

// ê°„ë‹¨í•œ ë¯¸ë¦¬ë³´ê¸° ìƒì„± (V1 ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì‹¤íŒ¨ ì‹œ)
function createSimplePreview(nutritionData) {
    calculateAndPreview();
}

// ë°ì´í„° ë¡œë“œ
async function loadData() {
    updateStatus('â³ ë°ì´í„° ë¡œë“œ ì¤‘...');
    updateLabelIdDisplay();
    
    try {
        // LABEL_ID í™•ì¸
        if (!LABEL_ID || isNaN(LABEL_ID)) {
            const errMsg = 'ë¼ë²¨ IDê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. LABEL_ID: ' + LABEL_ID;
            updateStatus('âŒ ' + errMsg);
            throw new Error(errMsg);
        }
        
        const apiUrl = API_NUTRITION_LOAD_URL;
        updateStatus(`ğŸ“¡ API í˜¸ì¶œ ì¤‘: ${apiUrl}`);
        
        const response = await fetch(apiUrl);
        updateStatus(`ğŸ“¡ ì‘ë‹µ ë°›ìŒ: ${response.status}`);
        
        if (!response.ok) {
            const errorText = await response.text();
            updateStatus(`âŒ API ì˜¤ë¥˜ (${response.status}): ${errorText.substring(0, 50)}`);
            throw new Error(`API ì‘ë‹µ ì˜¤ë¥˜ (${response.status}): ${errorText}`);
        }
        
        const data = await response.json();
        updateStatus('âœ… ë°ì´í„° ìˆ˜ì‹  ì™„ë£Œ');
        
        // ê¸°ë³¸ ì„¤ì •
        document.getElementById('serving_size').value = data.serving_size || '100';
        document.getElementById('serving_size_unit').value = data.serving_size_unit || 'g';
        document.getElementById('units_per_package').value = data.units_per_package || '1';
        document.getElementById('nutrition_display_unit').value = data.nutrition_display_unit || 'basic';

        // í‘œì‹œê¸°ì¤€ ë³µì› (ì €ì¥ëœ ê°’ì´ ìˆìœ¼ë©´ ë³µì›)
        if (data.basic_display_type) {
            document.getElementById('basic_display_type').value = data.basic_display_type;
            document.querySelectorAll('[data-basic]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.basic === data.basic_display_type);
            });
        }
        if (data.parallel_display_type) {
            document.getElementById('parallel_display_type').value = data.parallel_display_type;
            document.querySelectorAll('[data-parallel]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.parallel === data.parallel_display_type);
            });
        }

        updateStatus('âœ… ê¸°ë³¸ ì„¤ì • ì™„ë£Œ');
        
        // ê·¸ë¦¬ë“œì— ì˜ì–‘ì„±ë¶„ ë°ì´í„° ë¡œë“œ
        setGridNutritionData(data);
        updateStatus('âœ… ê·¸ë¦¬ë“œ ë°ì´í„° ë¡œë“œ ì™„ë£Œ');
        
        // ìŠ¤íƒ€ì¼ ì„¤ì • ë° ë¯¸ë¦¬ë³´ê¸° ê³„ì‚° (ë°ì´í„° ë¡œë“œ í›„ í•œ ë²ˆë§Œ)
        setPreviewStyle(document.getElementById('nutrition_display_unit').value || 'basic');
        updateStatus('âœ… ì´ˆê¸°í™” ì™„ë£Œ');
        
    } catch (error) {
        updateStatus(`âŒ ì˜¤ë¥˜: ${error.message}`);
        showSnackbar('ì˜ì–‘ì„±ë¶„ ë°ì´í„° ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
    }
}

// ë°ì´í„° ì €ì¥
async function saveData() {
    if (!CAN_EDIT) {
        showSnackbar('ì˜ì–‘ì„±ë¶„ í¸ì§‘ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. í˜„ì¬ ì—­í• ë¡œëŠ” ì˜ì–‘ì„±ë¶„ì„ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'warning');
        return;
    }
    try {
        const nutritionData = getGridNutritionData();

        // ì‰¼í‘œ ì œê±° í›„ ìˆ«ìë³€í™˜, ë¹ˆ ê°’ì´ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©
        const rawServingSize = parseFloat(String(document.getElementById('serving_size').value).replace(/,/g, ''));
        const rawUnits = parseFloat(String(document.getElementById('units_per_package').value).replace(/,/g, ''));

        const payload = {
            label_id: LABEL_ID,
            serving_size: isNaN(rawServingSize) ? '100' : String(rawServingSize),
            serving_size_unit: document.getElementById('serving_size_unit').value || 'g',
            units_per_package: isNaN(rawUnits) ? '1' : String(rawUnits),
            nutrition_display_unit: document.getElementById('nutrition_display_unit').value || 'basic',
            basic_display_type: document.getElementById('basic_display_type').value || 'total',
            parallel_display_type: document.getElementById('parallel_display_type').value || 'unit_total',
            ...nutritionData
        };
        
        const csrfToken = getCookie('csrftoken');
        
        const response = await fetch(API_NUTRITION_SAVE_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(payload)
        });
        
        if (!response.ok) {
            const errBody = await response.text().catch(() => '');
            console.error('[NutritionEditor] saveData API ì˜¤ë¥˜:', response.status, errBody);
            throw new Error(`ì €ì¥ ì‹¤íŒ¨ (${response.status})`);
        }
        
        const result = await response.json();

        // ë¶€ëª¨(product_detail) ì•ˆì— ìˆìœ¼ë©´ ë¶€ëª¨ Snackbar ì‚¬ìš©, ë‹¨ë… ì‹¤í–‰ ì‹œ ìì²´ Snackbar
        if (window.parent && window.parent !== window) {
            window.parent.postMessage({
                type: 'nutritionSaved',
                message: 'ì˜ì–‘ì„±ë¶„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.',
                labelId: LABEL_ID
            }, '*');
        } else {
            showSnackbar('ì˜ì–‘ì„±ë¶„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }
        
    } catch (error) {
        console.error('[NutritionEditor] saveData ì˜¤ë¥˜:', error);
        showSnackbar('ì˜ì–‘ì„±ë¶„ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
    }
}

// CSRF í† í° ê°€ì ¸ì˜¤ê¸°
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// ë¶€ëª¨ ì°½ì—ì„œ ì €ì¥ ìš”ì²­ ë°›ê¸°
window.addEventListener('message', function(event) {
    if (event.data && event.data.action === 'save') {
        saveData();
    }
});

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
    // ì´ˆê¸° ìƒíƒœ í‘œì‹œ
    updateLabelIdDisplay();
    updateStatus('â³ ì´ˆê¸°í™” ì¤‘...');
    
    // ê¸°ë³¸ê°’ìœ¼ë¡œ ì…ë ¥ í•„ë“œ ì´ˆê¸°í™” (placeholderê°€ ì•„ë‹Œ ì‹¤ì œ ê°’)
    document.getElementById('serving_size').value = '100';
    document.getElementById('units_per_package').value = '1';

    try {
        initGrid();
        updateStatus('âœ… ê·¸ë¦¬ë“œ ì´ˆê¸°í™” ì™„ë£Œ');
    } catch (error) {
        updateStatus('âŒ ê·¸ë¦¬ë“œ ì´ˆê¸°í™” ì˜¤ë¥˜: ' + error.message);
    }
    
    try {
        bindPreviewControls();
    } catch (error) {
        // ë¬´ì‹œ
    }
    
    // ë‹¨ìœ„ëŸ‰Â·í¬ì¥ê°œìˆ˜ ë³€ê²½ ì‹œ ì¦‰ì‹œ ë¯¸ë¦¬ë³´ê¸° ë°˜ì˜
    ['serving_size', 'units_per_package'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.addEventListener('input', () => calculateAndPreview());
            el.addEventListener('change', () => calculateAndPreview());
        }
    });
    
    try {
        loadData();
    } catch (error) {
        updateStatus('âŒ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜: ' + error.message);
    }
});
</script>

<!-- êµ¬ê¸€ Material Snackbar -->
<div id="v2Snackbar" aria-live="polite">
  <span id="v2SnackbarMsg"></span>
  <button onclick="hideSnackbar()">ë‹«ê¸°</button>
</div>
<script>
(function(){
  var _t = null;
  window.showSnackbar = function(message, type) {
    var el = document.getElementById('v2Snackbar');
    var msg = document.getElementById('v2SnackbarMsg');
    if (!el || !msg) return;
    if (_t) { clearTimeout(_t); _t = null; }
    el.classList.remove('snack-show','snack-error','snack-warning');
    msg.textContent = message;
    if (type === 'error') el.classList.add('snack-error');
    else if (type === 'warning') el.classList.add('snack-warning');
    void el.offsetWidth;
    el.classList.add('snack-show');
    _t = setTimeout(window.hideSnackbar, (type==='error'||type==='warning') ? 6000 : 4000);
  };
  window.hideSnackbar = function() {
    var el = document.getElementById('v2Snackbar');
    if (el) el.classList.remove('snack-show','snack-error','snack-warning');
    if (_t) { clearTimeout(_t); _t = null; }
  };
})();
</script>

</body>
</html>
