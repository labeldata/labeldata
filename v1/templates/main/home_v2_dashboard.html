{% extends "base_v2.html" %}
{% load static %}

{% block title %}홈 대시보드 - Food Data Portal{% endblock %}

{% block topbar %}
<div class="v2-topbar-title-wrapper">
    {% if is_guest %}
    <a href="{% url 'main:home_dashboard' %}" class="guest-gnb-logo">
        <i class="bi bi-grid-3x3-gap-fill me-2" style="color:#1967d2;"></i>Food Data Portal
    </a>
    {% else %}
    <span class="fw-semibold" style="font-size:15px; color:#1f1f1f;">홈</span>
    {% endif %}
</div>
{% include "includes/_topbar_account.html" %}
{% endblock %}

{% block extra_css %}
<link href="{% static 'css/home_v2_dashboard.css' %}?v={{ STATIC_BUILD_DATE }}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="dashboard-wrap">

    {% if is_guest %}
    <!-- ════════════════════════════════════════════════════
         히어로 배너
    ════════════════════════════════════════════════════ -->
    <div class="hero-banner">
        <div class="hero-content">
            <div class="hero-eyebrow"><i class="bi bi-patch-check-fill me-1"></i>식품 라벨 통합 관리 플랫폼</div>
            <h1 class="hero-title">표시사항부터 출시까지<br>하나의 워크플로우로</h1>
            <p class="hero-desc">
                협력업체 문서 수집 → 원료·BOM 구성 → 규정 검증 → 최종 승인까지<br>
                팀 전원이 역할에 맞게 참여하고 실시간으로 협업합니다.
            </p>
            <div class="hero-trust">
                <span><i class="bi bi-shield-check me-1" style="color:#4ade80;"></i>식품법규 기반 검증</span>
                <span><i class="bi bi-people me-1" style="color:#93c5fd;"></i>팀 협업 지원</span>
                <span><i class="bi bi-file-earmark-pdf me-1" style="color:#f87171;"></i>PDF 출력</span>
            </div>
        </div>
        <div class="hero-visual" aria-hidden="true">
            <svg viewBox="0 0 380 220" xmlns="http://www.w3.org/2000/svg">
                <rect width="380" height="220" rx="12" fill="white"/>
                <rect width="380" height="32" rx="0" fill="#f8f9fa"/>
                <rect y="0" width="380" height="32" rx="12" fill="#f8f9fa"/>
                <rect y="20" width="380" height="12" fill="#f8f9fa"/>
                <circle cx="14" cy="16" r="4" fill="#ff5f57"/>
                <circle cx="26" cy="16" r="4" fill="#febc2e"/>
                <circle cx="38" cy="16" r="4" fill="#28c840"/>
                <rect x="56" y="11" width="70" height="9" rx="4.5" fill="#e2e4e7"/>
                <rect x="300" y="10" width="66" height="11" rx="5.5" fill="#1967d2"/>
                <rect x="0" y="32" width="64" height="188" fill="#f1f3f4"/>
                <rect x="10" y="46" width="44" height="5" rx="2.5" fill="#1967d2"/>
                <rect x="10" y="60" width="38" height="4" rx="2" fill="#d1d5db"/>
                <rect x="10" y="72" width="40" height="4" rx="2" fill="#d1d5db"/>
                <rect x="10" y="84" width="32" height="4" rx="2" fill="#d1d5db"/>
                <rect x="10" y="100" width="44" height="1" fill="#e0e2e0"/>
                <rect x="10" y="108" width="38" height="4" rx="2" fill="#d1d5db"/>
                <rect x="10" y="120" width="34" height="4" rx="2" fill="#d1d5db"/>
                <rect x="76" y="40" width="62" height="40" rx="7" fill="#e8f0fe"/>
                <text x="107" y="58" text-anchor="middle" fill="#1967d2" font-size="13" font-weight="700">24</text>
                <text x="107" y="70" text-anchor="middle" fill="#5f6368" font-size="6">내 제품</text>
                <rect x="146" y="40" width="62" height="40" rx="7" fill="#e6f4ea"/>
                <text x="177" y="58" text-anchor="middle" fill="#1e8e3e" font-size="13" font-weight="700">8</text>
                <text x="177" y="70" text-anchor="middle" fill="#5f6368" font-size="6">협업 중</text>
                <rect x="216" y="40" width="62" height="40" rx="7" fill="#fce8e6"/>
                <text x="247" y="58" text-anchor="middle" fill="#c5221f" font-size="13" font-weight="700">3</text>
                <text x="247" y="70" text-anchor="middle" fill="#5f6368" font-size="6">검토 대기</text>
                <rect x="286" y="40" width="82" height="40" rx="7" fill="#fef7e0"/>
                <text x="327" y="58" text-anchor="middle" fill="#c77700" font-size="13" font-weight="700">12</text>
                <text x="327" y="70" text-anchor="middle" fill="#5f6368" font-size="6">승인 완료</text>
                <rect x="76" y="90" width="292" height="42" rx="7" fill="#f8f9fa"/>
                <text x="88" y="104" fill="#3c4043" font-size="7" font-weight="600">제품 진행상태</text>
                <rect x="88" y="110" width="28" height="4" rx="2" fill="#1967d2" opacity="0.4"/>
                <text x="120" y="114" fill="#5f6368" font-size="6">작성 중 5</text>
                <rect x="88" y="118" width="18" height="4" rx="2" fill="#0f9d58" opacity="0.5"/>
                <text x="110" y="122" fill="#5f6368" font-size="6">제출완료 8</text>
                <rect x="76" y="142" width="292" height="22" rx="5" fill="#f8f9fa"/>
                <rect x="84" y="149" width="10" height="8" rx="2" fill="#e8f0fe"/>
                <rect x="98" y="151" width="70" height="4" rx="2" fill="#d1d5db"/>
                <rect x="176" y="151" width="28" height="4" rx="2" fill="#c8e6c9"/>
                <rect x="76" y="170" width="292" height="22" rx="5" fill="#f8f9fa"/>
                <rect x="84" y="177" width="10" height="8" rx="2" fill="#f3e8fd"/>
                <rect x="98" y="179" width="60" height="4" rx="2" fill="#d1d5db"/>
                <rect x="166" y="179" width="36" height="4" rx="2" fill="#fde68a"/>
                <rect x="76" y="198" width="292" height="8" rx="4" fill="#f1f3f4"/>
            </svg>
        </div>
    </div><!-- /.hero-banner -->

    <!-- ════════════════════════════════════════════════════
         주요 기능 소개
    ════════════════════════════════════════════════════ -->
    <div class="features-section">
        <div class="section-label"><i class="bi bi-stars me-2 text-primary"></i>주요 기능</div>
        <div class="features-grid">
            <div class="feature-card">
                <div class="fc-icon si-blue"><i class="bi bi-hdd-stack"></i></div>
                <div class="fc-title">제품 통합 관리</div>
                <div class="fc-desc">표시사항·BOM·문서·영양성분을 하나의 제품 카드에서 관리합니다.</div>
                <span class="fc-badge fc-badge-blue" style="margin-top:auto;">핵심 기능</span>
            </div>
            <div class="feature-card">
                <div class="fc-icon si-green"><i class="bi bi-people-fill"></i></div>
                <div class="fc-title">공동 작업 & 권한 관리</div>
                <div class="fc-desc">편집·검토·승인 권한을 팀원에게 부여하고 실시간으로 협업하세요.</div>
                <span class="fc-badge fc-badge-green" style="margin-top:auto;">협업</span>
            </div>
            <div class="feature-card">
                <div class="fc-icon si-yellow"><i class="bi bi-file-earmark-check"></i></div>
                <div class="fc-title">표시사항 작성 & 검증</div>
                <div class="fc-desc">식품 법규 기반 자동 검증으로 오류 없이 표시사항을 완성합니다.</div>
                <span class="fc-badge fc-badge-yellow" style="margin-top:auto;">규정 검증</span>
            </div>
            <div class="feature-card">
                <div class="fc-icon fc-icon-teal"><i class="bi bi-box-seam"></i></div>
                <div class="fc-title">원료 & BOM 관리</div>
                <div class="fc-desc">원재료 DB에서 원료를 등록하고 배합비를 구성합니다.</div>
                <span class="fc-badge fc-badge-teal" style="margin-top:auto;">원재료</span>
            </div>
            <div class="feature-card">
                <div class="fc-icon si-purple"><i class="bi bi-bell-fill"></i></div>
                <div class="fc-title">알림 & 문서 인박스</div>
                <div class="fc-desc">공유 요청, 상태 변경, 문서 만료를 실시간 알림으로 받아보세요.</div>
                <span class="fc-badge fc-badge-purple" style="margin-top:auto;">알림</span>
            </div>
            <div class="feature-card">
                <div class="fc-icon si-red"><i class="bi bi-search"></i></div>
                <div class="fc-title">식품 DB 조회</div>
                <div class="fc-desc">국내·수입 식품 공개 DB를 검색해 참고 정보를 활용하세요.</div>
                <span class="fc-badge fc-badge-red" style="margin-top:auto;">DB</span>
            </div>
        </div>
    </div><!-- /.features-section -->

    <!-- ════════════════════════════════════════════════════
         협업 워크플로우 파이프라인
    ════════════════════════════════════════════════════ -->
    <div class="pipeline-section">
        <div class="section-label"><i class="bi bi-diagram-3-fill me-2 text-primary"></i>협업 워크플로우</div>
        <p class="pipeline-subtitle">각 역할이 연결된 하나의 흐름으로 제품을 완성합니다</p>
        <div class="pipeline-track">

            <!-- STEP 1 -->
            <div class="pipe-node pn-green">
                <div class="pipe-step-badge pn-green-badge">1</div>
                <div class="pipe-node-inner">
                    <div class="pipe-node-icon pn-green"><i class="bi bi-building"></i></div>
                    <div class="pipe-node-role">협력업체 관리자</div>
                    <span class="pipe-node-badge">자료 제출 권한</span>
                    <ul class="pipe-node-list">
                        <li class="pipe-key"><i class="bi bi-check2"></i><strong>규격서·성적서 업로드</strong></li>
                        <li><i class="bi bi-check2"></i>연락처 등록 및 관리</li>
                        <li><i class="bi bi-check2"></i>문서 요청 이메일 수신</li>
                        <li><i class="bi bi-check2"></i>제출 현황 실시간 확인</li>
                    </ul>
                </div>
            </div>

            <!-- 커넥터 1→2 -->
            <div class="pipe-connector-wrap">
                <div class="pcc-row">
                    <div class="pipe-connector-line"></div>
                    <i class="bi bi-caret-right-fill pipe-connector-arrow"></i>
                </div>
                <div class="pipe-connector-label">규격서·성적서 제출</div>
            </div>

            <!-- STEP 2 -->
            <div class="pipe-node pn-blue">
                <div class="pipe-step-badge pn-blue-badge">2</div>
                <div class="pipe-node-inner">
                    <div class="pipe-node-icon pn-blue"><i class="bi bi-pencil-square"></i></div>
                    <div class="pipe-node-role">표시사항 작성자</div>
                    <span class="pipe-node-badge">공동 편집 권한</span>
                    <ul class="pipe-node-list">
                        <li class="pipe-key"><i class="bi bi-check2"></i><strong>원료·BOM 구성 완성</strong></li>
                        <li><i class="bi bi-check2"></i>제품 프로젝트 생성</li>
                        <li><i class="bi bi-check2"></i>협력업체 문서 요청</li>
                        <li><i class="bi bi-check2"></i>품질 담당자에 검증 요청</li>
                    </ul>
                </div>
            </div>

            <!-- 커넥터 2→3 -->
            <div class="pipe-connector-wrap">
                <div class="pcc-row">
                    <div class="pipe-connector-line"></div>
                    <i class="bi bi-caret-right-fill pipe-connector-arrow"></i>
                </div>
                <div class="pipe-connector-label">검증 요청</div>
            </div>

            <!-- STEP 3 -->
            <div class="pipe-node pn-purple">
                <div class="pipe-step-badge pn-purple-badge">3</div>
                <div class="pipe-node-inner">
                    <div class="pipe-node-icon pn-purple"><i class="bi bi-clipboard2-check"></i></div>
                    <div class="pipe-node-role">품질 담당자</div>
                    <span class="pipe-node-badge">검토자 권한</span>
                    <ul class="pipe-node-list">
                        <li class="pipe-key"><i class="bi bi-check2"></i><strong>식품법규 자동 검증 확인</strong></li>
                        <li><i class="bi bi-check2"></i>표시사항·BOM 검토</li>
                        <li><i class="bi bi-check2"></i>의견·수정 요청 작성</li>
                        <li><i class="bi bi-check2"></i>검토 완료 후 출시 진행</li>
                    </ul>
                </div>
            </div>

            <!-- 커넥터 3→4 -->
            <div class="pipe-connector-wrap">
                <div class="pcc-row">
                    <div class="pipe-connector-line"></div>
                    <i class="bi bi-caret-right-fill pipe-connector-arrow"></i>
                </div>
                <div class="pipe-connector-label">최종 승인 요청</div>
            </div>

            <!-- STEP 4 -->
            <div class="pipe-node pn-orange">
                <div class="pipe-step-badge pn-orange-badge">4</div>
                <div class="pipe-node-inner">
                    <div class="pipe-node-icon pn-orange"><i class="bi bi-person-check-fill"></i></div>
                    <div class="pipe-node-role">제품 담당자</div>
                    <span class="pipe-node-badge">승인자 권한</span>
                    <ul class="pipe-node-list">
                        <li class="pipe-key"><i class="bi bi-check2"></i><strong>제품 최종 승인 처리</strong></li>
                        <li><i class="bi bi-check2"></i>전체 진행 현황 대시보드</li>
                        <li><i class="bi bi-check2"></i>검증 단계·의견 확인</li>
                        <li><i class="bi bi-check2"></i>표시사항 PDF 출력·출시</li>
                    </ul>
                </div>
            </div>

        </div><!-- /.pipeline-track -->
    </div><!-- /.pipeline-section -->

    {% else %}
    <!-- 컴팩트 헤더 스트립: 인사 + 만료 알림 + 퀵 액션 -->
    <div class="dash-hero">
        <div class="dash-hero-left">
            <div class="dash-greeting">안녕하세요, {{ request.user.username }}님 👋</div>
            <div class="dash-hero-meta">
                <span class="dash-sub">오늘도 Food Data Portal과 함께 제품 라벨 관리를 시작해보세요.</span>
                {% if expiring_count > 0 %}
                <a href="{% url 'products:product_explorer' %}" class="dash-alert-chip">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    {{ expiring_count }}건 만료 임박 →
                </a>
                {% endif %}
                {% if unread_notif_count > 0 %}
                <a href="{% url 'products:notification_list' %}" class="dash-notif-chip">
                    <i class="bi bi-bell-fill"></i>
                    알림 {{ unread_notif_count }}개
                </a>
                {% endif %}
            </div>
        </div>
        <div class="dash-hero-right">
            <a href="{% url 'products:product_create' %}" class="qa-btn primary">
                <i class="bi bi-plus-lg"></i> 신규 제품 등록
            </a>
            <a href="{% url 'products:product_explorer' %}" class="qa-btn">
                <i class="bi bi-hdd-stack"></i> 제품 목록
            </a>
            <a href="{% url 'label:my_label_list' %}" class="qa-btn">
                <i class="bi bi-file-earmark-text"></i> 표시사항 생성
            </a>
            <a href="{% url 'label:my_ingredient_list_combined' %}" class="qa-btn">
                <i class="bi bi-box-seam"></i> 원료 관리
            </a>
            <a href="{% url 'products:inbox' %}" class="qa-btn">
                <i class="bi bi-people"></i> 공동 작업
            </a>
        </div>
    </div>

    <!-- 통계 카드 4개 -->
    <div class="stats-grid">
        <a href="{% url 'products:product_explorer' %}?filter=MINE" class="stat-card">
            <div class="stat-icon si-blue"><i class="bi bi-box-seam"></i></div>
            <div>
                <div class="stat-val">{{ my_count }}</div>
                <div class="stat-lbl">내 제품</div>
            </div>
        </a>
        <a href="{% url 'products:product_explorer' %}?filter=COLLAB" class="stat-card">
            <div class="stat-icon si-green"><i class="bi bi-people-fill"></i></div>
            <div>
                <div class="stat-val">{{ collab_count }}</div>
                <div class="stat-lbl">협업 중 제품</div>
            </div>
        </a>
        <a href="{% url 'products:product_explorer' %}" class="stat-card">
            <div class="stat-icon si-yellow"><i class="bi bi-star-fill"></i></div>
            <div>
                <div class="stat-val">{{ starred_count }}</div>
                <div class="stat-lbl">즐겨찾기</div>
            </div>
        </a>
        <a href="{% url 'products:product_explorer' %}" class="stat-card">
            <div class="stat-icon si-red"><i class="bi bi-check-circle-fill"></i></div>
            <div>
                <div class="stat-val">{{ confirmed_count }}</div>
                <div class="stat-lbl">승인 완료</div>
            </div>
        </a>
    </div>

    <!-- 하단: 진행상태 + 최근 제품 -->
    <div class="bottom-grid">

        <!-- 진행상태 패널 -->
        <div class="panel-card">
            <div class="panel-header">
                <span class="panel-title"><i class="bi bi-bar-chart-fill me-2 text-primary"></i>제품 진행상태</span>
                {% if total_with_meta > 0 %}
                <span style="font-size:12px;color:#5f6368;">전체 {{ total_with_meta }}개</span>
                {% endif %}
            </div>
            <div class="panel-body">
                {% if total_with_meta == 0 %}
                <div class="text-center py-4">
                    <i class="bi bi-inbox" style="font-size:36px;color:#dadce0;"></i>
                    <p class="mt-2 text-muted" style="font-size:13px;">진행 중인 제품이 없습니다.</p>
                    <a href="{% url 'products:product_create' %}" class="btn btn-sm btn-primary mt-1">신규 등록</a>
                </div>
                {% else %}
                {% with max_val=total_with_meta %}
                <!-- 작성 중 -->
                <div class="status-row">
                    <div class="d-flex align-items-center gap-2" style="min-width:85px;">
                        <div class="status-dot" style="background:#1967d2;"></div>
                        <span style="font-size:12px;color:#5f6368;">작성 중</span>
                    </div>
                    <div class="status-bar-wrap">
                        <div class="status-bar-fill" style="background:#1967d2;width:{% if max_val > 0 %}{% widthratio status_counts.DRAFT max_val 100 %}%{% else %}0%{% endif %};"></div>
                    </div>
                    <span class="status-count">{{ status_counts.DRAFT }}</span>
                </div>
                <!-- 자료 요청 -->
                <div class="status-row">
                    <div class="d-flex align-items-center gap-2" style="min-width:85px;">
                        <div class="status-dot" style="background:#c77700;"></div>
                        <span style="font-size:12px;color:#5f6368;">자료 요청</span>
                    </div>
                    <div class="status-bar-wrap">
                        <div class="status-bar-fill" style="background:#c77700;width:{% if max_val > 0 %}{% widthratio status_counts.REQUESTING max_val 100 %}%{% else %}0%{% endif %};"></div>
                    </div>
                    <span class="status-count">{{ status_counts.REQUESTING }}</span>
                </div>
                <!-- 제출 완료 -->
                <div class="status-row">
                    <div class="d-flex align-items-center gap-2" style="min-width:85px;">
                        <div class="status-dot" style="background:#0f9d58;"></div>
                        <span style="font-size:12px;color:#5f6368;">제출 완료</span>
                    </div>
                    <div class="status-bar-wrap">
                        <div class="status-bar-fill" style="background:#0f9d58;width:{% if max_val > 0 %}{% widthratio status_counts.SUBMITTED max_val 100 %}%{% else %}0%{% endif %};"></div>
                    </div>
                    <span class="status-count">{{ status_counts.SUBMITTED }}</span>
                </div>
                <!-- 검토 중 -->
                <div class="status-row">
                    <div class="d-flex align-items-center gap-2" style="min-width:85px;">
                        <div class="status-dot" style="background:#9334e9;"></div>
                        <span style="font-size:12px;color:#5f6368;">검토 중</span>
                    </div>
                    <div class="status-bar-wrap">
                        <div class="status-bar-fill" style="background:#9334e9;width:{% if max_val > 0 %}{% widthratio status_counts.REVIEW max_val 100 %}%{% else %}0%{% endif %};"></div>
                    </div>
                    <span class="status-count">{{ status_counts.REVIEW }}</span>
                </div>
                <!-- 승인 대기 -->
                <div class="status-row">
                    <div class="d-flex align-items-center gap-2" style="min-width:85px;">
                        <div class="status-dot" style="background:#e37400;"></div>
                        <span style="font-size:12px;color:#5f6368;">승인 대기</span>
                    </div>
                    <div class="status-bar-wrap">
                        <div class="status-bar-fill" style="background:#e37400;width:{% if max_val > 0 %}{% widthratio status_counts.PENDING max_val 100 %}%{% else %}0%{% endif %};"></div>
                    </div>
                    <span class="status-count">{{ status_counts.PENDING }}</span>
                </div>
                <!-- 승인 완료 -->
                <div class="status-row">
                    <div class="d-flex align-items-center gap-2" style="min-width:85px;">
                        <div class="status-dot" style="background:#1e8e3e;"></div>
                        <span style="font-size:12px;color:#5f6368;">승인 완료</span>
                    </div>
                    <div class="status-bar-wrap">
                        <div class="status-bar-fill" style="background:#1e8e3e;width:{% if max_val > 0 %}{% widthratio status_counts.CONFIRMED max_val 100 %}%{% else %}0%{% endif %};"></div>
                    </div>
                    <span class="status-count">{{ status_counts.CONFIRMED }}</span>
                </div>
                {% endwith %}

                <!-- 전체 완료율 -->
                <div class="mt-3 pt-2 border-top">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span style="font-size:12px;color:#5f6368;">전체 승인 완료율</span>
                        <span style="font-size:13px;font-weight:700;color:{% if progress_pct >= 80 %}#1e8e3e{% elif progress_pct >= 40 %}#c77700{% else %}#c5221f{% endif %};">{{ progress_pct }}%</span>
                    </div>
                    <div style="height:8px;background:#f1f3f4;border-radius:4px;overflow:hidden;">
                        <div style="height:100%;border-radius:4px;width:{{ progress_pct }}%;
                            background:{% if progress_pct >= 80 %}#1e8e3e{% elif progress_pct >= 40 %}#c77700{% else %}#1967d2{% endif %};
                            transition:width 0.5s;"></div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- 최근 제품 패널 -->
        <div class="panel-card">
            <div class="panel-header">
                <span class="panel-title"><i class="bi bi-clock-history me-2 text-primary"></i>최근 수정 제품</span>
                <a href="{% url 'products:product_explorer' %}" style="font-size:12px;color:#1a73e8;text-decoration:none;">전체 보기</a>
            </div>
            <div class="panel-body">
                {% if recent_labels %}
                {% for label in recent_labels %}
                <a href="{% url 'products:product_detail_new' label.my_label_id %}" class="recent-item">
                    <div class="ri-icon"><i class="bi bi-file-earmark-text"></i></div>
                    <div style="min-width:0; flex:1;">
                        <div class="ri-name">{{ label.my_label_name|default:label.prdlst_nm|default:"(이름 없음)" }}</div>
                        <div class="ri-sub">{{ label.update_datetime|date:"Y.m.d H:i" }} 수정</div>
                    </div>
                    <i class="bi bi-chevron-right" style="font-size:12px;color:#bdc1c6;flex-shrink:0;"></i>
                </a>
                {% endfor %}
                {% else %}
                <div class="text-center py-4">
                    <i class="bi bi-inbox" style="font-size:36px;color:#dadce0;"></i>
                    <p class="mt-2 text-muted" style="font-size:13px;">아직 등록된 제품이 없습니다.</p>
                    <a href="{% url 'products:product_create' %}" class="btn btn-sm btn-primary mt-1">첫 제품 등록하기</a>
                </div>
                {% endif %}
            </div>
        </div>

    </div><!-- /.bottom-grid -->
    {% endif %}{# end is_guest/not is_guest #}


</div><!-- /.dashboard-wrap -->
{% endblock %}
