{% url action_url as target_url %}
<form id="searchFilterForm" method="get" action="{{ target_url }}" style="width:100%;max-width:100%;">
  <div class="search-filter-row d-flex align-items-center mb-3" style="font-size: 0.8rem; width:100%; max-width:100%;">
    <div class="search-filter-inner d-flex align-items-center flex-nowrap gap-2 w-100 justify-content-between" style="font-size: 0.8rem; width:100%; max-width:100%; overflow-x:auto;">
      {% if page_type == "product" %}
        <div style="min-width:110px;max-width:120px;flex:0 0 120px;">
          <select name="food_category" id="foodCategorySelect" class="form-select" style="font-size: 0.8rem;"
            onchange="this.form.submit()">
            <option value="domestic" {% if food_category == "domestic" %}selected{% endif %}>국내제품</option>
            <option value="imported" {% if food_category == "imported" %}selected{% endif %}>수입제품</option>
          </select>
        </div>
        {% if food_category == "imported" %}
          <input type="text" name="prdlst_nm" class="form-control flex-grow-1" style="font-size: 0.8rem; min-width:110px; max-width:180px;" placeholder="제품명" value="{{ search_values.prdlst_nm|default_if_none:'' }}">
          <input type="text" name="prdlst_dcnm" class="form-control flex-grow-1" style="font-size: 0.8rem; min-width:110px; max-width:180px;" placeholder="식품유형" value="{{ search_values.prdlst_dcnm|default_if_none:'' }}">
          <input type="text" name="xport_ntncd_nm" class="form-control flex-grow-1" style="font-size: 0.8rem; min-width:110px; max-width:180px;" placeholder="수출국" value="{{ search_values.xport_ntncd_nm|default_if_none:'' }}">
          <input type="text" name="bsn_ofc_name" class="form-control flex-grow-1" style="font-size: 0.8rem; min-width:110px; max-width:180px;" placeholder="수입업체" value="{{ search_values.bsn_ofc_name|default_if_none:'' }}">
          <input type="text" name="bssh_nm" class="form-control flex-grow-1" style="font-size: 0.8rem; min-width:110px; max-width:180px;" placeholder="제조사명" value="{{ search_values.bssh_nm|default_if_none:'' }}">
          <input type="text" name="pog_daycnt" class="form-control flex-grow-1" style="font-size: 0.8rem; min-width:110px; max-width:180px;" placeholder="소비기한" value="{{ search_values.pog_daycnt|default_if_none:'' }}">
          <input type="text" name="rawmtrl_nm" class="form-control flex-grow-1" style="font-size: 0.8rem; min-width:110px; max-width:180px;" placeholder="원재료명" value="{{ search_values.rawmtrl_nm|default_if_none:'' }}">
        {% else %}
          <input type="text" name="prdlst_report_no" class="form-control flex-grow-1" style="font-size: 0.8rem; min-width:110px; max-width:180px;" placeholder="품목보고번호" value="{{ search_values.prdlst_report_no|default_if_none:'' }}">
          <input type="text" name="prdlst_nm" class="form-control flex-grow-1" style="font-size: 0.8rem; min-width:110px; max-width:180px;" placeholder="제품명" value="{{ search_values.prdlst_nm|default_if_none:'' }}">
          <input type="text" name="prdlst_dcnm" class="form-control flex-grow-1" style="font-size: 0.8rem; min-width:110px; max-width:180px;" placeholder="식품유형" value="{{ search_values.prdlst_dcnm|default_if_none:'' }}">
          <input type="text" name="bssh_nm" class="form-control flex-grow-1" style="font-size: 0.8rem; min-width:110px; max-width:180px;" placeholder="제조사명" value="{{ search_values.bssh_nm|default_if_none:'' }}">
          <input type="text" name="pog_daycnt" class="form-control flex-grow-1" style="font-size: 0.8rem; min-width:110px; max-width:180px;" placeholder="소비기한" value="{{ search_values.pog_daycnt|default_if_none:'' }}">
          <input type="text" name="frmlc_mtrqlt" class="form-control flex-grow-1" style="font-size: 0.8rem; min-width:110px; max-width:180px;" placeholder="포장재질" value="{{ search_values.frmlc_mtrqlt|default_if_none:'' }}">
          <input type="text" name="rawmtrl_nm" class="form-control flex-grow-1" style="font-size: 0.8rem; min-width:110px; max-width:180px;" placeholder="원재료명 (,=OR / +=AND)" value="{{ search_values.rawmtrl_nm|default_if_none:'' }}">
        {% endif %}
      {% elif page_type == "ingredient" %}
        <div style="min-width:110px;max-width:120px;flex:0 0 120px;">
          <select name="food_category" id="foodCategorySelect" class="form-select" style="font-size: 0.8rem;"
            onchange="this.form.submit()">
            <option value="" {% if not food_category %}selected{% endif %}>구분 전체</option>
            <option value="processed" {% if food_category == "processed" %}selected{% endif %}>가공식품</option>
            <option value="additive" {% if food_category == "additive" %}selected{% endif %}>식품첨가물</option>
            <option value="agricultural" {% if food_category == "agricultural" %}selected{% endif %}>농수산물</option>
          </select>
        </div>
        <input type="text" name="prdlst_report_no" class="form-control flex-grow-1" style="font-size: 0.8rem; min-width:110px; max-width:180px;" placeholder="품목보고번호" value="{{ search_values.prdlst_report_no|default_if_none:'' }}">
        <input type="text" name="prdlst_nm" class="form-control flex-grow-1" style="font-size: 0.8rem; min-width:110px; max-width:180px;" placeholder="원재료명" value="{{ search_values.prdlst_nm|default_if_none:'' }}">
        <input type="text" name="prdlst_dcnm" class="form-control flex-grow-1" style="font-size: 0.8rem; min-width:110px; max-width:180px;" placeholder="식품유형" value="{{ search_values.prdlst_dcnm|default_if_none:'' }}">
        <input type="text" name="bssh_nm" class="form-control flex-grow-1" style="font-size: 0.8rem; min-width:110px; max-width:180px;" placeholder="제조사명" value="{{ search_values.bssh_nm|default_if_none:'' }}">
        <input type="text" name="ingredient_display_name" class="form-control flex-grow-1" style="font-size: 0.8rem; min-width:110px; max-width:180px;" placeholder="원료 표시명 (,=OR / +=AND)" value="{{ search_values.ingredient_display_name|default_if_none:'' }}">
        <input type="text" name="allergens" class="form-control flex-grow-1" style="font-size: 0.8rem; min-width:110px; max-width:180px;" placeholder="알레르기 (,=OR / +=AND)" value="{{ search_values.allergens|default_if_none:'' }}">
        <input type="text" name="gmo" class="form-control flex-grow-1" style="font-size: 0.8rem; min-width:110px; max-width:180px;" placeholder="GMO (,=OR / +=AND)" value="{{ search_values.gmo|default_if_none:'' }}">
      {% elif page_type == "label" %}
        <select name="prdlst_report_status" class="form-select flex-grow-1" style="font-size: 0.8rem; min-width:110px; max-width:180px;" onchange="this.form.submit()">
          <option value="">품보 신고 전체</option>
          <option value="completed" {% if prdlst_report_status == "completed" %}selected{% endif %}>신고 완료</option>
          <option value="pending" {% if prdlst_report_status == "pending" %}selected{% endif %}>신고 대기</option>
        </select>
        <input type="text" name="my_label_name" class="form-control flex-grow-1"
               style="font-size: 0.8rem; min-width:110px; max-width:180px;"
               placeholder="라벨명" value="{{ search_values.my_label_name|default_if_none:'' }}">
        <input type="text" name="prdlst_nm" class="form-control flex-grow-1"
               style="font-size: 0.8rem; min-width:110px; max-width:180px;"
               placeholder="제품명" value="{{ search_values.prdlst_nm|default_if_none:'' }}">
        <input type="text" name="prdlst_dcnm" class="form-control flex-grow-1"
               style="font-size: 0.8rem; min-width:110px; max-width:180px;"
               placeholder="식품유형" value="{{ search_values.prdlst_dcnm|default_if_none:'' }}">
        <input type="text" name="prdlst_report_no" class="form-control flex-grow-1"
               style="font-size: 0.8rem; min-width:110px; max-width:180px;"
               placeholder="품목보고번호" value="{{ search_values.prdlst_report_no|default_if_none:'' }}">
        <input type="text" name="bssh_nm" class="form-control flex-grow-1"
               style="font-size: 0.8rem; min-width:110px; max-width:180px;"
               placeholder="제조사명" value="{{ search_values.bssh_nm|default_if_none:'' }}">
        <input type="text" name="storage_method" class="form-control flex-grow-1"
               style="font-size: 0.8rem; min-width:110px; max-width:180px;"
               placeholder="보관조건" value="{{ search_values.storage_method|default_if_none:'' }}">
        <input type="text" name="frmlc_mtrqlt" class="form-control flex-grow-1"
               style="font-size: 0.8rem; min-width:110px; max-width:180px;"
               placeholder="포장재질" value="{{ search_values.frmlc_mtrqlt|default_if_none:'' }}">
        <!-- 소비기한(pog_daycnt) 검색 조건은 제외 -->
      {% endif %}
      <select name="items_per_page" class="form-select" style="font-size: 0.8rem; width:110px; min-width:100px;">
        <option value="10"  {% if items_per_page == 10  %}selected{% endif %}>10개</option>
        <option value="20"  {% if items_per_page == 20  %}selected{% endif %}>20개</option>
        <option value="50"  {% if items_per_page == 50  %}selected{% endif %}>50개</option>
        <option value="100" {% if items_per_page == 100 %}selected{% endif %}>100개</option>
      </select>
      <button type="submit" class="btn btn-primary search-filter-btn ms-2" id="searchBtn" style="font-size: 0.8rem; min-width:60px;">
        <span class="btn-text">검색</span>
        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
        <span class="loading-text d-none">검색중...</span>
      </button>
      <button type="button" class="btn btn-cancel search-filter-btn ms-1" id="searchResetBtn" onclick="location.href='{{ target_url }}'" style="font-size: 0.8rem; min-width:30px; max-width:40px;">
        &#x21BA;
      </button>
    </div>
  </div>
</form>

<!-- 검색 결과 건수 표시 영역: 항상 공간 확보, 투명도 조절 -->
<div class="mb-2" style="min-height:1.7em;">
  {% if search_result_count is not None %}
    <span class="text-primary fw-bold">{{ search_result_count }}</span>건이 조회되었습니다.
  {% else %}
    <span style="opacity:0;">0건이 조회되었습니다.</span>
  {% endif %}
</div>

<!-- 로딩 오버레이 -->
<div id="loadingOverlay" class="d-none">
  <div class="loading-content">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">로딩중...</span>
    </div>
    <div class="mt-2">검색 중입니다...</div>
  </div>
</div>

<style>
#loadingOverlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(255, 255, 255, 0.8);
  z-index: 9999;
  display: flex;
  justify-content: center;
  align-items: center;
}

.loading-content {
  text-align: center;
  background: white;
  padding: 2rem;
  border-radius: 8px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

/* 검색 버튼 상태 스타일 */
#searchBtn.loading {
  pointer-events: none;
  opacity: 0.7;
}
</style>

<script>
  // 검색조건 입력값을 localStorage에 저장/복원 (검색 버튼 클릭 시)
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form[action="{{ target_url }}"]');
    if (!form) return;
    // 복원
    try {
      const saved = localStorage.getItem('search_' + window.location.pathname);
      if (saved) {
        const params = JSON.parse(saved);
        for (const [k, v] of Object.entries(params)) {
          const el = form.elements[k];
          if (el) el.value = v;
        }
      }
    } catch (e) {}
    // 저장
    form.addEventListener('submit', function() {
      const params = {};
      Array.from(form.elements).forEach(el => {
        if (el.name && el.value !== undefined) params[el.name] = el.value;
      });
      localStorage.setItem('search_' + window.location.pathname, JSON.stringify(params));
    });
    // 초기화 버튼 클릭 시 localStorage 값도 삭제
    const resetBtn = document.getElementById('searchResetBtn');
    if (resetBtn) {
      resetBtn.addEventListener('click', function() {
        localStorage.removeItem('search_' + window.location.pathname);
      });
    }
  });
  // 식품 구분 select의 value를 서버에서 받은 값으로 명확히 설정 (혹시라도 selected가 안 먹는 경우)
  document.addEventListener('DOMContentLoaded', function() {
    var foodCategorySelect = document.getElementById('foodCategorySelect');
    if (foodCategorySelect && "{{ food_category|escapejs }}") {
      foodCategorySelect.value = "{{ food_category|escapejs }}";
    }
  });
</script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // 검색 폼을 찾습니다. ID 'searchFilterForm'를 우선적으로 사용하거나, #content 내의 첫 번째 form을 사용합니다.
    // 이 스크립트가 올바르게 동작하려면 검색 폼에 ID (예: "searchFilterForm")를 부여하는 것이 가장 좋습니다.
    const filterForm = document.getElementById('searchFilterForm') || document.querySelector('#content form'); 
    
    if (!filterForm) {
        // console.warn('검색 필터 폼을 찾을 수 없습니다. 검색 폼에 "searchFilterForm"과 같은 ID가 있는지 또는 이 인클루드 내용의 기본 폼인지 확인하세요.');
        return;
    }

    const searchInputs = filterForm.querySelectorAll('input[type="text"], input[type="search"], input[type="number"], select');

    function applyHasValueClassToAll() {
        searchInputs.forEach(input => {
            const value = input.value;
            if (value && String(value).trim() !== '') {
                input.classList.add('has-value');
            } else {
                input.classList.remove('has-value');
            }
        });
    }

    function clearSearchFields() {
        searchInputs.forEach(input => {
            if (input.tagName === 'SELECT') {
                // select 요소의 경우, value="" 옵션 또는 첫 번째 옵션으로 설정합니다.
                const defaultOption = input.querySelector('option[value=""]');
                if (defaultOption) {
                    input.value = "";
                } else if (input.options.length > 0 && !input.multiple) {
                    input.selectedIndex = 0; 
                } else if (input.multiple) {
                    Array.from(input.options).forEach(option => option.selected = false);
                } else {
                     input.value = ""; // 비어있거나 특이한 select 요소에 대한 대비책
                }
            } else {
                input.value = ''; // 텍스트 기반 입력 필드 초기화
            }
        });
        applyHasValueClassToAll(); // 스타일 업데이트
    }

    function applyFiltersFromUrlOrClearFields() {
        const urlParams = new URLSearchParams(window.location.search);
        let hasAnyRelevantQueryParamInUrl = false;

        searchInputs.forEach(input => {
            const inputName = input.name;
            if (inputName && urlParams.has(inputName)) {
                const urlValue = urlParams.get(inputName);
                // URL 파라미터가 존재하면 값을 설정합니다 (값이 비어 있어도). 그 후 스타일을 적용합니다.
                input.value = urlValue;
                if (urlValue.trim() !== '') {
                    hasAnyRelevantQueryParamInUrl = true;
                }
            } else if (inputName) {
                // URL에 해당 파라미터가 없으면 필드를 비웁니다 (bfcache 시나리오 대비).
                if (input.tagName === 'SELECT') {
                    const defaultOption = input.querySelector('option[value=""]');
                    input.value = defaultOption ? "" : (input.options.length > 0 && !input.multiple ? input.options[0].value : "");
                } else {
                    input.value = '';
                }
            }
        });
        
        // 알려진 검색 입력 이름 중 하나라도 URL 파라미터에 비어 있지 않은 값으로 존재하는지 확인합니다.
        let foundActiveSearchParam = false;
        for (const input of searchInputs) {
            if (input.name && urlParams.has(input.name) && urlParams.get(input.name).trim() !== '') {
                foundActiveSearchParam = true;
                break;
            }
        }

        if (!foundActiveSearchParam) {
            // URL에 활성 검색 파라미터가 없으면 모든 검색 필드를 비웁니다.
            // 이는 "?page=2"와 같이 검색어 없이 페이지로 이동하는 경우를 처리합니다.
            clearSearchFields();
        }
        
        applyHasValueClassToAll(); // 필드 설정/초기화 후 스타일 업데이트
    }

    // 초기 로드: URL에서 필터를 적용하거나 필드를 비웁니다.
    applyFiltersFromUrlOrClearFields();

    // bfcache (뒤로/앞으로 가기 캐시) 처리
    window.addEventListener('pageshow', function(event) {
        if (event.persisted) { // 페이지가 bfcache에서 복원된 경우
            applyFiltersFromUrlOrClearFields();
        }
    });

    // 초기화 버튼 기능
    const resetButton = document.getElementById('resetSearchFilters'); // 이 ID가 초기화 버튼의 ID와 일치하는지 확인하세요.
    if (resetButton) {
        resetButton.addEventListener('click', function (e) {
            e.preventDefault(); // submit 버튼인 경우 기본 폼 제출 방지
            clearSearchFields();
            // 모든 쿼리 파라미터를 제거하고 현재 페이지의 기본 경로로 이동합니다.
            window.location.href = window.location.pathname; 
        });
    }

    // 스타일링 (has-value 클래스)을 위한 input/change 리스너 추가
    searchInputs.forEach(input => {
        input.addEventListener('input', applyHasValueClassToAll);
        input.addEventListener('change', applyHasValueClassToAll); // select 요소용
    });

});
</script>
