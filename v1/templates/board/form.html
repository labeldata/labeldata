{% extends 'base_v2.html' %}
{% load static django_bootstrap5 %}
{% block title %}{% if form.instance.pk %}게시글 수정{% else %}게시글 작성{% endif %} - 직문 및 요청{% endblock %}

{% block topbar %}
<div class="page-title">
    <i class="bi bi-pencil-square v2-topbar-icon"></i>
    {% if form.instance.pk %}게시글 수정{% else %}게시글 작성{% endif %}
</div>
<div class="d-flex gap-2">
    <a href="{% url 'board:list' %}" class="form-action-btn cancel"><i class="bi bi-x"></i>취소</a>
    <button type="submit" form="board-form" class="form-action-btn save"><i class="bi bi-check2"></i>저장</button>
</div>
{% include "includes/_topbar_account.html" %}
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/board.css' %}">
{% endblock %}

{% block content %}

<div class="form-content">
    <div class="form-card">
        <div class="form-card-body">
            <form id="board-form" method="post" enctype="multipart/form-data">
                {% csrf_token %}

                <!-- 구분 + 옵션 -->
                <div class="form-row">
                    <div class="form-group board-select-group">
                        <label class="m3-label">구분 <span class="req">*</span></label>
                        <select name="category" class="m3-select" required>
                            <option value="">구분 선택</option>
                            {% if user.is_staff %}
                            <option value="공지사항" {% if form.instance.is_notice %}selected{% endif %}>공지사항</option>
                            {% endif %}
                            <option value="기능 요청" {% if '[기능 요청]' in form.instance.title %}selected{% endif %}>기능 요청</option>
                            <option value="오류 제보" {% if '[오류 제보]' in form.instance.title %}selected{% endif %}>오류 제보</option>
                            <option value="사업 제휴" {% if '[사업 제휴]' in form.instance.title %}selected{% endif %}>사업 제휴</option>
                        </select>
                    </div>
                    <div class="d-flex gap-3 align-items-center pb-1">
                        <label class="m3-check">
                            {{ form.is_hidden }}
                            비밀글
                        </label>
                        {% if user.is_staff %}
                        <label class="m3-check">
                            {{ form.is_notice }}
                            공지사항
                        </label>
                        {% endif %}
                    </div>
                </div>
                {% if form.is_hidden.errors %}<div class="error-msg mb-2">{{ form.is_hidden.errors }}</div>{% endif %}
                {% if form.is_notice.errors %}<div class="error-msg mb-2">{{ form.is_notice.errors }}</div>{% endif %}

                <!-- 제목 -->
                <div class="form-group">
                    <label class="m3-label">제목 <span class="req">*</span></label>
                    <input type="text" name="title" class="m3-input" id="id_title" required
                           value="{% if form.instance.title %}{% if '[기능 요청]' in form.instance.title %}{{ form.instance.title|slice:'8:' }}{% elif '[오류 제보]' in form.instance.title %}{{ form.instance.title|slice:'7:' }}{% elif '[사업 제휴]' in form.instance.title %}{{ form.instance.title|slice:'7:' }}{% else %}{{ form.instance.title }}{% endif %}{% endif %}">
                    {% if form.title.errors %}<div class="error-msg">{{ form.title.errors }}</div>{% endif %}
                </div>

                <!-- 내용 -->
                <div class="form-group">
                    <label class="m3-label">내용 <span class="req">*</span></label>
                    {{ form.content }}
                    {% if form.content.errors %}<div class="error-msg">{{ form.content.errors }}</div>{% endif %}
                </div>

                <!-- 관리자 전용: 첨부파일 + 이미지 -->
                {% if user.is_staff %}
                <hr class="form-divider">
                <div class="form-row">
                    <div class="form-group">
                        <label class="m3-label">첨부파일</label>
                        {{ form.attachment }}
                        {% if form.attachment.errors %}<div class="error-msg">{{ form.attachment.errors }}</div>{% endif %}
                        {% if form.instance.attachment %}
                        <div class="current-attachment">
                            <i class="bi bi-paperclip"></i>
                            <a href="{{ form.instance.attachment.url }}">{{ form.instance.attachment.name }}</a>
                            {% if form.delete_attachment %}
                            <label class="m3-check ms-2">{{ form.delete_attachment }} 삭제</label>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    <div class="form-group">
                        <label class="m3-label">이미지 첨부</label>
                        {{ form.image }}
                        {% if form.image.errors %}<div class="error-msg">{{ form.image.errors }}</div>{% endif %}
                        {% if form.instance.image %}
                        <div class="current-attachment mt-2">
                            <img src="{{ form.instance.image.url }}" alt="현재 이미지" class="board-preview-img">
                            {% if form.delete_image %}
                            <label class="m3-check ms-2">{{ form.delete_image }} 삭제</label>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </form>
        </div>
    </div>
</div>
{% endblock %}
